        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8" />
            <title>My page</title>
            <link
                    href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
                    rel="stylesheet"
            />
            <style>
                /* ========== Tokens ========== */
                :root {
                    --line: #e2e8f0;
                    --muted: #6b7280;
                    --brand: #2563eb;
                    --brand-weak: #e6efff;
                    --danger: #ef4444;
                    --shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
                    --preview-color: rgba(99, 179, 237, 0.25); /* í”„ë¦¬ë·° ë°•ìŠ¤ ë°°ê²½ */
                }

                /* ========== Base ========== */
                body {
                    margin: 0;
                    padding: 0;
                    font-family: 'Montserrat', sans-serif;
                    background-color: #f7f9fc;
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                }

                header {
                    padding: 20px;
                    box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
                    background-color: rgba(255, 255, 255, 0.85);
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    border-bottom: 1px solid #e2e8f0;
                }

                h1 {
                    font-size: 2.3rem;
                    font-weight: bold;
                    color: var(--brand);
                    margin: 0;
                }
                h1 a {
                    text-decoration: none;
                    color: inherit;
                }

                nav a {
                    margin-left: 20px;
                    text-decoration: none;
                    color: #333;
                    font-weight: 500;
                    transition: color 0.2s ease, font-size 0.2s ease;
                }
                nav a:hover {
                    color: #3b82f6;
                    font-size: 1.1rem;
                }

                main { flex: 1; padding: 20px 0; }

                /* ========== Layout (Grid) ========== */
                .container {
                    display: grid;
                    grid-template-columns: 2fr 1fr; /* ì¢Œ: ëŒ€í‘œ(ë„“ê²Œ) / ìš°: ì‚¬ì´ë“œ */
                    gap: 16px;
                    max-width: 1200px;
                    width: 100%;
                    margin: 0 auto;
                    padding: 20px 16px;
                }
                .sidebar {
                    display: flex;
                    flex-direction: column;
                    gap: 16px;
                }
                @media (max-width: 900px) {
                    .container { grid-template-columns: 1fr; }
                }

                /* ========== Cards / Boxes ========== */
                .box {
                    background: #fff;
                    border: 1px solid var(--line);
                    border-radius: 14px;
                    padding: 16px 18px;
                    box-shadow: var(--shadow);
                    display: flex;
                    flex-direction: column;
                    min-height: 160px;
                    box-sizing: border-box;
                    transition: transform .3s ease, box-shadow .3s ease;
                }
                .box3 { min-height: 220px; }
                .box:hover {
                    transform: translateY(-4px);
                    box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
                }
                .sidebar .box + .box { margin-top: 5px; }

                .box .card-title {
                    display: flex; align-items: center; gap: 10px;
                    margin: 0 0 12px;
                    font-size: 16px; font-weight: 800;
                }
                .box .card-title .icon {
                    display: inline-flex; align-items: center; justify-content: center;
                    width: 28px; height: 28px;
                    border-radius: 8px; background: var(--brand-weak);
                    font-size: 16px;
                }

                /* ========== Typography / Sections ========== */
                h2, h3 { margin: 0 0 10px; font-size: 1.1rem; color: #111827; }
                .section { margin-bottom: 10px; }
                .info p { margin: 3px 0; font-size: .9rem; color: #374151; }

                /* ì œëª©-ì•¡ì…˜ ê°€ë¡œ ì •ë ¬ */
                .section-header {
                    display: flex; align-items: center; justify-content: space-between; gap: 12px;
                }
                .section-header h3 { margin: 0; line-height: 1; transform: translateY(-3px); }
                .section-header .actions { display: flex; gap: 8px; }
                .section-header .actions button { width: auto; margin-top: 0; padding: 8px 12px; }
                @media (max-width: 560px) {
                    .section-header { flex-wrap: wrap; }
                    .section-header .actions { width: 100%; justify-content: flex-start; }
                }

                /* ========== Buttons ========== */
                button {
                    background-color: var(--brand);
                    color: #fff;
                    border: none;
                    padding: 10px 16px;
                    border-radius: 10px;
                    font-size: .9rem;
                    cursor: pointer;
                    transition: background-color .25s ease, transform .25s ease;
                }
                button:hover { background-color: #1e40af; transform: scale(1.03); }
                button.red { background-color: var(--danger); }
                button.red:hover { background-color: #dc2626; }

                /* ========== Representative Schedule Container ========== */
                .representative-container { width: 100%; }
                .representative-box {
                    background-color: #fff;
                    border-radius: 10px;
                    box-shadow: 0 4px 10px rgba(0,0,0,.05);
                    padding: 30px; box-sizing: border-box;
                }
                /* ëŒ€í‘œ ì‹œê°„í‘œ í­ ì§€ì • & ì¤‘ì•™ ì •ë ¬ */
                #repGridCard { width: 750px; margin: 0 auto; }

                /* ========== Footer ========== */
                footer {
                    background-color: rgba(30, 30, 30, 0.98);
                    color: rgba(200, 200, 200, 0.7);
                    font-size: .9rem;
                    padding: 2rem 1rem;
                    text-align: center;
                    border-top: 1px solid #444;
                    margin-top: auto;
                }
                footer a { text-decoration: none; color: rgba(200, 200, 200, 0.7); margin: 0 10px; }
                footer a:hover { text-decoration: underline; }

                /* ========== Select (Custom) ========== */
                select {
                    appearance: none; -webkit-appearance: none; -moz-appearance: none;
                    background-color: #fff;
                    border: 1px solid #cbd5e1;
                    border-radius: 8px;
                    padding: 10px 14px;
                    font-size: 1rem; color: #111827;
                    font-family: 'Montserrat', sans-serif;
                    cursor: pointer;
                    transition: border-color .2s ease, box-shadow .2s ease;
                    background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
                    background-repeat: no-repeat;
                    background-position: right 12px center;
                    background-size: 16px 16px;
                    padding-right: 40px;
                }
                select:hover { border-color: var(--brand); box-shadow: 0 0 0 3px rgba(37,99,235,.2); }
                select:focus { outline: none; border-color: var(--brand); box-shadow: 0 0 0 3px rgba(37,99,235,.3); }

                /* ========== Modal ========== */
                .modal-overlay {
                    position: fixed; inset: 0;
                    background-color: rgba(0,0,0,0.5);
                    display: flex; justify-content: center; align-items: center;
                    z-index: 1000;
                }
                .modal-wrapper { display: contents; }
                .modal {
                    background: #fff; border-radius: 12px;
                    padding: 24px 32px;
                    max-width: 400px; width: 90%;
                    box-shadow: 0 6px 24px rgba(0,0,0,.2);
                    text-align: center;
                    display: flex; flex-direction: row; gap: 16px;
                }
                .modal-buttons {
                    display: flex; justify-content: center; gap: 12px; margin-top: 8px;
                }
                .modal-buttons button {
                    flex: 1; max-width: 120px;
                    padding: .6rem 0; border-radius: 8px; font-size: .95rem;
                    transition: transform .15s, box-shadow .15s, opacity .15s;
                }
                .modal-buttons #confirm,
                .modal-buttons #changePwBtn { background-color: var(--brand); color: #fff; }
                .modal-buttons #close-btn,
                .modal-buttons #cancelChange { background-color: #e0e0e0; color: #333; }
                .modal-buttons button:hover { transform: translateY(-1px); opacity: .9; }
                .modal-buttons button:active { transform: translateY(1px); }
                .modal input[type='password'] {
                    width: 100%; padding: .75rem 1rem;
                    border: 1px solid #ccc; border-radius: 8px; font-size: 1rem;
                    box-sizing: border-box;
                }
                .hidden { display: none; }
                body.modal-open { overflow: hidden; }

                /* ========== Semester List ========== */
                #semesterList { list-style: none; padding-left: 0; margin: 12px 0 0 0; }
                #semesterList li {
                    margin: 5px 0;
                    display: flex; justify-content: space-between; align-items: center;
                }
                #semesterList .semester-item {
                    display: flex; align-items: center; justify-content: space-between; gap: 14px;
                    border: 1px solid #e5e7eb; border-radius: 10px;
                    padding: 10px 14px; background: #fff;
                    transition: background-color .15s ease, box-shadow .15s ease, border-color .15s ease;
                    cursor: pointer; width: 80%;
                }
                #semesterList .semester-item:hover {
                    background: #f9fafb; border-color: #d1d5db; box-shadow: 0 4px 12px rgba(0,0,0,.04);
                }
                #semesterList .semester-name { color: #111827; text-decoration: none; font-weight: 600; }
                #semesterList .semester-actions { display: flex; align-items: center; gap: 10px; }
                #semesterList .rep-label { display: inline-flex; align-items: center; gap: 6px; cursor: pointer; }
                #semesterList .del-btn {
                    background: transparent; border: none; cursor: pointer; padding: 4px;
                    display: flex; align-items: center; justify-content: center;
                }
                /* ë”ë³´ê¸° ë²„íŠ¼ */
                .hidden-semester { display: none !important; }
                #showMoreBtn {
                    margin-top: 10px; width: 100%;
                    background: #f3f4f6;
                    border: 1px solid #e5e7eb; color: #111827;
                    border-radius: 10px; padding: 8px 12px; cursor: pointer; font-size: .92rem;
                }
                #showMoreBtn:hover { background: #eceff3; }

                /* ========== Course Tooltip ========== */
                .course-tooltip { animation: fadeIn .12s; }
                @keyframes fadeIn {
                    from { opacity: 0; transform: translateY(8px); }
                    to   { opacity: 1; transform: translateY(0); }
                }

                /* ========== Tech Tree Small Cards ========== */
                .details-container {
                    display: grid;
                    grid-template-columns: repeat(4, minmax(0, 1fr));
                    gap: 10px; margin-top: 10px;
                }
                @media (max-width: 420px) {
                    .details-container { grid-template-columns: repeat(2, 1fr); }
                }
                .detail {
                    border: 1px solid var(--line); border-radius: 10px; background-color: #fff;
                    height: 70px; display: flex; flex-direction: column; justify-content: center; align-items: center;
                    box-shadow: 0 2px 6px rgba(0,0,0,.1);
                    transition: transform .2s ease-in-out, box-shadow .2s ease-in-out;
                }
                .detail:hover { transform: translateY(-4px); box-shadow: 0 8px 16px rgba(0,0,0,.15); cursor: pointer; }
                .detail .label { font-size: 17px; font-weight: bold; margin-bottom: 4px; }
                .detail .value { font-size: 20px; font-weight: 700; color: #007bff; }

                .box .desc-list { margin: 8px 0 14px; }
                .box .desc-list div { display: flex; gap: 10px; padding: 6px 0; border-bottom: 1px dashed var(--line); }
                .box .desc-list dt { width: 66px; color: var(--muted); font-weight: 700; }
                .box .desc-list dd { margin: 0; }
                .box2 .subtext, .box3 .subtext {
                    font-size: .85rem; line-height: 1.4; color: var(--muted); margin-top: 4px;
                }

                /* ========== Schedule (Grid-based) ========== */
                .schedule-card {
                    border: 1px solid var(--line);
                    border-radius: 14px;
                    overflow: hidden;
                    background: #fff;
                    box-shadow: var(--shadow);
                }
                .schedule-header {
                    display: grid; grid-template-columns: 120px repeat(5, 1fr);
                    background: #f9fbff; border-bottom: 1px solid var(--line);
                }
                .schedule-header > div { padding: 12px; font-weight: 700; text-align: center; }
                .schedule-body { display: flex; flex-direction: column; }

                /* Grid ë³¸ì²´ */
                .schedule-grid {
                    display: grid;
                    grid-template-columns: 120px repeat(5, 1fr); /* ì‹œê°„ì—´ + ì›”~ê¸ˆ */
                    grid-auto-rows: 80px;                        /* êµì‹œ ë†’ì´ (ëª¨ë‹¬/ëŒ€í‘œì—ì„œ JSë¡œ ì¡°ì • ê°€ëŠ¥) */
                    grid-auto-flow: row dense;
                    position: relative;
                    background: #fff;
                    border-top: 1px solid var(--line);
                    border-left: 1px solid var(--line);
                }

                /* ì™¼ìª½ ì‹œê°„ ì…€ */
                .time-cell {
                    display: flex; flex-direction: column; align-items: center; justify-content: center;
                    font-weight: 700; font-size: 14px;
                    background: #fbfbfb;
                    border-bottom: 1px solid var(--line);
                    border-right: 1px solid var(--line);
                }
                .time-cell span { color: var(--muted); font-weight: 600; }

                /* ë¹ˆ ìë¦¬(ê²©ì) */
                .cell-placeholder {
                    border-right: 1px solid var(--line);
                    border-bottom: 1px solid var(--line);
                    position: relative;
                }

                /* ê³¼ëª© ë¸”ë¡ (ê³µí†µ) */
                .course-block {
                    border-radius: 10px;
                    border: 2px solid rgba(0,0,0,.12);
                    box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 3px 10px rgba(0,0,0,.08);
                    color: #0f172a;
                    display: flex; align-items: center; justify-content: center;
                    padding: 8px 10px; text-align: center;
                    overflow: hidden;
                }

                /* ë°”ìœ ìƒíƒœ(ì‹¤ì œ ë°°ì¹˜) ì‹œ ë°°ê²½ â€¢ í…Œë‘ë¦¬ ì»¬ëŸ¬ ì ìš© */
                .course-block.busy {
                    --c: var(--course-color, #a5d8ff);
                    --stroke: color-mix(in oklab, var(--c) 85%, black);
                    background:
                            radial-gradient(
                                    circle at 50% 45%,
                                    #ffffff 0%,
                                    color-mix(in oklab, #ffffff 92%, var(--c)) 28%,
                                    color-mix(in oklab, #ffffff 88%, var(--c)) 48%,
                                    color-mix(in oklab, #ffffff 82%, var(--c)) 68%,
                                    color-mix(in oklab, #ffffff 75%, var(--c)) 100%
                            );
                    border: 2px solid var(--stroke);
                }

                /* ë¸”ë¡ ë‚´ë¶€ í…ìŠ¤íŠ¸ */
                .course-block .slot { line-height: 1.3; }
                .course-block .slot-title {
                    font-size: 13px; font-weight: 800;
                    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
                }
                .course-block .slot-room {
                    margin-top: 2px; font-size: 12px; font-weight: 600;
                    opacity: .9; color: var(--muted);
                }

                /* í”„ë¦¬ë·°(ë¯¸ë¦¬ë³´ê¸°) ë¸”ë¡ */
                .preview-block {
                    border-radius: 10px;
                    border: 2px dashed rgba(0,0,0,.18);
                    background: var(--preview-color);
                    color: #0f172a;
                    display: flex; align-items: center; justify-content: center;
                    padding: 8px 10px; text-align: center;
                    pointer-events: none;
                    z-index: 9;
                }

                /* Responsive trims */
                @media (max-width: 560px) {
                    .schedule-header,
                    .schedule-grid { grid-template-columns: 80px repeat(5, 1fr); }
                    .time-cell { font-size: 12px; }
                }

            </style>
        </head>
        <body>
        <header>
            <h1><a href="/">SMULET</a></h1>
            <nav>
                <a href="#"><b>ì´ìš©ì•ˆë‚´</b></a>
                <a href="/login_page" id="loginLink"><b>ë¡œê·¸ì¸</b></a>
                <a href="/Register" id="registerLink"><b>íšŒì›ê°€ì…</b></a>
                <a href="/" id="logoutLink" style="display: none"><b>ë¡œê·¸ì•„ì›ƒ</b></a>
                <a href="/" id="" style="display: none"><b>ë§ˆì´í˜ì´ì§€</b></a>
            </nav>
        </header>
        <main>
            <div class="container">
                <!-- ì¢Œì¸¡: ëŒ€í‘œ ì‹œê°„í‘œ -->
                <div class="representative-container">
                    <div class="box representative-box">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <h2 id="representativeTitle" class="card-title">
                                <span class="icon">ğŸ“Œ</span> ëŒ€í‘œ ì‹œê°„í‘œ
                            </h2>
                        </div>
                        <div id="representativeScheduleContainer">
                            <div class="schedule-card" id="repGridCard">
                                <div class="schedule-header">
                                    <div class="time-col"></div>
                                    <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div>
                                </div>
                                <div class="schedule-body" id="repGridBody"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar">
                    <!-- BOX1 -->
                    <div class="box box1">
                        <h2 class="card-title"><span class="icon">ğŸ“…</span> ì‹œê°„í‘œ</h2>
                        <p class="subtext">ì‹œê°„í‘œë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

                        <!-- ë“œë¡­ë‹¤ìš´ë§Œìœ¼ë¡œ ë°”ë¡œ í•™ê¸° ì¶”ê°€ -->
                        <div style="margin-top: 1px">
                            <select id="semesterSelectInline" style="min-width: 220px">
                                <option value="">í•™ê¸°ë¥¼ ì„ íƒí•´ ì¶”ê°€</option>
                                <!-- JSì—ì„œ ì˜µì…˜ ì±„ì›Œì§ -->
                            </select>
                            <div id="scheduleModalMount"></div>
                        </div>

                        <ul id="semesterList" style="margin-top: 12px"></ul>
                        <!-- ì‹œê°„í‘œ ëª¨ë‹¬ -->
                    </div>

                    <div
                            id="modalOverlay"
                            class="modal-overlay hidden"
                            role="dialog"
                            aria-modal="true"
                            aria-labelledby="pwTitle"
                    >
                        <div class="modal-wrapper">
                            <div class="modal">
                                <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                                <input type="password" id="pw" />
                                <div class="modal-buttons">
                                    <button id="confirm" type="button">í™•ì¸</button>
                                    <button id="close-btn" type="button">ë‹«ê¸°</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="changePwModal" class="modal-overlay hidden">
                        <div class="modal-wrapper">
                            <div class="modal">
                                <p>ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                                <input
                                        type="password"
                                        id="newPassword"
                                        placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"
                                />
                                <input
                                        type="password"
                                        id="confirmPassword"
                                        placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                                />
                                <div class="modal-buttons">
                                    <button id="changePwBtn" type="button">ë³€ê²½</button>
                                    <button id="cancelChange" type="button">ì·¨ì†Œ</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- BOX2 -->
                    <div class="box box2">
                        <h2 class="card-title"><span class="icon">ğŸŒ³</span> í…Œí¬íŠ¸ë¦¬</h2>
                        <p class="subtext">ëª¨ë“  í…Œí¬íŠ¸ë¦¬ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

                        <select
                                id="techTreeSelect"
                                onchange="goToTechTree()"
                                style="margin-top: 1px"
                        >
                            <option value="">í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                            <option value="21">21í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                            <option value="22">22í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                            <option value="23">23í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                            <option value="24">24í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                            <option value="25">25í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                        </select>

                        <!-- ê°€ë¡œ ì •ë ¬ëœ ë°•ìŠ¤ë“¤ -->
                        <div class="details-container">
                            <div class="detail">
                                <span class="label">bsm</span>
                                <span class="value" id="bsmCredit">0</span>
                            </div>
                            <div class="detail">
                                <span class="label">ì„¤ê³„</span>
                                <span class="value" id="designCredit">0</span>
                            </div>
                            <div class="detail">
                                <span class="label">ì „ê³µì„ íƒ</span>
                                <span class="value" id="majorElectiveCredit">0</span>
                            </div>
                            <div class="detail">
                                <span class="label">ì „ê³µì‹¬í™”</span>
                                <span class="value" id="majorAdvancedCredit">0</span>
                            </div>
                        </div>
                    </div>

                    <div class="box box3">
                        <div class="section">
                            <h2 class="card-title"><span class="icon">ğŸ‘¤</span> ë‚´ ì •ë³´</h2>
                            <dl class="desc-list">
                                <div>
                                    <dt>ì´ë¦„</dt>
                                    <dd><span id="userName"></span></dd>
                                </div>
                                <div>
                                    <dt>ì´ë©”ì¼</dt>
                                    <dd><span id="studentId"></span></dd>
                                </div>
                                <div>
                                    <dt>í•™ê³¼</dt>
                                    <dd><span id="userMajor">ì»´í“¨í„°ê³¼í•™ê³¼</span></dd>
                                </div>
                            </dl>
                            <div class="section">
                                <div class="section-header">
                                    <h3>ğŸ”’ íšŒì› ì„¤ì •</h3>
                                    <div class="actions">
                                        <button onclick="modifinguserinfo()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                                        <button class="red" onclick="deleteAccount()">
                                            íšŒì›íƒˆí‡´
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <footer>
            <b>
                <a href="#">Github</a>
                <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
                <a href="#">ì´ìš©ì•½ê´€</a><br /><br />
                <a href="#">Copyright</a>
            </b>
        </footer>

        <script>
            /***********************
             * ìƒìˆ˜ / ì „ì—­ ìƒíƒœ
             ***********************/
            const semesterOptions = [
                '2025ë…„ 2í•™ê¸°','2025ë…„ 1í•™ê¸°','2024ë…„ 2í•™ê¸°','2024ë…„ 1í•™ê¸°',
                '2023ë…„ 2í•™ê¸°','2023ë…„ 1í•™ê¸°','2022ë…„ 2í•™ê¸°','2022ë…„ 1í•™ê¸°',
                '2021ë…„ 2í•™ê¸°','2021ë…„ 1í•™ê¸°',
            ];
            const pastelPalette = ["#A5D8FF","#B2F2BB","#FFD8A8","#FFC9C9","#D0BFFF","#B2E3E8","#FFE69A","#F4C2D7","#C9E4A7","#C7D2FE"];

            const ColorManager = (() => {
                const pool = [...pastelPalette];
                for (let i = pool.length - 1; i > 0; i--) { const j = Math.floor(Math.random()*(i+1)); [pool[i],pool[j]]=[pool[j],pool[i]];}
                const map = new Map(); let cursor = 0;
                const nextPoolColor = (usedSet) => {
                    for (let i=0;i<pool.length;i++){ const idx=(cursor+i)%pool.length; const c=pool[idx]; if(!usedSet.has(c)){ cursor=(idx+1)%pool.length; return c; } }
                    return null;
                };
                const hslFromString = (s) => {
                    let hash=0; for (const ch of String(s)){ hash = ((hash<<5)-hash)+ch.charCodeAt(0); hash|=0; }
                    const h = Math.abs(hash)%360; return `hsl(${h}, 70%, 85%)`;
                };
                const get = (key) => {
                    if (!key) return pool[0];
                    if (map.has(key)) return map.get(key);
                    const used = new Set(map.values());
                    let color = nextPoolColor(used); if(!color) color = hslFromString(key);
                    map.set(key, color); return color;
                };
                const free = (key) => { if (!key) return; map.delete(key); };
                const has  = (key) => map.has(key);
                return { get, free, has };
            })();

            let UserId = null;
            let representativeTermCode = null; // "20252"
            let selectedSemesters = [];
            let timetableIdsBySemester = {};
            let _moreOpen = false; // ë”ë³´ê¸° í¼ì¹¨ ìƒíƒœ
            document.addEventListener('DOMContentLoaded', init);

            /***********************
             * ê³µí†µ ìœ í‹¸
             ***********************/
            function toSemesterCode(semText){
                const m = String(semText).match(/(\d{4})\D*(1|2)\D*í•™ê¸°?/);
                return m ? `${m[1]}${m[2]}` : semText.replace(/\D/g,'');
            }
            const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
            function periodLabel(p){
                if (p===0) return '8~9ì‹œ';
                const labels = ['9~10ì‹œ','10~11ì‹œ','11~12ì‹œ','12~1ì‹œ','1~2ì‹œ','2~3ì‹œ','3~4ì‹œ','4~5ì‹œ','5~6ì‹œ','6~7ì‹œ','7~8ì‹œ','8~9ì‹œ','9~10ì‹œ','10~11ì‹œ','11~12ì‹œ'];
                return labels[p-1]||'';
            }
            function isTruthyTag(tag){
                if (tag===true||tag===1) return true;
                if (tag===false||tag===0) return false;
                if (typeof tag==='string'){ const t=tag.trim().toLowerCase(); if(['t','true','1','y','yes'].includes(t)) return true; if(['f','false','0','n','no'].includes(t)) return false; }
                return !!tag;
            }
            function pickTimetableArray(obj){
                if (!obj || typeof obj!=='object') return [];
                const candidates = Object.values(obj).filter(Array.isArray);
                return candidates.find(arr => arr.some(r => r && typeof r==='object' && ('timetableId' in r || 'id' in r) && ('tag' in r || 'term' in r))) || [];
            }
            function toSemesterName(termCode){
                const s = String(termCode||''); const year = s.slice(0,4); const sem = s.slice(4);
                const label = sem==='1' ? '1í•™ê¸°' : sem==='2' ? '2í•™ê¸°' : '';
                return (year && label) ? `${year}ë…„ ${label}` : 'ëŒ€í‘œ ì‹œê°„í‘œ';
            }

            /***********************
             * í† í°/í†µì‹ 
             ***********************/
            const TokenManager = (() => {
                let accessToken = null;
                let refreshingPromise = null;
                const set = (t)=>{ accessToken = t || null; };
                const get = ()=> accessToken;
                const refresh = async () => {
                    if (refreshingPromise) return refreshingPromise;
                    refreshingPromise = (async () => {
                        const res = await fetch('/refreshT', { method:'POST', credentials:'include' });
                        if (!res.ok){ set(null); throw new Error('Refresh failed'); }
                        const auth = res.headers.get('Authorization');
                        if (!auth || !auth.startsWith('Bearer ')){ set(null); throw new Error('No Authorization header'); }
                        const token = auth.slice('Bearer '.length); set(token); return token;
                    })();
                    try { return await refreshingPromise; } finally { refreshingPromise = null; }
                };
                return { get, set, refresh };
            })();

            async function apiFetch(input, init = {}) {
                const headers = new Headers(init.headers || {});
                const token = TokenManager.get();
                if (token) headers.set('Authorization', `Bearer ${token}`);
                let res = await fetch(input, { ...init, headers, credentials: 'include' });
                if (res.status === 401) {
                    try {
                        const newToken = await TokenManager.refresh();
                        const retryHeaders = new Headers(init.headers || {});
                        retryHeaders.set('Authorization', `Bearer ${newToken}`);
                        res = await fetch(input, { ...init, headers: retryHeaders, credentials: 'include' });
                    } catch (e) {
                        TokenManager.set(null);
                        throw e;
                    }
                }
                return res;
            }


            /***********************
             * ì´ˆê¸°í™” & ì „ì—­ ì´ë²¤íŠ¸
             ***********************/


            async function loadScheduleModalFragment() {
                const mount = document.getElementById('scheduleModalMount');
                if (!mount) return;
                try {

                    const res = await fetch('/fragment/scheduleModal', { credentials: 'include' });
                    if (!res.ok) throw new Error(`Failed to load modal fragment (HTTP ${res.status})`);
                    const html = await res.text();
                    const temp = document.createElement('div');
                    temp.innerHTML = html;
                    const modalEl = temp.querySelector('#scheduleModal');
                    if (!modalEl) throw new Error('scheduleModal element not found');
                    // ì´ë¯¸ ìˆìœ¼ë©´ êµì²´ ë°©ì§€
                        if (!document.getElementById('scheduleModal')) {
                        document.body.appendChild(modalEl);   // âœ… bodyì— ì§ì ‘ ë¶€ì°©
                        }
                    // mountëŠ” ë¹„ì›Œë‘ (í•„ìš”ì‹œ: mount.innerHTML = '';)
                    // â¬‡ï¸ í”„ë˜ê·¸ë¨¼íŠ¸ ì£¼ì… ì™„ë£Œ ì‹ í˜¸
                    document.dispatchEvent(new CustomEvent('scheduleModal:fragment-ready'));
                } catch (e) {
                    console.error('Schedule modal load failed:', e);
                }
            }

            async function init() {
                try {
                    await loadScheduleModalFragment(); // âœ… ëª¨ë‹¬ ë¨¼ì € ì£¼ì…
                    await TokenManager.refresh().catch(()=>{});
                    toggleAuthLinks(!!TokenManager.get());
                    bindGlobalEvents();
                    populateSemesterSelectInline();
                    if (TokenManager.get()) {
                        await bootstrapApp();
                    }
                } catch (e) { console.error('Init error:', e); }
            }

            async function bootstrapApp() {
                await loaduserinfo();
                await hydrateSemestersFromServer();
                await renderRepresentativeFromServer();
                await loadCredits();
            }

            function toggleAuthLinks(isLoggedIn){
                const loginLink    = document.getElementById('loginLink');
                const logoutLink   = document.getElementById('logoutLink');
                const registerLink = document.querySelector('nav a[href="/Register"]');
                if (loginLink)     loginLink.style.display    = isLoggedIn ? 'none'  : 'inline';
                if (logoutLink)    logoutLink.style.display   = isLoggedIn ? 'inline': 'none';
                if (registerLink)  registerLink.style.display = isLoggedIn ? 'none'  : 'inline';
            }

            function bindGlobalEvents(){
                document.getElementById('logoutLink')?.addEventListener('click', onLogoutClick);
                document.getElementById('semesterSelectInline')?.addEventListener('change', onSemesterSelectInlineChange);
            }

            function onLogoutClick(e){
                e.preventDefault();
                TokenManager.set(null);
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
                window.location.href = '/';
            }

            /***********************
             * ì‚¬ìš©ì/ê³„ì • ê´€ë ¨
             ***********************/
            async function loaduserinfo(){
                return apiFetch('/userinfo', { method:'GET' })
                    .then(res=>{ if(!res.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); return res.json(); })
                    .then(data=>{
                        document.getElementById('userName').textContent = data.name || '';
                        document.getElementById('studentId').textContent = data.email || '';
                        UserId = data.userId ?? data.id ?? data.timetables?.[0]?.userId ?? null;
                    })
                    .catch(err=>{
                        console.error(err);
                        alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    });
            }

            function deleteAccount() {
                if (!confirm('ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) return;
                apiFetch('/member/delete', { method:'POST', headers:{'Content-Type':'application/json'} })
                    .then(res => { if(!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜'); return res.json(); })
                    .then(data => {
                        if (data.deleteStatus === 'success') {
                            alert('íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            localStorage.removeItem('jwtToken');
                            window.location.href = '/';
                        }
                    })
                    .catch(err => { alert('íšŒì› íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); console.error(err); });
            }

            function modifinguserinfo() {
                const modalOverlay = document.getElementById('modalOverlay');
                const closeBtn = document.getElementById('close-btn');
                const confirmBtn = document.getElementById('confirm');

                modalOverlay.classList.remove('hidden');
                document.body.classList.add('modal-open');

                closeBtn.onclick = () => {
                    modalOverlay.classList.add('hidden');
                    document.body.classList.remove('modal-open');
                };

                confirmBtn.onclick = () => {
                    const pw = document.getElementById('pw').value;
                    apiFetch('/check_pw_button', {
                        method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ pw })
                    })
                        .then(res => { if(!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜'); return res.json(); })
                        .then(data => {
                            if (data.Password === true) {
                                alert('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì™„ë£Œ!');
                                modalOverlay.classList.add('hidden');
                                document.getElementById('changePwModal').classList.remove('hidden');
                            } else {
                                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                            }
                        })
                        .catch(err => { alert('ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message); console.error(err); });
                };
            }

            document.getElementById('changePwBtn').onclick = function () {
                const newPw = document.getElementById('newPassword').value;
                const confirmPw = document.getElementById('confirmPassword').value;
                if (!newPw || !confirmPw || newPw !== confirmPw) { alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
                apiFetch('/PWupdate_button', {
                    method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ pw: newPw })
                })
                    .then(async (res) => {
                        if (!res.ok) { const errorText = await res.text(); alert(`ì„œë²„ ì˜¤ë¥˜ ${res.status}: ${errorText}`); throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + res.status); }
                        return res.json();
                    })
                    .then((data) => {
                        if (data.updateStatus === true) {
                            alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                            document.getElementById('changePwModal').classList.add('hidden');
                        } else {
                            alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                        }
                    })
                    .catch((err) => { alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message); });
            };
            document.getElementById('close-btn').onclick = function () {
                document.getElementById('modalOverlay').classList.add('hidden');
            };
            document.getElementById('cancelChange').onclick = function () {
                document.getElementById('changePwModal').classList.add('hidden');
            };

            function goToTechTree() {
                const select = document.getElementById('techTreeSelect');
                const year = select.value;
                if (!TokenManager.get()){ alert('ë¡œê·¸ì¸ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.'); return; }
                if (!year) { alert('í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”.'); return; }

                apiFetch(`/tech_tree?year=${year}`, { method:'GET' })
                    .then(res => { if (res.ok) return res.text(); else throw new Error('Unauthorized'); })
                    .then(html => { document.open(); document.write(html); document.close(); })
                    .catch(err => { console.error(err); window.location.href='/'; });
            }

            /***********************
             * í•™ê¸°/ì‹œê°„í‘œ ê´€ë¦¬
             ***********************/
            async function fetchLatestTimetableIdFromUserInfo(semesterCode,{tries=6,baseDelay=300}={}) {
                if (!semesterCode) throw new Error('semesterCodeê°€ í•„ìš”í•©ë‹ˆë‹¤.');
                const termNum = Number(semesterCode);
                const headers = { 'Cache-Control': 'no-cache' };
                for (let i=0;i<tries;i++){
                    const res = await apiFetch(`/userinfo?_=${Date.now()}`, { headers, cache:'no-store', credentials:'include' });
                    if (res.ok){
                        const u = await res.json();
                        if (Array.isArray(u?.timetables)) {
                            const matches = u.timetables.filter(t=>Number(t.term)===termNum);
                            if (matches.length){
                                const tid = matches.reduce((max,t)=>{
                                    const v = Number(t.timeTableId ?? t.timetableId ?? t.id);
                                    return Number.isFinite(v) ? Math.max(max,v) : max;
                                }, 0);
                                if (tid) return tid;
                            }
                        }
                    }
                    await sleep(baseDelay*(i+1));
                }
                return null;
            }

            async function createTimetableOnServer(semesterCode){
                const fd = new FormData();
                fd.append('semester', semesterCode);
                const res = await apiFetch('/addTimetable', { method:'POST', body: fd, credentials:'include' });
                const raw = await res.text();
                if (!res.ok) throw new Error(`addTimetable ì‹¤íŒ¨ (${res.status}): ${raw}`);
                try {
                    const j = JSON.parse(raw);
                    const directId = j.timeTableId ?? j.timetableId ?? j.id ?? j.data?.timeTableId ?? j.data?.id ?? null;
                    if (directId) return Number(directId);
                } catch {}
                const tid = await fetchLatestTimetableIdFromUserInfo(semesterCode, { tries:8, baseDelay:250 });
                if (!tid) throw new Error('userinfoì—ì„œ timetableIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return tid;
            }

            function populateSemesterSelectInline(){
                const select = document.getElementById('semesterSelectInline');
                if (!select) return;
                const prev = select.value;
                select.innerHTML = '';
                const placeholder = document.createElement('option'); placeholder.value = ''; placeholder.textContent = 'í•™ê¸°ë¥¼ ì„ íƒí•´ ì¶”ê°€'; select.appendChild(placeholder);
                semesterOptions.forEach(sem=>{
                    if (!selectedSemesters.includes(sem)){
                        const opt = document.createElement('option'); opt.value=sem; opt.textContent=sem; select.appendChild(opt);
                    }
                });
                if ([...select.options].some(o=>o.value===prev)) select.value=prev; else select.value='';
            }

            async function onSemesterSelectInlineChange(e){
                const semText = e.target.value;
                if (!semText) return;
                const semesterCode = toSemesterCode(semText);
                try {
                    const tid = await createTimetableOnServer(semesterCode);
                    timetableIdsBySemester[semesterCode] = tid;
                    if (!selectedSemesters.includes(semText)) selectedSemesters.push(semText);
                    renderSemesterList();
                    populateSemesterSelectInline();
                    window.timetableIdsBySemester = timetableIdsBySemester;
                    e.target.value = '';
                } catch(err){
                    console.error(err);
                    alert(`ì‹œê°„í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜: ${err.message}`);
                }
            }

            function renderSemesterList() {
                const list = document.getElementById('semesterList');
                if (!list) return;

                _moreOpen = false;
                list.innerHTML = '';

                const reps = [];
                const others = [];
                selectedSemesters.forEach(sem => {
                    const term = toSemesterCode(sem);
                    if (term === representativeTermCode) reps.push(sem);
                    else others.push(sem);
                });

                const makeRow = (sem, hidden) => {
                    const termCode = toSemesterCode(sem);
                    const tid = timetableIdsBySemester[termCode];

                    const li = document.createElement('li');
                    li.className = 'semester-item';
                    li.dataset.term = termCode;
                    if (hidden) li.classList.add('hidden-semester');

                    const nameSpan = document.createElement('span');
                    nameSpan.className = 'semester-name';
                    nameSpan.textContent = sem;

                    const actions = document.createElement('div');
                    actions.className = 'semester-actions';

                    const delBtn = document.createElement('button');
                    delBtn.className = 'del-btn';
                    delBtn.title = 'ì‚­ì œ';
                    delBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
           stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6l-2 14H7L5 6"></path>
        <path d="M10 11v6"></path>
        <path d="M14 11v6"></path>
      </svg>`;
                    delBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeSemester(termCode, tid);
                    });

                    const label = document.createElement('label');
                    label.className = 'rep-label';
                    label.style.display = 'inline-flex';
                    label.style.alignItems = 'center';
                    label.style.gap = '6px';
                    label.addEventListener('click', (e) => e.stopPropagation());

                    const cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.dataset.term = termCode;
                    cb.checked = (termCode === representativeTermCode);
                    cb.onchange = (e) => onToggleRepresentative(termCode, e.target.checked);

                    const labTxt = document.createElement('span');
                    labTxt.textContent = 'ëŒ€í‘œ';

                    label.appendChild(cb);
                    label.appendChild(labTxt);

                    actions.appendChild(delBtn);
                    actions.appendChild(label);

                    // âœ… í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸° (ëª¨ë‹¬ ì¤€ë¹„ ëŒ€ê¸° í¬í•¨)
                    li.addEventListener('click', async () => {
                        try {
                            await ensureModalReady();
                            window.openScheduleModal(sem);
                        } catch (e) {
                            console.error(e);
                            alert('ëª¨ë‹¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                        }
                    });

                    // âœ… appendëŠ” ë°˜ë“œì‹œ ë¦¬ìŠ¤ë„ˆ "ë°”ê¹¥"ì—ì„œ!
                    li.appendChild(nameSpan);
                    li.appendChild(actions);
                    list.appendChild(li);
                };

                reps.forEach(sem => makeRow(sem, false));
                others.forEach(sem => makeRow(sem, true));

                const oldBtn = document.getElementById('showMoreBtn');
                if (oldBtn) oldBtn.remove();

                if (others.length > 0) {
                    const btn = document.createElement('button');
                    btn.id = 'showMoreBtn';
                    btn.textContent = `ë”ë³´ê¸° (${others.length})`;
                    btn.onclick = () => {
                        _moreOpen = !_moreOpen;
                        list.querySelectorAll('.semester-item').forEach(li => {
                            const term = li.dataset.term;
                            const isRep = (term === representativeTermCode);
                            if (!isRep) li.classList.toggle('hidden-semester', !_moreOpen);
                        });
                        btn.textContent = _moreOpen ? 'ì ‘ê¸°' : `ë”ë³´ê¸° (${others.length})`;
                    };
                    list.insertAdjacentElement('afterend', btn);
                }
            }


            async function removeSemester(termCode, timetableId){
                if (!Number.isInteger(timetableId)){ alert('ìœ íš¨í•œ timetableIdê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return; }
                if (!confirm('ì´ í•™ê¸°ì˜ ì‹œê°„í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
                try{
                    const res = await apiFetch('/deleteTimetable', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(timetableId) });
                    const txt = await res.text();
                    if (!res.ok) throw new Error(`ì‚­ì œ ì‹¤íŒ¨: ${txt}`);
                    const semText = toSemesterName(termCode);
                    selectedSemesters = selectedSemesters.filter(s=>s!==semText);
                    delete timetableIdsBySemester[termCode];
                    renderSemesterList(); populateSemesterSelectInline();
                    alert('ì‹œê°„í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch(err){ alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message); console.error(err); }
            }

            async function onToggleRepresentative(termCode, checked) {
                const tid = timetableIdsBySemester?.[termCode] ?? (await fetchLatestTimetableIdFromUserInfo(termCode));
                if (!tid) { alert('timetableIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); renderSemesterList(); return; }

                try {
                    const fd = new FormData(); fd.append('timetableId', String(tid)); fd.append('active', String(!!checked));
                    const res = await apiFetch('/representative_Timetable', { method:'POST', body: fd });
                    if (!res.ok) { const msg = await res.text(); throw new Error(msg || 'ëŒ€í‘œ ì„¤ì • ì‹¤íŒ¨'); }
                    if (checked) { representativeTermCode = termCode; alert('ëŒ€í‘œ ì‹œê°„í‘œë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.'); }
                    else { representativeTermCode = null; alert('ëŒ€í‘œ ì‹œê°„í‘œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.'); }
                    await hydrateSemestersFromServer();
                    await renderRepresentativeFromServer();
                    renderSemesterList();
                } catch (err) {
                    alert('ëŒ€í‘œ ì„¤ì • ì¤‘ ì˜¤ë¥˜: ' + err.message);
                    const cb = document.querySelector(`.rep-label input[type="checkbox"][data-term="${termCode}"]`);
                    if (cb) cb.checked = !checked;
                }
            }

            async function hydrateSemestersFromServer(){
                try{
                    const res = await apiFetch('/tableId_List', { method:'GET', credentials:'include' });
                    if (!res.ok) throw new Error(`ì‹œê°„í‘œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (HTTP ${res.status})`);
                    const data = await res.json();
                    const list = pickTimetableArray(data);
                    if (!Array.isArray(list) || list.length===0) return;

                    selectedSemesters.length = 0;
                    Object.keys(timetableIdsBySemester).forEach(k => delete timetableIdsBySemester[k])

                    for (const row of list){
                        const term = String(row.term ?? row['term'] ?? '');
                        const tid  = Number(row.timeTableId ?? row['timetableId'] ?? row.id);
                        const tagVal = row.tag ?? row['tag'];
                        if (isTruthyTag(tagVal)) representativeTermCode = term;
                        if (!term || !tid) continue;
                        timetableIdsBySemester[term] = tid;
                        const semText = toSemesterName(term);
                        if (!selectedSemesters.includes(semText)) selectedSemesters.push(semText);
                    }
                    renderSemesterList();
                    populateSemesterSelectInline();
                } catch(err){ console.error('hydrateSemestersFromServer ì˜¤ë¥˜:', err); }
            }

            /***********************
             * ëŒ€í‘œ ì‹œê°„í‘œ ë Œë”
             ***********************/
            function buildRepGridSpan(periodCount=9){
                const body = document.getElementById('repGridBody'); if (!body) return;
                body.innerHTML = '';
                const grid = document.createElement('div');
                grid.className='schedule-grid'; grid.id='repGridSpanBody';
                const labels=['9~10ì‹œ','10~11ì‹œ','11~12ì‹œ','12~1ì‹œ','1~2ì‹œ','2~3ì‹œ','3~4ì‹œ','4~5ì‹œ','5~6ì‹œ'];
                for (let p=1;p<=periodCount;p++){
                    const t=document.createElement('div');
                    t.className='time-cell'; t.style.gridColumn='1'; t.style.gridRow=String(p);
                    t.innerHTML = `${p}êµì‹œ<br/><span>${labels[p-1]||''}</span>`;
                    grid.appendChild(t);
                    for (let day=0; day<5; day++){
                        const cell=document.createElement('div'); cell.className='cell-placeholder';
                        cell.dataset.day=String(day); cell.dataset.period=String(p);
                        cell.style.gridColumn=String(day+2); cell.style.gridRow=String(p);
                        grid.appendChild(cell);
                    }
                }
                body.appendChild(grid);
            }
            function ensureRepGridSpanMax(periodMax){
                const grid=document.getElementById('repGridSpanBody'); if(!grid) return;
                const curRows = grid.querySelectorAll('[data-period]').length
                    ? Math.max(...Array.from(grid.querySelectorAll('[data-period]')).map(e=>Number(e.dataset.period)||1))
                    : 0;
                if (periodMax <= curRows) return;
                for (let p=curRows+1; p<=periodMax; p++){
                    const t=document.createElement('div'); t.className='time-cell';
                    t.style.gridColumn='1'; t.style.gridRow=String(p);
                    t.innerHTML = `${p}êµì‹œ<br/><span>${periodLabel(p)}</span>`;
                    grid.appendChild(t);
                    for (let day=0; day<5; day++){
                        const cell=document.createElement('div'); cell.className='cell-placeholder';
                        cell.dataset.day=String(day); cell.dataset.period=String(p);
                        cell.style.gridColumn=String(day+2); cell.style.gridRow=String(p);
                        grid.appendChild(cell);
                    }
                }
            }
            function renderSlotHTML(subject, classroom, professor){
                const sub = subject ?? ""; const room = classroom ? `<div class="slot-room">${classroom}</div>` : "";
                return `<div class="slot"><div class="slot-title">${sub}</div>${room}</div>`;
            }

            function placeCourseBlockRep(item) {
                const grid = document.getElementById('repGridSpanBody');
                if (!grid) return;

                const info = normalizeRepCourseInfo(item);

                const subject = info.courseName;
                const professor = info.professorName || '';
                const classroom = info.classroom || '';
                const courseCode = info.identifyNumberOfCourse || subject;

                const dayIdx = (info.scheduleDay || 0) - 1;
                if (dayIdx < 0 || dayIdx > 4) return;

                const pStart = info.timeStart;
                const pEnd = info.timeEnd ?? info.timeStart;
                if (!Number.isFinite(pStart) || !Number.isFinite(pEnd)) return;

                const bg = ColorManager.get(courseCode);

                const block = document.createElement('div');
                block.className = 'course-block busy';
                block.style.gridColumn = String(dayIdx + 2);
                block.style.gridRow = `${pStart} / ${pEnd + 1}`;
                block.style.setProperty('--course-color', bg);
                block.dataset.courseId = courseCode;

                block.innerHTML = renderSlotHTML(subject, classroom, professor);

                // ğŸ”¥ ëª¨ë‹¬ JSì™€ ë™ì¼í•œ íŒ¨í„´ì˜ í˜¸ë²„ íˆ´íŒ
                block.addEventListener('mouseenter', () => {
                    showCourseTooltip(block, info);
                });
                block.addEventListener('mouseleave', () => {
                    hideCourseTooltip();
                });

                grid.appendChild(block);

                // ì•„ë˜ placeholderë“¤ border ì •ë¦¬ + ë°ì´í„° ì—°ê²°(í•„ìš”ì‹œ)
                for (let r = pStart; r <= pEnd; r++) {
                    const ph = grid.querySelector(
                        `.cell-placeholder[data-day="${dayIdx}"][data-period="${r}"]`
                    );
                    if (ph) {
                        ph.style.borderBottom = 'none';
                        // í•„ìš”í•˜ë©´ ì…€ì—ì„œë„ íˆ´íŒ ë„ìš°ë ¤ê³  ì´ ì¤„ ì¶”ê°€:
                        ph.dataset.courseId = courseCode;
                    }
                }
            }


            async function loadRepresentativeSchedule(getScheduleIds){
                try {
                    const res = await apiFetch('/getTS2TE', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ getScheduleIds }),
                    });
                    if (!res.ok) throw new Error('ëŒ€í‘œ ì‹œê°„í‘œ ì¡°íšŒ ì‹¤íŒ¨');

                    const data = await res.json();
                    // ğŸ‘‰ ëª¨ë‹¬ì˜ currentCourseListì²˜ëŸ¼ ëŒ€í‘œ ì‹œê°„í‘œ ì „ìš© ë¦¬ìŠ¤íŠ¸ ë³´ê´€
                    repCourseList = Array.isArray(data) ? data : [];
                    renderRepresentativeSchedule(repCourseList);
                } catch (err) {
                    console.error(err);
                    alert('ëŒ€í‘œ ì‹œê°„í‘œ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
                }
            }
            function renderRepresentativeSchedule(scheduleData) {
                const container = document.getElementById('representativeScheduleContainer');
                if (!container) return;

                if (!document.getElementById('repGridBody')) {
                    container.innerHTML = `
      <div class="schedule-card" id="repGridCard">
        <div class="schedule-header">
          <div class="time-col"></div>
          <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div>
        </div>
        <div class="schedule-body" id="repGridBody"></div>
      </div>`;
                }

                // ê¸°ë³¸ 9êµì‹œ ê·¸ë¦¬ë“œ ìƒì„±
                buildRepGridSpan(9);

                const repGrid = document.getElementById('repGridSpanBody');
                if (repGrid) {
                    repGrid.style.display = 'grid';
                    repGrid.style.gridAutoFlow = 'row dense';
                    repGrid.style.gridAutoRows = '62px';
                }

                // ìµœëŒ€ êµì‹œ ê³„ì‚° (0êµì‹œê°€ ë‚´ë ¤ì˜¬ ìˆ˜ë„ ìˆìŒ)
                let needMax = 9;
                (scheduleData || []).forEach(it => {
                    const end = Number(
                        it.time_end ??
                        it.timeEnd ??
                        it.periodEnd ??
                        it.time_start ??
                        it.timeStart ??
                        it.periodStart
                    );
                    if (Number.isFinite(end)) needMax = Math.max(needMax, end);
                });
                ensureRepGridSpanMax(needMax);

                // ì‹¤ì œ ë¸”ë¡ ë°°ì¹˜
                (scheduleData || []).forEach(placeCourseBlockRep);
            }


            async function renderRepresentativeFromServer(){
                try { await TokenManager.refresh(); } catch {}
                if (!UserId){ try { await loaduserinfo(); } catch {} }

                const res = await apiFetch('/tableId_List', { method:'GET', credentials:'include' });
                if (!res.ok) return;
                const data = await res.json();
                const list = pickTimetableArray(data);
                const rep = list.find(row => isTruthyTag(row.tag ?? row['tag']));
                if (!rep){
                    document.getElementById('representativeScheduleContainer').innerHTML = `<p style="color:#888;">ëŒ€í‘œ ì‹œê°„í‘œê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;
                    document.getElementById('representativeTitle').textContent = 'ğŸ“Œ ëŒ€í‘œ ì‹œê°„í‘œ';
                    return;
                }
                const termCode = String(rep.term ?? rep['term'] ?? '');
                const timetableId = Number(rep.timeTableId ?? rep['timeTableId'] ?? rep.timetableId ?? rep.id);
                representativeTermCode = termCode;
                document.getElementById('representativeTitle').textContent = `ğŸ“Œ ëŒ€í‘œ ì‹œê°„í‘œ - ${toSemesterName(termCode)}`;

                const byUid = await apiFetch('/getTC', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(UserId) });
                if (!byUid.ok){ const failTxt = await byUid.text(); console.error('getTC ì‹¤íŒ¨', byUid.status, failTxt); return; }
                let all;
                try { const txt = await byUid.text(); all = JSON.parse(txt); } catch(e){ console.error('[rep] /getTC JSON íŒŒì‹± ì‹¤íŒ¨:', e); return; }
                const rows = (all||[]).filter(r=>{ const tid = Number(r.timeTableId ?? r.timetableId ?? r.tid ?? r.id); return Number.isFinite(tid) && tid === timetableId; });
                const courseIds = Array.from(new Set(rows.map(r=> (r.courseId ?? r.course_id ?? null)).filter(v=>v!=null && String(v).trim()!=='')));
                await loadRepresentativeSchedule(courseIds);
            }

            /***********************
             * í•™ì  ë°•ìŠ¤
             ***********************/
            async function fetchCreditData(endpoint) {
                try {
                    const response = await apiFetch(endpoint, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(UserId) });
                    if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                    const data = await response.json();
                    if (Array.isArray(data)) return data.reduce((sum, v) => sum + Number(v || 0), 0);
                    return Number(data) || 0;
                } catch (error) {
                    console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                    return 0;
                }
            }
            async function loadCredits() {
                const bsm = await fetchCreditData("/getbsm");
                const design = await fetchCreditData("/getì„¤ê³„");
                const advanced = await fetchCreditData("/getì „ì‹¬");
                const select = await fetchCreditData("/getì „ì„ ");
                document.getElementById("bsmCredit").textContent = bsm;
                document.getElementById("designCredit").textContent = design;
                document.getElementById("majorAdvancedCredit").textContent = advanced;
                document.getElementById("majorElectiveCredit").textContent = select;
            }

            /***********************
             * ê³µìš© ë…¸ì¶œ (ëª¨ë‹¬ì—ì„œ ì‚¬ìš©)
             ***********************/
            window.TokenManager = TokenManager;
            window.apiFetch = apiFetch;
            window.ColorManager = ColorManager;
            window.timetableIdsBySemester = timetableIdsBySemester;
            window.renderSlotHTML = renderSlotHTML;
            window.periodLabel = periodLabel;
            window.toSemesterCode = toSemesterCode;
            window.renderRepresentativeFromServer = renderRepresentativeFromServer;
            window.hydrateSemestersFromServer = hydrateSemestersFromServer;
            // UserId ì ‘ê·¼ì„ ìœ„í•´ helper ì œê³µ
            window.getUserId = async function() {
                if (UserId) return UserId;
                await loaduserinfo();
                return UserId;
            };
            async function ensureModalReady(timeout = 1) {
                const start = Date.now();
                while (!(window.openScheduleModal && document.getElementById('scheduleModal'))) {
                    await sleep(50);
                    if (Date.now() - start > timeout) {
                        throw new Error('scheduleModal ìŠ¤í¬ë¦½íŠ¸ ë˜ëŠ” í”„ë˜ê·¸ë¨¼íŠ¸ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    }
                }
            }

            function getDivisionLabel(info) {
                // 1) bsm / ì„¤ê³„
                if (info.bsm != null) {
                    return Number(info.bsm) === 1 ? "ì„¤ê³„" : "bsm";
                }
                // 2) ì „ì„  / ì „ì‹¬
                if (info.ì „ì„ ì „ì‹¬ != null) {
                    return Number(info.ì „ì„ ì „ì‹¬) === 1 ? "ì „ê³µì„ íƒ" : "ì „ê³µì‹¬í™”";
                }
                return "-";
            }
            // ========== ê³µìš© íˆ´íŒ í•¨ìˆ˜ (ëª¨ë‹¬/ëŒ€í‘œ ì‹œê°„í‘œ ë‘˜ ë‹¤ ì‚¬ìš©) ==========
            function showCourseTooltip(anchor, courseInfo) {
                hideCourseTooltip();

                const division = getDivisionLabel(courseInfo);

                const tooltip = document.createElement('div');
                tooltip.className = 'course-tooltip';
                tooltip.style.position = 'absolute';
                tooltip.style.zIndex = 2000;
                tooltip.style.minWidth = '180px';
                tooltip.style.maxWidth = '260px';
                tooltip.style.background = '#ffffffcc';
                tooltip.style.border = '1px solid #2563eb';
                tooltip.style.borderRadius = '10px';
                tooltip.style.boxShadow = '0 4px 18px rgba(30,80,210,0.13)';
                tooltip.style.padding = '14px 18px 14px 14px';
                tooltip.style.fontSize = '0.98rem';
                tooltip.style.pointerEvents = 'none';

                tooltip.innerHTML = `
    <b>${courseInfo.courseName}(${
                    courseInfo.identifyNumberOfCourse
                        ? (courseInfo.identifyNumberOfCourse.split('-')[1] || '-')
                        : '-'
                })</b>
    <br>êµìˆ˜: ${courseInfo.professorName || '-'}
    <br>ì´ë©”ì¼:
    <br>ê°•ì˜ì‹¤: ${courseInfo.classroom || ''}
    <br>êµ¬ë¶„: ${division}
    <br>í•™ì : ${courseInfo.credit ?? '-'}
    <br>í•™ìˆ˜ë²ˆí˜¸: ${courseInfo.identifyNumberOfCourse || ''}
  `;


                document.body.appendChild(tooltip);
                const rect = anchor.getBoundingClientRect();
                tooltip.style.left = rect.right + 8 + 'px';
                tooltip.style.top  = rect.top + window.scrollY + 'px';
            }


            function hideCourseTooltip() {
                document.querySelectorAll('.course-tooltip').forEach(el => el.remove());
            }

            // í•„ìš”í•˜ë©´ ì „ì—­ ë…¸ì¶œ
            window.showCourseTooltip = showCourseTooltip;
            window.hideCourseTooltip = hideCourseTooltip;

            /***********************
             * ëŒ€í‘œ ì‹œê°„í‘œìš© ìƒíƒœ
             ***********************/
            let repCourseList = [];  // getTS2TEì—ì„œ ë°›ì•„ì˜¨ ê³¼ëª©/ìŠ¬ë¡¯ ë°ì´í„° ì „ì²´ë¥¼ ê·¸ëŒ€ë¡œ ë³´ê´€

            function normalizeRepCourseInfo(item) {
                const termDay = Number(item.day ?? item.scheduleDay ?? 0);
                const s = Number(item.timeStart);
                const e = Number(
                    item.timeEnd
                );

                return {
                    courseName: item.courseName || '',
                    identifyNumberOfCourse: item.identifyNumberOfCourse || '',
                    professorName: item.professorName || '',
                    classroom: item.classroom || '',
                    majorOrCulture: item.majorOrCulture ?? null,
                    bsm: item.bsm ?? null,
                    ì „ì„ ì „ì‹¬: item.ì „ì„ ì „ì‹¬ ?? item.majarS ?? null,   // â˜… ì´ ì¤„ ì¶”ê°€
                    credit: item.credit ?? '-',
                    scheduleDay: Number.isFinite(termDay) ? termDay : null,
                    timeStart: Number.isFinite(s) ? s : null,
                    timeEnd: Number.isFinite(e) ? e : null,
                };
            }
        </script>
        <script src="/jsCss/scheduleModal.js"></script>
        </body>
        </html>