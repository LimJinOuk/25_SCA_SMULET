<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì „ê³µ ì´ìˆ˜ ì²´ê³„ë„</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leader-line/1.0.7/leader-line.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: #f7f9fc;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background-color: white;
      padding: 20px;
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
    }
    h1 {
      font-size: 2.3rem;
      font-weight: bold;
      color: #2563eb;
      margin: 0;
    }
    h1 a {
      text-decoration: none;
      color: inherit;
    }
    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
    }
    nav a:hover {
      color: #3b82f6;
    }
    .grid-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 1200px;
      margin: 50px auto;
      position: relative;
    }
    .year-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #ddd;
      border-radius: 20px;
      padding: 10px;
      font-size: 1.1rem;  /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ì¡°ì •! */
    }
    .year{
      font-size: 1.3rem;
      font-weight: bold;
    }
    .semester-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 15px;
      background-color: #bbb;
      padding: 10px;
      border-radius: 10px;
      width: 100%;
      flex-wrap: wrap;
    }

    .course {
      background-color: white;
      border: 2px solid black;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      border-radius: 12px;
      min-width: 100px;
      transition: opacity 0.3s;

    }
    .flex-center-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 40px;
      margin: 20px auto;
      text-align: center;
    }
    .flex-center-header h1 {
      font-size: 2rem;
      font-weight: bold;
      margin: 0;
      color: #111;
    }
    .legend {
      display: flex;
      gap: 16px;
      align-items: center;
      font-size: 14px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-box {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid black;
    }
    .legend-bsm {
      background-color: #ffeb3b;
    }
    .legend-design {
      background-color: #1d7bc5;
    }
    .legend-thick {
      width: 16px;
      height: 16px;
      border: 4px solid black;
      background-color: white;
      border-radius: 4px;
    }
    .bsm { /* ë…¸ë‘ */
      border-color: #fff100 !important;
      border-width: 3px !important;
    }
    .design {
      border-color: #125a8e !important;
      border-width: 3px !important;
    }
    .advanced {
      border-width: 5px !important;
      border-style: double !important;
    }
    .course.design.advanced {
      border-color: #125a8e !important;
      border-style: double !important;
    }
    .dimmed {
      opacity: 0.2;
    }

    footer {
      background-color: rgba(30, 30, 30, 0.98);
      color: rgba(200, 200, 200, 0.7);
      font-size: 0.9rem;
      padding: 2rem 1rem;
      text-align: center;
      border-top: 1px solid #444;
      margin-top: auto;
    }
    footer a {
      text-decoration: none;
      color: rgba(200, 200, 200, 0.7);
      margin: 0 10px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .course.completed-course {
      background-color: #fda4af;   /* í†¤ë‹¤ìš´ëœ ì½”ë„ */
      border-color: #be123c;       /* ë¼ì¦ˆë² ë¦¬ ë ˆë“œ */
      color: #831843;
      box-shadow: 0 0 0 2px rgba(190, 18, 60, 0.35);
    }
  </style>
</head>
<body>
<header>
  <h1><a href="/">SMULET</a></h1>
  <nav>
    <a href="#"><b>ì´ìš©ì•ˆë‚´</b></a>
    <a href="/Register"><b>íšŒì›ê°€ì…</b></a>
  </nav>
</header>

<div class="flex-center-header">
  <h1>ì „ê³µ ì´ìˆ˜ ì²´ê³„ë„(22í•™ë²ˆ)</h1>
  <div class="legend">
    <div class="legend-item">
      <div class="legend-box legend-bsm"></div><span>BSM</span>
    </div>
    <div class="legend-item">
      <div class="legend-box legend-design"></div><span>ì„¤ê³„</span>
    </div>
    <div class="legend-item">
      <div class="legend-thick"></div><span>ì „ê³µ ì‹¬í™”</span>
    </div>
  </div>
</div>

<div class="grid-container" id="grid">
  <div class="year-container">
    <div class = 'year'>1í•™ë…„</div>
    <div class="semester-container">
      <div class = "semester-label">1í•™ê¸°</div>
      <div class="course bsm" data-subject="ì»´í“¨í„°ìˆ˜í•™">ì»´í“¨í„°ìˆ˜í•™</div>
      <div class="course" data-subject="íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°">íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°</div>
    </div>
    <div class="semester-container">
      <div class = "semester-label">2í•™ê¸°</div>
      <div class="course design" data-subject="ê³µí•™ì„¤ê³„ì…ë¬¸">ê³µí•™ì„¤ê³„ì…ë¬¸</div>
      <div class="course" data-subject="Cí”„ë¡œê·¸ë˜ë° I">Cí”„ë¡œê·¸ë˜ë° I</div>
      <div class="course bsm" data-subject="ì„ í˜•ëŒ€ìˆ˜í•™ I">ì„ í˜•ëŒ€ìˆ˜í•™ I</div>
    </div>
  </div>
  <div class="year-container">
    <div class = 'year'>2í•™ë…„</div>
    <div class="semester-container">
      <div class = "semester-label">1í•™ê¸°</div>
      <div class="course" data-subject="Cí”„ë¡œê·¸ë˜ë° II">Cí”„ë¡œê·¸ë˜ë° II</div>
      <div class="course" data-subject="ìë£Œêµ¬ì¡°">ìë£Œêµ¬ì¡°</div>
      <div class="course bsm" data-subject="ì´ì‚°ìˆ˜í•™">ì´ì‚°ìˆ˜í•™</div>
      <div class="course design" data-subject="ë…¼ë¦¬íšŒë¡œ">ë…¼ë¦¬íšŒë¡œ</div>
      <div class="course bsm" data-subject="ì„ í˜•ëŒ€ìˆ˜í•™ II">ì„ í˜•ëŒ€ìˆ˜í•™ II</div>
    </div>
    <div class="semester-container">
      <div class = "semester-label">2í•™ê¸°</div>
      <div class="course" data-subject="ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°">ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ë°ì´í„°ë² ì´ìŠ¤">ë°ì´í„°ë² ì´ìŠ¤</div>
      <div class="course" data-subject="ì•Œê³ ë¦¬ì¦˜">ì•Œê³ ë¦¬ì¦˜</div>
      <div class="course bsm" data-subject="í†µê³„ì ë¶„ì„">í†µê³„ì ë¶„ì„</div>
      <div class="course design" data-subject="ì‹œìŠ¤í…œ ì†Œí”„íŠ¸ì›¨ì–´">ì‹œìŠ¤í…œ ì†Œí”„íŠ¸ì›¨ì–´</div>
      <div class="course" data-subject="ì»´í“¨í„°êµ¬ì¡°">ì»´í“¨í„°êµ¬ì¡°</div>
      <div class="course" data-subject="ì •ë³´ë³´í˜¸">ì •ë³´ë³´í˜¸</div>
    </div>
  </div>
  <div class="year-container">
    <div class = 'year'>3í•™ë…„</div>
    <div class="semester-container">
      <div class = "semester-label">1í•™ê¸°</div>
      <div class="course design advanced" data-subject="ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™">ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™</div>
      <div class="course advanced" data-subject="ìš´ì˜ì²´ì œ">ìš´ì˜ì²´ì œ</div>
      <div class="course" data-subject="ë°ì´í„°ëª¨ë¸ë§ê³¼ë§ˆì´ë‹">ë°ì´í„°ëª¨ë¸ë§ê³¼ë§ˆì´ë‹</div>
      <div class="course advanced" data-subject="ì¸ê³µì§€ëŠ¥">ì¸ê³µì§€ëŠ¥</div>
      <div class="course advanced" data-subject="ì»´í“¨í„°ë„¤íŠ¸ì›Œí¬">ì»´í“¨í„°ë„¤íŠ¸ì›Œí¬</div>
      <div class="course" data-subject="ë””ì§€í„¸ ì‹ í˜¸ì²˜ë¦¬">ë””ì§€í„¸ ì‹ í˜¸ì²˜ë¦¬</div>
    </div>
    <div class="semester-container">
      <div class = "semester-label">2í•™ê¸°</div>
      <div class="course advanced" data-subject="ê³ ê¸‰ê°ì²´ì§€í–¥í”„ë¡œê·¸ë˜ë°">ê³ ê¸‰ê°ì²´ì§€í–¥í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤">ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤</div>
      <div class="course" data-subject="GPU í”„ë¡œê·¸ë˜ë°">GPU í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ë¶„ì‚°ì‹œìŠ¤í…œ">ë¶„ì‚°ì‹œìŠ¤í…œ</div>
      <div class="course advanced" data-subject="í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡ ">í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡ </div>
      <div class="course advanced" data-subject="ìœ ë‹‰ìŠ¤ í”„ë¡œê·¸ë˜ë°">ìœ ë‹‰ìŠ¤ í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ë°ì´í„° í†µì‹ ">ë°ì´í„° í†µì‹ </div>
      <div class="course advanced" data-subject="ì•”í˜¸í•™">ì•”í˜¸í•™</div>
    </div>
  </div>
  <div class="year-container">
    <div class = 'year'>4í•™ë…„</div>
    <div class="semester-container">
      <div class = "semester-label">1í•™ê¸°</div>
      <div class="course design" data-subject="ìº¡ìŠ¤í†¤ë””ìì¸1">ìº¡ìŠ¤í†¤ë””ìì¸ I</div>
      <div class="course design" data-subject="ë¹…ë°ì´í„°ì‘ìš©">ë¹…ë°ì´í„°ì‘ìš©</div>
      <div class="course" data-subject="í´ë¼ìš°ë“œ í”„ë¡œê·¸ë˜ë°">í´ë¼ìš°ë“œ í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ë„¤íŠ¸ì›Œí¬ë³´ì•ˆ">ë„¤íŠ¸ì›Œí¬ë³´ì•ˆ</div>
    </div>
    <div class="semester-container">
      <div class = "semester-label">2í•™ê¸°</div>
      <div class="course design" data-subject="ìº¡ìŠ¤í†¤ë””ìì¸2">ìº¡ìŠ¤í†¤ë””ìì¸ II</div>
      <div class="course" data-subject="í´ë¼ìš°ë“œ í”Œë«í¼">í´ë¼ìš°ë“œ í”Œë«í¼</div>
      <div class="course" data-subject="ì»´íŒŒì¼ëŸ¬">ì»´íŒŒì¼ëŸ¬</div>
      <div class="course" data-subject="ICT í•™ì ì´ìˆ˜ ì¸í„´ì œ">ICT í•™ì ì´ìˆ˜ ì¸í„´ì œ</div>
    </div>
  </div>

</div>

<footer>
  <b>
    <a href="https://github.com/LimJinOuk/25_SCA_SMULET">Github</a>
    <a href="/policy_page">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a><br><br>
    <a href="#">Copyright</a>
  </b>
</footer>

<script>
  /***********************
   * JWT í† í° / ê³µí†µ fetch
   ***********************/
  const TokenManager = (() => {
    let accessToken = null;
    let refreshingPromise = null;

    const set = (t) => { accessToken = t || null; };
    const get = () => accessToken;

    const refresh = async () => {
      if (refreshingPromise) return refreshingPromise;

      refreshingPromise = (async () => {
        const res = await fetch('/refreshT', {
          method: 'POST',
          credentials: 'include',   // ğŸ”¹ refresh í† í° ì¿ í‚¤ ì‚¬ìš©
        });

        if (!res.ok) {
          set(null);
          throw new Error('Refresh failed');
        }

        const auth = res.headers.get('Authorization');
        if (!auth || !auth.startsWith('Bearer ')) {
          set(null);
          throw new Error('No Authorization header');
        }

        const token = auth.slice('Bearer '.length);
        set(token);
        return token;
      })();

      try {
        return await refreshingPromise;
      } finally {
        refreshingPromise = null;
      }
    };

    return { get, set, refresh };
  })();

  async function apiFetch(input, init = {}) {
    const headers = new Headers(init.headers || {});
    const token = TokenManager.get();

    // ğŸ”¹ accessToken ìˆìœ¼ë©´ Authorization í—¤ë” ìë™ ì„¸íŒ…
    if (token) {
      headers.set('Authorization', `Bearer ${token}`);
    }

    let res = await fetch(input, {
      ...init,
      headers,
      credentials: 'include',   // ğŸ”¹ í•­ìƒ ì¿ í‚¤ë„ ê°™ì´ ë³´ëƒ„
    });

    // ğŸ”¹ 401ì´ë©´ í•œë²ˆë§Œ refresh ì¬ì‹œë„
    if (res.status === 401) {
      try {
        const newToken = await TokenManager.refresh();
        const retryHeaders = new Headers(init.headers || {});
        retryHeaders.set('Authorization', `Bearer ${newToken}`);

        res = await fetch(input, {
          ...init,
          headers: retryHeaders,
          credentials: 'include',
        });
      } catch (e) {
        TokenManager.set(null);
        throw e;
      }
    }

    return res;
  }

  function logout() {
    // í•„ìš”í•˜ë©´ ì„œë²„ ë¡œê·¸ì•„ì›ƒ ì—”ë“œí¬ì¸íŠ¸ë„ í˜¸ì¶œ ê°€ëŠ¥
    TokenManager.set(null);
  }

  let UserId = null;



  document.addEventListener('DOMContentLoaded', async () => {
    try {
      await TokenManager.refresh();

      if (!TokenManager.get()) {
        throw new Error('No access token');
      }

      await highlightCompletedCourses();

    } catch (e) {
      console.warn('Token check failed:', e);
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      logout();
      window.location.href = '/login_page';
    }
  });


  const groups = {
    pink: ['ê³µí•™ì„¤ê³„ì…ë¬¸', 'ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™', 'ìº¡ìŠ¤í†¤ë””ìì¸1', 'ìº¡ìŠ¤í†¤ë””ìì¸2'],
    green: ['íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°', 'Cí”„ë¡œê·¸ë˜ë° I', 'Cí”„ë¡œê·¸ë˜ë° II', 'ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°', 'ê³ ê¸‰ê°ì²´ì§€í–¥í”„ë¡œê·¸ë˜ë°'],
    black: ['íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°', 'Cí”„ë¡œê·¸ë˜ë° I', 'Cí”„ë¡œê·¸ë˜ë° II', 'ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°', 'ìº¡ìŠ¤í†¤ë””ìì¸1', 'ìº¡ìŠ¤í†¤ë””ìì¸2'],
    purple: ['ì„ í˜•ëŒ€ìˆ˜í•™ I', 'ì„ í˜•ëŒ€ìˆ˜í•™ II', 'ë””ì§€í„¸ ì‹ í˜¸ì²˜ë¦¬'],
    orange: ['íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°', 'Cí”„ë¡œê·¸ë˜ë° I', 'Cí”„ë¡œê·¸ë˜ë° II', 'ì‹œìŠ¤í…œ ì†Œí”„íŠ¸ì›¨ì–´', 'ìš´ì˜ì²´ì œ', 'ìœ ë‹‰ìŠ¤ í”„ë¡œê·¸ë˜ë°'],
    navy: ['íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°', 'Cí”„ë¡œê·¸ë˜ë° I', 'Cí”„ë¡œê·¸ë˜ë° II', 'ìë£Œêµ¬ì¡°', 'ë°ì´í„°ë² ì´ìŠ¤', 'ë°ì´í„°ëª¨ë¸ë§ê³¼ë§ˆì´ë‹', 'ë¹…ë°ì´í„°ì‘ìš©'],
    mint: ['ì´ì‚°ìˆ˜í•™', 'í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡ ', 'ì»´íŒŒì¼ëŸ¬'],
    gray: ['íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°', 'Cí”„ë¡œê·¸ë˜ë° I', 'Cí”„ë¡œê·¸ë˜ë° II', 'ì‹œìŠ¤í…œ ì†Œí”„íŠ¸ì›¨ì–´', 'ìš´ì˜ì²´ì œ', 'ìœ ë‹‰ìŠ¤ í”„ë¡œê·¸ë˜ë°'],
    cobalt: ['ì„ í˜•ëŒ€ìˆ˜í•™ I', 'ì„ í˜•ëŒ€ìˆ˜í•™ II', 'ì¸ê³µì§€ëŠ¥'],
    brown: ['ì •ë³´ë³´í˜¸', 'ì•”í˜¸í•™', 'ë„¤íŠ¸ì›Œí¬ë³´ì•ˆ'],
    red: ['í´ë¼ìš°ë“œ í”„ë¡œê·¸ë˜ë°', 'í´ë¼ìš°ë“œ í”Œë«í¼'],
    gold: ['ì»´í“¨í„°ë„¤íŠ¸ì›Œí¬', 'ë°ì´í„° í†µì‹ '],
    wine: ['í†µê³„ì  ë¶„ì„', 'ì¸ê³µì§€ëŠ¥'],
    coral: ['ìë£Œêµ¬ì¡°', 'ì•Œê³ ë¦¬ì¦˜'],
    beige: ['ì´ì‚°ìˆ˜í•™', 'ì•Œê³ ë¦¬ì¦˜'],
    orchid: ['ë…¼ë¦¬íšŒë¡œ', 'ì»´í“¨í„°êµ¬ì¡°'],
  };

  const allCourses = document.querySelectorAll('.course');
  let activeLines = [];

  function findGroups(subjectName) {
    return Object.values(groups).filter(group => group.includes(subjectName));
  }


  function drawLines(groupNames) {
    const lines = [];
    for (let i = 0; i < groupNames.length - 1; i++) {
      const from = document.querySelector(`[data-subject="${groupNames[i]}"]`);
      const to = document.querySelector(`[data-subject="${groupNames[i + 1]}"]`);
      if (from && to) {
        const fromYear = from.closest('.year-container');
        const toYear = to.closest('.year-container');
        const isSameYear = fromYear === toYear;

        let line;
        if (isSameYear) {
          // ê°™ì€ í•™ë…„ì´ë©´ì„œ ì¢Œìš°ë¡œ ë¶™ì–´ìˆëŠ” ê²½ìš° ì²´í¬
          const fromRect = from.getBoundingClientRect();
          const toRect = to.getBoundingClientRect();
          const isSideBySide = Math.abs(fromRect.top - toRect.top) < 30 && Math.abs(fromRect.right - toRect.left) < 150;
          if (isSideBySide) {
            // ì˜¤ë¥¸ìª½ ë°©í–¥ ì—°ê²°
            line = new LeaderLine(
                    LeaderLine.pointAnchor(from, { x: '98%', y: '50%' }),
                    LeaderLine.pointAnchor(to, { x: '2%', y: '50%' }),
                    {
                      color: 'black',
                      size: 2,
                      path: 'straight', // ê·¸ëŒ€ë¡œ ì§ì„ 
                      startPlug: 'behind',
                      endPlug: 'arrow1',
                      startSocket: 'right',
                      endSocket: 'left',
                    }
            );
          } else {
            // ì„¸ë¡œ ì—°ê²°ì€ ê¸°ì¡´ëŒ€ë¡œ
            line = new LeaderLine(
                    LeaderLine.pointAnchor(from, { x: '50%', y: '100%' }),
                    LeaderLine.pointAnchor(to, { x: '50%', y: '0%' }),
                    {
                      color: 'black',
                      size: 2,
                      path: 'straight',
                      startPlug: 'behind',
                      endPlug: 'arrow1',
                      startSocket: 'bottom',
                      endSocket: 'top',
                    }
            );
          }
        } else {
          // ë‹¤ë¥¸ í•™ë…„ì´ë©´ ì„¸ë¡œ grid ì—°ê²°
          line = new LeaderLine(
                  LeaderLine.pointAnchor(from, { x: '50%', y: '100%' }),
                  LeaderLine.pointAnchor(to, { x: '50%', y: '0%' }),
                  {
                    color: 'black',
                    size: 2,
                    path: 'grid',
                    startPlug: 'behind',
                    endPlug: 'arrow1',
                    startSocket: 'bottom',
                    endSocket: 'top',
                  }
          );
        }
        lines.push(line);
      }
    }
    return lines;
  }

  allCourses.forEach(course => {
    course.addEventListener('mouseenter', () => {
      const subject = course.dataset.subject;
      const matchedGroups = findGroups(subject);   // [group1, group2, ...]

      if (matchedGroups.length > 0) {
        const visibleNames = new Set(
                matchedGroups.flat()
        );

        allCourses.forEach(el => {
          if (visibleNames.has(el.dataset.subject)) {
            el.classList.remove('dimmed');
          } else {
            el.classList.add('dimmed');
          }
        });

        activeLines = matchedGroups.flatMap(group => drawLines(group));
      }
    });

    course.addEventListener('mouseleave', () => {
      allCourses.forEach(el => el.classList.remove('dimmed'));
      activeLines.forEach(line => line.remove());
      activeLines = [];
    });
  });


  async function fetchCompletedCourseNames() {
    // accessToken ì—†ìœ¼ë©´ ê·¸ëƒ¥ ë¹ˆ Set
    if (!TokenManager.get()) return new Set();

    // 1) /userinfoì—ì„œ UserId ê°€ì ¸ì˜¤ê¸° (í•œ ë²ˆë§Œ)
    if (!UserId) {
      try {
        const res = await apiFetch('/userinfo', { method: 'GET' });
        if (!res.ok) {
          throw new Error('ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
        }
        const data = await res.json();

        UserId =
                data.userId ??
                data.id ??
                (Array.isArray(data.timetables) && data.timetables.length > 0
                        ? data.timetables[0].userId
                        : null);

        if (!UserId) {
          console.warn('userId not found in /userinfo response');
          return new Set();
        }
      } catch (err) {
        console.error('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤:', err);
        return new Set();
      }
    }

    // 2) /getTCì—ì„œ ë‚´ê°€ ê°€ì§„ courseId ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
    const tcRes = await apiFetch('/getTC', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(UserId),   // ë§ˆì´í˜ì´ì§€ì™€ ë™ì¼í•˜ê²Œ UserIdë§Œ ì „ì†¡
    });

    if (!tcRes.ok) {
      console.error('getTC í˜¸ì¶œ ì‹¤íŒ¨:', tcRes.status);
      return new Set();
    }

    const tcData = await tcRes.json();
    console.log('[TechTree] tcData:', tcData);

    // 3) timetableIdë¡œ êµ³ì´ ë‚˜ëˆ„ì§€ ì•Šê³ , ë‚´ê°€ ìˆ˜ê°•í•œ ëª¨ë“  courseId ì‚¬ìš©
    const courseIdList = Array.from(new Set(
            (Array.isArray(tcData) ? tcData : [])
                    .map(r => r.courseId ?? null)
                    .filter(v => v != null && String(v).trim() !== '')
                    .map(v => Number(v))
    ));

    console.log('[TechTree] courseIdList ìµœì¢…:', courseIdList);

    if (courseIdList.length === 0) {
      return new Set();
    }

    // 4) /getTS2TEì—ì„œ courseName ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    const tsRes = await apiFetch('/getTS2TE', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ getScheduleIds: courseIdList }),
    });

    if (!tsRes.ok) {
      const failTxt = await tsRes.text();
      console.error('[TechTree] /getTS2TE ì‹¤íŒ¨', tsRes.status, failTxt);
      return new Set();
    }

    const tsData = await tsRes.json();
    console.log('[TechTree] getTS2TE data:', tsData);

    // 5) ê³¼ëª© ì´ë¦„ì„ Setìœ¼ë¡œ ì •ë¦¬
    const completedNameSet = new Set();
    (tsData || []).forEach(item => {
      if (item.courseName) {
        completedNameSet.add(item.courseName);
      }
    });

    return completedNameSet;
  }


  // âœ… DOMì˜ .course ë°•ìŠ¤ì— completed-course í´ë˜ìŠ¤ ë¶™ì´ëŠ” í•¨ìˆ˜
  async function highlightCompletedCourses() {
    try {
      const completedNames = await fetchCompletedCourseNames();

      allCourses.forEach(course => {
        const subject = course.dataset.subject;
        if (completedNames.has(subject)) {
          course.classList.add('completed-course');
        }
      });
    } catch (err) {
      console.error('ì´ìˆ˜ ê³¼ëª© í•˜ì´ë¼ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', err);
    }
  }

</script>
</body>
</html>
