<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My page</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* ê¸°ë³¸ ì„¤ì • */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: #f7f9fc;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* í—¤ë” */
    header {
      padding: 20px;
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
      background-color: rgb(255, 255, 255, 0.85);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
    }

    h1 {
      font-size: 2.3rem;
      font-weight: bold;
      color: #2563eb;
      margin: 0;
    }
    h1 a {
      text-decoration: none;
      color: inherit;
    }

    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: color 0.2s ease, font-size 0.2s ease;
    }

    nav a:hover {
      color: #3b82f6;
      font-size: 1.1rem;
    }

    main {
      flex: 1;
      padding-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      display: flex;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 20px 16px;
      max-width: 1200px;
      width: 100%;
      flex-wrap: wrap;
      margin: 0 auto;
    }
    /* ë°˜ì‘í˜• ì „í™˜ */
    @media (max-width: 900px) {
      .container {
        display: flex;
        flex-direction: column;
      }
    }

    /* ë°•ìŠ¤ ê³µí†µ */
    .box {
      flex: 1;
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      min-height: 150px;
      /*min-height: 430px;*/
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    .box:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
    }
    h2, h3 {
      margin: 0 0 10px;
      font-size: 1.1rem;
      color: #111827;
    }
    .section h3 {
      margin-top: 24px;     /* â€œë¹„ë°€ë²ˆí˜¸ ë³€ê²½â€ ì œëª© ìœ„ë¡œ 24px ë„ì›€ */
    }
    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .section {
      margin-bottom: 10px;
    }
    .section button{
      display: inline-block;    /* inline-block ì´ë©´ ë„ˆë¹„ ì§€ì •ë„ ê°€ëŠ¥ */
      width: 140px;             /* ì›í•˜ëŠ” ë„ˆë¹„ë¡œ ì¡°ì •í•˜ì„¸ìš” */
      margin-top: 8px;
      text-align: center;       /* ë²„íŠ¼ í…ìŠ¤íŠ¸ë„ ê°€ìš´ë° ì •ë ¬ */
    }
    .info p {
      margin: 3px 0;
      font-size: 0.9rem;
      color: #374151;
    }

    /* ë²„íŠ¼ */
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    button:hover {
      background-color: #1e40af;
      transform: scale(1.03);
    }
    button.red {
      background-color: #ef4444;
    }
    button.red:hover {
      background-color: #dc2626;
    }

    /* ì‹œê°„í‘œ ë²„íŠ¼ ê·¸ë£¹ */
    .button-group {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      justify-content: center;
    }

    /* ëŒ€í‘œ ì‹œê°„í‘œ ì»¨í…Œì´ë„ˆ  */
    .representative-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 20px; /* ìœ„ì™€ ê°„ê²© */
      order: 4; /* ì„¸ ë°•ìŠ¤ ì´í›„ì— ìœ„ì¹˜ */
    }

    .representative-box {
      width: 70%;
      max-width: 1000px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 30px;
      box-sizing: border-box;
      max-height: 775px; /* ì›í•˜ëŠ” ìµœëŒ€ ë†’ì´(px) ì§€ì • */
      overflow-y: auto;  /* ë‚´ë¶€ ìš”ì†Œê°€ ë„˜ì¹  ê²½ìš° ìŠ¤í¬ë¡¤ */
    }



    /* í‘¸í„° */
    footer {
      background-color: rgba(30, 30, 30, 0.98);
      color: rgba(200, 200, 200, 0.7);
      font-size: 0.9rem;
      padding: 2rem 1rem;
      text-align: center;
      border-top: 1px solid #444;
      margin-top: auto;
    }
    footer a {
      text-decoration: none;
      color: rgba(200, 200, 200, 0.7);
      margin: 0 10px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    select {
      appearance: none; /* ê¸°ë³¸ í™”ì‚´í‘œ ì œê±° */
      -webkit-appearance: none;
      -moz-appearance: none;

      background-color: white;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 1rem;
      color: #111827;
      font-family: 'Montserrat', sans-serif;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px 16px;
      padding-right: 40px; /* í™”ì‚´í‘œ ê³µê°„ í™•ë³´ */
    }

    select:hover {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-wrapper {
      display: contents;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 24px 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 6px 24px rgba(0,0,0,0.2);
      text-align: center;
      display: flex;
      flex-direction: row;
      gap: 16px;
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 8px;
    }
    .modal-buttons button {
      flex: 1;
      max-width: 120px;
      padding: 0.6rem 0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .modal-buttons #confirm,
    .modal-buttons #changePwBtn {
      background-color: #2563eb;
      color: #fff;
    }
    .modal-buttons #close-btn,
    .modal-buttons #cancelChange {
      background-color: #e0e0e0;
      color: #333;
    }
    .modal-buttons button:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }
    .modal-buttons button:active {
      transform: translateY(1px);
    }

    .modal input[type="password"] {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .hidden {
      display: none;
    }
    .button-group-vertical {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    body.modal-open{
      overflow: hidden;
    }
    #semesterList {
      list-style: none;
      padding-left: 0;
      margin: 12px 0 0 0; /* ìœ„ìª½ë§Œ 12px, ë‚˜ë¨¸ì§€ 0 */
    }
    #semesterList li {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* í•™ê¸° ë¦¬ìŠ¤íŠ¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
    #semesterList .semester-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      border: 1px solid #e5e7eb;       /* ì—°í•œ í…Œë‘ë¦¬ */
      border-radius: 10px;
      padding: 10px 14px;
      background: #fff;
      transition: background-color 0.15s ease, box-shadow 0.15s ease, border-color 0.15s ease;
      cursor: pointer;                   /* ì¹´ë“œ ì „ì²´ í´ë¦­ ê°€ëŠ¥ */
      width: 80%;
    }

    #semesterList .semester-item:hover {
      background: #f9fafb;
      border-color: #d1d5db;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
    }

    /* ì¹´ë“œ ì•ˆì—ì„œ: í•™ê¸°ëª…(ê²€ì •, ë°‘ì¤„X) */
    #semesterList .semester-name {
      color: #111827;
      text-decoration: none;
      font-weight: 600;
    }

    /* ì¹´ë“œ ìš°ì¸¡ ì•¡ì…˜ ì˜ì—­ */
    #semesterList .semester-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ì²´í¬ë°•ìŠ¤ ë¼ë²¨ ê·¸ë£¹ */
    #semesterList .rep-label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
    }

    /* ì‚­ì œ ë²„íŠ¼(íˆ¬ëª… ë°°ê²½) */
    #semesterList .del-btn {
      background: transparent;
      border: none;
      cursor: pointer;
      padding: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
    }


    #scheduleTable td {
      width: 80px;
      /* í•„ìš” ì‹œ ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì¡°ì ˆë„ ê°€ëŠ¥ */
      max-width: 100px;
      height: 50px; /* ì›í•˜ëŠ” ê°’(px, em ë“±)ìœ¼ë¡œ ì¡°ì • */
      min-width: 80px; /* ì¹¸ì˜ ê°€ë¡œí­ë„ ì¡°ì ˆ ê°€ëŠ¥ */
      vertical-align: middle; /* í…ìŠ¤íŠ¸ ìˆ˜ì§ ì¤‘ì•™ì •ë ¬ */
    }

    /* 4) ëª¨ë‹¬ ë³¸ë¬¸ */
    #add-icon-modal .modal {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #add-icon-modal .modal h2 {
      margin: 0;
      font-size: 1.2rem;
      color: #111827;
    }
    #add-icon-modal .modal label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    .course-tooltip {
      animation: fadeIn 0.12s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px);}
      to { opacity: 1; transform: translateY(0);}
    }
    .details-container {
      display: flex;       /* ê°€ë¡œ ë°°ì¹˜ */
      flex-direction: row;
      gap: 20px;           /* ë°•ìŠ¤ ì‚¬ì´ ê°„ê²© */
      margin-top: 16px;
    }

    .detail {
      flex: 1;             /* ë™ì¼í•œ í¬ê¸° */
      height: 80px;        /* ì„¸ë¡œëŠ” ë‚®ê²Œ, ê°€ë¡œëŠ” ê¸¸ê²Œ */
      background-color: #f4f4f4;
      border-radius: 10px;
      display: flex;
      flex-direction: column;  /* ì„¸ë¡œ ì •ë ¬ */
      justify-content: center; /* ì„¸ë¡œ ì¤‘ì•™ */
      align-items: center;     /* ê°€ë¡œ ì¤‘ì•™ */
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: transform 0.2s ease-in-out,
      box-shadow 0.2s ease-in-out
    }
    .detail:hover{
      transform: translateY(-4px);       /* ì‚´ì§ ìœ„ë¡œ */
      box-shadow: 0 8px 16px rgba(0,0,0,0.15); /* ê·¸ë¦¼ì ê°•ì¡° */
      cursor: pointer;                   /* ë§ˆìš°ìŠ¤ ì»¤ì„œ ë³€ê²½ */
      transition: all 0.5s ease;         /* ë¶€ë“œëŸ½ê²Œ ë³€í™” */
    }

    .detail .label {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .detail .value {
      font-size: 22px;
      font-weight: 700;
      color: #007bff;
    }
  </style>
</head>
<body onload="loaduserinfo()">
<header>
  <h1><a href="/">SMULET</a></h1>
  <nav>
    <a href="#"><b>ì´ìš©ì•ˆë‚´</b></a>
    <a href="/login_page" id="loginLink"><b>ë¡œê·¸ì¸</b></a>
    <a href="/Register" id="registerLink"><b>íšŒì›ê°€ì…</b></a>
    <a href="/" id="logoutLink" style="display: none;"><b>ë¡œê·¸ì•„ì›ƒ</b></a>
    <a href="/" id="" style="display: none;"><b>ë§ˆì´í˜ì´ì§€</b></a>
  </nav>
</header>
<main>
  <div class="container">
    <!-- BOX1 -->
    <div class="box box1">
      <div class="section">
        <h2>ë‚´ ì •ë³´</h2>
        <div class="nav">
          <div class="info">
            <p>ì´ë¦„: <span id="userName"></span></p>
            <p>ì´ë©”ì¼: <span id="studentId"></span></p>
            <p>í•™ê³¼: <span id="userMajor">ì»´í“¨í„°ê³¼í•™ê³¼</span></p>
          </div>
        </div>
        <div class="section">
          <h3>íšŒì› ì„¤ì •</h3>
          <div class="button-group">
            <button onclick="modifinguserinfo()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
            <button class="red" onclick="deleteAccount()">íšŒì›íƒˆí‡´</button>
          </div>
        </div>
      </div>
    </div>

    <div id="modalOverlay" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="pwTitle">
      <div class="modal-wrapper">
        <div class="modal">
          <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
          <input type="password" id="pw">
          <div class = "modal-buttons">
            <button id="confirm" type="button">í™•ì¸</button>
            <button id="close-btn" type="button">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
    </div>

    <div id="changePwModal" class="modal-overlay hidden">
      <div class="modal-wrapper">
        <div class="modal">
          <p>ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
          <input type="password" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
          <input type="password" id="confirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
          <div class="modal-buttons">
            <button id="changePwBtn" type="button">ë³€ê²½</button>
            <button id="cancelChange" type="button">ì·¨ì†Œ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- BOX2 -->
    <div class="box box2">
      <h2>í…Œí¬íŠ¸ë¦¬</h2>
      <p class="subtext">ëª¨ë“  í…Œí¬íŠ¸ë¦¬ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

      <select id="techTreeSelect" onchange="goToTechTree()" style="margin-top: 12px;">
        <option value="">í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
        <option value="21">21í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
        <option value="22">22í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
        <option value="23">23í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
        <option value="24">24í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
        <option value="25">25í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
      </select>

      <!-- ê°€ë¡œ ì •ë ¬ëœ ë°•ìŠ¤ë“¤ -->
      <div class="details-container">
        <div class="detail">
          <span class="label">bsm</span>
          <span class="value" id="bsmCredit">0</span>
        </div>
        <div class="detail">
          <span class="label">ì„¤ê³„</span>
          <span class="value" id="designCredit">0</span>
        </div>
        <div class="detail">
          <span class="label">ì „ê³µì„ íƒ</span>
          <span class="value" id="majorElectiveCredit">0</span>
        </div>
        <div class="detail">
          <span class="label">ì „ê³µì‹¬í™”</span>
          <span class="value" id="majorAdvancedCredit">0</span>
        </div>
      </div>

    </div>

    <div class="box box3">
      <h2>ì‹œê°„í‘œ</h2>
      <p class="subtext">ì‹œê°„í‘œë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

      <!-- ë“œë¡­ë‹¤ìš´ë§Œìœ¼ë¡œ ë°”ë¡œ í•™ê¸° ì¶”ê°€ -->
      <div style="margin-top: 12px;">
        <select id="semesterSelectInline" style="min-width: 220px;">
          <option value="">í•™ê¸°ë¥¼ ì„ íƒí•´ ì¶”ê°€</option>
          <!-- JSì—ì„œ ì˜µì…˜ ì±„ì›Œì§ -->
        </select>
      </div>


      <ul id="semesterList" style="margin-top: 12px;"></ul>
      <!-- ì‹œê°„í‘œ ëª¨ë‹¬ -->

    </div>
    <div id="scheduleModal" class="modal-overlay hidden">
      <div class="modal-wrapper">
        <div class="modal" style="display: flex; width: 90vw; max-width: 1000px; max-height: 800px; overflow: hidden; padding: 30px; gap: 20px;">

          <!-- ì™¼ìª½: ì‹œê°„í‘œ ì˜ì—­ -->
          <div style="flex: 2; overflow-y: auto;">
            <div style="text-align: right;">
              <button id="closeScheduleModal" style="background: #ef4444; color: white; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer;">ë‹«ê¸°</button>
              <button id="saveSchedule" style="background: #4466ef; color: white; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer;">ì €ì¥</button>
            </div>
            <h2 style="text-align:center; margin-bottom: 15px;" id="modalSemesterTitle"></h2>
            <div id="scheduleTableContainer">
              <!-- ë™ì  ì‹œê°„í‘œ -->
            </div>
          </div>

          <!-- ì˜¤ë¥¸ìª½: ìˆ˜ì—… ì •ë³´ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
          <!-- ì˜¤ë¥¸ìª½ ìˆ˜ì—… ì •ë³´ ë¦¬ìŠ¤íŠ¸ + ê²€ìƒ‰ì°½ ë¬¶ê¸° -->
          <div style="flex: 1; display: flex; flex-direction: column; border-left: 1px solid #ddd; padding-left: 10px;">

            <!-- ğŸ” ê²€ìƒ‰ì°½ -->
            <input
                    type="text"
                    id="searchInput"
                    placeholder="ê³¼ëª©ëª… ê²€ìƒ‰"
                    style="width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 6px;"
                    oninput="renderCourseList(currentCourseList)"
            />

            <!-- ğŸ“š ìˆ˜ì—… ë¦¬ìŠ¤íŠ¸ -->
            <div
                    id="classInfoList"
                    style="flex: 1; overflow-y: auto;"
            >
              <!-- JSë¡œ ìˆ˜ì—… ì •ë³´ê°€ ë“¤ì–´ì˜µë‹ˆë‹¤ -->
            </div>
          </div>


        </div>
      </div>
    </div>
    <div class="representative-container">
      <div class="box representative-box">
        <div style="display:flex; justify-content: space-between; align-items: center;">
          <h2 id="representativeTitle">ğŸ“Œ ëŒ€í‘œ ì‹œê°„í‘œ</h2>
        </div>
        <div id="representativeScheduleContainer">
          <p style="color: #888;">ëŒ€í‘œ ì‹œê°„í‘œê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </div>
</main>

<footer>
  <b>
    <a href="#">Github</a>
    <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
    <a href="#">ì´ìš©ì•½ê´€</a><br><br>
    <a href="#">Copyright</a>
  </b>
</footer>
<script>
  /***********************
   * ìƒìˆ˜ / ì „ì—­ ìƒíƒœ
   ***********************/
  const semesterOptions = [
    "2025ë…„ 2í•™ê¸°", "2025ë…„ 1í•™ê¸°",
    "2024ë…„ 2í•™ê¸°", "2024ë…„ 1í•™ê¸°",
    "2023ë…„ 2í•™ê¸°", "2023ë…„ 1í•™ê¸°",
    "2022ë…„ 2í•™ê¸°", "2022ë…„ 1í•™ê¸°",
    "2021ë…„ 2í•™ê¸°", "2021ë…„ 1í•™ê¸°"
  ];

  const randomColors = [
    "#F9E79F","#AEDFF7","#A7F3D0","#FFD6E0","#B4A7F7",
    "#FFD9B3","#B9F6CA","#FFE082","#FFAB91","#D1C4E9"
  ];
  let usedColors = [];

  let UserId = null;
  let representativeTermCode = null; // "20252" ê°™ì€ í˜•ì‹ìœ¼ë¡œ ëŒ€í‘œ í•™ê¸° ë³´ê´€


  let selectedSemesters = [];
  let currentCourseList = []; // ëª¨ë‹¬ì— ë„ìš´ í˜„ì¬ í•™ê¸° ì „ì²´ ìˆ˜ì—…ì •ë³´

  // ìƒˆ êµ¬ì¡° í•µì‹¬
  let timetableIdsBySemester = {}; // { "20252": 123, ... }
  let currentSemesterCode = null;  // í˜„ì¬ ëª¨ë‹¬ì—ì„œ í¸ì§‘ ì¤‘ì¸ í•™ê¸° ì½”ë“œ
  let currentTimetableId = null;   // í˜„ì¬ ëª¨ë‹¬ì˜ timetableId

  /***********************
   * ê³µí†µ ìœ í‹¸
   ***********************/

  function getRandomColorNoDuplicate() {
    const available = randomColors.filter(c => !usedColors.includes(c));
    if (available.length === 0) {
      usedColors = [];
      return getRandomColorNoDuplicate();
    }
    const color = available[Math.floor(Math.random() * available.length)];
    usedColors.push(color);
    return color;
  }


  function toSemesterCode(semText){
    // "2025ë…„ 2í•™ê¸°" â†’ "20252"
    const m = String(semText).match(/(\d{4})\D*(1|2)\D*í•™ê¸°?/);
    return m ? `${m[1]}${m[2]}` : semText.replace(/\D/g,''); // ë°±ì—…: ìˆ«ìë§Œ
  }


  // ì‘ì€ ëŒ€ê¸° ìœ í‹¸
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // /userinfoì—ì„œ timetables ë°°ì—´ì„ ë³´ê³ , term===semesterCode ì¸ í•­ëª© ì¤‘ ê°€ì¥ ìµœì‹  timetableId ë°˜í™˜
  async function fetchLatestTimetableIdFromUserInfo(semesterCode, { tries = 6, baseDelay = 300 } = {}) {
    if (!semesterCode) throw new Error('semesterCodeê°€ í•„ìš”í•©ë‹ˆë‹¤.');
    const termNum = Number(semesterCode);

    const token = localStorage.getItem('jwtToken');
    const headers = { 'Authorization': `Bearer ${token}`, 'Cache-Control': 'no-cache' };

    for (let i = 0; i < tries; i++) {
      const res = await fetch(`/userinfo?_=${Date.now()}`, {
        headers,
        cache: 'no-store',
        credentials: 'include'
      });

      if (res.ok) {
        const u = await res.json();
        // console.warn('[userinfo]', u); // í•„ìš”í•˜ë©´ êµ¬ì¡° í™•ì¸ìš©

        if (Array.isArray(u?.timetables)) {
          // termì´ ì¼ì¹˜í•˜ëŠ” ê²ƒë“¤ë§Œ í•„í„°
          const matches = u.timetables.filter(t => Number(t.term) === termNum);
          if (matches.length) {
            // ê°€ì¥ í° timetableIdë¥¼ ìµœì‹ ìœ¼ë¡œ ê°„ì£¼
            const tid = matches.reduce((max, t) => {
              const v = Number(t.timeTableId ?? t.timetableId ?? t.id);
              return Number.isFinite(v) ? Math.max(max, v) : max;
            }, 0);
            if (tid) return tid;
          }
        }
      }

      // DB ë°˜ì˜ ì§€ì—° ëŒ€ë¹„ ë°±ì˜¤í”„
      await sleep(baseDelay * (i + 1));
    }

    return null;
  }

  //
  // ë¹ˆ ì‹œê°„í‘œ ìƒì„± â†’ /userinfoë¡œ timetableId íšë“
  async function createTimetableOnServer(semesterCode) {
    let token = localStorage.getItem('jwtToken');
    if (!token) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      window.location.href = '/login_page';
      throw new Error('JWT ì—†ìŒ');
    }

    // ì„œë²„ê°€ FormDataë¥¼ ë°›ëŠ”ë‹¤ê³  ê°€ì • (JSONì´ë©´ ì•„ë˜ë¥¼ JSONìœ¼ë¡œ ë°”ê¿”ë„ ë¨)
    const fd = new FormData();
    fd.append('semester', semesterCode);

    const res = await fetch('/addTimetable', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }, // FormDataì¼ ë• Content-Type ì§€ì • X
      body: fd,
      credentials: 'include'
    });

    const raw = await res.text();
    if (!res.ok) throw new Error(`addTimetable ì‹¤íŒ¨ (${res.status}): ${raw}`);

    // ì‘ë‹µì— ì´ë¯¸ idê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©
    try {
      const j = JSON.parse(raw);
      const directId = j.timeTableId ?? j.timetableId ?? j.id ?? j.data?.timeTableId ?? j.data?.id ?? null;
      if (directId) return Number(directId);
    } catch(_) { /* ignore */ }

    // ì—†ìœ¼ë©´ /userinfoì—ì„œ term ê¸°ì¤€ìœ¼ë¡œ ì°¾ì•„ì˜¤ê¸° (í´ë§)
    const tid = await fetchLatestTimetableIdFromUserInfo(semesterCode, { tries: 8, baseDelay: 250 });
    if (!tid) throw new Error('userinfoì—ì„œ timetableIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
    return tid;
  }


  /***********************
   * ì´ˆê¸° ë°”ì¸ë”©
   ***********************/
  document.addEventListener('DOMContentLoaded', async function () {
    const loginLink = document.getElementById('loginLink');
    const logoutLink = document.getElementById('logoutLink');
    const registerLink = document.querySelector('nav a[href="/Register"]');
    const token = localStorage.getItem('jwtToken');

    if (token) {
      loginLink.style.display = 'none';
      logoutLink.style.display = 'inline';
      registerLink.style.display = 'none';
    } else {
      loginLink.style.display = 'inline';
      logoutLink.style.display = 'none';
      registerLink.style.display = 'inline';
    }

    logoutLink.addEventListener('click', function (e) {
      e.preventDefault();
      localStorage.removeItem('jwtToken');
      alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
      window.location.href = '/';
    });
    /*
        const showSemesterBtn = document.getElementById('showSemesterBtn');
        if (showSemesterBtn) {
          showSemesterBtn.addEventListener('click', showAddSemester);
        }
        */
    /*
        // âœ… ì¶”ê°€: ëŒ€í‘œ ì‹œê°„í‘œ ê°±ì‹  & í•™ê¸° ë¦¬ìŠ¤íŠ¸ ë³µì›
        if (token) {
          loadRepresentativeScheduleOnInit().catch(console.error);
          await hydrateSemestersFromServer();
        }
     */
    // ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° & ì²´ì¸ì§€ ë°”ì¸ë”©
    populateSemesterSelectInline();
    document.getElementById('semesterSelectInline')?.addEventListener('change', onSemesterSelectInlineChange);


    if (token) {
      // 1) userInfo ë¨¼ì € í™•ë³´(â†’ UserId ì„¸íŒ… ë³´ì¥)
      await loaduserinfo().catch(console.error);
      // 2) í•™ê¸° ë¦¬ìŠ¤íŠ¸ ë³µì›
      await hydrateSemestersFromServer();

      // DOMContentLoaded ë‚´ë¶€ì—ì„œ, token ì²˜ë¦¬ ë’¤ì— ì¶”ê°€:
      await renderRepresentativeFromServer();
    }
  });

  /** ë“œë¡­ë‹¤ìš´ ì˜µì…˜ì„ ê°±ì‹ í•œë‹¤. (ì´ë¯¸ ì¶”ê°€ëœ í•™ê¸°ëŠ” ì œì™¸) */
  function populateSemesterSelectInline() {
    const select = document.getElementById('semesterSelectInline');
    if (!select) return;

    // í˜„ì¬ ê°’ ë³´ì¡´
    const prev = select.value;

    // ì˜µì…˜ ì´ˆê¸°í™”
    select.innerHTML = '';
    const placeholder = document.createElement('option');
    placeholder.value = '';
    placeholder.textContent = 'í•™ê¸°ë¥¼ ì„ íƒí•´ ì¶”ê°€';
    select.appendChild(placeholder);

    // ì•„ì§ ì¶”ê°€í•˜ì§€ ì•Šì€ í•™ê¸°ë§Œ ì±„ìš°ê¸°
    semesterOptions.forEach(sem => {
      if (!selectedSemesters.includes(sem)) {
        const opt = document.createElement('option');
        opt.value = sem;
        opt.textContent = sem;
        select.appendChild(opt);
      }
    });

    // ë³´ì¡´í•˜ë ¤ë˜ ê°’ì´ ìœ íš¨í•˜ë©´ ìœ ì§€, ì•„ë‹ˆë©´ placeholderë¡œ
    if ([...select.options].some(o => o.value === prev)) {
      select.value = prev;
    } else {
      select.value = '';
    }
  }

  /** ë“œë¡­ë‹¤ìš´ì—ì„œ í•™ê¸°ë¥¼ ì„ íƒí•˜ë©´ ì¦‰ì‹œ ì„œë²„ì— ì‹œê°„í‘œë¥¼ ë§Œë“¤ê³  ë¦¬ìŠ¤íŠ¸ì— ë°˜ì˜ */
  async function onSemesterSelectInlineChange(e) {
    const semText = e.target.value;
    if (!semText) return; // placeholder ì„ íƒ

    const semesterCode = toSemesterCode(semText);
    try {
      // 1) ì„œë²„ì— ë¹ˆ ì‹œê°„í‘œ ìƒì„±
      const tid = await createTimetableOnServer(semesterCode);

      // 2) ë¡œì»¬ ìƒíƒœ ë°˜ì˜
      timetableIdsBySemester[semesterCode] = tid;
      if (!selectedSemesters.includes(semText)) {
        selectedSemesters.push(semText);
      }

      // 3) UI ê°±ì‹ 
      renderSemesterList();
      populateSemesterSelectInline();   // ë°©ê¸ˆ ì¶”ê°€í•œ í•™ê¸°ëŠ” ë“œë¡­ë‹¤ìš´ì—ì„œ ì œê±°
      e.target.value = '';              // ë‹¤ì‹œ placeholderë¡œ

    } catch (err) {
      console.error(err);
      alert(`ì‹œê°„í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜: ${err.message}`);
    }
  }

  /***********************
   * ì‚¬ìš©ì/ê³„ì • ê´€ë ¨
   ***********************/
  function loaduserinfo() {
    const token = localStorage.getItem('jwtToken');
    return fetch('/userinfo', {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${token}` }
    })
            .then(res => {
              if (!res.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
              return res.json();
            })
            .then(data => {
              document.getElementById('userName').textContent = data.name;
              document.getElementById('studentId').textContent = data.email;
              /*
                            // userId ì œëŒ€ë¡œ ì €ì¥í•˜ê¸°
                            if (data.timetables && data.timetables.length > 0) {
                              UserId = data.timetables[0].userId;
                            } else {
                              console.warn("userinfoì— timetables ë°ì´í„°ê°€ ì—†ìŒ:", data);
                            }

               */
              // ë‹¤ì–‘í•œ ì‘ë‹µ í˜•íƒœ ë°©ì–´ì ìœ¼ë¡œ ì²˜ë¦¬
              UserId = data.userId ?? data.id ?? (data.timetables?.[0]?.userId ?? null);
              if (!UserId) console.warn("userIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.", data);
            })

            .catch(err => {
              console.error(err);
              alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
  }

  function deleteAccount() {
    const token = localStorage.getItem('jwtToken');
    if (!confirm("ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

    fetch('/member/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      }
    })
            .then(res => {
              if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
              return res.json();
            })
            .then(data => {
              if (data.deleteStatus === 'success') {
                alert('íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                localStorage.removeItem('jwtToken');
                window.location.href = '/';
              }
            })
            .catch(err => {
              alert('íšŒì› íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              console.error(err);
            });
  }

  function modifinguserinfo() {
    const modalOverlay = document.getElementById('modalOverlay');
    const closeBtn = document.getElementById('close-btn');
    const confirmBtn = document.getElementById('confirm');
    const token = localStorage.getItem('jwtToken');

    modalOverlay.classList.remove('hidden');
    document.body.classList.add("modal-open");

    closeBtn.onclick = () => {
      modalOverlay.classList.add("hidden");
      document.body.classList.remove("modal-open");
    };

    confirmBtn.onclick = () => {
      const pw = document.getElementById('pw').value;

      fetch('/check_pw_button', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ pw })
      })
              .then(res => {
                if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                return res.json();
              })
              .then(data => {
                if (data.Password === true) {
                  alert('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì™„ë£Œ!');
                  modalOverlay.classList.add("hidden");
                  document.getElementById("changePwModal").classList.remove("hidden");
                } else {
                  alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
              })
              .catch(err => {
                alert('ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                console.error(err);
              });
    };
  }

  document.getElementById("changePwBtn").onclick = function () {
    const newPw = document.getElementById("newPassword").value;
    const confirmPw = document.getElementById("confirmPassword").value;
    const token = localStorage.getItem("jwtToken");

    if (!newPw || !confirmPw || newPw !== confirmPw) {
      alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    fetch('/PWupdate_button', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ pw: newPw })
    })
            .then(async res => {
              if (!res.ok) {
                const errorText = await res.text();
                alert(`ì„œë²„ ì˜¤ë¥˜ ${res.status}: ${errorText}`);
                throw new Error("ì„œë²„ ì˜¤ë¥˜: " + res.status);
              }
              return res.json();
            })
            .then(data => {
              if (data.updateStatus === true) {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById("changePwModal").classList.add("hidden");
              } else {
                alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            })
            .catch(err => {
              alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
            });
  };
  document.getElementById("openPwModalBtn")?.addEventListener('click', () => {
    document.getElementById("changePwModal").classList.remove("hidden");
    document.getElementById("newPassword").value = "";
    document.getElementById("confirmPassword").value = "";
  });
  document.getElementById("close-btn").onclick = function () {
    document.getElementById("modalOverlay").classList.add("hidden");
  };
  document.getElementById("cancelChange").onclick = function () {
    document.getElementById("changePwModal").classList.add("hidden");
  };

  function goToTechTree() {
    const select = document.getElementById('techTreeSelect');
    const year = select.value;
    const token = localStorage.getItem('jwtToken');

    if (!token) { alert("ë¡œê·¸ì¸ í† í°ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
    if (!year)  { alert("í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”."); return; }

    fetch(`/tech_tree?year=${year}`, {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${token}` }
    })
            .then(res => {
              if (res.ok) return res.text();
              else throw new Error("Unauthorized");
            })
            .then(html => {
              document.open(); document.write(html); document.close();
            })
            .catch(err => {
              console.error(err);
              window.location.href = '/';
            });
  }

  /***********************
   * í•™ê¸° ì¶”ê°€/ë¦¬ìŠ¤íŠ¸/ëª¨ë‹¬
   ***********************/
  function showAddSemester() {
    const addList = document.getElementById('addSemesterList');
    const select = document.getElementById('semesterSelect');

    select.innerHTML = '';
    semesterOptions.forEach(sem => {
      if (!selectedSemesters.includes(sem)) {
        const option = document.createElement('option');
        option.value = sem;
        option.textContent = sem;
        select.appendChild(option);
      }
    });

    addList.classList.toggle('hidden');
  }

  async function addSemester() {
    const select = document.getElementById('semesterSelect');
    const selected = select.value;
    if (!selected) return;

    const semesterCode = toSemesterCode(selected);

    try {
      // 1) ì„œë²„ì— ë¹ˆ ì‹œê°„í‘œ ìƒì„±
      const tid = await createTimetableOnServer(semesterCode);

      // 2) ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
      timetableIdsBySemester[semesterCode] = tid;
      if (!selectedSemesters.includes(selected)) selectedSemesters.push(selected);

      renderSemesterList();
      document.getElementById('addSemesterList').classList.add('hidden');
    } catch (err) {
      console.error(err);
      alert(`ì‹œê°„í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜: ${err.message}`);
    }
  }

  function renderSemesterList() {
    const list = document.getElementById('semesterList');
    list.innerHTML = '';

    selectedSemesters.forEach((sem) => {
      const termCode = toSemesterCode(sem);
      const tid = timetableIdsBySemester[termCode];

      // li ìì²´ë¥¼ ì¹´ë“œë¡œ ë§Œë“¤ê¸°
      const li = document.createElement('li');
      li.className = 'semester-item';
      // ì¹´ë“œ ì „ì²´ í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ
      li.addEventListener('click', () => openScheduleModal(sem));

      // ì™¼ìª½: í•™ê¸°ëª… (ê²€ì •/ë°‘ì¤„ì—†ìŒ)
      const nameSpan = document.createElement('span');
      nameSpan.className = 'semester-name';
      nameSpan.textContent = sem;

      // ì˜¤ë¥¸ìª½: ì•¡ì…˜ë“¤(ì‚­ì œ + ëŒ€í‘œ ì²´í¬)
      const actions = document.createElement('div');
      actions.className = 'semester-actions';

      // ì‚­ì œ ë²„íŠ¼ (SVG ì•„ì´ì½˜)
      const delBtn = document.createElement('button');
      delBtn.className = 'del-btn';
      delBtn.title = 'ì‚­ì œ';
      delBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg"
           width="18" height="18" viewBox="0 0 24 24" fill="none"
           stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6l-2 14H7L5 6"></path>
        <path d="M10 11v6"></path>
        <path d="M14 11v6"></path>
      </svg>
    `;
      // ì¹´ë“œ ì „ì²´ í´ë¦­ê³¼ êµ¬ë¶„(ë²„íŠ¼ í´ë¦­ ì‹œ ë²„ë¸” ì¤‘ë‹¨)
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeSemester(termCode, tid);
      });

      // ëŒ€í‘œ ì²´í¬ë°•ìŠ¤
      const label = document.createElement('label');
      label.className = 'rep-label';
      // ì¹´ë“œ ì „ì²´ í´ë¦­ê³¼ êµ¬ë¶„
      label.addEventListener('click', (e) => e.stopPropagation());

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = (termCode === representativeTermCode); // ëŒ€í‘œë©´ ì²´í¬
      // ì²´í¬ë°•ìŠ¤ í¬ê¸° í‚¤ìš°ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ë‘ ì¤„ ì‚¬ìš© (ì›í•˜ë©´ ê°’ ì¡°ì ˆ)
      cb.style.transform = 'scale(1.3)';
      cb.style.margin = '2px';

      cb.onchange = (e) => onToggleRepresentative(termCode, e.target.checked);

      const labTxt = document.createElement('span');
      labTxt.textContent = 'ëŒ€í‘œ';

      label.appendChild(cb);
      label.appendChild(labTxt);

      actions.appendChild(delBtn);
      actions.appendChild(label);

      li.appendChild(nameSpan);
      li.appendChild(actions);
      list.appendChild(li);
    });
  }




  function openScheduleModal(semester) {
    const modal = document.getElementById('scheduleModal');
    const title = document.getElementById('modalSemesterTitle');
    const container = document.getElementById('scheduleTableContainer');
    const listContainer = document.getElementById('classInfoList');

    // í˜„ì¬ í•™ê¸°ì½”ë“œ/ID í™•ë³´
    currentSemesterCode = toSemesterCode(semester);
    currentTimetableId = timetableIdsBySemester[currentSemesterCode] ?? null;

    if (!currentTimetableId) {
      alert('ì´ í•™ê¸°ì˜ ì‹œê°„í‘œ IDê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € "ì‹œê°„í‘œ ì¶”ê°€"ì—ì„œ í•™ê¸°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
      return;
    }

    document.getElementById("closeScheduleModal").onclick = function (){
      document.getElementById("scheduleModal").classList.add("hidden");
      document.body.classList.remove("modal-open");
      hideCourseTooltip();
    };

    title.textContent = semester;
    container.innerHTML = generateEmptyScheduleTable();
    listContainer.innerHTML = "<p>ìˆ˜ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>";
    modal.classList.remove('hidden');
    document.body.classList.add('modal-open');

    const token = localStorage.getItem('jwtToken');

    console.log("ğŸ‘‰ timetableId:", currentTimetableId);
    console.log("ğŸ‘‰ userId:", UserId);


    // ğŸŸ¢ 1) í˜„ì¬ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch("/getTC", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(UserId)
    })
            .then(res => {
              if (!res.ok) throw new Error("ì‹œê°„í‘œ ì¡°íšŒ ì‹¤íŒ¨");
              return res.json();
            })
            .then(allRows => {
              // âœ… í˜„ì¬ ëª¨ë‹¬ì˜ timetableIdì— í•´ë‹¹í•˜ëŠ” í–‰ë§Œ ì¶”ë ¤ì„œ ë Œë”
              const filtered = (allRows || []).filter(r => {
                const tid = getTid(r);
                return Number.isFinite(tid) && tid === Number(currentTimetableId);
              });
              if (filtered.length > 0) renderScheduleWithData(filtered);
            })
            .catch(err => console.error("getTC ì˜¤ë¥˜:", err));

    // ğŸŸ¢ 2) ìˆ˜ì—… ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
    fetch("/a", { headers: { 'Authorization': `Bearer ${token}` }})
            .then(res => res.json())
            .then(data => {
              currentCourseList = data;
              renderCourseList(data);
              attachCellEvents();
            })
            .catch(err => {
              listContainer.innerHTML = `<p style="color:red;">ìˆ˜ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
              console.error(err);
            });

    // ì €ì¥ í•¸ë“¤ëŸ¬(ì¤‘ë³µ ë°©ì§€)
    const saveBtn = document.getElementById("saveSchedule");
    saveBtn.replaceWith(saveBtn.cloneNode(true));
    document.getElementById("saveSchedule").addEventListener("click", onClickSaveSchedule);
  }

  function renderScheduleWithData(items) {
    const table = document.getElementById('scheduleTable');
    if (!table || !Array.isArray(items)) return;

    const DAYS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];

    // ìƒ‰ìƒ ì¤‘ë³µ ì´ˆê¸°í™”(ì„ íƒ)
    // usedColors = [];

    items.forEach(item => {
      // í•„ë“œ ìœ ì—° ë§¤í•‘
      const courseName = item.courseName ?? item.subject ?? item.name ?? '';
      const professor  = item.professorName ?? item.professor ?? '';
      const classroom  = item.classroom ?? item.room ?? '';
      const courseId   = item.identifyNumberOfCourse ?? item.courseId ?? item.subjectCode ?? '';
      // ì„œë²„ê°€ ì €ì¥í•œ "ìˆ˜ì—… í–‰ PK" (addTCì— ë³´ëƒˆë˜ ê°’ê³¼ ë§¤ì¹­)
      const classPk    = item.timeTableId ?? item.classId ?? item.id ?? '';

      // ìš”ì¼: 'ì›”/í™”/â€¦' ë˜ëŠ” ìˆ«ì(1~5)
      let dayIdx = -1;
      if (item.day != null) {
        dayIdx = (typeof item.day === 'string') ? DAYS.indexOf(item.day) : (Number(item.day) - 1);
      } else if (item.scheduleDay != null) {
        dayIdx = Number(item.scheduleDay) - 1;
      }
      if (dayIdx < 0) return;

      // êµì‹œ ë²”ìœ„
      const pStart = (item.period != null) ? Number(item.period)
              : (item.timeStart != null) ? Number(item.timeStart)
                      : (item.periodStart != null) ? Number(item.periodStart)
                              : null;
      const pEnd   = (item.timeEnd != null) ? Number(item.timeEnd)
              : (item.periodEnd != null) ? Number(item.periodEnd)
                      : pStart;

      if (pStart == null) return;

      const bg = getRandomColorNoDuplicate();
      for (let p = pStart; p <= pEnd; p++) {
        const row = table.rows[p + 1];           // í—¤ë” ë³´ì •
        if (!row) continue;
        const cell = row.cells[dayIdx + 1];
        if (!cell) continue;

        cell.innerHTML = classroom
                ? `${courseName}<br>(${classroom})`
                : `${courseName}${professor ? `<br>(${professor})` : ''}`;

        cell.style.backgroundColor = bg;
        if (courseId) cell.setAttribute('data-course-id', courseId);
        if (classPk)  cell.setAttribute('data-class-id', classPk);
        cell.removeAttribute('data-preview');
      }
    });

    attachCellEvents(); // íˆ´íŒ/í˜¸ë²„ ë‹¤ì‹œ ì—°ê²°
  }
  /***********************
   * ìˆ˜ì—… ë¦¬ìŠ¤íŠ¸/ì„ íƒ/ë¯¸ë¦¬ë³´ê¸°
   ***********************/
  function renderCourseList(classList) {
    const listContainer = document.getElementById('classInfoList');
    listContainer.innerHTML = '';

    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput?.value?.toLowerCase() || '';

    if (!Array.isArray(classList) || classList.length === 0) {
      listContainer.innerHTML = '<p>ìˆ˜ì—… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    const groupedByCourse = groupByCourse(classList);

    Object.entries(groupedByCourse).forEach(([courseName, allEntries]) => {
      if (searchTerm && !courseName.toLowerCase().includes(searchTerm)) return;

      const wrapper = document.createElement('div');
      wrapper.style.marginBottom = '12px';
      wrapper.style.border = '1px solid #ccc';
      wrapper.style.borderRadius = '6px';
      wrapper.style.background = '#f9f9f9';
      wrapper.style.padding = '10px';

      const header = document.createElement('div');
      header.style.cursor = 'pointer';
      header.style.fontWeight = 'bold';
      header.style.color = '#2563eb';
      header.textContent = courseName;

      const subList = document.createElement('div');
      subList.style.display = 'none';
      subList.style.marginTop = '8px';

      const groupedByIdentifyNumber = {};
      allEntries.forEach(entry => {
        const key = entry.identifyNumberOfCourse;
        if (!groupedByIdentifyNumber[key]) groupedByIdentifyNumber[key] = [];
        groupedByIdentifyNumber[key].push(entry);
      });

      Object.values(groupedByIdentifyNumber).forEach(entries => {
        const detail = document.createElement('div');
        detail.style.padding = '6px 10px';
        detail.style.borderTop = '1px solid #ddd';
        detail.style.cursor = 'pointer';
        detail.style.background = '#fff';

        const professor = entries[0].professorName || '-';
        const division = entries[0].identifyNumberOfCourse.split('-')[1] || '?';
        const weekdayNames = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
        const timeText = entries.map(e => {
          const day = weekdayNames[e.scheduleDay - 1] || `ìš”ì¼ ${e.scheduleDay}`;
          return e.timeStart === e.timeEnd
                  ? `${day} ${e.timeStart}êµì‹œ`
                  : `${day} ${e.timeStart}~${e.timeEnd}êµì‹œ`;
        }).join(', ');

        detail.innerHTML = `
          ë¶„ë°˜: ${division}<br>
          êµìˆ˜: ${professor}<br>
          ì‹œê°„: ${timeText}
        `;

        detail.addEventListener('mouseover', () => {
          if (!isCoursePermanentlyAdded(entries)) previewCourseOnSchedule(entries);
        });
        detail.addEventListener('mouseout', () => {
          if (!isCoursePermanentlyAdded(entries)) removePreviewFromSchedule();
        });
        detail.addEventListener('click', () => {
          addCourseToScheduleTable(entries); // ì‹¤ì œ ë“±ë¡/í† ê¸€
        });

        subList.appendChild(detail);
      });

      header.addEventListener('click', () => {
        subList.style.display = (subList.style.display === 'none') ? 'block' : 'none';
      });

      wrapper.appendChild(header);
      wrapper.appendChild(subList);
      listContainer.appendChild(wrapper);
    });
  }

  function groupByCourse(data) {
    const map = {};
    data.forEach(entry => {
      const key = entry.courseName;
      if (!map[key]) map[key] = [];
      map[key].push(entry);
    });
    return map;
  }

  function previewCourseOnSchedule(courseEntries) {
    const table = document.getElementById('scheduleTable');
    if (!table) return;

    courseEntries.forEach(entry => {
      const dayIndex = entry.scheduleDay - 1;
      for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
        const cell = table.rows[p + 1].cells[dayIndex + 1];
        if (!cell.getAttribute('data-course-id')) {
          cell.style.backgroundColor = '#d0ebff';
          cell.innerHTML = `${entry.courseName}<br>(${entry.classroom})`;
          cell.setAttribute('data-preview', 'true');
        }
      }
    });
  }

  function removePreviewFromSchedule() {
    const table = document.getElementById('scheduleTable');
    if (!table) return;
    const cells = table.querySelectorAll('td[data-preview="true"]');
    cells.forEach(cell => {
      cell.innerHTML = '';
      cell.style.backgroundColor = '';
      cell.removeAttribute('data-preview');
    });
  }

  function isCoursePermanentlyAdded(courseEntries) {
    const table = document.getElementById('scheduleTable');
    const courseId = courseEntries[0].identifyNumberOfCourse;

    for (let entry of courseEntries) {
      const dayIndex = entry.scheduleDay - 1;
      for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
        const cell = table.rows[p + 1].cells[dayIndex + 1];
        if (cell.getAttribute('data-course-id') === courseId) {
          return true;
        }
      }
    }
    return false;
  }

  function addCourseToScheduleTable(entries) {
    const table = document.getElementById('scheduleTable');
    if (!table) return;

    const courseId = entries[0].identifyNumberOfCourse;
    const courseName = entries[0].courseName;
    const classroom = entries[0].classroom;

    // ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìœ¼ë©´ í† ê¸€ ì‚­ì œ
    if (isCoursePermanentlyAdded(entries)) {
      entries.forEach(entry => {
        const dayIndex = entry.scheduleDay - 1;
        for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
          const cell = table.rows[p + 1].cells[dayIndex + 1];
          if (cell.getAttribute('data-course-id') === courseId) {
            cell.innerHTML = '';
            cell.style.backgroundColor = '';
            cell.removeAttribute('data-course-id');
            cell.removeAttribute('data-class-id');
            cell.removeAttribute('data-preview');
          }
        }
      });
      return;
    }

    // ì‹œê°„ ì¶©ëŒ ì²´í¬
    for (let entry of entries) {
      const dayIndex = entry.scheduleDay - 1;
      for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
        const cell = table.rows[p + 1].cells[dayIndex + 1];
        const existingId = cell.getAttribute('data-course-id');
        if (existingId && existingId !== courseId) {
          alert("í•´ë‹¹ ì‹œê°„ì— ì´ë¯¸ ë‹¤ë¥¸ ìˆ˜ì—…ì´ ìˆìŠµë‹ˆë‹¤!");
          return;
        }
      }
    }

    // ë“±ë¡
    const bg = getRandomColorNoDuplicate();
    entries.forEach(entry => {
      const dayIndex = entry.scheduleDay - 1;
      for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
        const cell = table.rows[p + 1].cells[dayIndex + 1];
        cell.innerHTML = `${courseName}<br>(${classroom})`;
        cell.style.backgroundColor = bg;
        cell.setAttribute('data-course-id', entry.identifyNumberOfCourse);
        cell.setAttribute('data-class-id', entry.timeTableId); // â† addTCì— ë³´ë‚¼ "ìˆ˜ì—… PK"
        cell.removeAttribute('data-preview');
      }
    });

    attachCellEvents();
  }

  /***********************
   * íˆ´íŒ
   ***********************/
  function attachCellEvents() {
    const table = document.getElementById('scheduleTable');
    if (!table) return;
    const allCells = table.querySelectorAll('td[data-period]');
    allCells.forEach(cell => {
      cell.onmouseover = function () {
        const courseId = cell.getAttribute('data-course-id');
        if (courseId) {
          // ê°™ì€ ê³¼ëª© ì—¬ëŸ¬ ì—”íŠ¸ë¦¬ ì¤‘ ì²« í•­ëª©
          const courseInfo = currentCourseList.find(c => c.identifyNumberOfCourse === courseId);
          if (courseInfo) showCourseTooltip(cell, courseInfo);
        }
      };
      cell.onmouseout = function () {
        hideCourseTooltip();
      };
    });
  }

  function showCourseTooltip(cell, courseInfo) {
    hideCourseTooltip();
    const tooltip = document.createElement('div');
    tooltip.className = 'course-tooltip';
    tooltip.style.position = 'absolute';
    tooltip.style.zIndex = 2000;
    tooltip.style.minWidth = '180px';
    tooltip.style.maxWidth = '260px';
    tooltip.style.background = '#ffffffcc';
    tooltip.style.border = '1px solid #2563eb';
    tooltip.style.borderRadius = '10px';
    tooltip.style.boxShadow = '0 4px 18px rgba(30,80,210,0.13)';
    tooltip.style.padding = '14px 18px 14px 14px';
    tooltip.style.fontSize = '0.98rem';
    tooltip.style.pointerEvents = 'none';
    tooltip.innerHTML = `
      <b>${courseInfo.courseName}</b>
      <br>êµìˆ˜: ${courseInfo.professorName || "-"}
      <br>ê°•ì˜ì‹¤: ${courseInfo.classroom}
      <br>êµ¬ë¶„: ${courseInfo.majorOrCulture ? "ì „ê³µ" : "êµì–‘"}
      <br>í•™ì : ${courseInfo.credit}
      <br>ìš”ì¼: ${['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'][courseInfo.scheduleDay - 1] || courseInfo.scheduleDay}
      <br>êµì‹œ: ${courseInfo.timeStart} ~ ${courseInfo.timeEnd}
      <br>ê³¼ëª©ì½”ë“œ: ${courseInfo.identifyNumberOfCourse}
    `;
    document.body.appendChild(tooltip);

    const rect = cell.getBoundingClientRect();
    tooltip.style.left = (rect.right + 8) + "px";
    tooltip.style.top = (rect.top + window.scrollY) + "px";
  }

  function hideCourseTooltip() {
    const prev = document.querySelector('.course-tooltip');
    if (prev) prev.remove();
  }

  /***********************
   * ì €ì¥(addTC) & í—¬í¼
   ***********************/
  function getSelectedClassIds() {
    const cells = document.querySelectorAll('#scheduleTable td[data-class-id]');
    const set = new Set();
    cells.forEach(cell => {
      const id = cell.getAttribute('data-class-id');
      if (id) set.add(Number(id));
    });
    return Array.from(set);
  }

  async function onClickSaveSchedule() {
    try {
      // í˜¹ì‹œ ìœ ì‹¤ëìœ¼ë©´ ë³µêµ¬
      if (!currentTimetableId) {
        currentTimetableId = timetableIdsBySemester[currentSemesterCode] ?? null;
      }
      if (!currentTimetableId) {
        currentTimetableId = await fetchLatestTimetableIdFromUserInfo(currentSemesterCode);
      }
      if (!currentTimetableId) throw new Error('timetableIdê°€ ì—†ìŠµë‹ˆë‹¤.');

      const classIds = getSelectedClassIds();
      if (classIds.length === 0) {
        alert('ì €ì¥í•  ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const token = localStorage.getItem('jwtToken');

      // ì„œë²„ê°€ FormDataë§Œ ë°›ëŠ” ê²½ìš°:
      const fd = new FormData();
      classIds.forEach(id => fd.append('classIds[]', id));
      const res = await fetch('/addTC', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          timetableId: Number(currentTimetableId),
          courseIds: classIds.map(Number)   // â† DTOì˜ getCourseIds()ì— ë§ì¶¤
        })
      });

      const txt = await res.text();
      if (!res.ok) throw new Error(`addTC ì‹¤íŒ¨: ${txt}`);

      alert('ì €ì¥ ì™„ë£Œ!');
    } catch (err) {
      console.error(err);
      alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜: ${err.message}`);
    }
  }

  /***********************
   * í…Œì´ë¸” ë Œë”
   ***********************/
  function generateEmptyScheduleTable() {
    const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
    let html = '<table id="scheduleTable" style="width:100%; border-collapse: collapse;">';

    html += '<tr><th></th>';
    days.forEach(day => {
      html += `<th style="border: 1px solid #ddd; padding: 8px; background:#f8f9fa;">${day}</th>`;
    });
    html += '</tr>';

    let startHour = 8;
    let endHour = 9;
    for (let period = 0; period <= 15; period++) {
      const timeStr = startHour <= 12 ? `${startHour}ì‹œ` : `${startHour - 12}ì‹œ`;
      const endtime = endHour <= 12 ? `${endHour}ì‹œ` : `${endHour - 12}ì‹œ`;
      html += `<tr><td style="border: 1px solid #ddd; padding: 8px; background:#e3e3fd; font-weight:bold;">${period}êµì‹œ<br>(${timeStr}~${endtime})</td>`;

      days.forEach(() => {
        html += `<td style="border: 1px solid #ddd; padding: 8px;" data-period="${period}"></td>`;
      });

      html += '</tr>';
      startHour++;
      endHour++;
    }

    html += '</table>';
    return html;
  }

  // âœ… íŒŒì¼ì— ì´ ë²„ì „ í•˜ë‚˜ë§Œ ìœ ì§€í•˜ì„¸ìš” (ì¤‘ë³µ ì„ ì–¸ ì œê±°!)
  function isTruthyTag(tag) {
    if (tag === true || tag === 1) return true;        // boolean/number
    if (tag === false || tag === 0) return false;
    if (typeof tag === 'string') {
      const t = tag.trim().toLowerCase();
      // postgres ë“±ì—ì„œ 't'/'f'ë¡œ ë‚´ë ¤ì˜¤ëŠ” ê²½ìš° í¬í•¨
      if (t === 't' || t === 'true' || t === '1' || t === 'y' || t === 'yes') return true;
      if (t === 'f' || t === 'false' || t === '0' || t === 'n' || t === 'no') return false;
    }
    return !!tag;
  }

  function pickTimetableArray(obj) {
    if (!obj || typeof obj !== 'object') return [];
    const candidates = Object.values(obj).filter(Array.isArray);
    return candidates.find(arr =>
            arr.some(r =>
                    r && typeof r === 'object' &&
                    ('timetableId' in r || 'id' in r) &&
                    ('tag' in r || 'term' in r)
            )
    ) || [];
  }

  /* ---------- í—¬í¼ë“¤ ---------- */

  // ì‘ë‹µ ë§µì—ì„œ ì²« ë²ˆì§¸ ë°°ì—´ ê°’ì„ ì°¾ì•„ ë°˜í™˜
  function findFirstArrayInMap(obj) {
    if (!obj || typeof obj !== 'object') return [];
    for (const k of Object.keys(obj)) {
      if (Array.isArray(obj[k])) return obj[k];
    }
    return [];
  }

  // "20252" -> "2025ë…„ 2í•™ê¸°"
  function toSemesterName(termCode) {
    const s = String(termCode || '');
    const year = s.slice(0, 4);
    const sem  = s.slice(4);
    const label = sem === '1' ? '1í•™ê¸°' : sem === '2' ? '2í•™ê¸°' : '';
    return year && label ? `${year}ë…„ ${label}` : 'ëŒ€í‘œ ì‹œê°„í‘œ';
  }

  // ëŒ€í‘œ ë²„íŠ¼ í…ìŠ¤íŠ¸/ìƒíƒœ ì—…ë°ì´íŠ¸ (ì„ íƒ)
  function markRepresentativeButtonAsSet(semesterName) {
    const btns = Array.from(document.querySelectorAll('#semesterList button'))
            .filter(b => b.textContent?.includes('ëŒ€í‘œë¡œ ì„¤ì •') || b.textContent?.includes('ëŒ€í‘œë¡œ ì„¤ì •ë¨'));

    // semTextê°€ ë²„íŠ¼ onclickì— ë“¤ì–´ê°€ ìˆë‹¤ë©´ ê·¸ê±¸ ì´ìš©í•´ì„œ ì°¾ì•„ë„ ë¨
    const target = btns.find(b => b.closest('li,div')?.textContent?.includes(semesterName));
    if (target) {
      target.disabled = true;
      target.textContent = 'ëŒ€í‘œë¡œ ì„¤ì •ë¨';
    }
  }


  // í˜ì´ì§€ ì§„ì… ì‹œ ìë™ ì‹¤í–‰
  // window.addEventListener('DOMContentLoaded', loadRepresentativeScheduleOnInit);

  async function hydrateSemestersFromServer() {
    const token = localStorage.getItem('jwtToken');
    try {
      const res = await fetch('/tableId_List', {
        method: 'GET',
        headers: { 'Authorization': `Bearer ${token}` },
        credentials: 'include'
      });
      if (!res.ok) throw new Error(`ì‹œê°„í‘œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (HTTP ${res.status})`);
      const data = await res.json();

      const list = pickTimetableArray(data);
      if (!Array.isArray(list) || list.length === 0) return;

      selectedSemesters = [];
      timetableIdsBySemester = {};

      for (const row of list) {
        const term = String(row.term ?? row['term'] ?? '');
        const tid  = Number(row.timeTableId ?? row['timetableId'] ?? row.id);
        const tagVal = row.tag ?? row['tag'];
        if (isTruthyTag(tagVal)) {
          representativeTermCode = term; // âœ… ëŒ€í‘œ í•™ê¸° ì½”ë“œ ìƒíƒœ ë°˜ì˜
        }

        if (!term || !tid) continue;

        timetableIdsBySemester[term] = tid;

        const semText = toSemesterName(term); // ì´ë¯¸ íŒŒì¼ì— ì •ì˜ë¨
        if (!selectedSemesters.includes(semText)) {
          selectedSemesters.push(semText);
        }
      }

      renderSemesterList();
      populateSemesterSelectInline();
    } catch (err) {
      console.error('hydrateSemestersFromServer ì˜¤ë¥˜:', err);
    }
  }

  async function removeSemester(termCode, timetableId) {
    if (!Number.isInteger(timetableId)) {
      alert("ìœ íš¨í•œ timetableIdê°€ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }
    const token = localStorage.getItem('jwtToken');
    if (!confirm('ì´ í•™ê¸°ì˜ ì‹œê°„í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;

    try {
      // ì„œë²„ ê·œì•½ì— ë§ì¶° í˜¸ì¶œ (ì§€ê¸ˆì€ /deleteTC ì˜ˆì‹œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
      const res = await fetch('/deleteTC', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify(timetableId)
      });

      const txt = await res.text();
      if (!res.ok) throw new Error(`ì‚­ì œ ì‹¤íŒ¨: ${txt}`);

      // âœ… ë¡œì»¬ ìƒíƒœì—ì„œë„ ì œê±°
      const semText = toSemesterName(termCode);
      selectedSemesters = selectedSemesters.filter(s => s !== semText);
      delete timetableIdsBySemester[termCode];
      renderSemesterList();
      alert('ì‹œê°„í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch (err) {
      alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
      console.error(err);
    }
  }


  async function onToggleRepresentative(termCode, checked) {
    const token = localStorage.getItem('jwtToken');
    if (!checked) {
      // í•´ì œëŠ” í—ˆìš©í•˜ì§€ ì•ŠìŒ â†’ UI ë˜ëŒë¦¼
      renderSemesterList();
      return;
    }

    // 1) termCode -> timetableId ì°¾ê¸°
    const tid = timetableIdsBySemester?.[termCode]
            ?? await fetchLatestTimetableIdFromUserInfo(termCode);
    if (!tid) {
      alert('timetableIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      renderSemesterList();
      return;
    }

    // 2) ëŒ€í‘œë¡œ ì„¤ì •
    const fd = new FormData();
    fd.append('timetableId', String(tid));
    const res = await fetch('/representative_Timetable', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: fd
    });
    if (!res.ok) {
      alert('ëŒ€í‘œ ì„¤ì • ì‹¤íŒ¨');
      renderSemesterList();
      return;
    }

    // 3) ìƒíƒœ ë°˜ì˜ + ë‹¤ì‹œ ë Œë”(ì„œë²„ ìµœì‹  ë°˜ì˜)
    representativeTermCode = termCode;

    // âœ… ì—¬ê¸° ë¶€ë¶„ì´ í•µì‹¬
    await hydrateSemestersFromServer();   // ëª©ë¡/ë§¤í•‘ ìµœì‹ í™”
    await renderRepresentativeFromServer(); // ëŒ€í‘œ ì‹œê°„í‘œ ì¬ë Œë”
    renderSemesterList();
  }


  async function loadRepresentativeSchedule(scheduleIdsOrCourseIds) {
    console.log("hi");
    const token = localStorage.getItem("jwtToken");
    if (!token) {
      alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
      return;
    }

    try {
      // 1) ì„œë²„ í˜¸ì¶œ
      const res = await fetch("/getTS2TE", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({scheduleIdsOrCourseIds})   // DTOì— ë§ê²Œ ì „ë‹¬
      });

      if (!res.ok) throw new Error("ëŒ€í‘œ ì‹œê°„í‘œ ì¡°íšŒ ì‹¤íŒ¨");

      const data = await res.json(); // schedule_of_course[]
      console.log("ëŒ€í‘œì‹œê°„í‘œ ë°ì´í„°:", data);

      // 2) í…Œì´ë¸” ìƒì„±
      renderRepresentativeSchedule(data);

    } catch (err) {
      console.error(err);
      alert("ëŒ€í‘œ ì‹œê°„í‘œ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    }
  }
  function renderRepresentativeSchedule(scheduleData) {
    const container = document.getElementById("representativeScheduleContainer");
    container.innerHTML = generateEmptyScheduleTable()
            .replace('id="scheduleTable"', 'id="repScheduleTable"');

    const table = container.querySelector("#repScheduleTable");
    if (!table) return;

    const DAYS = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];

    scheduleData.forEach(item => {
      const subject   = item.courseName || "";
      const professor = item.professorName || "";
      const classroom = item.classroom || "";

      const dayIdx = item.scheduleDay - 1;
      if (dayIdx < 0 || dayIdx > 4) return;

      const pStart = Number(item.timeStart);
      const pEnd   = Number(item.timeEnd ?? pStart);

      for (let p = pStart; p <= pEnd; p++) {
        const row = table.rows[p + 1]; // 0í–‰ = ìš”ì¼ í—¤ë”
        if (!row) continue;

        const cell = row.cells[dayIdx + 1];
        if (!cell) continue;

        cell.innerHTML = `${subject}<br>${professor}<br>${classroom}`;
        cell.style.backgroundColor = "#e0f7fa";
        cell.style.border = "1px solid #90caf9";
      }
    });
  }


  // âœ… ì‹œê°„í‘œ ID (ë¶€ëª¨)
  function getTid(r) {
    const v =
            r.timeTableId ??
            r.timetableId ??
            r.time_table_id ??
            r.timetable_id ??
            r.parentTimetableId ??
            r.timeTableIdOfParent ??
            r.tid;
    return v != null ? Number(v) : NaN;
  }

  // âœ… ìˆ˜ì—…í–‰(ìŠ¤ì¼€ì¤„) PK â†’ /getTS2TE ê°€ "ìŠ¤ì¼€ì¤„ PK ëª©ë¡"ì„ ë°›ëŠ” ì„¤ê³„ë¼ë©´ ì´ê±¸ ì‚¬ìš©
  function getScheduleRowId(r) {
    return Number(
            r.scheduleId ??
            r.classId ??
            r.courseScheduleId ??
            r.schedule_of_course_id ??
            r.id    // ì •ë§ë¡œ 'ìŠ¤ì¼€ì¤„í–‰ PK'ê°€ id ì¸ ê²½ìš°ì—ë§Œ ì‚¬ìš©
    );
  }

  // âœ… ì½”ìŠ¤ ID(= courseIds) â†’ ë‹¹ì‹ ì´ ë§í•œ â€œscheduleIds ëŠ” courseIds ì—¬ì•¼ í•œë‹¤â€ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ ì´ê±¸ ì‚¬ìš©
  function getCourseId(r) {
    return (
            r.courseId ??
            r.identifyNumberOfCourse ??   // ì˜ˆ: "HAEA0001-02"
            r.subjectCode ??
            r.course_id ??
            null
    );
  }



  async function renderRepresentativeFromServer() {
    const token = localStorage.getItem('jwtToken');
    if (!token) return;

    // âœ… UserId ë³´ì¥
    if (!UserId) {
      try { await loaduserinfo(); } catch(_) {}
    }

    // 1) ëŒ€í‘œ timetableId/term ì°¾ê¸°
    const res = await fetch('/tableId_List', {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${token}` },
      credentials: 'include'
    });
    if (!res.ok) return;

    const data = await res.json();
    const list = pickTimetableArray(data);
    const rep = list.find(row => isTruthyTag(row.tag ?? row['tag']));

    if (!rep) {
      document.getElementById('representativeScheduleContainer').innerHTML =
              `<p style="color:#888;">ëŒ€í‘œ ì‹œê°„í‘œê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;
      document.getElementById('representativeTitle').textContent = 'ğŸ“Œ ëŒ€í‘œ ì‹œê°„í‘œ';
      return;
    }

    const termCode = String(rep.term ?? rep['term'] ?? '');
    const timetableId = Number(rep.timeTableId ?? rep['timeTableId'] ?? rep.timetableId ?? rep.id);
    representativeTermCode = termCode;
    document.getElementById('representativeTitle').textContent =
            `ğŸ“Œ ëŒ€í‘œ ì‹œê°„í‘œ - ${toSemesterName(termCode)}`;

    // 2) í•­ìƒ userIdë¡œ /getTC ì¡°íšŒ â†’ í•´ë‹¹ timetableIdë§Œ í•„í„°
    const byUid = await fetch('/getTC', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
      // ì„œë²„ê°€ ì§€ê¸ˆê¹Œì§€ JSON.stringify(UserId) í˜•íƒœë¥¼ ë°›ì•˜ìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ìœ ì§€
      body: JSON.stringify(UserId)
    });
     if (!byUid.ok) {
         const failTxt = await byUid.text();
         console.error('getTC ì‹¤íŒ¨ status=', byUid.status, 'body=', failTxt);
         document.getElementById('representativeScheduleContainer').innerHTML =
                   `<p style="color:#888;">ëŒ€í‘œ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
         return;
       }

     let all;
     try {
         const txt = await byUid.text();
         try {
             all = JSON.parse(txt);
           } catch (e) {
             console.error('[rep] /getTC JSON íŒŒì‹± ì‹¤íŒ¨. ì›ë¬¸:', txt);
             throw e;
           }
       } catch (e) {
         console.error('[rep] /getTC ì‘ë‹µ ì½ê¸° ì‹¤íŒ¨:', e);
         return;
       }
     console.log('[rep] /getTC ì „ì²´ rows:', all);
     console.log('[rep] ëŒ€í‘œ timetableId(ë¹„êµê¸°ì¤€):', timetableId);

    const rows = (all || []).filter(r => {
      const tid = getTid(r);
      return Number.isFinite(tid) && tid === timetableId;
    });
    console.log('[rep] ëŒ€í‘œ timetableId:', timetableId, 'í•„í„°ëœ rows:', rows);

    // 3) scheduleIds ì¶”ì¶œ
    const courseIds = Array.from(new Set(
            rows.map(getCourseId).filter(v => v != null && String(v).trim() !== '')
    ));
    console.log('[rep] ì¶”ì¶œëœ courseIds:', courseIds);
/*
    if (scheduleIds.length === 0) {
      document.getElementById('representativeScheduleContainer').innerHTML =
              `<p style="color:#888;">ëŒ€í‘œ ì‹œê°„í‘œì— ì €ì¥ëœ ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
      return;
    }
*/
    // 4) /getTS2TE í˜¸ì¶œ â†’ ë Œë”
    await loadRepresentativeSchedule(courseIds);
  }
</script>
</body>
</html>