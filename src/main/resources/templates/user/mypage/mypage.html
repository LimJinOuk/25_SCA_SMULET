<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>My page</title>
    <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
            rel="stylesheet"
    />
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 20px;
            box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.85);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }
        h1 {
            font-size: 2.3rem;
            font-weight: bold;
            color: #2563eb;
            margin: 0;
        }
        h1 a {
            text-decoration: none;
            color: inherit;
        }

        nav a {
            margin-left: 20px;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.2s ease, font-size 0.2s ease;
        }
        nav a:hover {
            color: #3b82f6;
            font-size: 1.1rem;
        }
        main {
            flex: 1;
            padding: 20px 0;
        }
        .container {
            display: grid;
            grid-template-columns: 2fr 1fr; /* ì¢Œ:ëŒ€í‘œ(ë„“ê²Œ) / ìš°:ì‚¬ì´ë“œ */
            gap: 16px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 20px 16px;
        }

        /* ìš°ì¸¡ íŒ¨ë„ì€ ì„¸ë¡œ ìŠ¤íƒ */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* ë°˜ì‘í˜• ì „í™˜ */
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr; /* í•œ ì¤„ */
            }
        }
        .box {
            flex: unset;   /* ìë™ ë†’ì´ */
            background: #fff;
            border: 1px solid #e2e8f0; /* card ë¼ì¸ */
            border-radius: 14px;
            padding: 16px 18px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
            display: flex;
            flex-direction: column;
            min-height: 160px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        .box3{
            min-height: 220px;
        }
        .box:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }
        /* ë°•ìŠ¤ ê°„ ê°„ê²© í†µì¼ \*/
        .sidebar .box + .box {
            margin-top: 5px;
        }
        /* ë°•ìŠ¤ íƒ€ì´í‹€ì„ card í—¤ë”ì²˜ëŸ¼ ì“°ê³  ì‹¶ì„ ë•Œ */
        .box .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 0 12px;
            font-size: 16px;
            font-weight: 800;
        }
        .box .card-title .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: #e6efff; /* brand-weak ëŠë‚Œ */
            font-size: 16px;
        }

        /* í…ìŠ¤íŠ¸ ê³µí†µ */
        h2,
        h3 {
            margin: 0 0 10px;
            font-size: 1.1rem;
            color: #111827;
        }
        .section h3 {
            margin-top: 24px; /* â€œë¹„ë°€ë²ˆí˜¸ ë³€ê²½â€ ì œëª© ìœ„ë¡œ 24px ë„ì›€ */
        }
        .section {
            margin-bottom: 10px;
        }
        .section button {
            display: inline-block;
            width: 120px;
            margin-top: 8px;
            text-align: center;
        }
        /* íšŒì› ì„¤ì •: ì œëª©ê³¼ ë²„íŠ¼ì„ ê°™ì€ ì¤„ì— */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-top: 0px; /* ê¸°ì¡´ h3 ìœ„ ì—¬ë°± ëŒ€ì²´ */
        }
        .section-header h3 {
            margin: 0; /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
            line-height: 1; /* ë†’ì´ë¥¼ ì¡°ê¸ˆ ì¤„ì—¬ ìœ„ë¡œ ë¶™ê²Œ */
            transform: translateY(-3px); /* ìœ„ë¡œ 3px ì´ë™ (ì›í•˜ë©´ -2~ -5ë¡œ ì¡°ì ˆ) */
        }

        /* ë²„íŠ¼ ë¬¶ìŒ (ìš°ì¸¡) */
        .section-header .actions {
            display: flex;
            gap: 8px;
        }

        /* ê¸°ì¡´ .section button { width:120px } ê°™ì€ ê·œì¹™ì„ ë¬´ë ¥í™” */
        .section-header .actions button {
            width: auto;
            margin-top: 0;
            padding: 8px 12px; /* ì»´íŒ©íŠ¸ */
        }

        /* í™”ë©´ ì¢ì„ ë•ŒëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆ */
        @media (max-width: 560px) {
            .section-header {
                flex-wrap: wrap;
            }
            .section-header .actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        .info p {
            margin: 3px 0;
            font-size: 0.9rem;
            color: #374151;
        }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        button:hover {
            background-color: #1e40af;
            transform: scale(1.03);
        }
        button.red {
            background-color: #ef4444;
        }
        button.red:hover {
            background-color: #dc2626;
        }
        .representative-container {
            width: 100%;
            display: block; /* ì¤‘ì•™ì •ë ¬ í”Œë ‰ìŠ¤ ì œê±° */
            margin-top: 0;
        }
        .representative-box {
            width: auto; /* 70% ì œí•œ í•´ì œ */
            max-width: none; /* 1000px ì œí•œ í•´ì œ(í•„ìš” ì‹œ ë³µì› ê°€ëŠ¥) \*/
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 30px;
            box-sizing: border-box;
        }

        /* ëŒ€í‘œ ì‹œê°„í‘œë§Œ ê°€ë¡œ í­ ì¤„ì´ê¸° */
        #repGridCard {
            width: 750px;   /* ì›í•˜ëŠ” í¬ê¸° */
            margin: 0 auto; /* ê°€ìš´ë° ì •ë ¬ */
        }

        /* ëŒ€í‘œ ì‹œê°„í‘œë§Œ ì„¸ë¡œ ë†’ì´ ëŠ˜ë¦¬ê¸° */
        #repGridCard .row {
            height: 100px;   /* êµì‹œ ë†’ì´ */
        }
        #repGridCard .cell { min-height: 0; } /* ì¶©ëŒ ë°©ì§€ */


        footer {
            background-color: rgba(30, 30, 30, 0.98);
            color: rgba(200, 200, 200, 0.7);
            font-size: 0.9rem;
            padding: 2rem 1rem;
            text-align: center;
            border-top: 1px solid #444;
            margin-top: auto;
        }
        footer a {
            text-decoration: none;
            color: rgba(200, 200, 200, 0.7);
            margin: 0 10px;
        }
        footer a:hover {
            text-decoration: underline;
        }
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: white;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 1rem;
            color: #111827;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            padding-right: 40px; /* í™”ì‚´í‘œ ê³µê°„ í™•ë³´ */
        }
        select:hover {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-wrapper {
            display: contents;
        }
        .modal {
            background: #fff;
            border-radius: 12px;
            padding: 24px 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: flex;
            flex-direction: row;
            gap: 16px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 8px;
        }
        .modal-buttons button {
            flex: 1;
            max-width: 120px;
            padding: 0.6rem 0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .modal-buttons #confirm,
        .modal-buttons #changePwBtn {
            background-color: #2563eb;
            color: #fff;
        }
        .modal-buttons #close-btn,
        .modal-buttons #cancelChange {
            background-color: #e0e0e0;
            color: #333;
        }
        .modal-buttons button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        .modal-buttons button:active {
            transform: translateY(1px);
        }

        .modal input[type='password'] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .hidden {
            display: none;
        }
        body.modal-open {
            overflow: hidden;
        }
        #semesterList {
            list-style: none;
            padding-left: 0;
            margin: 12px 0 0 0;
        }
        #semesterList li {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #semesterList .semester-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 14px;
            background: #fff;
            transition: background-color 0.15s ease, box-shadow 0.15s ease,
            border-color 0.15s ease;
            cursor: pointer;
            width: 80%;
        }
        #semesterList .semester-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        }
        #semesterList .semester-name {
            color: #111827;
            text-decoration: none;
            font-weight: 600;
        }
        #semesterList .semester-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #semesterList .rep-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        #semesterList .del-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .course-tooltip {
            animation: fadeIn 0.12s;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .details-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr)); /* 4ë“±ë¶„ ê³ ì • */
            gap: 10px;
            margin-top: 10px;
        }
        @media (max-width: 420px) {
            .details-container {
                grid-template-columns: repeat(2, 1fr);
            } /* ëª¨ë°”ì¼ 2ì—´ \*/
        }
        .detail {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background-color: #fff;
            height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .detail:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.5s ease;
        }
        .detail .label {
            font-size: 17px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .detail .value {
            font-size: 20px;
            font-weight: 700;
            color: #007bff;
        }
        /* ì˜êµ¬ ë°°ì¹˜ê°€ ë“¤ì–´ì˜¬ ë•Œ ì‚´ì§ í•˜ì´ë¼ì´íŠ¸ */
        td.commit-flash {
            animation: commitFlash var(--preview-dur) var(--preview-ease) 1;
        }
        @keyframes commitFlash {
            0% {
                box-shadow: 0 0 0 rgba(37, 99, 235, 0);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.15);
            }
            100% {
                box-shadow: 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        #scheduleTable .cell[data-period] { position: relative; }


        .preview-overlay {
            position: absolute;
            inset: 0;
            padding: 8px 10px;
            display: block;               /* ê¸€ì ë ˆì´ì•„ì›ƒì„ ì…€ê³¼ ë™ì¼í•˜ê²Œ */
            background: var(--preview-color, #a5d8ff);
            box-shadow: inset 0 0 0 2px var(--preview-color, #a5d8ff);
            border-radius: 6px;
            z-index: 5;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.18s ease, transform 0.18s ease;
        }

        /* ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ ìœ ì§€ */
        .preview-overlay.show {
            opacity: 1;
            transform: scale(1);
        }

        .box .desc-list {
            margin: 8px 0 14px;
        }
        .box .desc-list div {
            display: flex;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        .box .desc-list dt {
            width: 66px;
            color: #6b7280;
            font-weight: 700;
        }
        .box .desc-list dd {
            margin: 0;
        }
        /* í…Œí¬íŠ¸ë¦¬ ì¹´ë“œ ì•ˆì˜ 'ëª¨ë“  í…Œí¬íŠ¸ë¦¬ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!'ë§Œ ì‘ê²Œ */
        .box2 .subtext,
        .box3 .subtext {
            font-size: 0.85rem; /* í•„ìš”í•˜ë©´ 0.8\~0.95rem ì‚¬ì´ë¡œ ì¡°ì ˆ */
            line-height: 1.4;
            color: #6b7280; /* (ì„ íƒ) ì‚´ì§ í†¤ ë‹¤ìš´ */
            margin-top: 4px; /* (ì„ íƒ) ìœ„ ì—¬ë°± ì•½ê°„ ì¤„ì„ \*/
        }
        :root{
            --line:#e2e8f0;
            --muted:#6b7280;
            --brand:#2563eb;
            --brand-weak:#e6efff;
            --danger:#ef4444;
            --shadow:0 6px 18px rgba(2,6,23,.06);
            --preview-color: #a5d8ff; /* â† ì›í•˜ëŠ” ë¯¸ë¦¬ë³´ê¸° ê³ ì •ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        }
        .schedule-card{
            border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff;
            box-shadow:var(--shadow);
        }
        .schedule-header{
            display:grid; grid-template-columns:120px repeat(5,1fr);
            background:#f9fbff; border-bottom:1px solid var(--line);
        }
        .schedule-header>div{ padding:12px; font-weight:700; text-align:center; }
        .schedule-body{ display:flex; flex-direction:column; }
        .row{
            display:grid; grid-template-columns:120px repeat(5,1fr);
            border-bottom:1px solid var(--line);
        }
        .row:last-child{ border-bottom:none; }
        .time-col{
            padding:12px; background:#fbfbfb; border-right:1px solid var(--line);
            font-weight:700; font-size:13px; text-align:center;
        }
        .time-col span{ display:block; color:var(--muted); font-weight:600; }
        .cell{
            min-height:60px; border-right:1px solid var(--line);
            background:linear-gradient(180deg,#fff 0%,#fff 60%,#fcfcfc 100%);
        }
        .row .cell:last-child{ border-right:none; }
        .cell.busy,
        .course-block.busy {
            /* JSì—ì„œ ì´ ë³€ìˆ˜ë§Œ ë„£ì–´ì£¼ë©´ ë©ë‹ˆë‹¤ */
            --c: var(--course-color, #a5d8ff);

            /* í…Œë‘ë¦¬ëŠ” ê°™ì€ ìƒ‰ìƒ ê³„ì—´ë¡œ ë” ë˜ë ·í•˜ê²Œ */
            --stroke: color-mix(in oklab, var(--c) 85%, black);

            /* ì¤‘ì•™â†’ë°”ê¹¥ìœ¼ë¡œ ê°ˆìˆ˜ë¡ 'í°ìƒ‰ì— ê°€ê¹Œìš´ í‹´íŠ¸'ê°€ ì´ì–´ì§€ë„ë¡,
               ëê¹Œì§€ ì›ìƒ‰ 100%ë¡œ ê°€ì§€ ì•Šê³  70~75% í‹´íŠ¸ê¹Œì§€ë§Œ ì‚¬ìš© */
            background:
                    radial-gradient(
                            circle at 50% 45%,
                            #ffffff 0%,
                            color-mix(in oklab, #ffffff 92%, var(--c)) 28%,
                            color-mix(in oklab, #ffffff 88%, var(--c)) 48%,
                            color-mix(in oklab, #ffffff 82%, var(--c)) 68%,
                            color-mix(in oklab, #ffffff 75%, var(--c)) 100%
                    );

            border: 2px solid var(--stroke);
            border-radius: 10px;

            /* ì‚´ì§ ì…ì²´ê° */
            box-shadow:
                    inset 0 1px 0 rgba(255,255,255,0.7),
                    0 3px 10px rgba(0,0,0,0.08);

            /* ê°€ìš´ë°ê°€ ë°ìœ¼ë‹ˆ ì§„í•œ í…ìŠ¤íŠ¸ê°€ ê°€ë…ì„± ì¢‹ìŒ */
            color: #0f172a;
        }

        @media (max-width:560px){
            .schedule-header,.row{ grid-template-columns:80px repeat(5,1fr); }
            .time-col{ font-size:12px; }
        }
        /* === ì‹œê°„í‘œ ì…€ ì•ˆ í…ìŠ¤íŠ¸ ê³µí†µ === */
        /* ê³¼ëª© ë¸”ë¡ ì „ì²´ */
        .cell {
            position: relative;
            padding: 8px 10px;           /* ì…€ ì•ˆìª½ ì—¬ë°± ì¡°ê¸ˆ ë„‰ë„‰í•˜ê²Œ */
            overflow: hidden;            /* ë„˜ì¹˜ë©´ ì˜ë¼ëƒ„ */
            box-sizing: border-box;
        }

        .cell .slot {
            display: flex;
            flex-direction: column;
            justify-content: center;     /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ â†’ ìœ„ë¡œ ë¶™ì´ê³  ì‹¶ìœ¼ë©´ flex-start */
            height: 100%;
            line-height: 1.3;            /* ì¤„ ê°„ê²© ì•½ê°„ ë„“í˜ */
            text-align: center;          /* ê°€ë¡œ ì •ë ¬: center / left / right */
        }

        /* ê³¼ëª©ëª… */
        .cell .slot-title {
            font-size: 14px;             /* ê¸°ë³¸ 0.95rem â†’ 13px */
            font-weight: 800;            /* ë” ë‘ê»ê²Œ */
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ê°•ì˜ì‹¤/êµìˆ˜ */
        .cell .slot-room {
            margin-top: 2px;
            font-size: 13px;             /* ê¸°ì¡´ë³´ë‹¤ ì¡°ê¸ˆ ì‘ê²Œ */
            font-weight: 600;
            color: var(--muted, #6b7280); /* var(--muted) ìš°ì„ , ì—†ìœ¼ë©´ íšŒìƒ‰ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.9;
        }
        /* ====== Grid-row span ê¸°ë°˜ ì‹œê°„í‘œ ë°”ë”” ====== */
        .schedule-grid {
            display: grid;
            grid-template-columns: 120px repeat(5, 1fr); /* ì‹œê°„ì—´ + ì›”~ê¸ˆ */
            grid-auto-rows: 80px;                        /* êµì‹œ ë†’ì´ */
            grid-auto-flow: row dense;/* ìœ„ì¹˜ ê³ ì • ë³´ì¡° */
            position: relative;                          /* ì½”ìŠ¤ ë¸”ë¡ ë°°ì¹˜ ê¸°ì¤€ */
            background: #fff;
            border-top: 1px solid var(--line);
            border-left: 1px solid var(--line);
        }

        /* ì™¼ìª½ ì‹œê°„ í‘œì‹œ ì…€ */
        .time-cell {
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            font-weight:700;
            font-size:14px;
            background:#fbfbfb;
            border-bottom: 1px solid var(--line);
            border-right: 1px solid var(--line);
        }
        .time-cell span { color: var(--muted); font-weight:600; }

        /* ë¹ˆ ìë¦¬(ê²©ìì„  ìš©) */
        .cell-placeholder {
            border-right:1px solid var(--line);
            border-bottom:1px solid var(--line);
            position: relative;
        }

        /* ì‹¤ì œ â€˜í•˜ë‚˜ë¡œ í•©ì³ì§„â€™ ê³¼ëª© ë°•ìŠ¤ */
        .course-block {
            border-radius: 10px;
            border: 2px solid rgba(0,0,0,.12);
            box-shadow: inset 0 1px 0 rgba(255,255,255,.7), 0 3px 10px rgba(0,0,0,.08);
            color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 10px;
            text-align: center;
            overflow: hidden;
        }

        /* ë¸”ë¡ ë‚´ë¶€ í…ìŠ¤íŠ¸(ê¸°ì¡´ í…œí”Œë¦¿ê³¼ í†¤ ë§ì¶¤) */
        .course-block .slot{ line-height:1.3; }
        .course-block .slot-title{
            font-size:13px; font-weight:800;
            white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
        }
        .course-block .slot-room{ margin-top:2px; font-size:12px; font-weight:600; opacity:.9; color: var(--muted); }
        /* ë¯¸ë¦¬ë³´ê¸° merged block (ì—°ê°• 1ë°•ìŠ¤) */
        .preview-block {
            border-radius: 10px;
            border: 2px dashed rgba(0,0,0,.18);
            background: var(--preview-color, rgba(99,179,237,0.25));
            color: #0f172a;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px 10px;
            text-align: center;
            pointer-events: none;     /* í´ë¦­ ë§‰ê¸° */
            z-index: 9;
        }

        /* ê¸°ë³¸ ìˆ¨ê¹€ (ë”ë³´ê¸° ì „) */
        .hidden-semester { display: none !important; }

        /* ë”ë³´ê¸° ë²„íŠ¼ì˜ íšŒìƒ‰ í†¤ */
        #showMoreBtn {
            margin-top: 10px;
            width: 100%;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            color: #111827;
            border-radius: 10px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 0.92rem;
        }
        #showMoreBtn:hover { background: #eceff3; }
    </style>
</head>
<body>
<header>
    <h1><a href="/">SMULET</a></h1>
    <nav>
        <a href="#"><b>ì´ìš©ì•ˆë‚´</b></a>
        <a href="/login_page" id="loginLink"><b>ë¡œê·¸ì¸</b></a>
        <a href="/Register" id="registerLink"><b>íšŒì›ê°€ì…</b></a>
        <a href="/" id="logoutLink" style="display: none"><b>ë¡œê·¸ì•„ì›ƒ</b></a>
        <a href="/" id="" style="display: none"><b>ë§ˆì´í˜ì´ì§€</b></a>
    </nav>
</header>
<main>
    <div class="container">
        <!-- ì¢Œì¸¡: ëŒ€í‘œ ì‹œê°„í‘œ -->
        <div class="representative-container">
            <div class="box representative-box">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 id="representativeTitle" class="card-title">
                        <span class="icon">ğŸ“Œ</span> ëŒ€í‘œ ì‹œê°„í‘œ
                    </h2>
                </div>
                <div id="representativeScheduleContainer">
                    <div class="schedule-card" id="repGridCard">
                        <div class="schedule-header">
                            <div class="time-col"></div>
                            <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div>
                        </div>
                        <div class="schedule-body" id="repGridBody"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <!-- BOX1 -->
            <div class="box box1">
                <h2 class="card-title"><span class="icon">ğŸ“…</span> ì‹œê°„í‘œ</h2>
                <p class="subtext">ì‹œê°„í‘œë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

                <!-- ë“œë¡­ë‹¤ìš´ë§Œìœ¼ë¡œ ë°”ë¡œ í•™ê¸° ì¶”ê°€ -->
                <div style="margin-top: 1px">
                    <select id="semesterSelectInline" style="min-width: 220px">
                        <option value="">í•™ê¸°ë¥¼ ì„ íƒí•´ ì¶”ê°€</option>
                        <!-- JSì—ì„œ ì˜µì…˜ ì±„ì›Œì§ -->
                    </select>
                </div>

                <ul id="semesterList" style="margin-top: 12px"></ul>
                <!-- ì‹œê°„í‘œ ëª¨ë‹¬ -->
            </div>

            <div
                    id="modalOverlay"
                    class="modal-overlay hidden"
                    role="dialog"
                    aria-modal="true"
                    aria-labelledby="pwTitle"
            >
                <div class="modal-wrapper">
                    <div class="modal">
                        <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                        <input type="password" id="pw" />
                        <div class="modal-buttons">
                            <button id="confirm" type="button">í™•ì¸</button>
                            <button id="close-btn" type="button">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="changePwModal" class="modal-overlay hidden">
                <div class="modal-wrapper">
                    <div class="modal">
                        <p>ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                        <input
                                type="password"
                                id="newPassword"
                                placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"
                        />
                        <input
                                type="password"
                                id="confirmPassword"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                        />
                        <div class="modal-buttons">
                            <button id="changePwBtn" type="button">ë³€ê²½</button>
                            <button id="cancelChange" type="button">ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOX2 -->
            <div class="box box2">
                <h2 class="card-title"><span class="icon">ğŸŒ³</span> í…Œí¬íŠ¸ë¦¬</h2>
                <p class="subtext">ëª¨ë“  í…Œí¬íŠ¸ë¦¬ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

                <select
                        id="techTreeSelect"
                        onchange="goToTechTree()"
                        style="margin-top: 1px"
                >
                    <option value="">í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="21">21í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                    <option value="22">22í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                    <option value="23">23í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                    <option value="24">24í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                    <option value="25">25í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                </select>

                <!-- ê°€ë¡œ ì •ë ¬ëœ ë°•ìŠ¤ë“¤ -->
                <div class="details-container">
                    <div class="detail">
                        <span class="label">bsm</span>
                        <span class="value" id="bsmCredit">0</span>
                    </div>
                    <div class="detail">
                        <span class="label">ì„¤ê³„</span>
                        <span class="value" id="designCredit">0</span>
                    </div>
                    <div class="detail">
                        <span class="label">ì „ê³µì„ íƒ</span>
                        <span class="value" id="majorElectiveCredit">0</span>
                    </div>
                    <div class="detail">
                        <span class="label">ì „ê³µì‹¬í™”</span>
                        <span class="value" id="majorAdvancedCredit">0</span>
                    </div>
                </div>
            </div>

            <div class="box box3">
                <div class="section">
                    <h2 class="card-title"><span class="icon">ğŸ‘¤</span> ë‚´ ì •ë³´</h2>
                    <dl class="desc-list">
                        <div>
                            <dt>ì´ë¦„</dt>
                            <dd><span id="userName"></span></dd>
                        </div>
                        <div>
                            <dt>ì´ë©”ì¼</dt>
                            <dd><span id="studentId"></span></dd>
                        </div>
                        <div>
                            <dt>í•™ê³¼</dt>
                            <dd><span id="userMajor">ì»´í“¨í„°ê³¼í•™ê³¼</span></dd>
                        </div>
                    </dl>
                    <div class="section">
                        <div class="section-header">
                            <h3>ğŸ”’ íšŒì› ì„¤ì •</h3>
                            <div class="actions">
                                <button onclick="modifinguserinfo()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                                <button class="red" onclick="deleteAccount()">
                                    íšŒì›íƒˆí‡´
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="scheduleModal" class="modal-overlay hidden">
                <div class="modal-wrapper">
                    <div
                            class="modal"
                            style=" display: flex; width: 90vw; max-width: 1000px; height: 600px; overflow: hidden; padding: 30px; gap: 20px;">
                        <!-- ì™¼ìª½: ì‹œê°„í‘œ ì˜ì—­ -->
                        <div style="flex: 2;overflow-y: auto;">
                            <div style="text-align: right;">
                                <button id="closeScheduleModal" style="background: #ef4444; color: white; border: none; border-radius: 5px;padding: 6px 12px;cursor: pointer;">
                                    ë‹«ê¸°
                                </button>
                                <button id="saveSchedule" style=" background: #4466ef; color: white; border: none; border-radius: 5px; padding: 6px 12px;  cursor: pointer;">
                                    ì €ì¥
                                </button>
                            </div>
                            <h2 style="text-align: center; margin-bottom: 15px" id="modalSemesterTitle"></h2>
                            <div id="scheduleTableContainer">
                                <!-- ë™ì  ì‹œê°„í‘œ -->
                            </div>
                        </div>
                        <div style=" flex: 1; display: flex; flex-direction: column;border-left: 1px solid #ddd;padding-left: 10px;">
                            <!-- ğŸ” ê²€ìƒ‰ì°½ -->
                            <input type="text" id="searchInput" placeholder="ê³¼ëª©ëª… ê²€ìƒ‰" style=" width: 100%; margin-bottom: 10px; padding: 8px;border: 1px solid #ccc; border-radius: 6px; "
                                   oninput="renderCourseList(currentCourseList)"/>

                            <!-- ğŸ“š ìˆ˜ì—… ë¦¬ìŠ¤íŠ¸ -->
                            <div id="classInfoList" style="flex: 1; overflow-y: auto">
                                <!-- JSë¡œ ìˆ˜ì—… ì •ë³´ê°€ ë“¤ì–´ì˜µë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<footer>
    <b>
        <a href="#">Github</a>
        <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        <a href="#">ì´ìš©ì•½ê´€</a><br /><br />
        <a href="#">Copyright</a>
    </b>
</footer>

<script>
    /***********************
     * ìƒìˆ˜ / ì „ì—­ ìƒíƒœ
     ***********************/
    const semesterOptions = [
        '2025ë…„ 2í•™ê¸°','2025ë…„ 1í•™ê¸°','2024ë…„ 2í•™ê¸°','2024ë…„ 1í•™ê¸°',
        '2023ë…„ 2í•™ê¸°','2023ë…„ 1í•™ê¸°','2022ë…„ 2í•™ê¸°','2022ë…„ 1í•™ê¸°',
        '2021ë…„ 2í•™ê¸°','2021ë…„ 1í•™ê¸°',
    ];

    const pastelPalette = [
        "#A5D8FF","#B2F2BB","#FFD8A8","#FFC9C9","#D0BFFF",
        "#B2E3E8","#FFE69A","#F4C2D7","#C9E4A7","#C7D2FE",
    ];

    /** ê³¼ëª©ë³„ ê³ ìœ  ìƒ‰ìƒ */
    const ColorManager = (() => {
        const pool = [...pastelPalette];
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
        }
        const map = new Map();
        let cursor = 0;

        function nextPoolColor(usedSet) {
            for (let i = 0; i < pool.length; i++) {
                const idx = (cursor + i) % pool.length;
                const c = pool[idx];
                if (!usedSet.has(c)) {
                    cursor = (idx + 1) % pool.length;
                    return c;
                }
            }
            return null;
        }

        function hslFromString(s) {
            let hash = 0;
            for (const ch of String(s)) { hash = ((hash << 5) - hash) + ch.charCodeAt(0); hash |= 0; }
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 70%, 85%)`;
        }
        function get(key) {
            if (!key) return pool[0];
            if (map.has(key)) return map.get(key);
            const used = new Set(map.values());
            let color = nextPoolColor(used);
            if (!color) color = hslFromString(key);
            map.set(key, color);
            return color;
        }
        function free(key) { if (!key) return; map.delete(key); }
        function has(key) { return map.has(key); }
        return { get, free, has };
    })();

    let UserId = null;
    let representativeTermCode = null; // "20252" í˜•ì‹
    let selectedSemesters = [];
    let currentCourseList = [];
    let timetableIdsBySemester = {};
    let currentSemesterCode = null;
    let currentTimetableId = null;

    const previewSession = { zeroAdded: false };
    document.addEventListener('DOMContentLoaded', async function () {
        const loginLink = document.getElementById('loginLink');
        const logoutLink = document.getElementById('logoutLink');
        const registerLink = document.querySelector('nav a[href="/Register"]');

        // ë¶€íŒ… ì‹œ refresh ì‹œë„(ì¿ í‚¤ì— refreshê°€ ìˆìœ¼ë©´ ìƒˆ accessë¥¼ ë©”ëª¨ë¦¬ì— ì±„ì›€)
        try { await TokenManager.refresh(); } catch {}
        const isLoggedIn = !!TokenManager.get();

        if (isLoggedIn) {
            loginLink && (loginLink.style.display = 'none');
            logoutLink && (logoutLink.style.display = 'inline');
            if (registerLink) registerLink.style.display = 'none';
        } else {
            loginLink && (loginLink.style.display = 'inline');
            logoutLink && (logoutLink.style.display = 'none');
            if (registerLink) registerLink.style.display = 'inline';
        }
        logoutLink.addEventListener('click', function (e) {
            e.preventDefault();
            TokenManager.set(null);
            alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/';
        });
        // ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° & ì²´ì¸ì§€ ë°”ì¸ë”©
        populateSemesterSelectInline();
        document
            .getElementById('semesterSelectInline')?.addEventListener('change', onSemesterSelectInlineChange);

        if (isLoggedIn) {
            // 1) userInfo ë¨¼ì € í™•ë³´(â†’ UserId ì„¸íŒ… ë³´ì¥)
            await loaduserinfo().catch(console.error);
            await hydrateSemestersFromServer();
            await renderRepresentativeFromServer();
            await loadCredits();               // â˜… ì´ì œ í˜¸ì¶œ (UserId ë³´ì¥)
        }
    });


    function deleteAccount() {
        if (
            !confirm(
                'ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            )
        )
            return;

        apiFetch('/member/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
            .then((res) => {
                if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                return res.json();
            })
            .then((data) => {
                if (data.deleteStatus === 'success') {
                    alert('íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    localStorage.removeItem('jwtToken');
                    window.location.href = '/';
                }
            })
            .catch((err) => {
                alert('íšŒì› íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(err);
            });
    }

    function modifinguserinfo() {
        const modalOverlay = document.getElementById('modalOverlay');
        const closeBtn = document.getElementById('close-btn');
        const confirmBtn = document.getElementById('confirm');

        modalOverlay.classList.remove('hidden');
        document.body.classList.add('modal-open');

        closeBtn.onclick = () => {
            modalOverlay.classList.add('hidden');
            document.body.classList.remove('modal-open');
        };

        confirmBtn.onclick = () => {
            const pw = document.getElementById('pw').value;

            apiFetch('/check_pw_button', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ pw }),
            })
                .then((res) => {
                    if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                    return res.json();
                })
                .then((data) => {
                    if (data.Password === true) {
                        alert('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì™„ë£Œ!');
                        modalOverlay.classList.add('hidden');
                        document
                            .getElementById('changePwModal')
                            .classList.remove('hidden');
                    } else {
                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                })
                .catch((err) => {
                    alert('ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                    console.error(err);
                });
        };
    }

    document.getElementById('changePwBtn').onclick = function () {
        const newPw = document.getElementById('newPassword').value;
        const confirmPw = document.getElementById('confirmPassword').value;

        if (!newPw || !confirmPw || newPw !== confirmPw) {
            alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        apiFetch('/PWupdate_button', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ pw: newPw }),
        })
            .then(async (res) => {
                if (!res.ok) {
                    const errorText = await res.text();
                    alert(`ì„œë²„ ì˜¤ë¥˜ ${res.status}: ${errorText}`);
                    throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + res.status);
                }
                return res.json();
            })
            .then((data) => {
                if (data.updateStatus === true) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('changePwModal').classList.add('hidden');
                } else {
                    alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch((err) => {
                alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            });
    };
    document
        .getElementById('openPwModalBtn')
        ?.addEventListener('click', () => {
            document.getElementById('changePwModal').classList.remove('hidden');
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        });
    document.getElementById('close-btn').onclick = function () {
        document.getElementById('modalOverlay').classList.add('hidden');
    };
    document.getElementById('cancelChange').onclick = function () {
        document.getElementById('changePwModal').classList.add('hidden');
    };

    function goToTechTree() {
        const select = document.getElementById('techTreeSelect');
        const year = select.value;

        if (!TokenManager.get()){
            alert('ë¡œê·¸ì¸ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        if (!year) {
            alert('í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        apiFetch(`/tech_tree?year=${year}`, {
            method: 'GET',
        })
            .then((res) => {
                if (res.ok) return res.text();
                else throw new Error('Unauthorized');
            })
            .then((html) => {
                document.open();
                document.write(html);
                document.close();
            })
            .catch((err) => {
                console.error(err);
                window.location.href = '/';
            });
    }





    function toSemesterCode(semText){
        const m = String(semText).match(/(\d{4})\D*(1|2)\D*í•™ê¸°?/);
        return m ? `${m[1]}${m[2]}` : semText.replace(/\D/g,'');
    }
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));

    async function fetchLatestTimetableIdFromUserInfo(semesterCode,{tries=6,baseDelay=300}={}) {
        if (!semesterCode) throw new Error('semesterCodeê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        const termNum = Number(semesterCode);
        const headers = { 'Cache-Control': 'no-cache' };

        for (let i=0;i<tries;i++){
            const res = await apiFetch(`/userinfo?_=${Date.now()}`, { headers, cache:'no-store', credentials:'include' });
            if (res.ok){
                const u = await res.json();
                if (Array.isArray(u?.timetables)) {
                    const matches = u.timetables.filter(t=>Number(t.term)===termNum);
                    if (matches.length){
                        const tid = matches.reduce((max,t)=>{
                            const v = Number(t.timeTableId ?? t.timetableId ?? t.id);
                            return Number.isFinite(v) ? Math.max(max,v) : max;
                        }, 0);
                        if (tid) return tid;
                    }
                }
            }
            await sleep(baseDelay*(i+1));
        }
        return null;
    }

    async function createTimetableOnServer(semesterCode){
        const fd = new FormData();
        fd.append('semester', semesterCode);
        const res = await apiFetch('/addTimetable', {
            method:'POST',
            body: fd,
            credentials:'include',
        });
        const raw = await res.text();
        if (!res.ok) throw new Error(`addTimetable ì‹¤íŒ¨ (${res.status}): ${raw}`);
        try {
            const j = JSON.parse(raw);
            const directId = j.timeTableId ?? j.timetableId ?? j.id ?? j.data?.timeTableId ?? j.data?.id ?? null;
            if (directId) return Number(directId);
        } catch {}
        const tid = await fetchLatestTimetableIdFromUserInfo(semesterCode, { tries:8, baseDelay:250 });
        if (!tid) throw new Error('userinfoì—ì„œ timetableIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return tid;
    }

    /***********************
     * ì´ˆê¸° ë°”ì¸ë”©
     ***********************/
    document.addEventListener('DOMContentLoaded', async () => {
        try { await TokenManager.refresh(); } catch {}
        const isLoggedIn = !!TokenManager.get();

        const loginLink    = document.getElementById('loginLink');
        const logoutLink   = document.getElementById('logoutLink');
        const registerLink = document.querySelector('nav a[href="/Register"]');

        loginLink.style.display  = isLoggedIn ? 'none'  : 'inline';
        logoutLink.style.display = isLoggedIn ? 'inline': 'none';
        registerLink.style.display = isLoggedIn ? 'none':'inline';

        logoutLink?.addEventListener('click', (e) => {
            e.preventDefault();
            TokenManager.set(null);
            alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            location.href = '/';
        });

        populateSemesterSelectInline();
        document.getElementById('semesterSelectInline')?.addEventListener('change', onSemesterSelectInlineChange);

        if (isLoggedIn) {
            await loaduserinfo();
            await hydrateSemestersFromServer();
            await renderRepresentativeFromServer();
            await loadCredits();
        }
    });


    /** ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ê°±ì‹  */
    function populateSemesterSelectInline(){
        const select = document.getElementById('semesterSelectInline');
        if (!select) return;
        const prev = select.value;
        select.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'í•™ê¸°ë¥¼ ì„ íƒí•´ ì¶”ê°€';
        select.appendChild(placeholder);

        semesterOptions.forEach(sem=>{
            if (!selectedSemesters.includes(sem)){
                const opt = document.createElement('option');
                opt.value = sem; opt.textContent = sem;
                select.appendChild(opt);
            }
        });
        if ([...select.options].some(o=>o.value===prev)) select.value = prev;
        else select.value='';
    }

    /** í•™ê¸° ì„ íƒ â†’ ì„œë²„ì— ì‹œê°„í‘œ ìƒì„± â†’ ë¦¬ìŠ¤íŠ¸ ë°˜ì˜ */
    async function onSemesterSelectInlineChange(e){
        const semText = e.target.value;
        if (!semText) return;
        const semesterCode = toSemesterCode(semText);
        try {
            const tid = await createTimetableOnServer(semesterCode);
            timetableIdsBySemester[semesterCode] = tid;
            if (!selectedSemesters.includes(semText)) selectedSemesters.push(semText);
            renderSemesterList();
            populateSemesterSelectInline();
            e.target.value = '';
        } catch(err){
            console.error(err);
            alert(`ì‹œê°„í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜: ${err.message}`);
        }
    }

    /***********************
     * ì‚¬ìš©ì/ê³„ì • ê´€ë ¨
     ***********************/
    async function loaduserinfo(){
        apiFetch('/userinfo', { method:'GET',})
            .then(res=>{ if(!res.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨'); return res.json(); })
            .then(data=>{
                document.getElementById('userName').textContent = data.name;
                document.getElementById('studentId').textContent = data.email;
                UserId = data.userId ?? data.id ?? data.timetables?.[0]?.userId ?? null;
                if (!UserId) console.warn('userIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', data);
            })
            .catch(err=>{
                console.error(err);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
    }

    /***********************
     * ë„¤ë¹„ê²Œì´ì…˜/í™”ë©´ ë Œë”*/

        // â–¼ íŒŒì¼ ìƒë‹¨ ì „ì—­ì— í•œ ì¤„ ì¶”ê°€
    let _moreOpen = false;  // ë”ë³´ê¸° í¼ì¹¨ ìƒíƒœ (ì´ˆê¸°: ì ‘í˜ â†’ ëŒ€í‘œë§Œ ë³´ì„)

    function renderSemesterList() {
        const list = document.getElementById('semesterList');
        if (!list) return;

        // ì§„ì… ì‹œì—” ì ‘í˜ ìƒíƒœë¡œ ì´ˆê¸°í™” (ëŒ€í‘œë§Œ ë³´ì´ê²Œ)
        _moreOpen = false;
        list.innerHTML = '';

        // ëŒ€í‘œ/ë¹„ëŒ€í‘œ ë¶„ë¦¬
        const reps = [];
        const others = [];
        selectedSemesters.forEach(sem => {
            const term = toSemesterCode(sem);
            if (term === representativeTermCode) reps.push(sem);
            else others.push(sem);
        });

        // í•œ ì¤„ ìƒì„± ìœ í‹¸
        const makeRow = (sem, hidden) => {
            const termCode = toSemesterCode(sem);
            const tid = timetableIdsBySemester[termCode];

            const li = document.createElement('li');
            li.className = 'semester-item';
            li.dataset.term = termCode;              // í† ê¸€ìš©
            if (hidden) li.classList.add('hidden-semester');

            // ë‚´ìš©
            const nameSpan = document.createElement('span');
            nameSpan.className = 'semester-name';
            nameSpan.textContent = sem;

            const actions = document.createElement('div');
            actions.className = 'semester-actions';

            const delBtn = document.createElement('button');
            delBtn.className = 'del-btn';
            delBtn.title = 'ì‚­ì œ';
            delBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
           stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6l-2 14H7L5 6"></path>
        <path d="M10 11v6"></path>
        <path d="M14 11v6"></path>
      </svg>`;
            delBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                removeSemester(termCode, tid);
            });

            const label = document.createElement('label');
            label.className = 'rep-label';
            label.style.display = 'inline-flex';
            label.style.alignItems = 'center';
            label.style.gap = '6px';
            label.addEventListener('click', (e) => e.stopPropagation());

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.dataset.term = termCode; // ì²´í¬ë°•ìŠ¤ í•´ì œ
            cb.checked = (termCode === representativeTermCode);
            cb.onchange = (e) => onToggleRepresentative(termCode, e.target.checked);

            const labTxt = document.createElement('span');
            labTxt.textContent = 'ëŒ€í‘œ';

            label.appendChild(cb);
            label.appendChild(labTxt);

            actions.appendChild(delBtn);
            actions.appendChild(label);

            // í´ë¦­ ì‹œ ëª¨ë‹¬ ì—´ê¸°
            li.addEventListener('click', () => openScheduleModal(sem));

            li.appendChild(nameSpan);
            li.appendChild(actions);
            list.appendChild(li);
        };

        // 1) ëŒ€í‘œ ë¨¼ì € ë…¸ì¶œ (í•­ìƒ í‘œì‹œ)
        reps.forEach(sem => makeRow(sem, false));

        // 2) ë‚˜ë¨¸ì§€ëŠ” ê¸°ë³¸ ìˆ¨ê¹€ (ë”ë³´ê¸° ì „)
        others.forEach(sem => makeRow(sem, true));

        // --- ë”ë³´ê¸° ë²„íŠ¼ ì²˜ë¦¬ ---
        // ê¸°ì¡´ ë²„íŠ¼ ì œê±°
        const oldBtn = document.getElementById('showMoreBtn');
        if (oldBtn) oldBtn.remove();

        if (others.length > 0) {
            const btn = document.createElement('button');
            btn.id = 'showMoreBtn';
            btn.textContent = `ë”ë³´ê¸° (${others.length})`;

            btn.onclick = () => {
                _moreOpen = !_moreOpen;
                // ëŒ€í‘œ ì™¸ í•­ëª©ë“¤ì„ í† ê¸€
                list.querySelectorAll('.semester-item').forEach(li => {
                    const term = li.dataset.term;
                    const isRep = (term === representativeTermCode);
                    if (!isRep) {
                        li.classList.toggle('hidden-semester', !_moreOpen);
                    }
                });
                btn.textContent = _moreOpen ? 'ì ‘ê¸°' : `ë”ë³´ê¸° (${others.length})`;
            };

            // ë¦¬ìŠ¤íŠ¸ ë°”ë¡œ ì•„ë˜ì— ë²„íŠ¼ ë¶€ì°©
            // (box1 ì•ˆì˜ <ul id="semesterList"> ë‹¤ìŒì— ë²„íŠ¼ì´ ì˜¤ë„ë¡)
            list.insertAdjacentElement('afterend', btn);
        }
    }



    /** ëª¨ë‹¬ ì˜¤í”ˆ (ê·¸ë¦¬ë“œ ì „ìš©) */
    async function openScheduleModal(semester){
        const modal = document.getElementById('scheduleModal');
        const title = document.getElementById('modalSemesterTitle');
        const container = document.getElementById('scheduleTableContainer');
        const listContainer = document.getElementById('classInfoList');

        currentSemesterCode = toSemesterCode(semester);
        currentTimetableId = timetableIdsBySemester[currentSemesterCode] ?? null;
        if (!currentTimetableId){
            alert('ì´ í•™ê¸°ì˜ ì‹œê°„í‘œ IDê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € "ì‹œê°„í‘œ ì¶”ê°€"ì—ì„œ í•™ê¸°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.');
            return;
        }

        // âœ… ë‹«ê¸° ì‹œ ë™ê¸°í™” (ë²„íŠ¼)
        document.getElementById('closeScheduleModal').onclick = async function(){
            document.getElementById('scheduleModal').classList.add('hidden');
            document.body.classList.remove('modal-open');
            hideCourseTooltip?.();

            try {
                await renderRepresentativeFromServer();
                await hydrateSemestersFromServer();
            } catch(e) {
                console.warn('ëŒ€í‘œ ì‹œê°„í‘œ ë™ê¸°í™” ì‹¤íŒ¨:', e);
            }
        };

        // âœ… ë‹«ê¸° ì‹œ ë™ê¸°í™” (ì˜¤ë²„ë ˆì´ í´ë¦­ìœ¼ë¡œ ë‹«ëŠ” ê²½ìš°ê¹Œì§€ ì»¤ë²„í•˜ê³  ì‹¶ë‹¤ë©´)
        modal.addEventListener('click', async (e) => {
            if (e.target === modal) { // ì˜¤ë²„ë ˆì´ ì˜ì—­ í´ë¦­
                modal.classList.add('hidden');
                document.body.classList.remove('modal-open');
                hideCourseTooltip?.();
                try {
                    await renderRepresentativeFromServer();
                    await hydrateSemestersFromServer();
                } catch(e) {
                    console.warn('ëŒ€í‘œ ì‹œê°„í‘œ ë™ê¸°í™” ì‹¤íŒ¨:', e);
                }
            }
        }, { once: true });


        title.textContent = semester;
        container.innerHTML = generateModalGridSpanTable(); // ê·¸ë¦¬ë“œ ìƒì„±

        const modalGrid = document.getElementById('modalGridSpanBody');
        if (modalGrid){
            modalGrid.style.display='grid';
            modalGrid.style.gridAutoFlow='row dense';
            modalGrid.style.alignContent='start';
            modalGrid.style.justifyContent='stretch';
            modalGrid.style.gridAutoRows='52px';
            if (!modalGrid.__previewClearBound){
                modalGrid.addEventListener('click', ()=>{ removePreviewFromSchedule(); });
                modalGrid.__previewClearBound = true;
            }
        }

        listContainer.innerHTML = '<p>ìˆ˜ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
        modal.classList.remove('hidden');
        document.body.classList.add('modal-open');

        // 1) í˜„ì¬ ì‹œê°„í‘œ â†’ ìŠ¬ë¡¯ìœ¼ë¡œ ë Œë”
        apiFetch('/getTC', {
            method:'POST',
            headers:{ 'Content-Type':'application/json',},
            body: JSON.stringify(UserId),
        })
            .then(res=>{ if(!res.ok) throw new Error('ì‹œê°„í‘œ ì¡°íšŒ ì‹¤íŒ¨'); return res.json(); })
            .then(async (allRows)=>{
                const filtered = (allRows||[]).filter(r => {
                    const tid = getTid(r);
                    return Number.isFinite(tid) && tid === Number(currentTimetableId);
                });
                const courseIds = Array.from(new Set(
                    filtered.map(getCourseId).filter(v=>v!=null && String(v).trim()!=='')
                ));
                if (courseIds.length === 0) return;
                const slotRes = await apiFetch('/getTS2TE', {
                    method:'POST',
                    headers:{ 'Content-Type':'application/json',},
                    body: JSON.stringify({ getScheduleIds: courseIds }),
                });
                if (!slotRes.ok) throw new Error('ìŠ¬ë¡¯ ì¡°íšŒ ì‹¤íŒ¨');
                const slotData = await slotRes.json();
                renderScheduleFromTS2TE(slotData);
            })
            .catch(err=>console.error('getTC/ìŠ¬ë¡¯ ë¡œë“œ ì˜¤ë¥˜:', err));

        // 2) ìˆ˜ì—… ëª©ë¡
        apiFetch('/a')
            .then(res=>res.json())
            .then(data=>{
                currentCourseList = data;
                renderCourseList(data);
                attachCellEvents();
            })
            .catch(err=>{
                listContainer.innerHTML = `<p style="color:red;">ìˆ˜ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
                console.error(err);
            });

        // ì €ì¥ ë²„íŠ¼
        const saveBtn = document.getElementById('saveSchedule');
        saveBtn.replaceWith(saveBtn.cloneNode(true));
        document.getElementById('saveSchedule').addEventListener('click', onClickSaveSchedule);
    }


    function renderScheduleFromTS2TE(scheduleData){
        const grid = document.getElementById('modalGridSpanBody');
        if (!grid || !Array.isArray(scheduleData)) return;

        // âœ… 0êµì‹œê°€ í•˜ë‚˜ë¼ë„ ìˆìœ¼ë©´ ë¨¼ì € 0êµì‹œ í–‰ì„ ë§Œë“ ë‹¤
        const hasZero = scheduleData.some(it => {
            const s = Number(it.time_start ?? it.timeStart ?? it.periodStart);
            const e = Number(it.time_end   ?? it.timeEnd   ?? it.periodEnd ?? s);
            return s === 0 || e === 0;
        });
        if (hasZero) prependZeroPeriodGrid(grid);

        // âœ… í•„ìš”í•œ ìµœëŒ€ êµì‹œ ìˆ˜ë§Œí¼ ì•„ë˜ë¡œ í™•ì¥
        let needMax = 9;
        scheduleData.forEach(it => {
            const e = Number(it.time_end ?? it.timeEnd ?? it.periodEnd ?? it.time_start ?? it.timeStart);
            if (Number.isFinite(e)) needMax = Math.max(needMax, e);
        });
        ensureModalGridSpanMax(needMax);

        scheduleData.forEach(item=>{
            const subject    = item.courseName || '';
            const professor  = item.professorName || '';
            const classroom  = item.classroom || '';
            const courseCode = item.identify_number_of_course ?? item.identifyNumberOfCourse ?? item.courseCode ?? subject;

            const dayIdx = toPeriodNumber(item.day, 0) - 1;
            const pStart = toPeriodNumber(item.time_start ?? item.timeStart ?? item.periodStart, null);
            const pEnd   = toPeriodNumber(item.time_end   ?? item.timeEnd   ?? item.periodEnd ?? pStart, null);
            if (dayIdx < 0 || pStart == null || pEnd == null) return;

            // âœ… ì½”ìŠ¤ PK í›„ë³´ í‚¤ (ì‹œê°„í‘œ id/ë§¤í•‘í–‰ idëŠ” ì ˆëŒ€ ë„£ì§€ ì•ŠìŒ)
            const coursePk = item.courseId;

            const color = ColorManager.get(courseCode);
            const block = document.createElement('div');
            block.className = 'course-block busy';
            block.style.gridColumn = String(dayIdx + 2);
            const startRow = gridRowForPeriod(grid, pStart);
            const endRow   = gridRowForPeriod(grid, pEnd) + 1;
            block.style.gridRow = `${startRow} / ${endRow}`;
            block.style.setProperty('--course-color', color);

            // âœ… data-* ì‹¬ê¸°
            block.dataset.courseId = courseCode;
            if (coursePk != null) block.dataset.coursePk = String(coursePk);

            block.innerHTML = renderSlotHTML(subject, classroom, professor);

            block.onmouseenter = () => showCourseTooltip(block, {
                courseName: subject, professorName: professor, classroom,
                credit: item.credit ?? '-', majorOrCulture: item.majorOrCulture ?? null,
                scheduleDay: dayIdx + 1, timeStart: pStart, timeEnd: pEnd,
                identifyNumberOfCourse: courseCode
            });
            block.onmouseleave = hideCourseTooltip;

            grid.appendChild(block);

            // âœ… placeholderì—ë„ PK/ì½”ë“œ ì‹¬ê¸° (ì €ì¥ ì‹œ ìˆ˜ì§‘ë  ìˆ˜ ìˆê²Œ)
            for (let p = pStart; p <= pEnd; p++) {
                const ph = grid.querySelector(`.cell-placeholder[data-day="${dayIdx}"][data-period="${p}"]`);
                if (ph){
                    ph.setAttribute('data-course-id', courseCode);
                    if (coursePk != null) ph.setAttribute('data-course-pk', String(coursePk));
                    ph.style.borderBottom = 'none';
                }
            }
        });

        attachCellEvents();
    }


    /***********************
     * ìˆ˜ì—… ë¦¬ìŠ¤íŠ¸ & í”„ë¦¬ë·°/ì¶”ê°€ (ê·¸ë¦¬ë“œ ì „ìš©)
     ***********************/
    function renderCourseList(classList){
        const listContainer = document.getElementById('classInfoList');
        listContainer.innerHTML = '';

        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput?.value?.toLowerCase() || '';

        if (!Array.isArray(classList) || classList.length === 0){
            listContainer.innerHTML = '<p>ìˆ˜ì—… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        const grouped = groupByCourse(classList);
        Object.entries(grouped).forEach(([courseName, allEntries])=>{
            if (searchTerm && !courseName.toLowerCase().includes(searchTerm)) return;

            const wrapper = document.createElement('div');
            wrapper.style.marginBottom='12px';
            wrapper.style.border='1px solid #ccc';
            wrapper.style.borderRadius='6px';
            wrapper.style.background='#f9f9f9';
            wrapper.style.padding='10px';

            const header = document.createElement('div');
            header.style.cursor='pointer';
            header.style.fontWeight='bold';
            header.style.color='#2563eb';
            header.textContent = courseName;

            const subList = document.createElement('div');
            subList.style.display='none';
            subList.style.marginTop='8px';

            const groupedByIdentify = {};
            allEntries.forEach(e=>{
                const key = e.identifyNumberOfCourse;
                (groupedByIdentify[key] ||= []).push(e);
            });

            Object.values(groupedByIdentify).forEach(entries=>{
                const detail = document.createElement('div');
                detail.style.padding='6px 10px';
                detail.style.borderTop='1px solid #ddd';
                detail.style.cursor='pointer';
                detail.style.background='#fff';

                const professor = entries[0].professorName || '-';
                const code = entries[0]?.identifyNumberOfCourse ?? '';
                const division = (typeof code === 'string' && code.includes('-')) ? code.split('-')[1] : '?';
                const weekdayNames = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
                const timeText = entries.map(e=>{
                    const day = weekdayNames[e.scheduleDay - 1] || `ìš”ì¼ ${e.scheduleDay}`;
                    return e.timeStart === e.timeEnd ? `${day} ${e.timeStart}êµì‹œ` : `${day} ${e.timeStart}~${e.timeEnd}êµì‹œ`;
                }).join(', ');

                detail.innerHTML = `ë¶„ë°˜: ${division}<br>êµìˆ˜: ${professor}<br>ì‹œê°„: ${timeText}`;

                detail.addEventListener('mouseover', ()=>{
                    if (!isCoursePermanentlyAddedGrid(entries)) previewCourseOnGrid(entries);
                });
                detail.addEventListener('mouseout', ()=>{
                    if (!isCoursePermanentlyAddedGrid(entries)) removePreviewFromSchedule();
                });
                detail.addEventListener('click', ()=>{
                    addCourseToScheduleTableGrid(entries); // í† ê¸€
                });

                subList.appendChild(detail);
            });

            header.addEventListener('click', ()=>{
                subList.style.display = (subList.style.display==='none') ? 'block' : 'none';
            });

            wrapper.appendChild(header);
            wrapper.appendChild(subList);
            listContainer.appendChild(wrapper);
        });
    }

    function groupByCourse(data){
        const map = {};
        data.forEach(e=>{
            const key = e.courseName;
            (map[key] ||= []).push(e);
        });
        return map;
    }

    const FIXED_PREVIEW_COLOR = 'rgba(99, 179, 237, 0.25)';

    /** í˜„ì¬ ëª¨ë‹¬ ê·¸ë¦¬ë“œì— ì´ë¯¸ ì˜êµ¬ ë°°ì¹˜ëëŠ”ì§€ ê²€ì‚¬ */
    function isCoursePermanentlyAddedGrid(entries){
        const grid = document.getElementById('modalGridSpanBody');
        if (!grid || !entries?.length) return false;
        const code = entries[0].identifyNumberOfCourse;
        return !!grid.querySelector(`.course-block[data-course-id="${code}"]`);
    }

    /** í”„ë¦¬ë·°(ê·¸ë¦¬ë“œ) */
    function previewCourseOnGrid(entries){
        const grid = document.getElementById('modalGridSpanBody');
        if (!grid || !entries?.length) return;

        // ê¸°ì¡´ í”„ë¦¬ë·° ì œê±°
        grid.querySelectorAll('.preview-block').forEach(b=>b.remove());

        // 0êµì‹œ í•„ìš” ì‹œ prepend
        const needsZero = entries.some(e => Number(e.timeStart)===0 || Number(e.timeEnd)===0);
        if (needsZero) prependZeroPeriodGrid(grid);

        // ì•„ë˜ë¡œ í™•ì¥
        let needMax = 9;
        entries.forEach(e=>{
            const end = Number(e.timeEnd ?? e.periodEnd ?? e.timeStart);
            if (Number.isFinite(end)) needMax = Math.max(needMax, end);
        });
        ensureModalGridSpanMax(needMax);

        // ìš”ì¼ë³„ ë³‘í•© í›„ í”„ë¦¬ë·° ë¸”ë¡ ìƒì„±
        const byDay = {};
        entries.forEach(e=>{
            const d = N(e.scheduleDay,0)-1;
            const s = N(e.timeStart ?? e.periodStart, null);
            const t = N(e.timeEnd   ?? e.periodEnd   ?? e.timeStart, null);
            if (!(d>=0 && d<5) || !Number.isFinite(s) || !Number.isFinite(t)) return;
            (byDay[d] ||= []).push([s,t]);
        });

        Object.entries(byDay).forEach(([dStr, ranges])=>{
            const d = Number(dStr);
            ranges.sort((a,b)=>a[0]-b[0]);
            const merged = [];
            let cur=null;
            for (const [s,t] of ranges){
                if (!cur) cur=[s,t];
                else if (s <= cur[1]+1) cur[1] = Math.max(cur[1], t);
                else { merged.push(cur); cur=[s,t]; }
            }
            if (cur) merged.push(cur);

            merged.forEach(([s,t])=>{
                const block = document.createElement('div');
                block.className='course-block preview-block';
                block.style.gridColumn = String(d+2);
                const startRow = gridRowForPeriod(grid, s);
                const endRow   = gridRowForPeriod(grid, t) + 1;
                block.style.gridRow = `${startRow} / ${endRow}`;
                const base = entries[0];
                block.innerHTML = renderSlotHTML(base.courseName, base.classroom, base.professorName || '');
                // ì—°í•œ í”„ë¦¬ë·° ë°°ê²½
                block.style.background = FIXED_PREVIEW_COLOR;
                grid.appendChild(block);
            });
        });

        previewSession.zeroAdded ||= needsZero;
    }

    /** í”„ë¦¬ë·° ì œê±°(ê·¸ë¦¬ë“œ) */
    function removePreviewFromSchedule(){
        const grid = document.getElementById('modalGridSpanBody');
        if (grid){
            grid.querySelectorAll('.preview-block').forEach(b=>b.remove());
            if (previewSession.zeroAdded){
                removeZeroPeriodGridIfEmpty(grid);
                previewSession.zeroAdded = false;
            }
        }
    }

    /** ì‹¤ì œ ì¶”ê°€/í† ê¸€(ê·¸ë¦¬ë“œ) */
    function addCourseToScheduleTableGrid(entries){
        const grid = document.getElementById('modalGridSpanBody');
        if (!grid || !entries?.length) return;

        removePreviewFromSchedule();

        const needsZero = entries.some(e => Number(e.timeStart) === 0 || Number(e.timeEnd) === 0);
        if (needsZero) prependZeroPeriodGrid(grid);

        const courseName = entries[0].courseName;
        const classroom  = entries[0].classroom;
        const professor  = entries[0].professorName || '';
        const courseCode = String(entries[0].identifyNumberOfCourse ?? '');
        // âœ… PKë¥¼ í•­ìƒ courseIdë¡œ í†µì¼
        const coursePk   = entries[0].courseId != null ? String(entries[0].courseId) : null;

        console.log('[pick]', { courseName, courseCode, coursePk });

        // âœ… ë™ì¼ ê³¼ëª©(+ê°™ì€ PKë©´ PKë„) í† ê¸€.
        //    ê¸°ì¡´ì— PK ì—†ì´ ë“¤ì–´ê°„ ë¸”ë¡ë„ ì§€ìš¸ ìˆ˜ ìˆë„ë¡ not([data-course-pk])ë„ í¬í•¨
        const selectorByCode = `.course-block[data-course-id="${courseCode}"]`;
        const existingExact = coursePk != null
            ? grid.querySelectorAll(`${selectorByCode}[data-course-pk="${coursePk}"], ${selectorByCode}:not([data-course-pk])`)
            : grid.querySelectorAll(selectorByCode);

        if (existingExact.length){
            existingExact.forEach(b => b.remove());

            // placeholderë„ ë™ì¼ ë¡œì§ìœ¼ë¡œ ê±·ì–´ë‚´ê¸°
            const phSelBase = `.cell-placeholder[data-course-id="${courseCode}"]`;
            const phSel = coursePk != null
                ? `${phSelBase}[data-course-pk="${coursePk}"], ${phSelBase}:not([data-course-pk])`
                : phSelBase;

            grid.querySelectorAll(phSel).forEach(ph=>{
                ph.removeAttribute('data-course-id');
                ph.removeAttribute('data-course-pk');
                ph.style.borderBottom = '';
            });

            ColorManager.free(courseCode || courseName);
            removeZeroPeriodGridIfEmpty(grid);
            return;
        }

        // ... (ì•„ë˜ ì›ë˜ ë¡œì§ ê·¸ëŒ€ë¡œ, ë‹¤ë§Œ ìƒì„± ì‹œì—ë„ coursePkë¥¼ ì‹¬ì–´ì¤ë‹ˆë‹¤)
        const byDay = {};
        entries.forEach(e=>{
            const d = toPeriodNumber(e.scheduleDay,0)-1;
            const s = toPeriodNumber(e.timeStart ?? e.periodStart, null);
            const t = toPeriodNumber(e.timeEnd   ?? e.periodEnd   ?? e.timeStart, null);
            if (d<0 || s==null || t==null) return;
            (byDay[d] ||= []).push([s,t]);
        });

        const mergedByDay = {};
        Object.entries(byDay).forEach(([dStr, ranges])=>{
            const d = Number(dStr);
            ranges.sort((a,b)=>a[0]-b[0]);
            let cur=null, merged=[];
            for (const [s,t] of ranges){
                if (!cur) cur=[s,t];
                else if (s <= cur[1]+1) cur[1] = Math.max(cur[1], t);
                else { merged.push(cur); cur=[s,t]; }
            }
            if (cur) merged.push(cur);
            mergedByDay[d] = merged;
        });

        // ê²¹ì¹¨ ê²€ì‚¬ (ê·¸ëŒ€ë¡œ)
        for (const [dStr, merged] of Object.entries(mergedByDay)){
            const d = Number(dStr);
            for (const [s, t] of merged){
                for (let p=s; p<=t; p++){
                    const ph = grid.querySelector(`.cell-placeholder[data-day="${d}"][data-period="${p}"]`);
                    if (!ph) continue;
                    const occId = ph.getAttribute('data-course-id');
                    const occPk = ph.getAttribute('data-course-pk');
                    const sameId = occId && occId === courseCode;
                    const samePk = (coursePk == null) ? true : (occPk === coursePk);
                    const occupiedByOthers = occId && !(sameId && samePk);
                    if (occupiedByOthers){
                        alert('ì´ë¯¸ ë°°ì¹˜ëœ ìˆ˜ì—… ì‹œê°„ê³¼ ê²¹ì³ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                        return;
                    }
                }
            }
        }

        // ì‹¤ì œ ë°°ì¹˜ (PK ì‹¬ê¸° í†µì¼)
        const color = ColorManager.get(courseCode || courseName);
        Object.entries(mergedByDay).forEach(([dStr, merged])=>{
            const d = Number(dStr);
            merged.forEach(([s,t])=>{
                const block = document.createElement('div');
                block.className = 'course-block busy';
                block.style.gridColumn = String(d+2);
                const startRow = gridRowForPeriod(grid, s);
                const endRow   = gridRowForPeriod(grid, t) + 1;
                block.style.gridRow = `${startRow} / ${endRow}`;
                block.style.setProperty('--course-color', color);

                block.dataset.courseId = courseCode;
                if (coursePk != null) block.dataset.coursePk = coursePk; // âœ… í†µì¼

                block.innerHTML = renderSlotHTML(courseName, classroom, professor);
                block.onmouseenter = () => showCourseTooltip(block, {
                    courseName, professorName: professor, classroom,
                    scheduleDay: d+1, timeStart: s, timeEnd: t, identifyNumberOfCourse: courseCode
                });
                block.onmouseleave = hideCourseTooltip;
                grid.appendChild(block);

                for (let p=s; p<=t; p++){
                    const ph = grid.querySelector(`.cell-placeholder[data-day="${d}"][data-period="${p}"]`);
                    if (ph){
                        ph.setAttribute('data-course-id', courseCode);
                        if (coursePk != null) ph.setAttribute('data-course-pk', coursePk); // âœ… í†µì¼
                        ph.style.borderBottom = 'none';
                    }
                }
            });
        });
    }


    /***********************
     * íˆ´íŒ & ì…€ ì´ë²¤íŠ¸
     ***********************/
    function attachCellEvents(){
        const grid = document.getElementById('modalGridSpanBody');
        if (!grid) return;

        // placeholder hover â†’ ì ìœ ëœ ì…€ë§Œ íˆ´íŒ
        grid.querySelectorAll('.cell-placeholder[data-period]').forEach(cell=>{
            cell.onmouseover = () => {
                const courseId = cell.getAttribute('data-course-id');
                if (!courseId) return;
                const info = currentCourseList.find(c => c.identifyNumberOfCourse === courseId);
                if (info) showCourseTooltip(cell, info);
            };
            cell.onmouseout = hideCourseTooltip;
        });

        // ë°°ì¹˜ëœ ë¸”ë¡ hover
        grid.querySelectorAll('.course-block').forEach(block=>{
            const courseId = block.getAttribute('data-course-id');
            const info = currentCourseList.find(c => c.identifyNumberOfCourse === courseId);
            if (info){
                block.onmouseenter = () => showCourseTooltip(block, info);
                block.onmouseleave = hideCourseTooltip;
            }
        });
    }

    function showCourseTooltip(anchor, courseInfo){
        hideCourseTooltip();
        const tooltip = document.createElement('div');
        tooltip.className = 'course-tooltip';
        tooltip.style.position='absolute';
        tooltip.style.zIndex=2000;
        tooltip.style.minWidth='180px';
        tooltip.style.maxWidth='260px';
        tooltip.style.background='#ffffffcc';
        tooltip.style.border='1px solid #2563eb';
        tooltip.style.borderRadius='10px';
        tooltip.style.boxShadow='0 4px 18px rgba(30,80,210,0.13)';
        tooltip.style.padding='14px 18px 14px 14px';
        tooltip.style.fontSize='0.98rem';
        tooltip.style.pointerEvents='none';
        tooltip.innerHTML = `
    <b>${courseInfo.courseName}(${
            courseInfo.identifyNumberOfCourse
                ? courseInfo.identifyNumberOfCourse.split('-')[1]|| '-'
                : '-'
        })</b>
    <br>êµìˆ˜: ${courseInfo.professorName || '-'}
    <br>ì´ë©”ì¼:
    <br>ê°•ì˜ì‹¤: ${courseInfo.classroom}
    <br>êµ¬ë¶„: ${courseInfo.majorOrCulture ? 'êµì–‘' : 'ì „ê³µ'}
    <br>í•™ì : ${courseInfo.credit}
    <br>í•™ìˆ˜ë²ˆí˜¸: ${courseInfo.identifyNumberOfCourse}
  `;
        document.body.appendChild(tooltip);

        const rect = anchor.getBoundingClientRect();
        tooltip.style.left = rect.right + 8 + 'px';
        tooltip.style.top  = rect.top + window.scrollY + 'px';
    }
    function hideCourseTooltip(){ document.querySelector('.course-tooltip')?.remove(); }

    /***********************
     * ì €ì¥
     ***********************/
    function getSelectedClassIds(){
        const root = document.getElementById('modalGridSpanBody') || document;
        const idSet = new Set();

        // 1) DOMì— data-course-pkê°€ ìˆìœ¼ë©´ ê·¸ê²Œ ìµœìš°ì„ 
        root.querySelectorAll('.course-block[data-course-pk], .cell-placeholder[data-course-pk]')
            .forEach(el=>{
                const pk = Number(el.getAttribute('data-course-pk'));
                if (Number.isInteger(pk) && pk > 0) idSet.add(pk);
            });
        if (idSet.size) return Array.from(idSet);

        // 2) ì—†ìœ¼ë©´ ì½”ë“œë¡œ ë§¤í•‘
        const codes = new Set();
        root.querySelectorAll('[data-course-id]').forEach(el=>{
            const c = el.getAttribute('data-course-id');
            if (c) codes.add(c);
        });
        if (!codes.size) return [];

        // âœ… ì—¬ê¸°ì„œ â€˜ì½”ìŠ¤ PKâ€™ë§Œ íƒìƒ‰ (ì‹œê°„í‘œ/ì¡°ì¸ í…Œì´ë¸” idëŠ” ì œì™¸)
        const pkKeys = [
            'courseId' // ì„œë²„ ì‹¤ì œ ìŠ¤í‚¤ë§ˆì— ë§ì¶° ë‘ë˜,
        ];

        currentCourseList.forEach(e=>{
            const code = e.identifyNumberOfCourse ?? e.identify_number_of_course ?? e.courseCode ?? null;
            if (!code || !codes.has(String(code))) return;
            for (const k of pkKeys){
                const n = Number(e?.[k]);
                if (Number.isInteger(n) && n > 0){ idSet.add(n); break; }
            }
        });

        return Array.from(idSet);
    }


    // â¬‡ï¸ ì´ë¯¸ ì´ ì‹œê°„í‘œì— ì €ì¥ëœ courseId(ìˆ«ì PK)ë“¤ì„ ë°›ì•„ì˜¤ê¸°
    async function fetchExistingCourseIdsByTimetable(timetableId){
        const res = await apiFetch('/getTC', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', },
            body: JSON.stringify(UserId),
        });
        if (!res.ok) throw new Error('ê¸°ì¡´ ê³¼ëª© ì¡°íšŒ ì‹¤íŒ¨');
        const rows = await res.json();

        const list = (rows||[]).filter(r=>{
            const tid = Number(r.timeTableId ?? r.timetableId ?? r.time_table_id ?? r.timetable_id);
            return Number.isFinite(tid) && tid === Number(timetableId);
        });

        // âœ… ì½”ìŠ¤ PKë§Œ ì¶”ì¶œ
        const ids = new Set();
        const pkKeys = ['courseId']; // ì„œë²„ì— ë§ì¶° ì¡°ì •
        list.forEach(r=>{
            for (const k of pkKeys){
                const n = Number(r?.[k]);
                if (Number.isInteger(n) && n > 0){ ids.add(n); break; }
            }
        });
        return ids;
    }

    async function onClickSaveSchedule() {
        try {
            if (!currentTimetableId) {
                currentTimetableId = timetableIdsBySemester[currentSemesterCode] ?? null;
            }
            if (!currentTimetableId) throw new Error('timetableIdê°€ ì—†ìŠµë‹ˆë‹¤.');

            const selectedCodes = collectSelectedCourseCodes();
            if (!selectedCodes.length) {
                alert('ì €ì¥í•  ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const allCourseIds = mapCodesToCourseIds(selectedCodes);
            if (!allCourseIds.length) {
                alert('í™”ë©´ì˜ ê³¼ëª©ë“¤ì—ì„œ courseIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                return;
            }

            const payload = {
                timetableId: Number(currentTimetableId),
                courseIds: allCourseIds,
            };

            const res = await apiFetch('/addTC', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload),
            });

            if (!res.ok) {
                const txt = await res.text();
                throw new Error(`ì €ì¥ ì‹¤íŒ¨: ${txt || ('HTTP ' + res.status)}`);
            }

            alert('ì €ì¥ ì™„ë£Œ!');
            await renderRepresentativeFromServer();
            await hydrateSemestersFromServer();
        } catch (err) {
            console.error('[addTC] Exception:', err);
            alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜: ${err.message}`);
        }
    }



    /***********************
     * ëŒ€í‘œ ì‹œê°„í‘œ ë Œë”
     ***********************/
    function getTid(r){
        const v = r.timeTableId ?? r.timetableId ?? r.time_table_id ?? r.timetable_id ?? r.parentTimetableId ?? r.timeTableIdOfParent ?? r.tid;
        return v != null ? Number(v) : NaN;
    }
    function getCourseId(r){
        return (r.courseId ?? r.identifyNumberOfCourse ?? r.subjectCode ?? r.course_id ?? null);
    }
    function isTruthyTag(tag){
        if (tag === true || tag === 1) return true;
        if (tag === false || tag === 0) return false;
        if (typeof tag === 'string'){
            const t = tag.trim().toLowerCase();
            if (t==='t'||t==='true'||t==='1'||t==='y'||t==='yes') return true;
            if (t==='f'||t==='false'||t==='0'||t==='n'||t==='no') return false;
        }
        return !!tag;
    }
    function pickTimetableArray(obj){
        if (!obj || typeof obj !== 'object') return [];
        const candidates = Object.values(obj).filter(Array.isArray);
        return candidates.find(arr => arr.some(r => r && typeof r==='object' && ('timetableId' in r || 'id' in r) && ('tag' in r || 'term' in r))) || [];
    }
    function toSemesterName(termCode){
        const s = String(termCode||''); const year = s.slice(0,4); const sem = s.slice(4);
        const label = sem==='1' ? '1í•™ê¸°' : sem==='2' ? '2í•™ê¸°' : '';
        return (year && label) ? `${year}ë…„ ${label}` : 'ëŒ€í‘œ ì‹œê°„í‘œ';
    }

    async function hydrateSemestersFromServer(){
        try{
            const res = await apiFetch('/tableId_List', { method:'GET',credentials:'include' });
            if (!res.ok) throw new Error(`ì‹œê°„í‘œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (HTTP ${res.status})`);
            const data = await res.json();
            const list = pickTimetableArray(data);
            if (!Array.isArray(list) || list.length===0) return;

            selectedSemesters = [];
            timetableIdsBySemester = {};

            for (const row of list){
                const term = String(row.term ?? row['term'] ?? '');
                const tid  = Number(row.timeTableId ?? row['timetableId'] ?? row.id);
                const tagVal = row.tag ?? row['tag'];
                if (isTruthyTag(tagVal)) representativeTermCode = term;

                if (!term || !tid) continue;
                timetableIdsBySemester[term] = tid;
                const semText = toSemesterName(term);
                if (!selectedSemesters.includes(semText)) selectedSemesters.push(semText);
            }
            renderSemesterList();
            populateSemesterSelectInline();
        } catch(err){
            console.error('hydrateSemestersFromServer ì˜¤ë¥˜:', err);
        }
    }

    async function removeSemester(termCode, timetableId){
        if (!Number.isInteger(timetableId)){
            alert('ìœ íš¨í•œ timetableIdê°€ í•„ìš”í•©ë‹ˆë‹¤.'); return;
        }
        if (!confirm('ì´ í•™ê¸°ì˜ ì‹œê°„í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;
        try{
            const res = await apiFetch('/deleteTimetable', {
                method:'POST',
                headers:{ 'Content-Type':'application/json',},
                body: JSON.stringify(timetableId),
            });
            const txt = await res.text();
            if (!res.ok) throw new Error(`ì‚­ì œ ì‹¤íŒ¨: ${txt}`);

            const semText = toSemesterName(termCode);
            selectedSemesters = selectedSemesters.filter(s=>s!==semText);
            delete timetableIdsBySemester[termCode];
            renderSemesterList();
            populateSemesterSelectInline();
            alert('ì‹œê°„í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch(err){
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            console.error(err);
        }
    }

    async function onToggleRepresentative(termCode, checked) {

        // í•´ë‹¹ í•™ê¸°ì˜ timetableId ì°¾ê¸°
        const tid = timetableIdsBySemester?.[termCode] ?? (await fetchLatestTimetableIdFromUserInfo(termCode));
        if (!tid) {
            alert('timetableIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            renderSemesterList();
            return;
        }

        try {
            const fd = new FormData();
            fd.append('timetableId', String(tid));
            fd.append('active', String(!!checked));

            const res = await apiFetch('/representative_Timetable', {
                method: 'POST',
                body: fd,
            });

            if (!res.ok) {
                const msg = await res.text();
                throw new Error(msg || 'ëŒ€í‘œ ì„¤ì • ì‹¤íŒ¨');
            }

            // âœ… ì„±ê³µ í›„ UI ë°˜ì˜
            if (checked) {
                representativeTermCode = termCode; // ëŒ€í‘œ ì§€ì •
                alert('ëŒ€í‘œ ì‹œê°„í‘œë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                representativeTermCode = null; // ëŒ€í‘œ í•´ì œ
                alert('ëŒ€í‘œ ì‹œê°„í‘œê°€ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }

            // âœ… ë¦¬ìŠ¤íŠ¸/ëŒ€í‘œë·° ëª¨ë‘ ê°±ì‹  (UI ì²´í¬ë°•ìŠ¤ ìƒíƒœë„ ê°±ì‹ ë¨)
            await hydrateSemestersFromServer();
            await renderRepresentativeFromServer();
            renderSemesterList();

        } catch (err) {
            alert('ëŒ€í‘œ ì„¤ì • ì¤‘ ì˜¤ë¥˜: ' + err.message);

            // â— ì—ëŸ¬ ì‹œ ì²´í¬ë°•ìŠ¤ ìƒíƒœë¥¼ ì›ë˜ëŒ€ë¡œ ë˜ëŒë¦¬ê¸°
            const cb = document.querySelector(`.rep-label input[type="checkbox"][data-term="${termCode}"]`);
            if (cb) cb.checked = !checked;
        }
    }



    async function loadRepresentativeSchedule(getScheduleIds){
        try{
            const res = await apiFetch('/getTS2TE', {
                method:'POST',
                headers:{ 'Content-Type':'application/json',},
                body: JSON.stringify({ getScheduleIds }),
            });
            if (!res.ok) throw new Error('ëŒ€í‘œ ì‹œê°„í‘œ ì¡°íšŒ ì‹¤íŒ¨');
            const data = await res.json();
            renderRepresentativeSchedule(data);
        } catch(err){
            console.error(err);
            alert('ëŒ€í‘œ ì‹œê°„í‘œ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
        }
    }

    function renderRepresentativeSchedule(scheduleData){
        const container = document.getElementById('representativeScheduleContainer');
        if (!container) return;

        if (!document.getElementById('repGridBody')){
            container.innerHTML = `
      <div class="schedule-card" id="repGridCard">
        <div class="schedule-header">
          <div class="time-col"></div>
          <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div>
        </div>
        <div class="schedule-body" id="repGridBody"></div>
      </div>`;
        }
        buildRepGridSpan(9);

        // âœ… ëŒ€í‘œ ì‹œê°„í‘œì—ë„ 0êµì‹œê°€ ìˆìœ¼ë©´ ë¯¸ë¦¬ 0êµì‹œ í–‰ì„ ë„£ê¸°
        const repGrid = document.getElementById('repGridSpanBody');
        const hasZero = Array.isArray(scheduleData) && scheduleData.some(it =>
            Number(it.time_start ?? it.timeStart ?? it.periodStart) === 0 ||
            Number(it.time_end   ?? it.timeEnd   ?? it.periodEnd)   === 0
        );
        if (hasZero && repGrid) prependZeroPeriodGrid(repGrid);


        //const repGrid = document.getElementById('repGridSpanBody');
        if (repGrid){
            repGrid.style.display='grid';
            repGrid.style.gridAutoFlow='row dense';
            repGrid.style.alignContent='start';
            repGrid.style.justifyContent='stretch';
            repGrid.style.gridAutoRows='62px';
        }

        let needMax = 9;
        scheduleData?.forEach(it=>{
            const e = Number(it.time_end ?? it.timeEnd ?? it.periodEnd ?? it.time_start ?? it.timeStart);
            if (Number.isFinite(e)) needMax = Math.max(needMax, e);
        });
        ensureRepGridSpanMax(needMax);
        scheduleData?.forEach(placeCourseBlockRep);
    }

    function placeCourseBlockRep(item){
        const grid = document.getElementById('repGridSpanBody');
        if (!grid) return;

        const subject    = item.courseName || '';
        const professor  = item.professorName || '';
        const classroom  = item.classroom || '';
        const courseCode = item.identify_number_of_course ?? item.courseCode ?? item.identifyNumberOfCourse ?? subject;

        const dayIdx = (Number(item.day) || 0) - 1;
        if (dayIdx < 0 || dayIdx > 4) return;

        const pStart = Number(item.time_start ?? item.timeStart ?? item.periodStart);
        const pEnd   = Number(item.time_end   ?? item.timeEnd   ?? item.periodEnd ?? pStart);
        if (!Number.isFinite(pStart) || !Number.isFinite(pEnd)) return;

        const bg = ColorManager.get(courseCode);
        const block = document.createElement('div');
        block.className = 'course-block';
        block.style.gridColumn = String(dayIdx + 2);
        const sRow = gridRowForPeriod(grid, pStart);
        const eRow = gridRowForPeriod(grid, pEnd) + 1;
        block.style.gridRow = `${sRow} / ${eRow}`;
        block.style.setProperty('--course-color', bg);
        block.classList.add('busy');
        block.dataset.courseId = courseCode;
        block.innerHTML = renderSlotHTML(subject, classroom, professor);

        const tipData = {
            courseName: subject, professorName: professor, classroom,
            majorOrCulture: item.majorOrCulture ?? item.isMajor ?? null,
            credit: item.credit ?? '-', scheduleDay: Number(item.day),
            timeStart: pStart, timeEnd: pEnd, identifyNumberOfCourse: courseCode
        };
        block.onmouseenter = () => showCourseTooltip(block, tipData);
        block.onmouseleave = () => hideCourseTooltip();

        grid.appendChild(block);

        // ë°‘ì¤„ ì œê±°
        for (let r=pStart; r<=pEnd; r++){
            const ph = grid.querySelector(`.cell-placeholder[data-day="${dayIdx}"][data-period="${r}"]`);
            if (ph) ph.style.borderBottom = 'none';
        }
    }

    /***********************
     * ê·¸ë¦¬ë“œ ë¹Œë“œ/í™•ì¥ ê³µí†µ
     ***********************/
    function renderSlotHTML(subject, classroom, professor){
        const sub = subject ?? "";
        const room = classroom ? `<div class="slot-room">${classroom}</div>` : "";
        return `
    <div class="slot">
      <div class="slot-title">${sub}</div>
      ${room}
    </div>`;
    }

    function buildRepGridSpan(periodCount=9){
        const body = document.getElementById('repGridBody');
        if (!body) return;
        body.innerHTML = '';

        const grid = document.createElement('div');
        grid.className = 'schedule-grid';
        grid.id = 'repGridSpanBody';

        const labels = ['9~10ì‹œ','10~11ì‹œ','11~12ì‹œ','12~1ì‹œ','1~2ì‹œ','2~3ì‹œ','3~4ì‹œ','4~5ì‹œ','5~6ì‹œ'];
        for (let p=1; p<=periodCount; p++){
            const t = document.createElement('div');
            t.className='time-cell';
            t.style.gridColumn='1';
            t.style.gridRow=String(p);
            t.innerHTML = `${p}êµì‹œ<br/><span>${labels[p-1] || ''}</span>`;
            grid.appendChild(t);

            for (let day=0; day<5; day++){
                const cell = document.createElement('div');
                cell.className='cell-placeholder';
                cell.dataset.day=String(day);
                cell.dataset.period=String(p);
                cell.style.gridColumn=String(day+2);
                cell.style.gridRow=String(p);
                grid.appendChild(cell);
            }
        }
        body.appendChild(grid);
    }

    function ensureRepGridSpanMax(periodMax){
        const grid = document.getElementById('repGridSpanBody');
        if (!grid) return;
        const curRows = grid.querySelectorAll('[data-period]').length
            ? Math.max(...Array.from(grid.querySelectorAll('[data-period]')).map(e=>Number(e.dataset.period)||1))
            : 0;
        if (periodMax <= curRows) return;

        const labels = ['9~10ì‹œ','10~11ì‹œ','11~12ì‹œ','12~1ì‹œ','1~2ì‹œ','2~3ì‹œ','3~4ì‹œ','4~5ì‹œ','5~6ì‹œ'];
        for (let p=curRows+1; p<=periodMax; p++){
            const t = document.createElement('div');
            t.className='time-cell';
            t.style.gridColumn='1';
            t.style.gridRow=String(p);
            t.innerHTML = `${p}êµì‹œ<br/><span>${labels[p-1] || ''}</span>`;
            grid.appendChild(t);
            for (let day=0; day<5; day++){
                const cell = document.createElement('div');
                cell.className='cell-placeholder';
                cell.dataset.day=String(day);
                cell.dataset.period=String(p);
                cell.style.gridColumn=String(day+2);
                cell.style.gridRow=String(p);
                grid.appendChild(cell);
            }
        }
    }

    function generateModalGridSpanTable(maxPeriod=9){
        const days = ['ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ'];
        const labels = ['9~10ì‹œ','10~11ì‹œ','11~12ì‹œ','12~1ì‹œ','1~2ì‹œ','2~3ì‹œ','3~4ì‹œ','4~5ì‹œ','5~6ì‹œ'];
        let grid = `
  <div class="schedule-card" id="scheduleTable">
    <div class="schedule-header">
      <div class="time-col"></div>
      ${days.map(d=>`<div>${d}</div>`).join('')}
    </div>
    <div class="schedule-body">
      <div class="schedule-grid" id="modalGridSpanBody">`;
        for (let p=1; p<=maxPeriod; p++){
            grid += `
      <div class="time-cell" style="grid-column:1;grid-row:${p}">
        ${p}êµì‹œ<br/><span>${labels[p-1] || ''}</span>
      </div>`;
            for (let day=0; day<5; day++){
                grid += `
        <div class="cell-placeholder" data-day="${day}" data-period="${p}"
             style="grid-column:${day+2};grid-row:${p}"></div>`;
            }
        }
        grid += `</div></div></div>`;
        return grid;
    }

    function ensureModalGridSpanMax(periodMax){
        const grid = document.getElementById('modalGridSpanBody');
        if (!grid) return;
        const curMax = Array.from(grid.querySelectorAll('.cell-placeholder'))
            .reduce((m,el)=>Math.max(m, Number(el.dataset.period)||1), 0);
        if (periodMax <= curMax) return;

        const labels = ['9~10ì‹œ','10~11ì‹œ','11~12ì‹œ','12~1ì‹œ','1~2ì‹œ','2~3ì‹œ','3~4ì‹œ','4~5ì‹œ','5~6ì‹œ','6~7','7~8','8~9','9~10'];
        for (let p=curMax+1; p<=periodMax; p++){
            const t = document.createElement('div');
            t.className='time-cell';
            t.style.gridColumn='1'; t.style.gridRow=String(p);
            t.innerHTML = `${p}êµì‹œ<br/><span>${labels[p-1] || ''}</span>`;
            grid.appendChild(t);
            for (let day=0; day<5; day++){
                const cell = document.createElement('div');
                cell.className='cell-placeholder';
                cell.dataset.day=String(day);
                cell.dataset.period=String(p);
                cell.style.gridColumn=String(day+2);
                cell.style.gridRow=String(p);
                grid.appendChild(cell);
            }
        }
    }

    function hasZeroPeriodGrid(grid){ return !!grid.querySelector('.cell-placeholder[data-period="0"]'); }

    function prependZeroPeriodGrid(grid){
        if (!grid || hasZeroPeriodGrid(grid)) return;
        Array.from(grid.children).forEach(el=>{
            const row = (el.style.gridRow || '').trim();
            if (!row) return;
            if (row.includes('/')){
                const [s,e] = row.split('/').map(v=>parseInt(v.trim(),10));
                if (Number.isFinite(s) && Number.isFinite(e)) el.style.gridRow = `${s+1} / ${e+1}`;
            } else {
                const n = parseInt(row,10);
                if (Number.isFinite(n)) el.style.gridRow = String(n+1);
            }
        });

        const frag = document.createDocumentFragment();
        const t = document.createElement('div');
        t.className='time-cell'; t.style.gridColumn='1'; t.style.gridRow='1';
        t.innerHTML = `0êµì‹œ<br/><span>8~9ì‹œ</span>`;
        frag.appendChild(t);

        for (let day=0; day<5; day++){
            const cell = document.createElement('div');
            cell.className='cell-placeholder';
            cell.dataset.day=String(day);
            cell.dataset.period='0';
            cell.style.gridColumn=String(day+2);
            cell.style.gridRow='1';
            frag.appendChild(cell);
        }
        grid.prepend(frag);
        relabelTimeCells(grid);
    }

    function removeZeroPeriodGridIfEmpty(grid){
        if (!grid || !hasZeroPeriodGrid(grid)) return;
        const used = Array.from(grid.querySelectorAll('.cell-placeholder[data-period="0"]'))
            .some(ph => ph.getAttribute('data-course-id'));
        if (used) return;

        Array.from(grid.querySelectorAll('.time-cell, .cell-placeholder')).forEach(el=>{
            if (el.dataset && el.dataset.period === '0') el.remove();
        });
        grid.querySelectorAll('.preview-block').forEach(el=>el.remove());

        Array.from(grid.children).forEach(el=>{
            const row = (el.style.gridRow || '').trim();
            if (!row) return;
            if (row.includes('/')){
                const [s,e] = row.split('/').map(v=>parseInt(v.trim(),10));
                if (Number.isFinite(s) && Number.isFinite(e)) el.style.gridRow = `${s-1} / ${e-1}`;
            } else {
                const n = parseInt(row,10);
                if (Number.isFinite(n)) el.style.gridRow = String(n-1);
            }
        });
        relabelTimeCells(grid);
    }

    function gridRowForPeriod(grid, period){
        return hasZeroPeriodGrid(grid) ? (period + 1) : period;
    }

    function relabelTimeCells(grid){
        if (!grid) return;
        const labels = { 0:'8~9ì‹œ', 1:'9~10ì‹œ', 2:'10~11ì‹œ', 3:'11~12ì‹œ', 4:'12~1ì‹œ', 5:'1~2ì‹œ', 6:'2~3ì‹œ', 7:'3~4ì‹œ', 8:'4~5ì‹œ', 9:'5~6ì‹œ', 10:'6~7', 11:'7~8', 12: '8~9', 13:'9~10' };
        grid.querySelectorAll('.time-cell').forEach(tc=>{
            const rowCss = tc.style.gridRow || '';
            let row=null;
            if (rowCss.includes('/')) row = N(rowCss.split('/')[0], 1);
            else row = N(rowCss, 1);
            const period = hasZeroPeriodGrid(grid) ? (row - 1) : row;
            const title = period===0 ? '0êµì‹œ' : `${period}êµì‹œ`;
            const sub = labels[period] || '';
            tc.innerHTML = `${title}<br/><span>${sub}</span>`;
        });
    }

    function toPeriodNumber(v, fb=null){
        if (v==null) return fb;
        if (typeof v === 'number' && Number.isFinite(v)) return v;
        const m = String(v).match(/\d+/);
        if (!m) return fb;
        const n = parseInt(m[0],10);
        return Number.isFinite(n) ? n : fb;
    }
    function N(v,fb=null){ const n = Number(v); return Number.isFinite(n) ? n : fb; }

    /***********************
     * ëŒ€í‘œ ì‹œê°„í‘œ ë°ì´í„° ë¡œë“œ
     ***********************/
    async function renderRepresentativeFromServer(){
        try { await TokenManager.refresh(); } catch {}
        if (!UserId){ try { await loaduserinfo(); } catch {} }

        const res = await apiFetch('/tableId_List', { method:'GET', credentials:'include' });
        if (!res.ok) return;
        const data = await res.json();
        const list = pickTimetableArray(data);
        const rep = list.find(row => isTruthyTag(row.tag ?? row['tag']));
        if (!rep){
            document.getElementById('representativeScheduleContainer').innerHTML = `<p style="color:#888;">ëŒ€í‘œ ì‹œê°„í‘œê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;
            document.getElementById('representativeTitle').textContent = 'ğŸ“Œ ëŒ€í‘œ ì‹œê°„í‘œ';
            return;
        }
        const termCode = String(rep.term ?? rep['term'] ?? '');
        const timetableId = Number(rep.timeTableId ?? rep['timeTableId'] ?? rep.timetableId ?? rep.id);
        representativeTermCode = termCode;
        document.getElementById('representativeTitle').textContent = `ğŸ“Œ ëŒ€í‘œ ì‹œê°„í‘œ - ${toSemesterName(termCode)}`;

        const byUid = await apiFetch('/getTC', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', },
            body: JSON.stringify(UserId),
        });
        if (!byUid.ok){
            const failTxt = await byUid.text();
            console.error('getTC ì‹¤íŒ¨ status=', byUid.status, 'body=', failTxt);
            document.getElementById('representativeScheduleContainer').innerHTML = `<p style="color:#888;">ëŒ€í‘œ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
            return;
        }
        let all;
        try {
            const txt = await byUid.text();
            all = JSON.parse(txt);
        } catch (e){
            console.error('[rep] /getTC JSON íŒŒì‹± ì‹¤íŒ¨:', e);
            return;
        }
        const rows = (all||[]).filter(r=>{ const tid = getTid(r); return Number.isFinite(tid) && tid === timetableId; });
        const courseIds = Array.from(new Set(rows.map(getCourseId).filter(v=>v!=null && String(v).trim()!=='')));
        await loadRepresentativeSchedule(courseIds);
    }
    // ê³µí†µ fetch í•¨ìˆ˜
    async function fetchCreditData(endpoint) {
        try {
            const response = await apiFetch(endpoint, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(UserId),
            });

            if (!response.ok) {
                throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
            }

            const data = await response.json();

            if (Array.isArray(data)) {
                return data.reduce((sum, v) => sum + Number(v || 0), 0);
            }

            return Number(data) || 0;
        } catch (error) {
            console.error("ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
            return 0;
        }
    }

    // í•™ì  ë¶ˆëŸ¬ì˜¤ê¸° ë° HTML ë°˜ì˜
    async function loadCredits() {
        const bsm = await fetchCreditData("/getbsm");
        const design = await fetchCreditData("/getì„¤ê³„");
        const advanced = await fetchCreditData("/getì „ì‹¬");
        const select = await fetchCreditData("/getì „ì„ ");

        document.getElementById("bsmCredit").textContent = bsm;
        document.getElementById("designCredit").textContent = design;
        document.getElementById("majorAdvancedCredit").textContent = advanced;
        document.getElementById("majorElectiveCredit").textContent = select;
    }
    function collectSelectedCourseCodes(){
        const root = document.getElementById('modalGridSpanBody');
        if (!root) return [];
        const codes = new Set();
        root.querySelectorAll('.course-block[data-course-id], .cell-placeholder[data-course-id]')
            .forEach(el=>{
                const code = el.getAttribute('data-course-id');
                if (code) codes.add(code);
            });
        return Array.from(codes);
    }
    function pickCoursePk(row){
        // ì„œë²„ êµ¬ì¡°ì— ë§ê²Œ ìš°ì„ ìˆœìœ„ ë‚˜ì—´
        const cand = [
            row.courseId, row.course_id,
            row.timeTableId, row.timetableId, // â† ì§€ê¸ˆ JSONì€ ì´ê±°ë§Œ ìˆìŒ
            row.id
        ];
        for (const v of cand){
            const n = Number(v);
            if (Number.isInteger(n) && n > 0) return n;
        }
        return null;
    }

    function mapCodesToCourseIds(codes){
        const result = new Set();
        codes.forEach(code=>{
            (currentCourseList || []).forEach(e=>{
                if (String(e.identifyNumberOfCourse) === String(code)){
                    const pk = pickCoursePk(e);
                    if (pk != null) result.add(pk);
                }
            });
        });
        return Array.from(result);
    }
    /************ AccessToken ë©”ëª¨ë¦¬ ë³´ê´€ + ìë™ ë¦¬í”„ë ˆì‹œ ************/
    const TokenManager = (() => {
        let accessToken = null;
        let refreshingPromise = null;

        const set = (t) => { accessToken = t || null; };
        const get = () => accessToken;

        const refresh = async () => {
            if (refreshingPromise) return refreshingPromise;
            refreshingPromise = (async () => {
                const res = await fetch('/refreshT', {
                    method: 'POST',
                    credentials: 'include', // â˜… HttpOnly refreshToken ì¿ í‚¤ ì „ì†¡
                });
                if (!res.ok) { set(null); throw new Error('Refresh failed'); }

                // ì„œë²„ê°€ ì´ë¯¸ Access-Control-Expose-Headers: Authorization ì„¤ì •í•¨
                const auth = res.headers.get('Authorization'); // "Bearer xxx"
                if (!auth || !auth.startsWith('Bearer ')) {
                    set(null);
                    throw new Error('No Authorization header');
                }
                const token = auth.slice('Bearer '.length);
                set(token);
                return token;
            })();
            try { return await refreshingPromise; }
            finally { refreshingPromise = null; }
        };

        return { get, set, refresh };
    })();

    /************ ëª¨ë“  API í˜¸ì¶œìš© ê³µí†µ fetch (401ì‹œ 1íšŒ ìë™ ì¬ì‹œë„) ************/
    async function apiFetch(input, init = {}) {
        const headers = new Headers(init.headers || {});
        const token = TokenManager.get();
        if (token) headers.set('Authorization', `Bearer ${token}`);

        // ê¸°ë³¸ì ìœ¼ë¡œ ì¿ í‚¤ ë™ë´‰(ì„œë²„ê°€ ì¿ í‚¤ ì‚¬ìš©í•˜ëŠ” ì—”ë“œí¬ì¸íŠ¸ ë§ìŒ)
        let res = await fetch(input, { ...init, headers, credentials: 'include' });

        if (res.status === 401) {
            try {
                const newToken = await TokenManager.refresh();
                const retryHeaders = new Headers(init.headers || {});
                retryHeaders.set('Authorization', `Bearer ${newToken}`);
                res = await fetch(input, { ...init, headers: retryHeaders, credentials: 'include' });
            } catch (e) {
                TokenManager.set(null);
                throw e;
            }
        }
        return res;
    }
</script>
</body>
</html>