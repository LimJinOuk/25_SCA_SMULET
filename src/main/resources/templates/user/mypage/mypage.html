<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My page</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* ê¸°ë³¸ ì„¤ì • */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: #f7f9fc;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* í—¤ë” */
    header {
      background-color: white;
      padding: 20px;
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
      background-color: rgb(255, 255, 255, 0.85);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
    }

    h1 {
      font-size: 2.3rem;
      font-weight: bold;
      color: #2563eb;
      margin: 0;
    }
    h1 a {
      text-decoration: none;
      color: inherit;
    }

    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: color 0.2s ease, font-size 0.2s ease;
    }

    nav a:hover {
      color: #3b82f6;
      font-size: 1.1rem;
    }

    main {
      flex: 1;
      padding-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 20px 16px;
      max-width: 1200px;
      width: 100%;
      flex-wrap: wrap;
    }


    /* ë°˜ì‘í˜• ì „í™˜ */
    @media (max-width: 900px) {
      .container {
        display: flex;
        flex-direction: column;
      }
    }

    /* ë°•ìŠ¤ ê³µí†µ */
    .box {
      flex: 1;
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      min-height: 430px;
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    .box:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
    }
    h2, h3 {
      margin: 0 0 10px;
      font-size: 1.1rem;
      color: #111827;
    }

    /* ë‚´ë¶€ ì •ë ¬ */
    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .section {
      margin-bottom: 24px;
    }
    .section button{
      display: block;
      margin-top: 8px;
    }
    .info p {
      margin: 3px 0;
      font-size: 0.9rem;
      color: #374151;
    }

    /* ë²„íŠ¼ */
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    button:hover {
      background-color: #1e40af;
      transform: scale(1.03);
    }
    button.red {
      background-color: #ef4444;
    }
    button.red:hover {
      background-color: #dc2626;
    }

    /* í…Œí¬íŠ¸ë¦¬ ë²„íŠ¼ ê°„ ê°„ê²© */
    .tech-buttons a {
      display: block;
      margin-bottom: 10px;
      text-decoration: none;
    }

    /* ì‹œê°„í‘œ ë²„íŠ¼ ê·¸ë£¹ */
    .button-group {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    /* ì‹œê°„í‘œ ì•„ì´í…œ */
    #scheduleList .schedule-item {
      background-color: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.9rem;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* í‘¸í„° */
    footer {
      background-color: rgba(30, 30, 30, 0.98);
      color: rgba(200, 200, 200, 0.7);
      font-size: 0.9rem;
      padding: 2rem 1rem;
      text-align: center;
      border-top: 1px solid #444;
      margin-top: auto;
    }
    footer a {
      text-decoration: none;
      color: rgba(200, 200, 200, 0.7);
      margin: 0 10px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    select {
      appearance: none; /* ê¸°ë³¸ í™”ì‚´í‘œ ì œê±° */
      -webkit-appearance: none;
      -moz-appearance: none;

      background-color: white;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 1rem;
      color: #111827;
      font-family: 'Montserrat', sans-serif;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px 16px;
      padding-right: 40px; /* í™”ì‚´í‘œ ê³µê°„ í™•ë³´ */
    }

    select:hover {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
    }
    .modal-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background-color: rgba(0, 0, 0, 0.5); /* ì–´ë‘ìš´ ë°°ê²½ */
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .modal {
      background: white;
      padding: 30px 20px;
      border-radius: 10px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      min-width: 300px;
    }

    .hidden {
      display: none;
    }
    .button-group-vertical {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    body.modal-open{
      overflow: hidden;
    }
    .hidden {
      display: none;
    }

    #semesterList li {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #scheduleTable td {
      width: 80px;
      /* í•„ìš” ì‹œ ìµœì†Œ/ìµœëŒ€ ë„ˆë¹„ ì¡°ì ˆë„ ê°€ëŠ¥ */
      max-width: 100px;
      height: 50px; /* ì›í•˜ëŠ” ê°’(px, em ë“±)ìœ¼ë¡œ ì¡°ì • */
      min-width: 80px; /* ì¹¸ì˜ ê°€ë¡œí­ë„ ì¡°ì ˆ ê°€ëŠ¥ */
      vertical-align: middle; /* í…ìŠ¤íŠ¸ ìˆ˜ì§ ì¤‘ì•™ì •ë ¬ */
    }
    .course-tooltip {
      animation: fadeIn 0.12s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px);}
      to { opacity: 1; transform: translateY(0);}
    }


  </style>
</head>
<body onload="loaduserinfo()">
<header>
  <h1><a href="/">SMULET</a></h1>
  <nav>
    <a href="#"><b>ì´ìš©ì•ˆë‚´</b></a>
    <a href="/login_page" id="loginLink"><b>ë¡œê·¸ì¸</b></a>
    <a href="/Register" id="registerLink"><b>íšŒì›ê°€ì…</b></a>
    <a href="/" id="logoutLink" style="display: none;"><b>ë¡œê·¸ì•„ì›ƒ</b></a>
    <a href="/" id="" style="display: none;"><b>ë§ˆì´í˜ì´ì§€</b></a>
  </nav>
</header>
<main>
  <div class="container">
    <!-- BOX1 -->
    <div class="box box1">
      <div class="section">
        <h2>ë‚´ ì •ë³´</h2>
        <div class="nav">
          <div class="info">
            <p>ì´ë¦„: <span id="userName"></span></p>
            <p>ì´ë©”ì¼: <span id="studentId"></span></p>
            <p>í•™ê³¼: <span id="userMajor">ì»´í“¨í„°ê³¼í•™ê³¼</span></p>
          </div>
        </div>
        <div class="section">
          <h3>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
          <div class="button-group-vertical">
            <button onclick="modifinguserinfo()">ë³€ê²½</button>
          </div>
        </div>
      </div>
      <div class="section">
        <h3>íšŒì›íƒˆí‡´</h3>
        <button class="red" onclick="deleteAccount()">íƒˆí‡´</button>
      </div>
    </div>

    <div id="modalOverlay" class="modal-overlay hidden">
      <div class="modal-wrapper">
        <div class="modal">
          <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
          <input type="password" id="pw">
          <div style="margin-top: 10px;">
            <button id="confirm" type="button">í™•ì¸</button>
            <button id="close-btn" type="button">ë‹«ê¸°</button>
          </div>
        </div>
      </div>
    </div>

    <div id="changePwModal" class="modal-overlay hidden">
      <div class="modal-wrapper">
        <div class="modal">
          <p>ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
          <input type="password" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸">
          <input type="password" id="confirmPassword" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸">
          <div style="margin-top: 10px;">
            <button id="changePwBtn" type="button">ë³€ê²½</button>
            <button id="cancelChange" type="button">ì·¨ì†Œ</button>
          </div>
        </div>
      </div>
    </div>

    <!-- BOX2 -->
    <div class="box box2">
      <h2>í…Œí¬íŠ¸ë¦¬</h2>
      <p class="subtext">ëª¨ë“  í…Œí¬íŠ¸ë¦¬ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

      <select id="techTreeSelect" onchange="goToTechTree()" style="margin-top: 12px;">
        <option value="">í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
        <option value="21">21í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
        <option value="22">22í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
        <option value="23">23í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
        <option value="24">24í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
        <option value="25">25í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
      </select>

    </div>

    <div class="box box3">
      <h2>ì‹œê°„í‘œ</h2>
      <p class="subtext">ì‹œê°„í‘œë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

      <div style="margin-top: 12px;">
        <button id="showSemesterBtn">ì‹œê°„í‘œ ì¶”ê°€</button>
      </div>

      <div id="addSemesterList" class="hidden" style="margin-top: 10px;">
        <select id="semesterSelect"></select>
        <button onclick="addSemester()">ì¶”ê°€</button>
      </div>

      <ul id="semesterList" style="margin-top: 12px;"></ul>
      <!-- ì‹œê°„í‘œ ëª¨ë‹¬ -->

    </div>
    <div id="scheduleModal" class="modal-overlay hidden">
      <div class="modal-wrapper">
        <div class="modal" style="display: flex; width: 90vw; max-width: 1000px; max-height: 700px; overflow: hidden; padding: 30px; gap: 20px;">

          <!-- ì™¼ìª½: ì‹œê°„í‘œ ì˜ì—­ -->
          <div style="flex: 2; overflow-y: auto;">
            <div style="text-align: right;">
              <button id="closeScheduleModal" style="background: #ef4444; color: white; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer;">ë‹«ê¸°</button>
              <button id="saveSchedule" style="background: #4466ef; color: white; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer;">ì €ì¥</button>
            </div>
            <h2 style="text-align:center; margin-bottom: 15px;" id="modalSemesterTitle"></h2>
            <div id="scheduleTableContainer">
              <!-- ë™ì  ì‹œê°„í‘œ -->
            </div>
          </div>

          <!-- ì˜¤ë¥¸ìª½: ìˆ˜ì—… ì •ë³´ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
          <div id="classInfoList" style="flex: 1; overflow-y: auto; border-left: 1px solid #ddd; padding-left: 10px;">
            <!-- ìˆ˜ì—… ì •ë³´ê°€ JSë¡œ ì±„ì›Œì§ -->
          </div>

        </div>
      </div>
    </div>

  </div>
</main>

<footer>
  <b>
    <a href="#">Github</a>
    <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
    <a href="#">ì´ìš©ì•½ê´€</a><br><br>
    <a href="#">Copyright</a>
  </b>
</footer>
<script>
  const semesterOptions = [
    "2025ë…„ 2í•™ê¸°", "2025ë…„ 1í•™ê¸°",
    "2024ë…„ 2í•™ê¸°", "2024ë…„ 1í•™ê¸°",
    "2023ë…„ 2í•™ê¸°", "2023ë…„ 1í•™ê¸°",
    "2022ë…„ 2í•™ê¸°", "2022ë…„ 1í•™ê¸°",
    "2021ë…„ 2í•™ê¸°", "2021ë…„ 1í•™ê¸°"
  ];
  // ìŠ¤í¬ë¦½íŠ¸ ë§¨ ìœ„ë‚˜ addCourseToScheduleTable í•¨ìˆ˜ ë°”ê¹¥ì— ì„ ì–¸
  const randomColors = [
    "#F9E79F", // ì—°ë…¸ë‘
    "#AEDFF7", // ì—°í•˜ëŠ˜
    "#A7F3D0", // ë¯¼íŠ¸ê·¸ë¦°
    "#FFD6E0", // ì—°ë¶„í™
    "#B4A7F7", // ë¼ë²¤ë”
    "#FFD9B3", // ì‚´êµ¬
    "#B9F6CA", // ì—°ì—°ë‘
    "#FFE082", // ë°ì€ ë…¸ë‘
    "#FFAB91", // ì—°ì½”ë„
    "#D1C4E9"  // ì—°ë³´ë¼
  ];

  // ì´ë¯¸ ì‚¬ìš©ëœ ìƒ‰ì„ ì¶”ì 
  let usedColors = [];
  let UserId = null;

  function getRandomColorNoDuplicate() {
    // ì•„ì§ ì•ˆ ì“´ ìƒ‰ë§Œ í•„í„°
    const availableColors = randomColors.filter(color => !usedColors.includes(color));
    // ë‚¨ì€ ê²Œ ì—†ìœ¼ë©´ usedColors ë¦¬ì…‹
    if (availableColors.length === 0) {
      usedColors = [];
      // ë‹¤ì‹œ ì „ì²´ ì¤‘ì—ì„œ ëœë¤ ì„ íƒ
      return getRandomColorNoDuplicate();
    }
    // ëœë¤í•˜ê²Œ í•˜ë‚˜ ì„ íƒ
    const randomIndex = Math.floor(Math.random() * availableColors.length);
    const selectedColor = availableColors[randomIndex];
    usedColors.push(selectedColor); // ì‚¬ìš©ëœ ìƒ‰ì— ì¶”ê°€
    return selectedColor;
  }



  let selectedSemesters = [];
  let currentCourseList = []; // ëª¨ë‹¬ì— ë„ìš´ í˜„ì¬ í•™ê¸° ì „ì²´ ìˆ˜ì—…ì •ë³´ ì €ì¥

  document.addEventListener('DOMContentLoaded', function () {
    const loginLink = document.getElementById('loginLink');
    const logoutLink = document.getElementById('logoutLink');
    const registerLink = document.querySelector('nav a[href="/Register"]');
    const token = localStorage.getItem('jwtToken');

    // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ ë§í¬ í† ê¸€
    if (token) {
      loginLink.style.display = 'none';
      logoutLink.style.display = 'inline';
      registerLink.style.display = 'none';
    } else {
      loginLink.style.display = 'inline';
      logoutLink.style.display = 'none';
      registerLink.style.display = 'inline';
    }

    // ë¡œê·¸ì•„ì›ƒ
    logoutLink.addEventListener('click', function (e) {
      e.preventDefault();
      localStorage.removeItem('jwtToken');
      alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
      window.location.href = '/';
    });

    // ì‹œê°„í‘œ ì¶”ê°€ ë²„íŠ¼ ì—°ê²°
    const showSemesterBtn = document.getElementById('showSemesterBtn');
    if (showSemesterBtn) {
      showSemesterBtn.addEventListener('click', showAddSemester);
    }
  });

  // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
  function loaduserinfo() {
    const token = localStorage.getItem('jwtToken');
    fetch('/userinfo', {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
            .then(res => {
              if (!res.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
              return res.json();
            })
            .then(data => {
              document.getElementById('userName').textContent = data.name;
              document.getElementById('studentId').textContent = data.email;
              UserId = data.id;
            })
            .catch(err => {
              console.error(err);
              alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
  }

  // íšŒì› íƒˆí‡´
  function deleteAccount() {
    const token = localStorage.getItem('jwtToken');
    if (!confirm("ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")) return;

    fetch('/member/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      }
    })
            .then(res => {
              if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
              return res.json();
            })
            .then(data => {
              if (data.deleteStatus === 'success') {
                alert('íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                localStorage.removeItem('jwtToken');
                window.location.href = '/';
              }
            })
            .catch(err => {
              alert('íšŒì› íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
              console.error(err);
            });
  }

  // ì‚¬ìš©ì ì •ë³´ ìˆ˜ì • - ë¹„ë°€ë²ˆí˜¸ í™•ì¸
  function modifinguserinfo() {
    const modalOverlay = document.getElementById('modalOverlay');
    const closeBtn = document.getElementById('close-btn');
    const confirmBtn = document.getElementById('confirm');
    const token = localStorage.getItem('jwtToken');

    modalOverlay.classList.remove('hidden');
    document.body.classList.add("modal-open");

    closeBtn.onclick = () => {
      modalOverlay.classList.add("hidden");
      document.body.classList.remove("modal-open");
    };

    confirmBtn.onclick = () => {
      const pw = document.getElementById('pw').value;

      fetch('/check_pw_button', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ pw: pw })
      })
              .then(res => {
                if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                return res.json();
              })
              .then(data => {
                if (data.Password === true) {
                  alert('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì™„ë£Œ!');
                  modalOverlay.classList.add("hidden");
                  document.getElementById("changePwModal").classList.remove("hidden");
                } else {
                  alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
              })
              .catch(err => {
                alert('ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                console.error(err);
              });
    };
  }

  // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •
  document.getElementById("changePwBtn").onclick = function () {
    const newPw = document.getElementById("newPassword").value;
    const confirmPw = document.getElementById("confirmPassword").value;
    const token = localStorage.getItem("jwtToken");

    if (!newPw || !confirmPw || newPw !== confirmPw) {
      alert("ë¹„ë°€ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }

    fetch('/PWupdate_button', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ pw: newPw })
    })
            .then(async res => {
              if (!res.ok) {
                const errorText = await res.text();
                alert(`ì„œë²„ ì˜¤ë¥˜ ${res.status}: ${errorText}`);
                throw new Error("ì„œë²„ ì˜¤ë¥˜: " + res.status);
              }
              return res.json();
            })
            .then(data => {
              if (data.updateStatus === true) {
                alert("ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById("changePwModal").classList.add("hidden");
              } else {
                alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
              }
            })
            .catch(err => {
              alert("ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
            });
  };

  // ëª¨ë‹¬ ì—´ê¸°/ë‹«ê¸°
  document.getElementById("openPwModalBtn").onclick = function () {
    document.getElementById("changePwModal").classList.remove("hidden");
    document.getElementById("newPassword").value = "";
    document.getElementById("confirmPassword").value = "";
  };
  document.getElementById("close-btn").onclick = function () {
    document.getElementById("modalOverlay").classList.add("hidden");
  };
  document.getElementById("cancelChange").onclick = function () {
    document.getElementById("changePwModal").classList.add("hidden");
  };

  function goToTechTree() {
    const select = document.getElementById('techTreeSelect');
    const year = select.value;
    const token = localStorage.getItem('jwtToken');

    if (!token) {
      alert("ë¡œê·¸ì¸ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    if (!year) {
      alert("í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”.");
      return;
    }

    fetch(`/tech_tree?year=${year}`, {
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
            .then(res => {
              if (res.ok) return res.text();
              else throw new Error("Unauthorized");
            })
            .then(html => {
              document.open();
              document.write(html);
              document.close();
            })
            .catch(err => {
              console.error(err);
              window.location.href = '/';
            });

  }

  function showAddSemester() {
    const addList = document.getElementById('addSemesterList');
    const select = document.getElementById('semesterSelect');

    select.innerHTML = '';
    semesterOptions.forEach(sem => {
      if (!selectedSemesters.includes(sem)) {
        const option = document.createElement('option');
        option.value = sem;
        option.textContent = sem;
        select.appendChild(option);
      }
    });

    addList.classList.toggle('hidden');
  }

  function addSemester() {
    const select = document.getElementById('semesterSelect');
    const selected = select.value;
    if (!selected) return;

    selectedSemesters.push(selected);
    renderSemesterList();
    document.getElementById('addSemesterList').classList.add('hidden');
  }

  function renderSemesterList() {
    const list = document.getElementById('semesterList');
    list.innerHTML = '';

    selectedSemesters.forEach((sem, index) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="semester-name" style="cursor:pointer; color:#2563eb; text-decoration: underline;">${sem}</span>
        <button onclick="removeSemester(${index})" style="color: white; background-color: red">ì‚­ì œ</button>
    `;
      list.appendChild(li);

      li.querySelector('.semester-name').addEventListener('click', () => {
        openScheduleModal(sem);
      });
    });
  }

  function openScheduleModal(semester) {
    const modal = document.getElementById('scheduleModal');
    const title = document.getElementById('modalSemesterTitle');
    const container = document.getElementById('scheduleTableContainer');
    const listContainer = document.getElementById('classInfoList');
    document.getElementById("closeScheduleModal").onclick = function (){
      document.getElementById("scheduleModal").classList.add("hidden");
      document.body.classList.remove("modal-open");
      hideCourseTooltip();
    }

    title.textContent = semester;
    container.innerHTML = generateEmptyScheduleTable();
    listContainer.innerHTML = "<p>ìˆ˜ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>";
    modal.classList.remove('hidden');
    document.body.classList.add('modal-open');

    // ì—¬ê¸°ì„œ ìˆ˜ì—… ëª©ë¡ì„ ì„œë²„ì—ì„œ ë¶ˆëŸ¬ì˜¨ë‹¤ê³  ê°€ì •
    const token = localStorage.getItem('jwtToken');
    fetch("/a", {
      headers: {
        'Authorization': `Bearer ${token}`
      }
    })
            .then(res => res.json())
            .then(data => {
              currentCourseList = data;   // â˜…â˜…â˜…â˜…â˜… ë°˜ë“œì‹œ í•„ìš”!
              renderCourseList(data);
              attachCellEvents();         // ë˜ëŠ” renderCourseListì—ì„œ í˜¸ì¶œ
            })
            .catch(err => {
              listContainer.innerHTML = `<p style="color:red;">ìˆ˜ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
              console.error(err);
            });
  }

  function renderCourseList(classList) {
    const listContainer = document.getElementById('classInfoList');
    currentCourseList = classList;
    if (!Array.isArray(classList) || classList.length === 0) {
      listContainer.innerHTML = '<p>ìˆ˜ì—… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    listContainer.innerHTML = '';

    const grouped = groupByCourse(classList);

    Object.entries(grouped).forEach(([key, entries]) => {
      const box = document.createElement('div');
      box.style.border = "1px solid #ccc";
      box.style.padding = "10px";
      box.style.marginBottom = "10px";
      box.style.borderRadius = "6px";
      box.style.backgroundColor = "#f9f9f9";
      box.style.cursor = "pointer";

      const courseName = entries[0].courseName;
      const classroom = entries[0].classroom;

      box.innerHTML = `
      <strong>${courseName}</strong><br>
      ê°•ì˜ì‹¤: ${classroom}
    `;

      box.onclick = () => {
        addCourseToScheduleTable(entries);
        attachCellEvents();
      };

      listContainer.appendChild(box);
    });
  }

  // ìˆ˜ì—…ëª…ì„ ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í•‘
  function groupByCourse(data) {
    const map = {};
    data.forEach(entry => {
      const key = entry.courseName;
      if (!map[key]) map[key] = [];
      map[key].push(entry);
    });
    return map;
  }

  // ì‹œê°„í‘œì— ìˆ˜ì—… ë°˜ì˜
  function addCourseToScheduleTable(courseEntries) {
    const table = document.getElementById('scheduleTable');
    if (!table) return;
    const courseName = courseEntries[0].courseName;
    const classroom = courseEntries[0].classroom;
    const courseId = courseEntries[0].identifyNumberOfCourse;
    let isAlreadyAdded = false;
    const dayIndex = courseEntries[0].scheduleDay;
    const firstPeriod = courseEntries[0].timeStart;
    const row = table.rows[firstPeriod + 1];
    const cell = row.cells[dayIndex + 1];
    if (cell && (cell.textContent.trim() === `${courseName}\n(${classroom})` ||
            cell.innerHTML.trim() === `${courseName}<br>(${classroom})`)) {
      isAlreadyAdded = true;
    }
    // ëœë¤ìƒ‰(ì¤‘ë³µë°©ì§€) í• ë‹¹
    const randomColor = getRandomColorNoDuplicate();

    courseEntries.forEach(entry => {
      const dayIndex = entry.scheduleDay;
      for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
        const row = table.rows[p + 1];
        const cell = row.cells[dayIndex + 1];
        if (cell) {
          if (isAlreadyAdded) {
            cell.textContent = '';
            cell.style.backgroundColor = '';
            cell.removeAttribute('data-course-id');
          } else {
            cell.innerHTML = `${entry.courseName}<br>(${entry.classroom})`;
            cell.style.backgroundColor = randomColor;
            cell.setAttribute('data-course-id', entry.identifyNumberOfCourse);
          }
          attachCellEvents();
        }
      }
    });
    const saveBtn = document.getElementById("saveSchedule");
    saveBtn.replaceWith(saveBtn.cloneNode(true));  // ê°€ì¥ ê°„ë‹¨í•˜ê²Œ ê¸°ì¡´ ì´ë²¤íŠ¸ ì´ˆê¸°í™”
    document.getElementById("saveSchedule").addEventListener("click", async function () {
      const semesterText = document.getElementById('modalSemesterTitle').textContent;
      const semesterCode = semesterText.replace("ë…„ ", "").replace("í•™ê¸°", "").replace(" ", "");

      const formData = new FormData();
      formData.append("semester", semesterCode);

      try {
        const res = await fetch('/addTimetable', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('jwtToken')}`
          },
          body: formData
        });

        const data = await res.text();

        // ì—¬ê¸°ê°€ í•µì‹¬
        if (data.success === "ok") {
          alert("ì‹œê°„í‘œê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!");
        } else {
          alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }

      } catch (err) {
        alert("ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      }
    });

  }

  // ===== ğŸŸ¢ğŸŸ¢ğŸŸ¢ íˆ´íŒ ë¶€ë¶„ ì¶”ê°€ ===========================

  function attachCellEvents() {
    const table = document.getElementById('scheduleTable');
    if (!table) return;
    const allCells = table.querySelectorAll('td[data-period]');
    allCells.forEach(cell => {
      cell.onmouseover = function (e) {
        const courseId = cell.getAttribute('data-course-id');
        if (courseId) {
          const courseInfo = currentCourseList.find(c => c.identifyNumberOfCourse === courseId);
          if (courseInfo) showCourseTooltip(cell, courseInfo);
        }
      };
      cell.onmouseout = function (e) {
        hideCourseTooltip();
      };
    });
  }

  function showCourseTooltip(cell, courseInfo) {
    hideCourseTooltip();
    const tooltip = document.createElement('div');
    tooltip.className = 'course-tooltip';
    tooltip.style.position = 'absolute';
    tooltip.style.zIndex = 2000;
    tooltip.style.minWidth = '180px';
    tooltip.style.maxWidth = '260px';
    tooltip.style.background = '#ffffffcc';
    tooltip.style.border = '1px solid #2563eb';
    tooltip.style.borderRadius = '10px';
    tooltip.style.boxShadow = '0 4px 18px rgba(30,80,210,0.13)';
    tooltip.style.padding = '14px 18px 14px 14px';
    tooltip.style.fontSize = '0.98rem';
    tooltip.style.pointerEvents = 'none';
    tooltip.innerHTML = `
      <b>${courseInfo.courseName}</b>
      <br>êµìˆ˜: ${courseInfo.professorName || "-"}
      <br>ê°•ì˜ì‹¤: ${courseInfo.classroom}
      <br>êµ¬ë¶„: ${courseInfo.majorOrCulture ? "ì „ê³µ" : "êµì–‘"}
      <br>í•™ì : ${courseInfo.credit}
      <br>ìš”ì¼: ${['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'][courseInfo.scheduleDay] || courseInfo.scheduleDay}
      <br>êµì‹œ: ${courseInfo.timeStart} ~ ${courseInfo.timeEnd}
      <br>ê³¼ëª©ì½”ë“œ: ${courseInfo.identifyNumberOfCourse}
    `;
    document.body.appendChild(tooltip);

    // íˆ´íŒ ìœ„ì¹˜
    const rect = cell.getBoundingClientRect();
    tooltip.style.left = (rect.right + 8) + "px";
    tooltip.style.top = (rect.top + window.scrollY) + "px";
  }

  function hideCourseTooltip() {
    const prev = document.querySelector('.course-tooltip');
    if (prev) prev.remove();
  }


  function renderClassInfoList(scheduleData) {
    const listContainer = document.getElementById('classInfoList');
    if (!listContainer) return;

    if (!Array.isArray(scheduleData) || scheduleData.length === 0) {
      listContainer.innerHTML = '<p>ìˆ˜ì—… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
      return;
    }

    listContainer.innerHTML = scheduleData.map(cls => `
        <div style="border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 6px; background-color: #f9f9f9;">
            <strong>${cls.subject}</strong><br>
            êµìˆ˜: ${cls.professor}<br>
            ìš”ì¼: ${cls.day}, ${cls.period}êµì‹œ
        </div>
    `).join('');
  }
  function generateEmptyScheduleTable() {
    const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
    let html = '<table id="scheduleTable" style="width:100%; border-collapse: collapse;">';

    html += '<tr><th></th>';
    days.forEach(day => {
      html += `<th style="border: 1px solid #ddd; padding: 8px; background:#f8f9fa;">${day}</th>`;
    });
    html += '</tr>';

    let startHour = 9;
    for (let period = 1; period <= 15; period++) {
      const timeStr = startHour <= 12 ? `ì˜¤ì „ ${startHour}ì‹œ` : `ì˜¤í›„ ${startHour - 12}ì‹œ`;
      html += `<tr><td style="border: 1px solid #ddd; padding: 8px; background:#e3e3fd; font-weight:bold;">${period}êµì‹œ<br>(${timeStr})</td>`;

      days.forEach(() => {
        html += `<td style="border: 1px solid #ddd; padding: 8px;" data-period="${period}"></td>`;
      });

      html += '</tr>';
      startHour++;
    }

    html += '</table>';
    return html;
  }

  function renderScheduleWithData(scheduleData) {
    // ì˜ˆ: [{ id, subject, professor, day, period }, ...]
    const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
    const table = document.getElementById('scheduleTable');
    if (!table) return;

    Array.from(table.querySelectorAll('td[data-period]')).forEach(td => {
      td.textContent = '';
      td.dataset.scheduleId = '';
      td.style.backgroundColor = '';
    });

    scheduleData.forEach(item => {
      const dayIndex = days.indexOf(item.day);
      if (dayIndex === -1) return;

      const row = table.rows[item.period];
      if (!row) return;

      const cell = row.cells[dayIndex + 1];
      if (cell) {
        cell.textContent = `${item.subject}\n(${item.professor})`;
        cell.dataset.scheduleId = item.id;
        cell.style.backgroundColor = '#dbeafe';
      }
    });
  }

  function removeSemester(index) {
    selectedSemesters.splice(index, 1);
    renderSemesterList();
  }
</script>
</body>
</html>