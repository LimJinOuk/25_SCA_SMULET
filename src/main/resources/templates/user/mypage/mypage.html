<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My page</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* 기본 설정 */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: #f7f9fc;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* 헤더 */
    header {
      background-color: white;
      padding: 20px;
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
      background-color: rgb(255, 255, 255, 0.85);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
    }

    h1 {
      font-size: 2.3rem;
      font-weight: bold;
      color: #2563eb;
      margin: 0;
    }
    h1 a {
      text-decoration: none;
      color: inherit;
    }

    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
      transition: color 0.2s ease, font-size 0.2s ease;
    }

    nav a:hover {
      color: #3b82f6;
      font-size: 1.1rem;
    }

    main {
      flex: 1;
      padding-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      display: flex;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      padding: 20px 16px;
      max-width: 1200px;
      width: 100%;
      flex-wrap: wrap;
      margin: 0 auto;
    }


    /* 반응형 전환 */
    @media (max-width: 900px) {
      .container {
        display: flex;
        flex-direction: column;
      }
    }

    /* 박스 공통 */
    .box {
      flex: 1;
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
      display: flex;
      flex-direction: column;
      min-height: 150px;
      /*min-height: 430px;*/
      box-sizing: border-box;
      transition: all 0.3s ease;
    }
    .box:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
    }
    h2, h3 {
      margin: 0 0 10px;
      font-size: 1.1rem;
      color: #111827;
    }
    .section h3 {
      margin-top: 24px;     /* “비밀번호 변경” 제목 위로 24px 띄움 */
    }
    .nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .section {
      margin-bottom: 10px;
    }
    .section button{
      display: inline-block;    /* inline-block 이면 너비 지정도 가능 */
      width: 140px;             /* 원하는 너비로 조정하세요 */
      margin-top: 8px;
      text-align: center;       /* 버튼 텍스트도 가운데 정렬 */
    }
    .info p {
      margin: 3px 0;
      font-size: 0.9rem;
      color: #374151;
    }

    /* 버튼 */
    button {
      background-color: #2563eb;
      color: white;
      border: none;
      padding: 10px 16px;
      border-radius: 10px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.25s ease;
    }
    button:hover {
      background-color: #1e40af;
      transform: scale(1.03);
    }
    button.red {
      background-color: #ef4444;
    }
    button.red:hover {
      background-color: #dc2626;
    }

    /* 테크트리 버튼 간 간격 */
    .tech-buttons a {
      display: block;
      margin-bottom: 10px;
      text-decoration: none;
    }

    /* 시간표 버튼 그룹 */
    .button-group {
      display: flex;
      gap: 10px;
      margin: 10px 0;
      justify-content: center;
    }

    /* 시간표 아이템 */
    #scheduleList .schedule-item {
      background-color: #f3f4f6;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      padding: 8px 12px;
      font-size: 0.9rem;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* 대표 시간표 컨테이너  */
    .representative-container {
      width: 100%;
      display: flex;
      justify-content: center;
      margin-top: 20px; /* 위와 간격 */
      order: 4; /* 세 박스 이후에 위치 */
    }

    .representative-box {
      width: 70%;
      max-width: 1000px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      padding: 30px;
      box-sizing: border-box;
      max-height: 775px; /* 원하는 최대 높이(px) 지정 */
      overflow-y: auto;  /* 내부 요소가 넘칠 경우 스크롤 */
    }



    /* 푸터 */
    footer {
      background-color: rgba(30, 30, 30, 0.98);
      color: rgba(200, 200, 200, 0.7);
      font-size: 0.9rem;
      padding: 2rem 1rem;
      text-align: center;
      border-top: 1px solid #444;
      margin-top: auto;
    }
    footer a {
      text-decoration: none;
      color: rgba(200, 200, 200, 0.7);
      margin: 0 10px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    select {
      appearance: none; /* 기본 화살표 제거 */
      -webkit-appearance: none;
      -moz-appearance: none;

      background-color: white;
      border: 1px solid #cbd5e1;
      border-radius: 8px;
      padding: 10px 14px;
      font-size: 1rem;
      color: #111827;
      font-family: 'Montserrat', sans-serif;
      cursor: pointer;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 16px 16px;
      padding-right: 40px; /* 화살표 공간 확보 */
    }

    select:hover {
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
    }

    select:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
    }
    .modal-overlay {
      position: fixed;
      inset: 0;
      background-color: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-wrapper {
      display: contents;
    }

    .modal {
      background: #fff;
      border-radius: 12px;
      padding: 24px 32px;
      max-width: 400px;
      width: 90%;
      box-shadow: 0 6px 24px rgba(0,0,0,0.2);
      text-align: center;
      display: flex;
      flex-direction: row;
      gap: 16px;
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 12px;
      margin-top: 8px;
    }
    .modal-buttons button {
      flex: 1;
      max-width: 120px;
      padding: 0.6rem 0;
      border-radius: 8px;
      font-size: 0.95rem;
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .modal-buttons #confirm,
    .modal-buttons #changePwBtn {
      background-color: #2563eb;
      color: #fff;
    }
    .modal-buttons #close-btn,
    .modal-buttons #cancelChange {
      background-color: #e0e0e0;
      color: #333;
    }
    .modal-buttons button:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }
    .modal-buttons button:active {
      transform: translateY(1px);
    }

    .modal input[type="password"] {
      width: 100%;
      padding: 0.75rem 1rem;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    .hidden {
      display: none;
    }
    .button-group-vertical {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    body.modal-open{
      overflow: hidden;
    }

    #semesterList li {
      margin: 5px 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #scheduleTable td {
      width: 80px;
      /* 필요 시 최소/최대 너비 조절도 가능 */
      max-width: 100px;
      height: 50px; /* 원하는 값(px, em 등)으로 조정 */
      min-width: 80px; /* 칸의 가로폭도 조절 가능 */
      vertical-align: middle; /* 텍스트 수직 중앙정렬 */
    }
    /* 대표 시간표에만 적용되는 행/열 크기 스타일 */


    /* ───────────────────────────────────────── */
    /* MOD: 사용자 정의 아이콘 + 모달 스타일 */

    /* 1) 사용자 정의 아이콘 렌더 영역 */
    #custom-icons {
      display: flex;
      gap: 30px;
      flex-wrap: wrap;
    }

    /* 2) + 버튼 박스 효과 */
    #add-icon-btn .logo-box {
      background-color: rgba(0,0,0,0.2);
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    #add-icon-btn:hover .logo-box {
      background-color: rgba(0,0,0,0.35);
    }

    /* 3) 모달 오버레이 (아이콘 등록) */
    #add-icon-modal.modal-overlay {
      /* password 모달과 구분을 위해 ID 셀렉터 우선 적용 */
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #add-icon-modal.modal-overlay.hidden {
      display: none;
    }

    /* 4) 모달 본문 */
    #add-icon-modal .modal {
      background: #fff;
      padding: 24px;
      border-radius: 8px;
      width: 300px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    #add-icon-modal .modal h2 {
      margin: 0;
      font-size: 1.2rem;
      color: #111827;
    }
    #add-icon-modal .modal label {
      display: flex;
      flex-direction: column;
      font-size: 0.9rem;
    }
    #add-icon-modal .modal input[type="url"] {
      margin-top: 4px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #add-icon-modal .modal .button-group-vertical {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }
    #add-icon-modal .modal button {
      padding: 8px 12px;
      font-size: 0.9rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    #add-icon-modal .modal button[type="submit"] {
      background: #2563eb;
      color: #fff;
    }
    #add-icon-modal .modal button#cancel-icon-btn {
      background: #ddd;
      color: #333;
    }
    #scheduleTable td {
      width: 80px;
      /* 필요 시 최소/최대 너비 조절도 가능 */
      max-width: 100px;
      height: 50px; /* 원하는 값(px, em 등)으로 조정 */
      min-width: 80px; /* 칸의 가로폭도 조절 가능 */
      vertical-align: middle; /* 텍스트 수직 중앙정렬 */
    }

    .course-tooltip {
      animation: fadeIn 0.12s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px);}
      to { opacity: 1; transform: translateY(0);}
    }


  </style>
</head>
<body onload="loaduserinfo()">
<header>
  <h1><a href="/">SMULET</a></h1>
  <nav>
    <a href="#"><b>이용안내</b></a>
    <a href="/login_page" id="loginLink"><b>로그인</b></a>
    <a href="/Register" id="registerLink"><b>회원가입</b></a>
    <a href="/" id="logoutLink" style="display: none;"><b>로그아웃</b></a>
    <a href="/" id="" style="display: none;"><b>마이페이지</b></a>
  </nav>
</header>
<main>
  <div class="container">
    <!-- BOX1 -->
    <div class="box box1">
      <div class="section">
        <h2>내 정보</h2>
        <div class="nav">
          <div class="info">
            <p>이름: <span id="userName"></span></p>
            <p>이메일: <span id="studentId"></span></p>
            <p>학과: <span id="userMajor">컴퓨터과학과</span></p>
          </div>
        </div>
        <div class="section">
          <h3>회원 설정</h3>
          <div class="button-group">
            <button onclick="modifinguserinfo()">비밀번호 변경</button>
            <button class="red" onclick="deleteAccount()">회원탈퇴</button>
          </div>
        </div>
      </div>
    </div>

    <div id="modalOverlay" class="modal-overlay hidden">
      <div class="modal-wrapper">
        <div class="modal">
          <p>비밀번호를 입력하세요</p>
          <input type="password" id="pw">
          <div class = "modal-buttons">
            <button id="confirm" type="button">확인</button>
            <button id="close-btn" type="button">닫기</button>
          </div>
        </div>
      </div>
    </div>

    <div id="changePwModal" class="modal-overlay hidden">
      <div class="modal-wrapper">
        <div class="modal">
          <p>새 비밀번호를 입력하세요</p>
          <input type="password" id="newPassword" placeholder="새 비밀번호">
          <input type="password" id="confirmPassword" placeholder="비밀번호 확인">
            <div class="modal-buttons">
            <button id="changePwBtn" type="button">변경</button>
            <button id="cancelChange" type="button">취소</button>
          </div>
        </div>
      </div>
    </div>

    <!-- BOX2 -->
    <div class="box box2">
      <h2>테크트리</h2>
      <p class="subtext">모든 테크트리를 만나보세요!</p>

      <select id="techTreeSelect" onchange="goToTechTree()" style="margin-top: 12px;">
        <option value="">학번을 선택하세요</option>
        <option value="21">21학번 테크트리</option>
        <option value="22">22학번 테크트리</option>
        <option value="23">23학번 테크트리</option>
        <option value="24">24학번 테크트리</option>
        <option value="25">25학번 테크트리</option>
      </select>

    </div>

    <div class="box box3">
      <h2>시간표</h2>
      <p class="subtext">시간표를 만나보세요!</p>

      <div style="margin-top: 12px;">
        <button id="showSemesterBtn">시간표 추가</button>
      </div>

      <div id="addSemesterList" class="hidden" style="margin-top: 10px;">
        <select id="semesterSelect"></select>
        <button onclick="addSemester()">추가</button>
      </div>

      <ul id="semesterList" style="margin-top: 12px;"></ul>
      <!-- 시간표 모달 -->

    </div>
    <div id="scheduleModal" class="modal-overlay hidden">
      <div class="modal-wrapper">
        <div class="modal" style="display: flex; width: 90vw; max-width: 1000px; max-height: 800px; overflow: hidden; padding: 30px; gap: 20px;">

          <!-- 왼쪽: 시간표 영역 -->
          <div style="flex: 2; overflow-y: auto;">
            <div style="text-align: right;">
              <button id="closeScheduleModal" style="background: #ef4444; color: white; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer;">닫기</button>
              <button id="saveSchedule" style="background: #4466ef; color: white; border: none; border-radius: 5px; padding: 6px 12px; cursor: pointer;">저장</button>
            </div>
            <h2 style="text-align:center; margin-bottom: 15px;" id="modalSemesterTitle"></h2>
            <div id="scheduleTableContainer">
              <!-- 동적 시간표 -->
            </div>
          </div>

          <!-- 오른쪽: 수업 정보 리스트 영역 -->
          <!-- 오른쪽 수업 정보 리스트 + 검색창 묶기 -->
          <div style="flex: 1; display: flex; flex-direction: column; border-left: 1px solid #ddd; padding-left: 10px;">

            <!-- 🔍 검색창 -->
            <input
                    type="text"
                    id="searchInput"
                    placeholder="과목명 검색"
                    style="width: 100%; margin-bottom: 10px; padding: 8px; border: 1px solid #ccc; border-radius: 6px;"
                    oninput="renderCourseList(currentCourseList)"
            />

            <!-- 📚 수업 리스트 -->
            <div
                    id="classInfoList"
                    style="flex: 1; overflow-y: auto;"
            >
              <!-- JS로 수업 정보가 들어옵니다 -->
            </div>
          </div>


        </div>
      </div>
    </div>
    <div class="representative-container">
      <div class="box representative-box">
        <div style="display:flex; justify-content: space-between; align-items: center;">
          <h2 id="representativeTitle">📌 대표 시간표</h2>
        </div>
        <div id="representativeScheduleContainer">
          <p style="color: #888;">대표 시간표가 아직 설정되지 않았습니다.</p>
        </div>
      </div>
    </div>
  </div>
</main>

<footer>
  <b>
    <a href="#">Github</a>
    <a href="#">개인정보처리방침</a>
    <a href="#">이용약관</a><br><br>
    <a href="#">Copyright</a>
  </b>
</footer>
<script>
  /***********************
   * 상수 / 전역 상태
   ***********************/
  const semesterOptions = [
    "2025년 2학기", "2025년 1학기",
    "2024년 2학기", "2024년 1학기",
    "2023년 2학기", "2023년 1학기",
    "2022년 2학기", "2022년 1학기",
    "2021년 2학기", "2021년 1학기"
  ];

  const randomColors = [
    "#F9E79F","#AEDFF7","#A7F3D0","#FFD6E0","#B4A7F7",
    "#FFD9B3","#B9F6CA","#FFE082","#FFAB91","#D1C4E9"
  ];
  let usedColors = [];

  let UserId = null;
  let representativeSemester = null;

  let selectedSemesters = [];
  let currentCourseList = []; // 모달에 띄운 현재 학기 전체 수업정보

  // 새 구조 핵심
  let timetableIdsBySemester = {}; // { "20252": 123, ... }
  let currentSemesterCode = null;  // 현재 모달에서 편집 중인 학기 코드
  let currentTimetableId = null;   // 현재 모달의 timetableId

  /***********************
   * 공통 유틸
   ***********************/
  function toSemesterCode(semText){
    // "2025년 2학기" -> "20252"
    return semText.replace("년 ","").replace("학기","").replace(" ","");
  }

  function getRandomColorNoDuplicate() {
    const available = randomColors.filter(c => !usedColors.includes(c));
    if (available.length === 0) {
      usedColors = [];
      return getRandomColorNoDuplicate();
    }
    const color = available[Math.floor(Math.random() * available.length)];
    usedColors.push(color);
    return color;
  }
  //
  // "2025년 2학기" -> "20252"
  function toSemesterCode(semText){
    return semText.replace("년 ","").replace("학기","").replace(" ","");
  }

  // 작은 대기 유틸
  function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

  // /userinfo에서 timetables 배열을 보고, term===semesterCode 인 항목 중 가장 최신 timetableId 반환
  async function fetchLatestTimetableIdFromUserInfo(semesterCode, { tries = 6, baseDelay = 300 } = {}) {
    if (!semesterCode) throw new Error('semesterCode가 필요합니다.');
    const termNum = Number(semesterCode);

    const token = localStorage.getItem('jwtToken');
    const headers = { 'Authorization': `Bearer ${token}`, 'Cache-Control': 'no-cache' };

    for (let i = 0; i < tries; i++) {
      const res = await fetch(`/userinfo?_=${Date.now()}`, {
        headers,
        cache: 'no-store',
        credentials: 'include'
      });

      if (res.ok) {
        const u = await res.json();
        // console.warn('[userinfo]', u); // 필요하면 구조 확인용

        if (Array.isArray(u?.timetables)) {
          // term이 일치하는 것들만 필터
          const matches = u.timetables.filter(t => Number(t.term) === termNum);
          if (matches.length) {
            // 가장 큰 timetableId를 최신으로 간주
            const tid = matches.reduce((max, t) => Math.max(max, Number(t.timetableId)), 0);
            if (tid) return tid;
          }
        }
      }

      // DB 반영 지연 대비 백오프
      await sleep(baseDelay * (i + 1));
    }

    return null;
  }

  //
  // 빈 시간표 생성 → /userinfo로 timetableId 획득
  async function createTimetableOnServer(semesterCode) {
    let token = localStorage.getItem('jwtToken');
    if (!token) {
      alert('로그인이 필요합니다.');
      window.location.href = '/login_page';
      throw new Error('JWT 없음');
    }

    // 서버가 FormData를 받는다고 가정 (JSON이면 아래를 JSON으로 바꿔도 됨)
    const fd = new FormData();
    fd.append('semester', semesterCode);

    const res = await fetch('/addTimetable', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }, // FormData일 땐 Content-Type 지정 X
      body: fd,
      credentials: 'include'
    });

    const raw = await res.text();
    if (!res.ok) throw new Error(`addTimetable 실패 (${res.status}): ${raw}`);

    // 응답에 이미 id가 있으면 바로 사용
    try {
      const j = JSON.parse(raw);
      const directId = j.timetableId ?? j.id ?? j.data?.id ?? null;
      if (directId) return Number(directId);
    } catch(_) { /* ignore */ }

    // 없으면 /userinfo에서 term 기준으로 찾아오기 (폴링)
    const tid = await fetchLatestTimetableIdFromUserInfo(semesterCode, { tries: 8, baseDelay: 250 });
    if (!tid) throw new Error('userinfo에서 timetableId를 찾지 못했습니다.');
    return tid;
  }


  /***********************
   * 초기 바인딩
   ***********************/
  document.addEventListener('DOMContentLoaded', function () {
    const loginLink = document.getElementById('loginLink');
    const logoutLink = document.getElementById('logoutLink');
    const registerLink = document.querySelector('nav a[href="/Register"]');
    const token = localStorage.getItem('jwtToken');

    if (token) {
      loginLink.style.display = 'none';
      logoutLink.style.display = 'inline';
      registerLink.style.display = 'none';
    } else {
      loginLink.style.display = 'inline';
      logoutLink.style.display = 'none';
      registerLink.style.display = 'inline';
    }

    logoutLink.addEventListener('click', function (e) {
      e.preventDefault();
      localStorage.removeItem('jwtToken');
      alert('로그아웃 되었습니다.');
      window.location.href = '/';
    });

    const showSemesterBtn = document.getElementById('showSemesterBtn');
    if (showSemesterBtn) {
      showSemesterBtn.addEventListener('click', showAddSemester);
    }
  });

  /***********************
   * 사용자/계정 관련
   ***********************/
  function loaduserinfo() {
    const token = localStorage.getItem('jwtToken');
    fetch('/userinfo', {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${token}` }
    })
            .then(res => {
              if (!res.ok) throw new Error('사용자 정보 불러오기 실패');
              return res.json();
            })
            .then(data => {
              document.getElementById('userName').textContent = data.name;
              document.getElementById('studentId').textContent = data.email;
              UserId = data.id;
            })
            .catch(err => {
              console.error(err);
              alert('사용자 정보를 불러오는데 실패했습니다.');
            });
  }

  function deleteAccount() {
    const token = localStorage.getItem('jwtToken');
    if (!confirm("정말로 회원 탈퇴하시겠습니까? 이 작업은 되돌릴 수 없습니다.")) return;

    fetch('/member/delete', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      }
    })
            .then(res => {
              if (!res.ok) throw new Error('서버 응답 오류');
              return res.json();
            })
            .then(data => {
              if (data.deleteStatus === 'success') {
                alert('회원 탈퇴가 완료되었습니다.');
                localStorage.removeItem('jwtToken');
                window.location.href = '/';
              }
            })
            .catch(err => {
              alert('회원 탈퇴 중 오류가 발생했습니다.');
              console.error(err);
            });
  }

  function modifinguserinfo() {
    const modalOverlay = document.getElementById('modalOverlay');
    const closeBtn = document.getElementById('close-btn');
    const confirmBtn = document.getElementById('confirm');
    const token = localStorage.getItem('jwtToken');

    modalOverlay.classList.remove('hidden');
    document.body.classList.add("modal-open");

    closeBtn.onclick = () => {
      modalOverlay.classList.add("hidden");
      document.body.classList.remove("modal-open");
    };

    confirmBtn.onclick = () => {
      const pw = document.getElementById('pw').value;

      fetch('/check_pw_button', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ pw })
      })
              .then(res => {
                if (!res.ok) throw new Error('서버 응답 오류');
                return res.json();
              })
              .then(data => {
                if (data.Password === true) {
                  alert('비밀번호 확인 완료!');
                  modalOverlay.classList.add("hidden");
                  document.getElementById("changePwModal").classList.remove("hidden");
                } else {
                  alert('비밀번호가 일치하지 않습니다.');
                }
              })
              .catch(err => {
                alert('요청 중 문제가 발생했습니다: ' + err.message);
                console.error(err);
              });
    };
  }

  document.getElementById("changePwBtn").onclick = function () {
    const newPw = document.getElementById("newPassword").value;
    const confirmPw = document.getElementById("confirmPassword").value;
    const token = localStorage.getItem("jwtToken");

    if (!newPw || !confirmPw || newPw !== confirmPw) {
      alert("비밀번호를 정확히 입력해주세요.");
      return;
    }

    fetch('/PWupdate_button', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`
      },
      body: JSON.stringify({ pw: newPw })
    })
            .then(async res => {
              if (!res.ok) {
                const errorText = await res.text();
                alert(`서버 오류 ${res.status}: ${errorText}`);
                throw new Error("서버 오류: " + res.status);
              }
              return res.json();
            })
            .then(data => {
              if (data.updateStatus === true) {
                alert("비밀번호가 성공적으로 변경되었습니다.");
                document.getElementById("changePwModal").classList.add("hidden");
              } else {
                alert("비밀번호 변경에 실패했습니다.");
              }
            })
            .catch(err => {
              alert("비밀번호 변경 중 오류 발생: " + err.message);
            });
  };
  document.getElementById("openPwModalBtn")?.addEventListener('click', () => {
    document.getElementById("changePwModal").classList.remove("hidden");
    document.getElementById("newPassword").value = "";
    document.getElementById("confirmPassword").value = "";
  });
  document.getElementById("close-btn").onclick = function () {
    document.getElementById("modalOverlay").classList.add("hidden");
  };
  document.getElementById("cancelChange").onclick = function () {
    document.getElementById("changePwModal").classList.add("hidden");
  };

  function goToTechTree() {
    const select = document.getElementById('techTreeSelect');
    const year = select.value;
    const token = localStorage.getItem('jwtToken');

    if (!token) { alert("로그인 토큰이 없습니다."); return; }
    if (!year)  { alert("학번을 선택하세요."); return; }

    fetch(`/tech_tree?year=${year}`, {
      method: 'GET',
      headers: { 'Authorization': `Bearer ${token}` }
    })
            .then(res => {
              if (res.ok) return res.text();
              else throw new Error("Unauthorized");
            })
            .then(html => {
              document.open(); document.write(html); document.close();
            })
            .catch(err => {
              console.error(err);
              window.location.href = '/';
            });
  }

  /***********************
   * 학기 추가/리스트/모달
   ***********************/
  function showAddSemester() {
    const addList = document.getElementById('addSemesterList');
    const select = document.getElementById('semesterSelect');

    select.innerHTML = '';
    semesterOptions.forEach(sem => {
      if (!selectedSemesters.includes(sem)) {
        const option = document.createElement('option');
        option.value = sem;
        option.textContent = sem;
        select.appendChild(option);
      }
    });

    addList.classList.toggle('hidden');
  }

  async function addSemester() {
    const select = document.getElementById('semesterSelect');
    const selected = select.value;
    if (!selected) return;

    const semesterCode = toSemesterCode(selected);

    try {
      // 1) 서버에 빈 시간표 생성
      const tid = await createTimetableOnServer(semesterCode);

      // 2) 로컬 상태 업데이트
      timetableIdsBySemester[semesterCode] = tid;
      if (!selectedSemesters.includes(selected)) selectedSemesters.push(selected);

      renderSemesterList();
      document.getElementById('addSemesterList').classList.add('hidden');
    } catch (err) {
      console.error(err);
      alert(`시간표 생성 중 오류: ${err.message}`);
    }
  }

  function renderSemesterList() {
    const list = document.getElementById('semesterList');
    list.innerHTML = '';

    selectedSemesters.forEach((sem, index) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="semester-name" style="cursor:pointer; color:#2563eb; text-decoration: underline;">${sem}</span>
        <div>
          <button onclick="removeSemester(${index})" style="color: white; background-color: red;">삭제</button>
          <button onclick="loadRepresentativeSchedule('${sem}')" style="margin-left: 8px;">대표로 설정</button>
        </div>
      `;
      list.appendChild(li);

      li.querySelector('.semester-name').addEventListener('click', () => {
        openScheduleModal(sem);
      });
    });
  }

  function openScheduleModal(semester) {
    const modal = document.getElementById('scheduleModal');
    const title = document.getElementById('modalSemesterTitle');
    const container = document.getElementById('scheduleTableContainer');
    const listContainer = document.getElementById('classInfoList');

    // 현재 학기코드/ID 확보
    currentSemesterCode = toSemesterCode(semester);
    currentTimetableId = timetableIdsBySemester[currentSemesterCode] ?? null;

    if (!currentTimetableId) {
      alert('이 학기의 시간표 ID가 없습니다. 먼저 "시간표 추가"에서 학기를 추가하세요.');
      return;
    }

    document.getElementById("closeScheduleModal").onclick = function (){
      document.getElementById("scheduleModal").classList.add("hidden");
      document.body.classList.remove("modal-open");
      hideCourseTooltip();
    };

    title.textContent = semester;
    container.innerHTML = generateEmptyScheduleTable();
    listContainer.innerHTML = "<p>수업 정보를 불러오는 중입니다...</p>";
    modal.classList.remove('hidden');
    document.body.classList.add('modal-open');

    const token = localStorage.getItem('jwtToken');

    // 🟢 1) 현재 시간표 불러오기
    fetch("/getTC", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify({ timetableId: currentTimetableId })
    })
            .then(res => {
              if (!res.ok) throw new Error("시간표 조회 실패");
              return res.json();
            })
            .then(scheduleData => {
              if (Array.isArray(scheduleData) && scheduleData.length > 0) {
                renderScheduleWithData(scheduleData);
              }
            })
            .catch(err => {
              console.error("getTC 오류:", err);
            });

    // 🟢 2) 수업 목록 불러오기
    fetch("/a", { headers: { 'Authorization': `Bearer ${token}` }})
            .then(res => res.json())
            .then(data => {
              currentCourseList = data;
              renderCourseList(data);
              attachCellEvents();
            })
            .catch(err => {
              listContainer.innerHTML = `<p style="color:red;">수업 목록을 불러오지 못했습니다.</p>`;
              console.error(err);
            });

    // 저장 핸들러(중복 방지)
    const saveBtn = document.getElementById("saveSchedule");
    saveBtn.replaceWith(saveBtn.cloneNode(true));
    document.getElementById("saveSchedule").addEventListener("click", onClickSaveSchedule);
  }


  /***********************
   * 수업 리스트/선택/미리보기
   ***********************/
  function renderCourseList(classList) {
    const listContainer = document.getElementById('classInfoList');
    listContainer.innerHTML = '';

    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput?.value?.toLowerCase() || '';

    if (!Array.isArray(classList) || classList.length === 0) {
      listContainer.innerHTML = '<p>수업 정보가 없습니다.</p>';
      return;
    }

    const groupedByCourse = groupByCourse(classList);

    Object.entries(groupedByCourse).forEach(([courseName, allEntries]) => {
      if (searchTerm && !courseName.toLowerCase().includes(searchTerm)) return;

      const wrapper = document.createElement('div');
      wrapper.style.marginBottom = '12px';
      wrapper.style.border = '1px solid #ccc';
      wrapper.style.borderRadius = '6px';
      wrapper.style.background = '#f9f9f9';
      wrapper.style.padding = '10px';

      const header = document.createElement('div');
      header.style.cursor = 'pointer';
      header.style.fontWeight = 'bold';
      header.style.color = '#2563eb';
      header.textContent = courseName;

      const subList = document.createElement('div');
      subList.style.display = 'none';
      subList.style.marginTop = '8px';

      const groupedByIdentifyNumber = {};
      allEntries.forEach(entry => {
        const key = entry.identifyNumberOfCourse;
        if (!groupedByIdentifyNumber[key]) groupedByIdentifyNumber[key] = [];
        groupedByIdentifyNumber[key].push(entry);
      });

      Object.values(groupedByIdentifyNumber).forEach(entries => {
        const detail = document.createElement('div');
        detail.style.padding = '6px 10px';
        detail.style.borderTop = '1px solid #ddd';
        detail.style.cursor = 'pointer';
        detail.style.background = '#fff';

        const professor = entries[0].professorName || '-';
        const division = entries[0].identifyNumberOfCourse.split('-')[1] || '?';
        const weekdayNames = ['월','화','수','목','금'];
        const timeText = entries.map(e => {
          const day = weekdayNames[e.scheduleDay - 1] || `요일 ${e.scheduleDay}`;
          return e.timeStart === e.timeEnd
                  ? `${day} ${e.timeStart}교시`
                  : `${day} ${e.timeStart}~${e.timeEnd}교시`;
        }).join(', ');

        detail.innerHTML = `
          분반: ${division}<br>
          교수: ${professor}<br>
          시간: ${timeText}
        `;

        detail.addEventListener('mouseover', () => {
          if (!isCoursePermanentlyAdded(entries)) previewCourseOnSchedule(entries);
        });
        detail.addEventListener('mouseout', () => {
          if (!isCoursePermanentlyAdded(entries)) removePreviewFromSchedule();
        });
        detail.addEventListener('click', () => {
          addCourseToScheduleTable(entries); // 실제 등록/토글
        });

        subList.appendChild(detail);
      });

      header.addEventListener('click', () => {
        subList.style.display = (subList.style.display === 'none') ? 'block' : 'none';
      });

      wrapper.appendChild(header);
      wrapper.appendChild(subList);
      listContainer.appendChild(wrapper);
    });
  }

  function groupByCourse(data) {
    const map = {};
    data.forEach(entry => {
      const key = entry.courseName;
      if (!map[key]) map[key] = [];
      map[key].push(entry);
    });
    return map;
  }

  function previewCourseOnSchedule(courseEntries) {
    const table = document.getElementById('scheduleTable');
    if (!table) return;

    courseEntries.forEach(entry => {
      const dayIndex = entry.scheduleDay - 1;
      for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
        const cell = table.rows[p + 1].cells[dayIndex + 1];
        if (!cell.getAttribute('data-course-id')) {
          cell.style.backgroundColor = '#d0ebff';
          cell.innerHTML = `${entry.courseName}<br>(${entry.classroom})`;
          cell.setAttribute('data-preview', 'true');
        }
      }
    });
  }

  function removePreviewFromSchedule() {
    const table = document.getElementById('scheduleTable');
    if (!table) return;
    const cells = table.querySelectorAll('td[data-preview="true"]');
    cells.forEach(cell => {
      cell.innerHTML = '';
      cell.style.backgroundColor = '';
      cell.removeAttribute('data-preview');
    });
  }

  function isCoursePermanentlyAdded(courseEntries) {
    const table = document.getElementById('scheduleTable');
    const courseId = courseEntries[0].identifyNumberOfCourse;

    for (let entry of courseEntries) {
      const dayIndex = entry.scheduleDay - 1;
      for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
        const cell = table.rows[p + 1].cells[dayIndex + 1];
        if (cell.getAttribute('data-course-id') === courseId) {
          return true;
        }
      }
    }
    return false;
  }

  function addCourseToScheduleTable(entries) {
    const table = document.getElementById('scheduleTable');
    if (!table) return;

    const courseId = entries[0].identifyNumberOfCourse;
    const courseName = entries[0].courseName;
    const classroom = entries[0].classroom;

    // 이미 등록되어 있으면 토글 삭제
    if (isCoursePermanentlyAdded(entries)) {
      entries.forEach(entry => {
        const dayIndex = entry.scheduleDay - 1;
        for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
          const cell = table.rows[p + 1].cells[dayIndex + 1];
          if (cell.getAttribute('data-course-id') === courseId) {
            cell.innerHTML = '';
            cell.style.backgroundColor = '';
            cell.removeAttribute('data-course-id');
            cell.removeAttribute('data-class-id');
            cell.removeAttribute('data-preview');
          }
        }
      });
      return;
    }

    // 시간 충돌 체크
    for (let entry of entries) {
      const dayIndex = entry.scheduleDay - 1;
      for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
        const cell = table.rows[p + 1].cells[dayIndex + 1];
        const existingId = cell.getAttribute('data-course-id');
        if (existingId && existingId !== courseId) {
          alert("해당 시간에 이미 다른 수업이 있습니다!");
          return;
        }
      }
    }

    // 등록
    const bg = getRandomColorNoDuplicate();
    entries.forEach(entry => {
      const dayIndex = entry.scheduleDay - 1;
      for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
        const cell = table.rows[p + 1].cells[dayIndex + 1];
        cell.innerHTML = `${courseName}<br>(${classroom})`;
        cell.style.backgroundColor = bg;
        cell.setAttribute('data-course-id', entry.identifyNumberOfCourse);
        cell.setAttribute('data-class-id', entry.timeTableId); // ← addTC에 보낼 "수업 PK"
        cell.removeAttribute('data-preview');
      }
    });

    attachCellEvents();
  }

  /***********************
   * 툴팁
   ***********************/
  function attachCellEvents() {
    const table = document.getElementById('scheduleTable');
    if (!table) return;
    const allCells = table.querySelectorAll('td[data-period]');
    allCells.forEach(cell => {
      cell.onmouseover = function () {
        const courseId = cell.getAttribute('data-course-id');
        if (courseId) {
          // 같은 과목 여러 엔트리 중 첫 항목
          const courseInfo = currentCourseList.find(c => c.identifyNumberOfCourse === courseId);
          if (courseInfo) showCourseTooltip(cell, courseInfo);
        }
      };
      cell.onmouseout = function () {
        hideCourseTooltip();
      };
    });
  }

  function showCourseTooltip(cell, courseInfo) {
    hideCourseTooltip();
    const tooltip = document.createElement('div');
    tooltip.className = 'course-tooltip';
    tooltip.style.position = 'absolute';
    tooltip.style.zIndex = 2000;
    tooltip.style.minWidth = '180px';
    tooltip.style.maxWidth = '260px';
    tooltip.style.background = '#ffffffcc';
    tooltip.style.border = '1px solid #2563eb';
    tooltip.style.borderRadius = '10px';
    tooltip.style.boxShadow = '0 4px 18px rgba(30,80,210,0.13)';
    tooltip.style.padding = '14px 18px 14px 14px';
    tooltip.style.fontSize = '0.98rem';
    tooltip.style.pointerEvents = 'none';
    tooltip.innerHTML = `
      <b>${courseInfo.courseName}</b>
      <br>교수: ${courseInfo.professorName || "-"}
      <br>강의실: ${courseInfo.classroom}
      <br>구분: ${courseInfo.majorOrCulture ? "전공" : "교양"}
      <br>학점: ${courseInfo.credit}
      <br>요일: ${['월', '화', '수', '목', '금'][courseInfo.scheduleDay - 1] || courseInfo.scheduleDay}
      <br>교시: ${courseInfo.timeStart} ~ ${courseInfo.timeEnd}
      <br>과목코드: ${courseInfo.identifyNumberOfCourse}
    `;
    document.body.appendChild(tooltip);

    const rect = cell.getBoundingClientRect();
    tooltip.style.left = (rect.right + 8) + "px";
    tooltip.style.top = (rect.top + window.scrollY) + "px";
  }

  function hideCourseTooltip() {
    const prev = document.querySelector('.course-tooltip');
    if (prev) prev.remove();
  }

  /***********************
   * 저장(addTC) & 헬퍼
   ***********************/
  function getSelectedClassIds() {
    const cells = document.querySelectorAll('#scheduleTable td[data-class-id]');
    const set = new Set();
    cells.forEach(cell => {
      const id = cell.getAttribute('data-class-id');
      if (id) set.add(Number(id));
    });
    return Array.from(set);
  }

  async function onClickSaveSchedule() {
    try {
      // 혹시 유실됐으면 복구
      if (!currentTimetableId) {
        currentTimetableId = timetableIdsBySemester[currentSemesterCode] ?? null;
      }
      if (!currentTimetableId) {
        currentTimetableId = await fetchLatestTimetableIdFromUserInfo();
      }
      if (!currentTimetableId) throw new Error('timetableId가 없습니다.');

      const classIds = getSelectedClassIds();
      if (classIds.length === 0) {
        alert('저장할 수업이 없습니다.');
        return;
      }

      const token = localStorage.getItem('jwtToken');

      // 서버가 FormData만 받는 경우:
       const fd = new FormData();
       fd.append('timetableId', currentTimetableId);
       classIds.forEach(id => fd.append('classIds[]', id));
       const res = await fetch('/addTC', {
         method: 'POST',
         headers: { 'Authorization': `Bearer ${token}` },
         body: fd
       });

      const txt = await res.text();
      if (!res.ok) throw new Error(`addTC 실패: ${txt}`);

      alert('저장 완료!');
    } catch (err) {
      console.error(err);
      alert(`저장 중 오류: ${err.message}`);
    }
  }

  /***********************
   * 테이블 렌더
   ***********************/
  function generateEmptyScheduleTable() {
    const days = ['월', '화', '수', '목', '금'];
    let html = '<table id="scheduleTable" style="width:100%; border-collapse: collapse;">';

    html += '<tr><th></th>';
    days.forEach(day => {
      html += `<th style="border: 1px solid #ddd; padding: 8px; background:#f8f9fa;">${day}</th>`;
    });
    html += '</tr>';

    let startHour = 8;
    let endHour = 9;
    for (let period = 0; period <= 15; period++) {
      const timeStr = startHour <= 12 ? `${startHour}시` : `${startHour - 12}시`;
      const endtime = endHour <= 12 ? `${endHour}시` : `${endHour - 12}시`;
      html += `<tr><td style="border: 1px solid #ddd; padding: 8px; background:#e3e3fd; font-weight:bold;">${period}교시<br>(${timeStr}~${endtime})</td>`;

      days.forEach(() => {
        html += `<td style="border: 1px solid #ddd; padding: 8px;" data-period="${period}"></td>`;
      });

      html += '</tr>';
      startHour++;
      endHour++;
    }

    html += '</table>';
    return html;
  }

  /***********************
   * 대표 시간표 (기존 로직 유지)
   ***********************/
  async function loadRepresentativeSchedule() {
    const token = localStorage.getItem('jwtToken');

    try {
      const res = await fetch('/tableId_List', {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!res.ok) throw new Error("시간표 목록을 불러오는 데 실패했습니다.");
      const data = await res.json(); // 예: { "20242": [101, 102], "20241": [88] }

      const semesters = Object.keys(data).sort((a, b) => b - a);
      if (semesters.length === 0) {
        alert("저장된 시간표가 없습니다.");
        return;
      }

      const latestSemesterCode = semesters[0];
      const latestSemesterList = data[latestSemesterCode];
      const representativeId = latestSemesterList[0];

      const detailRes = await fetch(`/timetable/detail?id=${representativeId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });

      if (!detailRes.ok) throw new Error("대표 시간표 정보를 불러오지 못했습니다.");
      const scheduleData = await detailRes.json(); // 예: [{ subject, professor, day, period }, ...]

      const year = latestSemesterCode.slice(0, 4);
      const semester = latestSemesterCode.slice(4) === "1" ? "1학기" : "2학기";
      const semesterName = `${year}년 ${semester}`;

      renderRepresentativeSchedule(scheduleData, semesterName);
    } catch (err) {
      console.error(err);
      alert("대표 시간표를 불러오는 중 오류가 발생했습니다.");
    }
  }

  function renderRepresentativeSchedule(scheduleData, semesterName) {
    const container = document.getElementById('representativeScheduleContainer');
    const title = document.getElementById('representativeTitle');

    title.innerHTML = `📌 대표 시간표 - ${semesterName}`;
    container.innerHTML = generateEmptyScheduleTable();

    const table = container.querySelector('#scheduleTable');
    if (!table) return;

    const days = ['월', '화', '수', '목', '금'];

    scheduleData.forEach(item => {
      const dayIndex = days.indexOf(item.day);
      if (dayIndex === -1) return;

      const row = table.rows[item.period];
      if (!row) return;

      const cell = row.cells[dayIndex + 1];
      if (cell) {
        cell.innerHTML = `${item.subject}<br>(${item.professor})`;
        cell.style.backgroundColor = '#e0f7fa';
        cell.style.border = '1px solid #90caf9';
      }
    });
  }

  async function removeSemester(timetableId) {
    if (!Number.isInteger(timetableId)) {
      alert("유효한 timetableId가 필요합니다.");
      return;
    }

    const token = localStorage.getItem('jwtToken');

    try {
      const res = await fetch('/deleteTC', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ timetableId: timetableId })
      });

      const txt = await res.text();
      let data;
      try {
        data = JSON.parse(txt);
      } catch {
        data = { raw: txt };
      }

      if (res.ok && (data.deleteStatus === "success" || data.success === true)) {
        alert("시간표가 삭제되었습니다.");
      } else {
        alert("삭제 실패: " + txt);
      }
    } catch (err) {
      alert("삭제 중 오류 발생: " + err.message);
      console.error(err);
    }
  }

</script>

</body>
</html>