<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì „ê³µ ì´ìˆ˜ ì²´ê³„ë„</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leader-line/1.0.7/leader-line.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Montserrat', sans-serif;
      background-color: #f7f9fc;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    header {
      background-color: white;
      padding: 20px;
      box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #e2e8f0;
    }
    h1 {
      font-size: 2.3rem;
      font-weight: bold;
      color: #2563eb;
      margin: 0;
    }
    h1 a {
      text-decoration: none;
      color: inherit;
    }
    nav a {
      margin-left: 20px;
      text-decoration: none;
      color: #333;
      font-weight: 500;
    }
    nav a:hover {
      color: #3b82f6;
    }
    .grid-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
      max-width: 1200px;
      margin: 50px auto;
      position: relative;
    }
    .year-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      background-color: #ddd;
      border-radius: 20px;
      padding: 10px;
      font-size: 1.1rem;  /* ì›í•˜ëŠ” í¬ê¸°ë¡œ ì¡°ì •! */
    }
    .year{
      font-size: 1.3rem;
      font-weight: bold;
    }
    .semester-container {
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 15px;
      background-color: #bbb;
      padding: 10px;
      border-radius: 10px;
      width: 100%;
      flex-wrap: wrap;
    }

    .course {
      background-color: white;
      border: 2px solid black;
      padding: 15px;
      text-align: center;
      font-weight: bold;
      border-radius: 12px;
      min-width: 100px;
      transition: opacity 0.3s;

    }
    .flex-center-header {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 40px;
      margin: 20px auto;
      text-align: center;
    }
    .flex-center-header h1 {
      font-size: 2rem;
      font-weight: bold;
      margin: 0;
      color: #111;
    }
    .legend {
      display: flex;
      gap: 16px;
      align-items: center;
      font-size: 14px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .legend-box {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      border: 1px solid black;
    }
    .legend-bsm {
      background-color: #ffeb3b;
    }
    .legend-design {
      background-color: #1d7bc5;
    }
    .legend-thick {
      width: 16px;
      height: 16px;
      border: 4px solid black;
      background-color: white;
      border-radius: 4px;
    }
    .bsm { /* ë…¸ë‘ */
      border-color: #fff100 !important;
      border-width: 3px !important;
    }
    .design {
      border-color: #125a8e !important;
      border-width: 3px !important;
    }
    .advanced {
      border-width: 5px !important;
      border-style: double !important;
    }
    .course.design.advanced {
      border-color: #125a8e !important;
      border-style: double !important;
    }
    .dimmed {
      opacity: 0.2;
    }

    footer {
      background-color: rgba(30, 30, 30, 0.98);
      color: rgba(200, 200, 200, 0.7);
      font-size: 0.9rem;
      padding: 2rem 1rem;
      text-align: center;
      border-top: 1px solid #444;
      margin-top: auto;
    }
    footer a {
      text-decoration: none;
      color: rgba(200, 200, 200, 0.7);
      margin: 0 10px;
    }
    footer a:hover {
      text-decoration: underline;
    }
    .course.completed-course {
      background-color: #dbeafe;   /* ì˜…ì€ íŒŒë‘ */
      border-color: #2563eb;
      color: #1e3a8a;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
    }
  </style>
</head>
<body>
<header>
  <h1><a href="/static">SMULET</a></h1>
  <nav>
    <a href="#"><b>ì´ìš©ì•ˆë‚´</b></a>
    <a href="/Register"><b>íšŒì›ê°€ì…</b></a>
  </nav>
</header>

<div class="flex-center-header">
  <h1>ì „ê³µ ì´ìˆ˜ ì²´ê³„ë„(22í•™ë²ˆ)</h1>
  <div class="legend">
    <div class="legend-item">
      <div class="legend-box legend-bsm"></div><span>BSM</span>
    </div>
    <div class="legend-item">
      <div class="legend-box legend-design"></div><span>ì„¤ê³„</span>
    </div>
    <div class="legend-item">
      <div class="legend-thick"></div><span>ì „ê³µ ì‹¬í™”</span>
    </div>
  </div>
</div>

<div class="grid-container" id="grid">
  <div class="year-container">
    <div class = 'year'>1í•™ë…„</div>
    <div class="semester-container">
      <div class = "semester-label">1í•™ê¸°</div>
      <div class="course bsm" data-subject="ì»´í“¨í„°ìˆ˜í•™">ì»´í“¨í„°ìˆ˜í•™</div>
      <div class="course" data-subject="íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°">íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°</div>
    </div>
    <div class="semester-container">
      <div class = "semester-label">2í•™ê¸°</div>
      <div class="course design" data-subject="ê³µí•™ì„¤ê³„ì…ë¬¸">ê³µí•™ì„¤ê³„ì…ë¬¸</div>
      <div class="course" data-subject="Cí”„ë¡œê·¸ë˜ë° I">Cí”„ë¡œê·¸ë˜ë° I</div>
      <div class="course bsm" data-subject="ì„ í˜•ëŒ€ìˆ˜í•™ I">ì„ í˜•ëŒ€ìˆ˜í•™ I</div>
    </div>
  </div>
  <div class="year-container">
    <div class = 'year'>2í•™ë…„</div>
    <div class="semester-container">
      <div class = "semester-label">1í•™ê¸°</div>
      <div class="course" data-subject="Cí”„ë¡œê·¸ë˜ë° II">Cí”„ë¡œê·¸ë˜ë° II</div>
      <div class="course" data-subject="ìë£Œêµ¬ì¡°">ìë£Œêµ¬ì¡°</div>
      <div class="course bsm" data-subject="ì´ì‚°ìˆ˜í•™">ì´ì‚°ìˆ˜í•™</div>
      <div class="course design" data-subject="ë…¼ë¦¬íšŒë¡œ">ë…¼ë¦¬íšŒë¡œ</div>
      <div class="course bsm" data-subject="ì„ í˜•ëŒ€ìˆ˜í•™ II">ì„ í˜•ëŒ€ìˆ˜í•™ II</div>
    </div>
    <div class="semester-container">
      <div class = "semester-label">2í•™ê¸°</div>
      <div class="course" data-subject="ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°">ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ë°ì´í„°ë² ì´ìŠ¤">ë°ì´í„°ë² ì´ìŠ¤</div>
      <div class="course" data-subject="ì•Œê³ ë¦¬ì¦˜">ì•Œê³ ë¦¬ì¦˜</div>
      <div class="course bsm" data-subject="í†µê³„ì ë¶„ì„">í†µê³„ì ë¶„ì„</div>
      <div class="course design" data-subject="ì‹œìŠ¤í…œ ì†Œí”„íŠ¸ì›¨ì–´">ì‹œìŠ¤í…œ ì†Œí”„íŠ¸ì›¨ì–´</div>
      <div class="course" data-subject="ì»´í“¨í„°êµ¬ì¡°">ì»´í“¨í„°êµ¬ì¡°</div>
      <div class="course" data-subject="ì •ë³´ë³´í˜¸">ì •ë³´ë³´í˜¸</div>
    </div>
  </div>
  <div class="year-container">
    <div class = 'year'>3í•™ë…„</div>
    <div class="semester-container">
      <div class = "semester-label">1í•™ê¸°</div>
      <div class="course design advanced" data-subject="ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™">ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™</div>
      <div class="course advanced" data-subject="ìš´ì˜ì²´ì œ">ìš´ì˜ì²´ì œ</div>
      <div class="course" data-subject="ë°ì´í„°ëª¨ë¸ë§ê³¼ë§ˆì´ë‹">ë°ì´í„°ëª¨ë¸ë§ê³¼ë§ˆì´ë‹</div>
      <div class="course advanced" data-subject="ì¸ê³µì§€ëŠ¥">ì¸ê³µì§€ëŠ¥</div>
      <div class="course advanced" data-subject="ì»´í“¨í„°ë„¤íŠ¸ì›Œí¬">ì»´í“¨í„°ë„¤íŠ¸ì›Œí¬</div>
      <div class="course" data-subject="ë””ì§€í„¸ ì‹ í˜¸ì²˜ë¦¬">ë””ì§€í„¸ ì‹ í˜¸ì²˜ë¦¬</div>
    </div>
    <div class="semester-container">
      <div class = "semester-label">2í•™ê¸°</div>
      <div class="course advanced" data-subject="ê³ ê¸‰ê°ì²´ì§€í–¥í”„ë¡œê·¸ë˜ë°">ê³ ê¸‰ê°ì²´ì§€í–¥í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤">ì‚¬ìš©ìì¸í„°í˜ì´ìŠ¤</div>
      <div class="course" data-subject="GPU í”„ë¡œê·¸ë˜ë°">GPU í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ë¶„ì‚°ì‹œìŠ¤í…œ">ë¶„ì‚°ì‹œìŠ¤í…œ</div>
      <div class="course advanced" data-subject="í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡ ">í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡ </div>
      <div class="course advanced" data-subject="ìœ ë‹‰ìŠ¤ í”„ë¡œê·¸ë˜ë°">ìœ ë‹‰ìŠ¤ í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ë°ì´í„° í†µì‹ ">ë°ì´í„° í†µì‹ </div>
      <div class="course advanced" data-subject="ì•”í˜¸í•™">ì•”í˜¸í•™</div>
    </div>
  </div>
  <div class="year-container">
    <div class = 'year'>4í•™ë…„</div>
    <div class="semester-container">
      <div class = "semester-label">1í•™ê¸°</div>
      <div class="course design" data-subject="ìº¡ìŠ¤í†¤ë””ìì¸ I">ìº¡ìŠ¤í†¤ë””ìì¸ I</div>
      <div class="course design" data-subject="ë¹…ë°ì´í„°ì‘ìš©">ë¹…ë°ì´í„°ì‘ìš©</div>
      <div class="course" data-subject="í´ë¼ìš°ë“œ í”„ë¡œê·¸ë˜ë°">í´ë¼ìš°ë“œ í”„ë¡œê·¸ë˜ë°</div>
      <div class="course" data-subject="ë„¤íŠ¸ì›Œí¬ë³´ì•ˆ">ë„¤íŠ¸ì›Œí¬ë³´ì•ˆ</div>
    </div>
    <div class="semester-container">
      <div class = "semester-label">2í•™ê¸°</div>
      <div class="course design" data-subject="ìº¡ìŠ¤í†¤ë””ìì¸ II">ìº¡ìŠ¤í†¤ë””ìì¸ II</div>
      <div class="course" data-subject="í´ë¼ìš°ë“œ í”Œë«í¼">í´ë¼ìš°ë“œ í”Œë«í¼</div>
      <div class="course" data-subject="ì»´íŒŒì¼ëŸ¬">ì»´íŒŒì¼ëŸ¬</div>
      <div class="course" data-subject="ICT í•™ì ì´ìˆ˜ ì¸í„´ì œ">ICT í•™ì ì´ìˆ˜ ì¸í„´ì œ</div>
    </div>
  </div>

</div>

<footer>
  <b>
    <a href="#">Github</a>
    <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
    <a href="#">ì´ìš©ì•½ê´€</a><br><br>
    <a href="#">Copyright</a>
  </b>
</footer>

<script>
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      await TokenManager.refresh();

      if (!TokenManager.get()) {
        throw new Error('No access token');
      }

      await highlightCompletedCourses();

    } catch (e) {
      console.warn('Token check failed:', e);
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      logout();
      window.location.href = '/login_page';
    }
  });


  const groups = {
    pink: ['ê³µí•™ì„¤ê³„ì…ë¬¸', 'ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™', 'ìº¡ìŠ¤í†¤ë””ìì¸ I', 'ìº¡ìŠ¤í†¤ë””ìì¸ II'],
    green: ['íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°', 'Cí”„ë¡œê·¸ë˜ë° I', 'Cí”„ë¡œê·¸ë˜ë° II', 'ê°ì²´ì§€í–¥ í”„ë¡œê·¸ë˜ë°', 'ê³ ê¸‰ê°ì²´ì§€í–¥í”„ë¡œê·¸ë˜ë°', 'ìº¡ìŠ¤í†¤ë””ìì¸ I', 'ìº¡ìŠ¤í†¤ë””ìì¸ II'],
    purple: ['ì„ í˜•ëŒ€ìˆ˜í•™ I', 'ì„ í˜•ëŒ€ìˆ˜í•™ II', 'ë””ì§€í„¸ ì‹ í˜¸ì²˜ë¦¬'],
    orange: ['íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°', 'Cí”„ë¡œê·¸ë˜ë° I', 'Cí”„ë¡œê·¸ë˜ë° II', 'ì‹œìŠ¤í…œ ì†Œí”„íŠ¸ì›¨ì–´', 'ìš´ì˜ì²´ì œ', 'ìœ ë‹‰ìŠ¤ í”„ë¡œê·¸ë˜ë°'],
    navy: ['íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°', 'Cí”„ë¡œê·¸ë˜ë° I', 'Cí”„ë¡œê·¸ë˜ë° II', 'ìë£Œêµ¬ì¡°', 'ë°ì´í„°ë² ì´ìŠ¤', 'ë°ì´í„°ëª¨ë¸ë§ê³¼ë§ˆì´ë‹', 'ë¹…ë°ì´í„°ì‘ìš©'],
    mint: ['ì´ì‚°ìˆ˜í•™', 'í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡ ', 'ì»´íŒŒì¼ëŸ¬'],
    gray: ['íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë°', 'Cí”„ë¡œê·¸ë˜ë° I', 'Cí”„ë¡œê·¸ë˜ë° II', 'ì‹œìŠ¤í…œ ì†Œí”„íŠ¸ì›¨ì–´', 'ìš´ì˜ì²´ì œ', 'ìœ ë‹‰ìŠ¤ í”„ë¡œê·¸ë˜ë°'],
    cobalt: ['ì„ í˜•ëŒ€ìˆ˜í•™ I', 'ì„ í˜•ëŒ€ìˆ˜í•™ II', 'ì¸ê³µì§€ëŠ¥'],
    brown: ['ì •ë³´ë³´í˜¸', 'ì•”í˜¸í•™', 'ë„¤íŠ¸ì›Œí¬ë³´ì•ˆ'],
    red: ['í´ë¼ìš°ë“œ í”„ë¡œê·¸ë˜ë°', 'í´ë¼ìš°ë“œ í”Œë«í¼'],
    gold: ['ì»´í“¨í„°ë„¤íŠ¸ì›Œí¬', 'ë°ì´í„° í†µì‹ '],
    wine: ['í†µê³„ì  ë¶„ì„', 'ì¸ê³µì§€ëŠ¥'],
    coral: ['ìë£Œêµ¬ì¡°', 'ì•Œê³ ë¦¬ì¦˜'],
    beige: ['ì´ì‚°ìˆ˜í•™', 'ì•Œê³ ë¦¬ì¦˜'],
    orchid: ['ë…¼ë¦¬íšŒë¡œ', 'ì»´í“¨í„°êµ¬ì¡°'],
  };

  const allCourses = document.querySelectorAll('.course');
  let activeLines = [];

  function findGroup(subjectName) {
    return Object.values(groups).find(group => group.includes(subjectName));
  }

  function drawLines(groupNames) {
    const lines = [];
    for (let i = 0; i < groupNames.length - 1; i++) {
      const from = document.querySelector(`[data-subject="${groupNames[i]}"]`);
      const to = document.querySelector(`[data-subject="${groupNames[i + 1]}"]`);
      if (from && to) {
        const fromYear = from.closest('.year-container');
        const toYear = to.closest('.year-container');
        const isSameYear = fromYear === toYear;

        let line;
        if (isSameYear) {
          // ê°™ì€ í•™ë…„ì´ë©´ì„œ ì¢Œìš°ë¡œ ë¶™ì–´ìˆëŠ” ê²½ìš° ì²´í¬
          const fromRect = from.getBoundingClientRect();
          const toRect = to.getBoundingClientRect();
          const isSideBySide = Math.abs(fromRect.top - toRect.top) < 30 && Math.abs(fromRect.right - toRect.left) < 150;
          if (isSideBySide) {
            // ì˜¤ë¥¸ìª½ ë°©í–¥ ì—°ê²°
            line = new LeaderLine(
                    LeaderLine.pointAnchor(from, { x: '98%', y: '50%' }),
                    LeaderLine.pointAnchor(to, { x: '2%', y: '50%' }),
                    {
                      color: 'black',
                      size: 2,
                      path: 'straight', // ê·¸ëŒ€ë¡œ ì§ì„ 
                      startPlug: 'behind',
                      endPlug: 'arrow1',
                      startSocket: 'right',
                      endSocket: 'left',
                    }
            );
          } else {
            // ì„¸ë¡œ ì—°ê²°ì€ ê¸°ì¡´ëŒ€ë¡œ
            line = new LeaderLine(
                    LeaderLine.pointAnchor(from, { x: '50%', y: '100%' }),
                    LeaderLine.pointAnchor(to, { x: '50%', y: '0%' }),
                    {
                      color: 'black',
                      size: 2,
                      path: 'straight',
                      startPlug: 'behind',
                      endPlug: 'arrow1',
                      startSocket: 'bottom',
                      endSocket: 'top',
                    }
            );
          }
        } else {
          // ë‹¤ë¥¸ í•™ë…„ì´ë©´ ì„¸ë¡œ grid ì—°ê²°
          line = new LeaderLine(
                  LeaderLine.pointAnchor(from, { x: '50%', y: '100%' }),
                  LeaderLine.pointAnchor(to, { x: '50%', y: '0%' }),
                  {
                    color: 'black',
                    size: 2,
                    path: 'grid',
                    startPlug: 'behind',
                    endPlug: 'arrow1',
                    startSocket: 'bottom',
                    endSocket: 'top',
                  }
          );
        }
        lines.push(line);
      }
    }
    return lines;
  }

  allCourses.forEach(course => {
    course.addEventListener('mouseenter', () => {
      const subject = course.dataset.subject;
      const group = findGroup(subject);
      if (group) {
        allCourses.forEach(el => {
          if (group.includes(el.dataset.subject)) {
            el.classList.remove('dimmed');
          } else {
            el.classList.add('dimmed');
          }
        });
        activeLines = drawLines(group);
      }
    });

    course.addEventListener('mouseleave', () => {
      allCourses.forEach(el => el.classList.remove('dimmed'));
      activeLines.forEach(line => line.remove());
      activeLines = [];
    });
  });

  // âœ… ì´ìˆ˜í•œ ê³¼ëª©ëª…ë“¤ì„ Setìœ¼ë¡œ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
  async function  fetchCompletedCourseNames() {
    const token = TokenManager.get();
    if (!token) return new Set();

    // âœ… ì‹¤ì œë¡œ userIdë¥¼ ì–´ë””ì— ì €ì¥í–ˆëŠ”ì§€ì— ë§ê²Œ ë°”ê¿”ì¤˜!
    const userId = localStorage.getItem('userId');
    if (!userId) {
      console.warn('userId not found (localStorage ë“±ì—ì„œ ê°€ì ¸ì˜¤ë„ë¡ ìˆ˜ì • í•„ìš”)');
      return new Set();
    }

    const headers = {
      'Content-Type': 'application/json',
      'Authorization': `Bearer ${token}`,
    };

    // 1) getTCë¡œ userIdë¥¼ ë³´ë‚´ì„œ courseId ëª©ë¡ ë°›ê¸°
    const tcRes = await fetch('/getTC', {   // â† ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
      method: 'POST',
      headers,
      body: JSON.stringify({ userId })
    });

    if (!tcRes.ok) {
      throw new Error('getTC í˜¸ì¶œ ì‹¤íŒ¨');
    }

    // ì˜ˆ: [1, 2, 3, ...] ë˜ëŠ” { courseIdList: [...] } í˜•ì‹ì¼ ìˆ˜ ìˆìŒ
    const tcData = await tcRes.json();

// ğŸ”¹ tcData: [{ courseId: 1, timetableId: 446 }, ...] í˜•íƒœ
    const courseIdList = Array.isArray(tcData)
            ? tcData.map(item => item.courseId)  // [1, 2, 3, ...] ì´ë ‡ê²Œ ë³€í™˜
            : [];

    const completedNameSet = new Set();

    // 2) ê° courseIdë¡œ getTS2TE í˜¸ì¶œí•´ì„œ courseName ëª¨ìœ¼ê¸°
    for (const courseId of courseIdList) {
      const tsRes = await fetch('/getTS2TE', {  // â† ì‹¤ì œ ì—”ë“œí¬ì¸íŠ¸ë¡œ ë³€ê²½
        method: 'POST',
        headers,
        body: JSON.stringify({ courseId })
      });

      if (!tsRes.ok) {
        console.warn('getTS2TE ì‹¤íŒ¨, courseId:', courseId);
        continue;
      }

      const tsData = await tsRes.json();
      // ì˜ˆì‹œ: [{ day: 2, timeStart: 1, courseName: "ì´ì‚°ìˆ˜í•™", ... }, ...]
      (tsData || []).forEach(item => {
        if (item.courseName) {
          completedNameSet.add(item.courseName);
        }
      });
    }

    return completedNameSet;
  }

  // âœ… DOMì˜ .course ë°•ìŠ¤ì— completed-course í´ë˜ìŠ¤ ë¶™ì´ëŠ” í•¨ìˆ˜
  async function highlightCompletedCourses() {
    try {
      const completedNames = await fetchCompletedCourseNames(); // Set<string>

      allCourses.forEach(course => {
        const subject = course.dataset.subject;
        if (completedNames.has(subject)) {
          course.classList.add('completed-course');
        }
      });
    } catch (err) {
      console.error('ì´ìˆ˜ ê³¼ëª© í•˜ì´ë¼ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', err);
    }
  }

</script>
</body>
</html>
