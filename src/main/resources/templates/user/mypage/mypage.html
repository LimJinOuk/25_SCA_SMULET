<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>My page</title>
    <link
            href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap"
            rel="stylesheet"
    />
    <style>
        /* =========================
     ê¸°ë³¸ ì„¤ì •
    ========================= */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #f7f9fc;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            padding: 20px;
            box-shadow: 0 4px 4px rgba(0, 0, 0, 0.1);
            background-color: rgba(255, 255, 255, 0.85);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #e2e8f0;
        }
        h1 {
            font-size: 2.3rem;
            font-weight: bold;
            color: #2563eb;
            margin: 0;
        }
        h1 a {
            text-decoration: none;
            color: inherit;
        }

        nav a {
            margin-left: 20px;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: color 0.2s ease, font-size 0.2s ease;
        }
        nav a:hover {
            color: #3b82f6;
            font-size: 1.1rem;
        }
        main {
            flex: 1;
            padding: 20px 0;
        }
        .container {
            display: grid;
            grid-template-columns: 2fr 1fr; /* ì¢Œ:ëŒ€í‘œ(ë„“ê²Œ) / ìš°:ì‚¬ì´ë“œ */
            gap: 16px;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 20px 16px;
        }

        /* ìš°ì¸¡ íŒ¨ë„ì€ ì„¸ë¡œ ìŠ¤íƒ */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* ë°˜ì‘í˜• ì „í™˜ */
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr; /* í•œ ì¤„ */
            }
        }
        .box {
            flex: 1;
            background: #fff;
            border: 1px solid #e2e8f0; /* card ë¼ì¸ */
            border-radius: 14px;
            padding: 16px 18px;
            box-shadow: 0 6px 18px rgba(2, 6, 23, 0.06);
            display: flex;
            flex-direction: column;
            min-height: 160px;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        .box3{
            min-height: 220px;
        }
        .box:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
        }
        /* ë°•ìŠ¤ ê°„ ê°„ê²© í†µì¼ \*/
        .sidebar .box + .box {
            margin-top: 16px;
        }
        /* ë°•ìŠ¤ íƒ€ì´í‹€ì„ card í—¤ë”ì²˜ëŸ¼ ì“°ê³  ì‹¶ì„ ë•Œ */
        .box .card-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 0 12px;
            font-size: 16px;
            font-weight: 800;
        }
        .box .card-title .icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: #e6efff; /* brand-weak ëŠë‚Œ */
            font-size: 16px;
        }

        /* í…ìŠ¤íŠ¸ ê³µí†µ */
        h2,
        h3 {
            margin: 0 0 10px;
            font-size: 1.1rem;
            color: #111827;
        }
        .section h3 {
            margin-top: 24px; /* â€œë¹„ë°€ë²ˆí˜¸ ë³€ê²½â€ ì œëª© ìœ„ë¡œ 24px ë„ì›€ */
        }

        .nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .section {
            margin-bottom: 10px;
        }
        .section button {
            display: inline-block;
            width: 120px;
            margin-top: 8px;
            text-align: center;
        }
        /* íšŒì› ì„¤ì •: ì œëª©ê³¼ ë²„íŠ¼ì„ ê°™ì€ ì¤„ì— */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            margin-top: 0px; /* ê¸°ì¡´ h3 ìœ„ ì—¬ë°± ëŒ€ì²´ */
        }
        .section-header h3 {
            margin: 0; /* ê¸°ë³¸ ë§ˆì§„ ì œê±° */
            line-height: 1; /* ë†’ì´ë¥¼ ì¡°ê¸ˆ ì¤„ì—¬ ìœ„ë¡œ ë¶™ê²Œ */
            transform: translateY(-3px); /* ìœ„ë¡œ 3px ì´ë™ (ì›í•˜ë©´ -2~ -5ë¡œ ì¡°ì ˆ) */
        }

        /* ë²„íŠ¼ ë¬¶ìŒ (ìš°ì¸¡) */
        .section-header .actions {
            display: flex;
            gap: 8px;
        }

        /* ê¸°ì¡´ .section button { width:120px } ê°™ì€ ê·œì¹™ì„ ë¬´ë ¥í™” */
        .section-header .actions button {
            width: auto;
            margin-top: 0;
            padding: 8px 12px; /* ì»´íŒ©íŠ¸ */
        }

        /* í™”ë©´ ì¢ì„ ë•ŒëŠ” ìì—°ìŠ¤ëŸ½ê²Œ ì¤„ë°”ê¿ˆ */
        @media (max-width: 560px) {
            .section-header {
                flex-wrap: wrap;
            }
            .section-header .actions {
                width: 100%;
                justify-content: flex-start;
            }
        }

        .info p {
            margin: 3px 0;
            font-size: 0.9rem;
            color: #374151;
        }
        button {
            background-color: #2563eb;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        button:hover {
            background-color: #1e40af;
            transform: scale(1.03);
        }
        button.red {
            background-color: #ef4444;
        }
        button.red:hover {
            background-color: #dc2626;
        }
        .representative-container {
            width: 100%;
            display: block; /* ì¤‘ì•™ì •ë ¬ í”Œë ‰ìŠ¤ ì œê±° */
            margin-top: 0;
        }
        .representative-box {
            width: auto; /* 70% ì œí•œ í•´ì œ */
            max-width: none; /* 1000px ì œí•œ í•´ì œ(í•„ìš” ì‹œ ë³µì› ê°€ëŠ¥) \*/
            background-color: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            padding: 30px;
            box-sizing: border-box;
            max-height: 775px;
            overflow-y: auto;
        }
        footer {
            background-color: rgba(30, 30, 30, 0.98);
            color: rgba(200, 200, 200, 0.7);
            font-size: 0.9rem;
            padding: 2rem 1rem;
            text-align: center;
            border-top: 1px solid #444;
            margin-top: auto;
        }
        footer a {
            text-decoration: none;
            color: rgba(200, 200, 200, 0.7);
            margin: 0 10px;
        }
        footer a:hover {
            text-decoration: underline;
        }
        select {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: white;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 10px 14px;
            font-size: 1rem;
            color: #111827;
            font-family: 'Montserrat', sans-serif;
            cursor: pointer;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-image: url("data:image/svg+xml;utf8,<svg fill='gray' height='20' viewBox='0 0 24 24' width='20' xmlns='http://www.w3.org/2000/svg'><path d='M7 10l5 5 5-5z'/></svg>");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px 16px;
            padding-right: 40px; /* í™”ì‚´í‘œ ê³µê°„ í™•ë³´ */
        }
        select:hover {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.2);
        }
        select:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.3);
        }
        .modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-wrapper {
            display: contents;
        }
        .modal {
            background: #fff;
            border-radius: 12px;
            padding: 24px 32px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.2);
            text-align: center;
            display: flex;
            flex-direction: row;
            gap: 16px;
        }

        .modal-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 8px;
        }
        .modal-buttons button {
            flex: 1;
            max-width: 120px;
            padding: 0.6rem 0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: transform 0.15s, box-shadow 0.15s;
        }
        .modal-buttons #confirm,
        .modal-buttons #changePwBtn {
            background-color: #2563eb;
            color: #fff;
        }
        .modal-buttons #close-btn,
        .modal-buttons #cancelChange {
            background-color: #e0e0e0;
            color: #333;
        }
        .modal-buttons button:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }
        .modal-buttons button:active {
            transform: translateY(1px);
        }

        .modal input[type='password'] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
        }

        .hidden {
            display: none;
        }
        body.modal-open {
            overflow: hidden;
        }
        #semesterList {
            list-style: none;
            padding-left: 0;
            margin: 12px 0 0 0;
        }
        #semesterList li {
            margin: 5px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #semesterList .semester-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 14px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            padding: 10px 14px;
            background: #fff;
            transition: background-color 0.15s ease, box-shadow 0.15s ease,
            border-color 0.15s ease;
            cursor: pointer;
            width: 80%;
        }
        #semesterList .semester-item:hover {
            background: #f9fafb;
            border-color: #d1d5db;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.04);
        }
        #semesterList .semester-name {
            color: #111827;
            text-decoration: none;
            font-weight: 600;
        }
        #semesterList .semester-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #semesterList .rep-label {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }
        #semesterList .del-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #scheduleTable td {
            width: 80px;
            max-width: 100px;
            height: 50px;
            min-width: 80px;
            vertical-align: middle;
        }
        /* 4) ëª¨ë‹¬ ë‚´ë¶€ ì‘ì€ í¼ */
        #add-icon-modal .modal {
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            width: 300px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        #add-icon-modal .modal h2 {
            margin: 0;
            font-size: 1.2rem;
            color: #111827;
        }
        #add-icon-modal .modal label {
            display: flex;
            flex-direction: column;
            font-size: 0.9rem;
        }

        .course-tooltip {
            animation: fadeIn 0.12s;
        }
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .details-container {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr)); /* 4ë“±ë¶„ ê³ ì • */
            gap: 10px;
            margin-top: 10px;
        }
        @media (max-width: 420px) {
            .details-container {
                grid-template-columns: repeat(2, 1fr);
            } /* ëª¨ë°”ì¼ 2ì—´ \*/
        }
        .detail {
            border: 1px solid #e2e8f0;
            border-radius: 10px;
            background-color: #fff;
            height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .detail:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            transition: all 0.5s ease;
        }
        .detail .label {
            font-size: 17px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        .detail .value {
            font-size: 20px;
            font-weight: 700;
            color: #007bff;
        }

        #semesterLis:root {
            --preview-bg: #d0ebff;
            --preview-dur: 220ms;
            --preview-ease: ease;
        }
        /* ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ */
        td.preview-cell {
            background-color: var(--preview-bg);
            transition: background-color var(--preview-dur) var(--preview-ease),
            transform var(--preview-dur) var(--preview-ease),
            opacity var(--preview-dur) var(--preview-ease),
            box-shadow var(--preview-dur) var(--preview-ease);
            position: relative;
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        }

        /* ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ (enter) */
        td.preview-enter {
            opacity: 0;
            transform: scale(0.98);
            box-shadow: 0 0 0 rgba(0, 0, 0, 0);
        }
        td.preview-enter.preview-enter-active {
            opacity: 1;
            transform: scale(1);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
        }

        /* í‡´ì¥ ì• ë‹ˆë©”ì´ì…˜ (leave) */
        td.preview-leave {
            opacity: 1;
            transform: scale(1);
        }
        td.preview-leave.preview-leave-active {
            opacity: 0;
            transform: scale(0.98);
        }

        /* ì˜êµ¬ ë°°ì¹˜ê°€ ë“¤ì–´ì˜¬ ë•Œ ì‚´ì§ í•˜ì´ë¼ì´íŠ¸ */
        td.commit-flash {
            animation: commitFlash var(--preview-dur) var(--preview-ease) 1;
        }
        @keyframes commitFlash {
            0% {
                box-shadow: 0 0 0 rgba(37, 99, 235, 0);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(37, 99, 235, 0.15);
            }
            100% {
                box-shadow: 0 0 0 rgba(37, 99, 235, 0);
            }
        }

        #scheduleTable .cell[data-period] { position: relative; }


        .preview-overlay {
            position: absolute;
            inset: 0;
            padding: 8px 10px;
            display: block;               /* ê¸€ì ë ˆì´ì•„ì›ƒì„ ì…€ê³¼ ë™ì¼í•˜ê²Œ */
            background: linear-gradient(180deg, var(--preview-color, #a5d8ff) 0%, #ffffff 100%);
            box-shadow: inset 0 0 0 2px var(--preview-color, #a5d8ff);
            border-radius: 6px;
            z-index: 5;
            pointer-events: none;
            opacity: 0;
            transform: scale(0.98);
            transition: opacity 0.18s ease, transform 0.18s ease;
        }

        /* ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ ìœ ì§€ */
        .preview-overlay.show {
            opacity: 1;
            transform: scale(1);
        }

        .box .desc-list {
            margin: 8px 0 14px;
        }
        .box .desc-list div {
            display: flex;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px dashed #e2e8f0;
        }
        .box .desc-list dt {
            width: 66px;
            color: #6b7280;
            font-weight: 700;
        }
        .box .desc-list dd {
            margin: 0;
        }
        /* í…Œí¬íŠ¸ë¦¬ ì¹´ë“œ ì•ˆì˜ 'ëª¨ë“  í…Œí¬íŠ¸ë¦¬ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!'ë§Œ ì‘ê²Œ */
        .box2 .subtext,
        .box3 .subtext {
            font-size: 0.85rem; /* í•„ìš”í•˜ë©´ 0.8\~0.95rem ì‚¬ì´ë¡œ ì¡°ì ˆ */
            line-height: 1.4;
            color: #6b7280; /* (ì„ íƒ) ì‚´ì§ í†¤ ë‹¤ìš´ */
            margin-top: 4px; /* (ì„ íƒ) ìœ„ ì—¬ë°± ì•½ê°„ ì¤„ì„ \*/
        }
        :root{
            --line:#e2e8f0;
            --muted:#6b7280;
            --brand:#2563eb;
            --brand-weak:#e6efff;
            --danger:#ef4444;
            --shadow:0 6px 18px rgba(2,6,23,.06);
            --preview-color: #a5d8ff; /* â† ì›í•˜ëŠ” ë¯¸ë¦¬ë³´ê¸° ê³ ì •ìƒ‰ìœ¼ë¡œ ë³€ê²½ */
        }
        .schedule-card{
            border:1px solid var(--line); border-radius:14px; overflow:hidden; background:#fff;
            box-shadow:var(--shadow);
        }
        .schedule-header{
            display:grid; grid-template-columns:120px repeat(5,1fr);
            background:#f9fbff; border-bottom:1px solid var(--line);
        }
        .schedule-header>div{ padding:12px; font-weight:700; text-align:center; }
        .schedule-body{ display:flex; flex-direction:column; }
        .row{
            display:grid; grid-template-columns:120px repeat(5,1fr);
            border-bottom:1px solid var(--line);
        }
        .row:last-child{ border-bottom:none; }
        .time-col{
            padding:12px; background:#fbfbfb; border-right:1px solid var(--line);
            font-weight:700; font-size:13px; text-align:center;
        }
        .time-col span{ display:block; color:var(--muted); font-weight:600; }
        .cell{
            min-height:60px; border-right:1px solid var(--line);
            background:linear-gradient(180deg,#fff 0%,#fff 60%,#fcfcfc 100%);
        }
        .row .cell:last-child{ border-right:none; }
        .cell.busy{
            /* JSì—ì„œ ì´ ë³€ìˆ˜ë§Œ ë„£ì–´ì£¼ë©´ ë©ë‹ˆë‹¤ */
            --c: var(--course-color, #a5d8ff);

            /* í…Œë‘ë¦¬ëŠ” ê°™ì€ ìƒ‰ìƒ ê³„ì—´ë¡œ ë” ë˜ë ·í•˜ê²Œ */
            --stroke: color-mix(in oklab, var(--c) 85%, black);

            /* ì¤‘ì•™â†’ë°”ê¹¥ìœ¼ë¡œ ê°ˆìˆ˜ë¡ 'í°ìƒ‰ì— ê°€ê¹Œìš´ í‹´íŠ¸'ê°€ ì´ì–´ì§€ë„ë¡,
               ëê¹Œì§€ ì›ìƒ‰ 100%ë¡œ ê°€ì§€ ì•Šê³  70~75% í‹´íŠ¸ê¹Œì§€ë§Œ ì‚¬ìš© */
            background:
                    radial-gradient(
                            circle at 50% 45%,
                            #ffffff 0%,
                            color-mix(in oklab, #ffffff 92%, var(--c)) 28%,
                            color-mix(in oklab, #ffffff 88%, var(--c)) 48%,
                            color-mix(in oklab, #ffffff 82%, var(--c)) 68%,
                            color-mix(in oklab, #ffffff 75%, var(--c)) 100%
                    );

            border: 2px solid var(--stroke);
            border-radius: 10px;

            /* ì‚´ì§ ì…ì²´ê° */
            box-shadow:
                    inset 0 1px 0 rgba(255,255,255,0.7),
                    0 3px 10px rgba(0,0,0,0.08);

            /* ê°€ìš´ë°ê°€ ë°ìœ¼ë‹ˆ ì§„í•œ í…ìŠ¤íŠ¸ê°€ ê°€ë…ì„± ì¢‹ìŒ */
            color: #0f172a;
        }


        @media (max-width:560px){
            .schedule-header,.row{ grid-template-columns:80px repeat(5,1fr); }
            .time-col{ font-size:12px; }
        }
        /* === ì‹œê°„í‘œ ì…€ ì•ˆ í…ìŠ¤íŠ¸ ê³µí†µ === */
        /* ê³¼ëª© ë¸”ë¡ ì „ì²´ */
        .cell {
            position: relative;
            padding: 8px 10px;           /* ì…€ ì•ˆìª½ ì—¬ë°± ì¡°ê¸ˆ ë„‰ë„‰í•˜ê²Œ */
            overflow: hidden;            /* ë„˜ì¹˜ë©´ ì˜ë¼ëƒ„ */
            box-sizing: border-box;
        }

        .cell .slot {
            display: flex;
            flex-direction: column;
            justify-content: center;     /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ â†’ ìœ„ë¡œ ë¶™ì´ê³  ì‹¶ìœ¼ë©´ flex-start */
            height: 100%;
            line-height: 1.3;            /* ì¤„ ê°„ê²© ì•½ê°„ ë„“í˜ */
            text-align: center;          /* ê°€ë¡œ ì •ë ¬: center / left / right */
        }

        /* ê³¼ëª©ëª… */
        .cell .slot-title {
            font-size: 13px;             /* ê¸°ë³¸ 0.95rem â†’ 13px */
            font-weight: 800;            /* ë” ë‘ê»ê²Œ */
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* ê°•ì˜ì‹¤/êµìˆ˜ */
        .cell .slot-room {
            margin-top: 2px;
            font-size: 12px;             /* ê¸°ì¡´ë³´ë‹¤ ì¡°ê¸ˆ ì‘ê²Œ */
            font-weight: 600;
            color: var(--muted, #6b7280); /* var(--muted) ìš°ì„ , ì—†ìœ¼ë©´ íšŒìƒ‰ */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            opacity: 0.9;
        }




    </style>
</head>
<body onload="loaduserinfo()">
<header>
    <h1><a href="/">SMULET</a></h1>
    <nav>
        <a href="#"><b>ì´ìš©ì•ˆë‚´</b></a>
        <a href="/login_page" id="loginLink"><b>ë¡œê·¸ì¸</b></a>
        <a href="/Register" id="registerLink"><b>íšŒì›ê°€ì…</b></a>
        <a href="/" id="logoutLink" style="display: none"><b>ë¡œê·¸ì•„ì›ƒ</b></a>
        <a href="/" id="" style="display: none"><b>ë§ˆì´í˜ì´ì§€</b></a>
    </nav>
</header>
<main>
    <div class="container">
        <!-- ì¢Œì¸¡: ëŒ€í‘œ ì‹œê°„í‘œ -->
        <div class="representative-container">
            <div class="box representative-box">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 id="representativeTitle" class="card-title">
                        <span class="icon">ğŸ“Œ</span> ëŒ€í‘œ ì‹œê°„í‘œ
                    </h2>
                </div>
                <div id="representativeScheduleContainer">
                    <div class="schedule-card" id="repGridCard">
                        <div class="schedule-header">
                            <div class="time-col"></div>
                            <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div>
                        </div>
                        <div class="schedule-body" id="repGridBody"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <!-- BOX1 -->
            <div class="box box1">
                <div class="section">
                    <h2 class="card-title"><span class="icon">ğŸ‘¤</span> ë‚´ ì •ë³´</h2>
                    <dl class="desc-list">
                        <div>
                            <dt>ì´ë¦„</dt>
                            <dd><span id="userName"></span></dd>
                        </div>
                        <div>
                            <dt>ì´ë©”ì¼</dt>
                            <dd><span id="studentId"></span></dd>
                        </div>
                        <div>
                            <dt>í•™ê³¼</dt>
                            <dd><span id="userMajor">ì»´í“¨í„°ê³¼í•™ê³¼</span></dd>
                        </div>
                    </dl>
                    <div class="section">
                        <div class="section-header">
                            <h3>ğŸ”’ íšŒì› ì„¤ì •</h3>
                            <div class="actions">
                                <button onclick="modifinguserinfo()">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                                <button class="red" onclick="deleteAccount()">
                                    íšŒì›íƒˆí‡´
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div
                    id="modalOverlay"
                    class="modal-overlay hidden"
                    role="dialog"
                    aria-modal="true"
                    aria-labelledby="pwTitle"
            >
                <div class="modal-wrapper">
                    <div class="modal">
                        <p>ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                        <input type="password" id="pw" />
                        <div class="modal-buttons">
                            <button id="confirm" type="button">í™•ì¸</button>
                            <button id="close-btn" type="button">ë‹«ê¸°</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="changePwModal" class="modal-overlay hidden">
                <div class="modal-wrapper">
                    <div class="modal">
                        <p>ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”</p>
                        <input
                                type="password"
                                id="newPassword"
                                placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸"
                        />
                        <input
                                type="password"
                                id="confirmPassword"
                                placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸"
                        />
                        <div class="modal-buttons">
                            <button id="changePwBtn" type="button">ë³€ê²½</button>
                            <button id="cancelChange" type="button">ì·¨ì†Œ</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BOX2 -->
            <div class="box box2">
                <h2 class="card-title"><span class="icon">ğŸŒ³</span> í…Œí¬íŠ¸ë¦¬</h2>
                <p class="subtext">ëª¨ë“  í…Œí¬íŠ¸ë¦¬ë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

                <select
                        id="techTreeSelect"
                        onchange="goToTechTree()"
                        style="margin-top: 1px"
                >
                    <option value="">í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="21">21í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                    <option value="22">22í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                    <option value="23">23í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                    <option value="24">24í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                    <option value="25">25í•™ë²ˆ í…Œí¬íŠ¸ë¦¬</option>
                </select>

                <!-- ê°€ë¡œ ì •ë ¬ëœ ë°•ìŠ¤ë“¤ -->
                <div class="details-container">
                    <div class="detail">
                        <span class="label">bsm</span>
                        <span class="value" id="bsmCredit">0</span>
                    </div>
                    <div class="detail">
                        <span class="label">ì„¤ê³„</span>
                        <span class="value" id="designCredit">0</span>
                    </div>
                    <div class="detail">
                        <span class="label">ì „ê³µì„ íƒ</span>
                        <span class="value" id="majorElectiveCredit">0</span>
                    </div>
                    <div class="detail">
                        <span class="label">ì „ê³µì‹¬í™”</span>
                        <span class="value" id="majorAdvancedCredit">0</span>
                    </div>
                </div>
            </div>

            <div class="box box3">
                <h2 class="card-title"><span class="icon">ğŸ“…</span> ì‹œê°„í‘œ</h2>
                <p class="subtext">ì‹œê°„í‘œë¥¼ ë§Œë‚˜ë³´ì„¸ìš”!</p>

                <!-- ë“œë¡­ë‹¤ìš´ë§Œìœ¼ë¡œ ë°”ë¡œ í•™ê¸° ì¶”ê°€ -->
                <div style="margin-top: 1px">
                    <select id="semesterSelectInline" style="min-width: 220px">
                        <option value="">í•™ê¸°ë¥¼ ì„ íƒí•´ ì¶”ê°€</option>
                        <!-- JSì—ì„œ ì˜µì…˜ ì±„ì›Œì§ -->
                    </select>
                </div>

                <ul id="semesterList" style="margin-top: 12px"></ul>
                <!-- ì‹œê°„í‘œ ëª¨ë‹¬ -->
            </div>
            <div id="scheduleModal" class="modal-overlay hidden">
                <div class="modal-wrapper">
                    <div
                            class="modal"
                            style="
              display: flex;
              width: 90vw;
              max-width: 1000px;
              max-height: 800px;
              overflow: hidden;
              padding: 30px;
              gap: 20px;
            "
                    >
                        <!-- ì™¼ìª½: ì‹œê°„í‘œ ì˜ì—­ -->
                        <div style="flex: 2; overflow-y: auto">
                            <div style="text-align: right">
                                <button
                                        id="closeScheduleModal"
                                        style="
                    background: #ef4444;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    padding: 6px 12px;
                    cursor: pointer;
                  "
                                >
                                    ë‹«ê¸°
                                </button>
                                <button
                                        id="saveSchedule"
                                        style="
                    background: #4466ef;
                    color: white;
                    border: none;
                    border-radius: 5px;
                    padding: 6px 12px;
                    cursor: pointer;
                  "
                                >
                                    ì €ì¥
                                </button>
                            </div>
                            <h2
                                    style="text-align: center; margin-bottom: 15px"
                                    id="modalSemesterTitle"
                            ></h2>
                            <div id="scheduleTableContainer">
                                <!-- ë™ì  ì‹œê°„í‘œ -->
                            </div>
                        </div>

                        <!-- ì˜¤ë¥¸ìª½: ìˆ˜ì—… ì •ë³´ ë¦¬ìŠ¤íŠ¸ ì˜ì—­ -->
                        <!-- ì˜¤ë¥¸ìª½ ìˆ˜ì—… ì •ë³´ ë¦¬ìŠ¤íŠ¸ + ê²€ìƒ‰ì°½ ë¬¶ê¸° -->
                        <div
                                style="
                flex: 1;
                display: flex;
                flex-direction: column;
                border-left: 1px solid #ddd;
                padding-left: 10px;
              "
                        >
                            <!-- ğŸ” ê²€ìƒ‰ì°½ -->
                            <input
                                    type="text"
                                    id="searchInput"
                                    placeholder="ê³¼ëª©ëª… ê²€ìƒ‰"
                                    style="
                  width: 100%;
                  margin-bottom: 10px;
                  padding: 8px;
                  border: 1px solid #ccc;
                  border-radius: 6px;
                "
                                    oninput="renderCourseList(currentCourseList)"
                            />

                            <!-- ğŸ“š ìˆ˜ì—… ë¦¬ìŠ¤íŠ¸ -->
                            <div id="classInfoList" style="flex: 1; overflow-y: auto">
                                <!-- JSë¡œ ìˆ˜ì—… ì •ë³´ê°€ ë“¤ì–´ì˜µë‹ˆë‹¤ -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</main>

<footer>
    <b>
        <a href="#">Github</a>
        <a href="#">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
        <a href="#">ì´ìš©ì•½ê´€</a><br /><br />
        <a href="#">Copyright</a>
    </b>
</footer>

<script>
    /***********************
     * ìƒìˆ˜ / ì „ì—­ ìƒíƒœ
     ***********************/
    const semesterOptions = [
        '2025ë…„ 2í•™ê¸°',
        '2025ë…„ 1í•™ê¸°',
        '2024ë…„ 2í•™ê¸°',
        '2024ë…„ 1í•™ê¸°',
        '2023ë…„ 2í•™ê¸°',
        '2023ë…„ 1í•™ê¸°',
        '2022ë…„ 2í•™ê¸°',
        '2022ë…„ 1í•™ê¸°',
        '2021ë…„ 2í•™ê¸°',
        '2021ë…„ 1í•™ê¸°',
    ];

    const pastelPalette = [
        "#A5D8FF", // ìŠ¤ì¹´ì´ ë¸”ë£¨
        "#B2F2BB", // ë¯¼íŠ¸ ê·¸ë¦°
        "#FFD8A8", // ì‚´êµ¬
        "#FFC9C9", // ë¼ì´íŠ¸ ì½”ë„
        "#D0BFFF", // ë¼ì¼ë½
        "#B2E3E8", // íŒŒìŠ¤í…” í‹¸
        "#FFE69A", // ë°”ë‹ë¼ ì˜ë¡œ
        "#F4C2D7", // ë¡œì¦ˆ í•‘í¬
        "#C9E4A7", // ì„¸ì´ì§€ ê·¸ë¦°
        "#C7D2FE"  // í˜ë¦¬ìœ™í´

    ];

    // === Unique Color Manager (ê³¼ëª©ë³„ ìœ ì¼ ìƒ‰ìƒ) ===
    const ColorManager = (() => {
        const pool = [...pastelPalette];            // íŒ”ë ˆíŠ¸ ë³µì‚¬
        // Fisherâ€“Yates shuffle
        for (let i = pool.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [pool[i], pool[j]] = [pool[j], pool[i]];
        }
        const map = new Map(); // courseKey -> color
        let cursor = 0;

        function nextPoolColor(usedSet) {
            // ì•„ì§ ì•ˆ ì“´ ìƒ‰ì„ í•˜ë‚˜ ë°˜í™˜
            for (let i = 0; i < pool.length; i++) {
                const idx = (cursor + i) % pool.length;
                const c = pool[idx];
                if (!usedSet.has(c)) {
                    cursor = (idx + 1) % pool.length;
                    return c;
                }
            }
            return null; // ë‹¤ ì¼ìœ¼ë©´ null
        }

        function hslFromString(s) {
            // íŒ”ë ˆíŠ¸ ì´ˆê³¼ ì‹œì—ë„ ì¶©ëŒ ì ê²Œë” ê³ ìš´ íŒŒìŠ¤í…” HSL
            let hash = 0;
            for (const ch of String(s)) {
                hash = ((hash << 5) - hash) + ch.charCodeAt(0);
                hash |= 0;
            }
            const h = Math.abs(hash) % 360;
            return `hsl(${h}, 70%, 85%)`;
        }

        function get(courseKey) {
            if (!courseKey) return pool[0];
            if (map.has(courseKey)) return map.get(courseKey);

            const usedSet = new Set(map.values());
            let color = nextPoolColor(usedSet);
            if (!color) color = hslFromString(courseKey); // íŒ”ë ˆíŠ¸ ë‹¤ ì“°ë©´ HSL fallback
            map.set(courseKey, color);
            return color;
        }

        function free(courseKey) {
            if (!courseKey) return;
            map.delete(courseKey);
        }

        function has(courseKey) {
            return map.has(courseKey);
        }

        return { get, free, has };
    })();


    let UserId = null;
    let representativeTermCode = null; // "20252" ê°™ì€ í˜•ì‹ìœ¼ë¡œ ëŒ€í‘œ í•™ê¸° ë³´ê´€

    let selectedSemesters = [];
    let currentCourseList = []; // ëª¨ë‹¬ì— ë„ìš´ í˜„ì¬ í•™ê¸° ì „ì²´ ìˆ˜ì—…ì •ë³´

    // ìƒˆ êµ¬ì¡° í•µì‹¬
    let timetableIdsBySemester = {}; // { "20252": 123, ... }
    let currentSemesterCode = null; // í˜„ì¬ ëª¨ë‹¬ì—ì„œ í¸ì§‘ ì¤‘ì¸ í•™ê¸° ì½”ë“œ
    let currentTimetableId = null; // í˜„ì¬ ëª¨ë‹¬ì˜ timetableId

    // ë¯¸ë¦¬ë³´ê¸°ë¡œ ì„ì‹œ ì¶”ê°€í•œ ìš”ì†Œë“¤ì„ ì¶”ì 
    const previewSession = {
        zeroAdded: false, // ë¯¸ë¦¬ë³´ê¸° ì¤‘ 0êµì‹œë¥¼ ì¶”ê°€í–ˆëŠ”ê°€
        extendedTo: null, // ë¯¸ë¦¬ë³´ê¸°ë¡œ í™•ì¥í•œ ìµœëŒ“ êµì‹œ(ìˆ«ì)
    };
    const PERIOD_SELECTOR = '.cell[data-period]';

    /***********************
     * ê³µí†µ ìœ í‹¸
     ***********************/



    function toSemesterCode(semText) {
        // "2025ë…„ 2í•™ê¸°" â†’ "20252"
        const m = String(semText).match(/(\d{4})\D*(1|2)\D*í•™ê¸°?/);
        return m ? `${m[1]}${m[2]}` : semText.replace(/\D/g, ''); // ë°±ì—…: ìˆ«ìë§Œ
    }

    // ì‘ì€ ëŒ€ê¸° ìœ í‹¸
    function sleep(ms) {
        return new Promise((r) => setTimeout(r, ms));
    }

    // /userinfoì—ì„œ timetables ë°°ì—´ì„ ë³´ê³ , term===semesterCode ì¸ í•­ëª© ì¤‘ ê°€ì¥ ìµœì‹  timetableId ë°˜í™˜
    async function fetchLatestTimetableIdFromUserInfo(
        semesterCode,
        { tries = 6, baseDelay = 300 } = {}
    ) {
        if (!semesterCode) throw new Error('semesterCodeê°€ í•„ìš”í•©ë‹ˆë‹¤.');
        const termNum = Number(semesterCode);

        const token = localStorage.getItem('jwtToken');
        const headers = {
            Authorization: `Bearer ${token}`,
            'Cache-Control': 'no-cache',
        };

        for (let i = 0; i < tries; i++) {
            const res = await fetch(`/userinfo?_=${Date.now()}`, {
                headers,
                cache: 'no-store',
                credentials: 'include',
            });

            if (res.ok) {
                const u = await res.json();
                // console.warn('[userinfo]', u); // í•„ìš”í•˜ë©´ êµ¬ì¡° í™•ì¸ìš©

                if (Array.isArray(u?.timetables)) {
                    // termì´ ì¼ì¹˜í•˜ëŠ” ê²ƒë“¤ë§Œ í•„í„°
                    const matches = u.timetables.filter(
                        (t) => Number(t.term) === termNum
                    );
                    if (matches.length) {
                        // ê°€ì¥ í° timetableIdë¥¼ ìµœì‹ ìœ¼ë¡œ ê°„ì£¼
                        const tid = matches.reduce((max, t) => {
                            const v = Number(t.timeTableId ?? t.timetableId ?? t.id);
                            return Number.isFinite(v) ? Math.max(max, v) : max;
                        }, 0);
                        if (tid) return tid;
                    }
                }
            }

            // DB ë°˜ì˜ ì§€ì—° ëŒ€ë¹„ ë°±ì˜¤í”„
            await sleep(baseDelay * (i + 1));
        }

        return null;
    }

    //
    // ë¹ˆ ì‹œê°„í‘œ ìƒì„± â†’ /userinfoë¡œ timetableId íšë“
    async function createTimetableOnServer(semesterCode) {
        let token = localStorage.getItem('jwtToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            window.location.href = '/login_page';
            throw new Error('JWT ì—†ìŒ');
        }

        // ì„œë²„ê°€ FormDataë¥¼ ë°›ëŠ”ë‹¤ê³  ê°€ì • (JSONì´ë©´ ì•„ë˜ë¥¼ JSONìœ¼ë¡œ ë°”ê¿”ë„ ë¨)
        const fd = new FormData();
        fd.append('semester', semesterCode);

        const res = await fetch('/addTimetable', {
            method: 'POST',
            headers: { Authorization: `Bearer ${token}` }, // FormDataì¼ ë• Content-Type ì§€ì • X
            body: fd,
            credentials: 'include',
        });

        const raw = await res.text();
        if (!res.ok)
            throw new Error(`addTimetable ì‹¤íŒ¨ (${res.status}): ${raw}`);

        // ì‘ë‹µì— ì´ë¯¸ idê°€ ìˆìœ¼ë©´ ë°”ë¡œ ì‚¬ìš©
        try {
            const j = JSON.parse(raw);
            const directId =
                j.timeTableId ??
                j.timetableId ??
                j.id ??
                j.data?.timeTableId ??
                j.data?.id ??
                null;
            if (directId) return Number(directId);
        } catch (_) {
            /* ignore */
        }

        // ì—†ìœ¼ë©´ /userinfoì—ì„œ term ê¸°ì¤€ìœ¼ë¡œ ì°¾ì•„ì˜¤ê¸° (í´ë§)
        const tid = await fetchLatestTimetableIdFromUserInfo(semesterCode, {
            tries: 8,
            baseDelay: 250,
        });
        if (!tid)
            throw new Error('userinfoì—ì„œ timetableIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
        return tid;
    }

    /***********************
     * ì´ˆê¸° ë°”ì¸ë”©
     ***********************/
    document.addEventListener('DOMContentLoaded', async function () {
        const loginLink = document.getElementById('loginLink');
        const logoutLink = document.getElementById('logoutLink');
        const registerLink = document.querySelector('nav a[href="/Register"]');
        const token = localStorage.getItem('jwtToken');

        if (token) {
            loginLink.style.display = 'none';
            logoutLink.style.display = 'inline';
            registerLink.style.display = 'none';
        } else {
            loginLink.style.display = 'inline';
            logoutLink.style.display = 'none';
            registerLink.style.display = 'inline';
        }

        logoutLink.addEventListener('click', function (e) {
            e.preventDefault();
            localStorage.removeItem('jwtToken');
            alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');
            window.location.href = '/';
        });
        /*
        const showSemesterBtn = document.getElementById('showSemesterBtn');
        if (showSemesterBtn) {
          showSemesterBtn.addEventListener('click', showAddSemester);
        }
        */
        /*
        // âœ… ì¶”ê°€: ëŒ€í‘œ ì‹œê°„í‘œ ê°±ì‹  & í•™ê¸° ë¦¬ìŠ¤íŠ¸ ë³µì›
        if (token) {
          loadRepresentativeScheduleOnInit().catch(console.error);
          await hydrateSemestersFromServer();
        }
     */
        // ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° & ì²´ì¸ì§€ ë°”ì¸ë”©
        populateSemesterSelectInline();
        document
            .getElementById('semesterSelectInline')
            ?.addEventListener('change', onSemesterSelectInlineChange);

        if (token) {
            // 1) userInfo ë¨¼ì € í™•ë³´(â†’ UserId ì„¸íŒ… ë³´ì¥)
            await loaduserinfo().catch(console.error);
            // 2) í•™ê¸° ë¦¬ìŠ¤íŠ¸ ë³µì›
            await hydrateSemestersFromServer();

            // DOMContentLoaded ë‚´ë¶€ì—ì„œ, token ì²˜ë¦¬ ë’¤ì— ì¶”ê°€:
            await renderRepresentativeFromServer();
        }
    });

    /** ë“œë¡­ë‹¤ìš´ ì˜µì…˜ì„ ê°±ì‹ í•œë‹¤. (ì´ë¯¸ ì¶”ê°€ëœ í•™ê¸°ëŠ” ì œì™¸) */
    function populateSemesterSelectInline() {
        const select = document.getElementById('semesterSelectInline');
        if (!select) return;

        // í˜„ì¬ ê°’ ë³´ì¡´
        const prev = select.value;

        // ì˜µì…˜ ì´ˆê¸°í™”
        select.innerHTML = '';
        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'í•™ê¸°ë¥¼ ì„ íƒí•´ ì¶”ê°€';
        select.appendChild(placeholder);

        // ì•„ì§ ì¶”ê°€í•˜ì§€ ì•Šì€ í•™ê¸°ë§Œ ì±„ìš°ê¸°
        semesterOptions.forEach((sem) => {
            if (!selectedSemesters.includes(sem)) {
                const opt = document.createElement('option');
                opt.value = sem;
                opt.textContent = sem;
                select.appendChild(opt);
            }
        });

        // ë³´ì¡´í•˜ë ¤ë˜ ê°’ì´ ìœ íš¨í•˜ë©´ ìœ ì§€, ì•„ë‹ˆë©´ placeholderë¡œ
        if ([...select.options].some((o) => o.value === prev)) {
            select.value = prev;
        } else {
            select.value = '';
        }
    }

    /** ë“œë¡­ë‹¤ìš´ì—ì„œ í•™ê¸°ë¥¼ ì„ íƒí•˜ë©´ ì¦‰ì‹œ ì„œë²„ì— ì‹œê°„í‘œë¥¼ ë§Œë“¤ê³  ë¦¬ìŠ¤íŠ¸ì— ë°˜ì˜ */
    async function onSemesterSelectInlineChange(e) {
        const semText = e.target.value;
        if (!semText) return; // placeholder ì„ íƒ

        const semesterCode = toSemesterCode(semText);
        try {
            // 1) ì„œë²„ì— ë¹ˆ ì‹œê°„í‘œ ìƒì„±
            const tid = await createTimetableOnServer(semesterCode);

            // 2) ë¡œì»¬ ìƒíƒœ ë°˜ì˜
            timetableIdsBySemester[semesterCode] = tid;
            if (!selectedSemesters.includes(semText)) {
                selectedSemesters.push(semText);
            }

            // 3) UI ê°±ì‹ 
            renderSemesterList();
            populateSemesterSelectInline(); // ë°©ê¸ˆ ì¶”ê°€í•œ í•™ê¸°ëŠ” ë“œë¡­ë‹¤ìš´ì—ì„œ ì œê±°
            e.target.value = ''; // ë‹¤ì‹œ placeholderë¡œ
        } catch (err) {
            console.error(err);
            alert(`ì‹œê°„í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜: ${err.message}`);
        }
    }

    /***********************
     * ì‚¬ìš©ì/ê³„ì • ê´€ë ¨
     ***********************/
    function loaduserinfo() {
        const token = localStorage.getItem('jwtToken');
        return fetch('/userinfo', {
            method: 'GET',
            headers: { Authorization: `Bearer ${token}` },
        })
            .then((res) => {
                if (!res.ok) throw new Error('ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');
                return res.json();
            })
            .then((data) => {
                document.getElementById('userName').textContent = data.name;
                document.getElementById('studentId').textContent = data.email;
                /*
                                // userId ì œëŒ€ë¡œ ì €ì¥í•˜ê¸°
                                if (data.timetables && data.timetables.length > 0) {
                                  UserId = data.timetables[0].userId;
                                } else {
                                  console.warn("userinfoì— timetables ë°ì´í„°ê°€ ì—†ìŒ:", data);
                                }

                   */
                // ë‹¤ì–‘í•œ ì‘ë‹µ í˜•íƒœ ë°©ì–´ì ìœ¼ë¡œ ì²˜ë¦¬
                UserId =
                    data.userId ?? data.id ?? data.timetables?.[0]?.userId ?? null;
                if (!UserId) console.warn('userIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', data);
            })

            .catch((err) => {
                console.error(err);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            });
    }

    function deleteAccount() {
        const token = localStorage.getItem('jwtToken');
        if (
            !confirm(
                'ì •ë§ë¡œ íšŒì› íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'
            )
        )
            return;

        fetch('/member/delete', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`,
            },
        })
            .then((res) => {
                if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                return res.json();
            })
            .then((data) => {
                if (data.deleteStatus === 'success') {
                    alert('íšŒì› íƒˆí‡´ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    localStorage.removeItem('jwtToken');
                    window.location.href = '/';
                }
            })
            .catch((err) => {
                alert('íšŒì› íƒˆí‡´ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                console.error(err);
            });
    }

    function modifinguserinfo() {
        const modalOverlay = document.getElementById('modalOverlay');
        const closeBtn = document.getElementById('close-btn');
        const confirmBtn = document.getElementById('confirm');
        const token = localStorage.getItem('jwtToken');

        modalOverlay.classList.remove('hidden');
        document.body.classList.add('modal-open');

        closeBtn.onclick = () => {
            modalOverlay.classList.add('hidden');
            document.body.classList.remove('modal-open');
        };

        confirmBtn.onclick = () => {
            const pw = document.getElementById('pw').value;

            fetch('/check_pw_button', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ pw }),
            })
                .then((res) => {
                    if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
                    return res.json();
                })
                .then((data) => {
                    if (data.Password === true) {
                        alert('ë¹„ë°€ë²ˆí˜¸ í™•ì¸ ì™„ë£Œ!');
                        modalOverlay.classList.add('hidden');
                        document
                            .getElementById('changePwModal')
                            .classList.remove('hidden');
                    } else {
                        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                })
                .catch((err) => {
                    alert('ìš”ì²­ ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + err.message);
                    console.error(err);
                });
        };
    }

    document.getElementById('changePwBtn').onclick = function () {
        const newPw = document.getElementById('newPassword').value;
        const confirmPw = document.getElementById('confirmPassword').value;
        const token = localStorage.getItem('jwtToken');

        if (!newPw || !confirmPw || newPw !== confirmPw) {
            alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }

        fetch('/PWupdate_button', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify({ pw: newPw }),
        })
            .then(async (res) => {
                if (!res.ok) {
                    const errorText = await res.text();
                    alert(`ì„œë²„ ì˜¤ë¥˜ ${res.status}: ${errorText}`);
                    throw new Error('ì„œë²„ ì˜¤ë¥˜: ' + res.status);
                }
                return res.json();
            })
            .then((data) => {
                if (data.updateStatus === true) {
                    alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    document.getElementById('changePwModal').classList.add('hidden');
                } else {
                    alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch((err) => {
                alert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            });
    };
    document
        .getElementById('openPwModalBtn')
        ?.addEventListener('click', () => {
            document.getElementById('changePwModal').classList.remove('hidden');
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
        });
    document.getElementById('close-btn').onclick = function () {
        document.getElementById('modalOverlay').classList.add('hidden');
    };
    document.getElementById('cancelChange').onclick = function () {
        document.getElementById('changePwModal').classList.add('hidden');
    };

    function goToTechTree() {
        const select = document.getElementById('techTreeSelect');
        const year = select.value;
        const token = localStorage.getItem('jwtToken');

        if (!token) {
            alert('ë¡œê·¸ì¸ í† í°ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        if (!year) {
            alert('í•™ë²ˆì„ ì„ íƒí•˜ì„¸ìš”.');
            return;
        }

        fetch(`/tech_tree?year=${year}`, {
            method: 'GET',
            headers: { Authorization: `Bearer ${token}` },
        })
            .then((res) => {
                if (res.ok) return res.text();
                else throw new Error('Unauthorized');
            })
            .then((html) => {
                document.open();
                document.write(html);
                document.close();
            })
            .catch((err) => {
                console.error(err);
                window.location.href = '/';
            });
    }

    /***********************
     * í•™ê¸° ì¶”ê°€/ë¦¬ìŠ¤íŠ¸/ëª¨ë‹¬
     ***********************/
    function showAddSemester() {
        const addList = document.getElementById('addSemesterList');
        const select = document.getElementById('semesterSelect');

        select.innerHTML = '';
        semesterOptions.forEach((sem) => {
            if (!selectedSemesters.includes(sem)) {
                const option = document.createElement('option');
                option.value = sem;
                option.textContent = sem;
                select.appendChild(option);
            }
        });

        addList.classList.toggle('hidden');
    }

    async function addSemester() {
        const select = document.getElementById('semesterSelect');
        const selected = select.value;
        if (!selected) return;

        const semesterCode = toSemesterCode(selected);

        try {
            // 1) ì„œë²„ì— ë¹ˆ ì‹œê°„í‘œ ìƒì„±
            const tid = await createTimetableOnServer(semesterCode);

            // 2) ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
            timetableIdsBySemester[semesterCode] = tid;
            if (!selectedSemesters.includes(selected))
                selectedSemesters.push(selected);

            renderSemesterList();
            document.getElementById('addSemesterList').classList.add('hidden');
        } catch (err) {
            console.error(err);
            alert(`ì‹œê°„í‘œ ìƒì„± ì¤‘ ì˜¤ë¥˜: ${err.message}`);
        }
    }

    function renderSemesterList() {
        const list = document.getElementById('semesterList');
        list.innerHTML = '';

        selectedSemesters.forEach((sem) => {
            const termCode = toSemesterCode(sem);
            const tid = timetableIdsBySemester[termCode];

            // li ìì²´ë¥¼ ì¹´ë“œë¡œ ë§Œë“¤ê¸°
            const li = document.createElement('li');
            li.className = 'semester-item';
            // ì¹´ë“œ ì „ì²´ í´ë¦­ ì‹œ ëª¨ë‹¬ ì˜¤í”ˆ
            li.addEventListener('click', () => openScheduleModal(sem));

            // ì™¼ìª½: í•™ê¸°ëª… (ê²€ì •/ë°‘ì¤„ì—†ìŒ)
            const nameSpan = document.createElement('span');
            nameSpan.className = 'semester-name';
            nameSpan.textContent = sem;

            // ì˜¤ë¥¸ìª½: ì•¡ì…˜ë“¤(ì‚­ì œ + ëŒ€í‘œ ì²´í¬)
            const actions = document.createElement('div');
            actions.className = 'semester-actions';

            // ì‚­ì œ ë²„íŠ¼ (SVG ì•„ì´ì½˜)
            const delBtn = document.createElement('button');
            delBtn.className = 'del-btn';
            delBtn.title = 'ì‚­ì œ';
            delBtn.innerHTML = `
      <svg xmlns="http://www.w3.org/2000/svg"
           width="18" height="18" viewBox="0 0 24 24" fill="none"
           stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="3 6 5 6 21 6"></polyline>
        <path d="M19 6l-2 14H7L5 6"></path>
        <path d="M10 11v6"></path>
        <path d="M14 11v6"></path>
      </svg>
    `;
            // ì¹´ë“œ ì „ì²´ í´ë¦­ê³¼ êµ¬ë¶„(ë²„íŠ¼ í´ë¦­ ì‹œ ë²„ë¸” ì¤‘ë‹¨)
            delBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                removeSemester(termCode, tid);
            });

            // ëŒ€í‘œ ì²´í¬ë°•ìŠ¤
            const label = document.createElement('label');
            label.className = 'rep-label';
            // ì¹´ë“œ ì „ì²´ í´ë¦­ê³¼ êµ¬ë¶„
            label.addEventListener('click', (e) => e.stopPropagation());

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.checked = termCode === representativeTermCode; // ëŒ€í‘œë©´ ì²´í¬
            // ì²´í¬ë°•ìŠ¤ í¬ê¸° í‚¤ìš°ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ë‘ ì¤„ ì‚¬ìš© (ì›í•˜ë©´ ê°’ ì¡°ì ˆ)
            cb.style.transform = 'scale(1.3)';
            cb.style.margin = '2px';

            cb.onchange = (e) =>
                onToggleRepresentative(termCode, e.target.checked);

            const labTxt = document.createElement('span');
            labTxt.textContent = 'ëŒ€í‘œ';

            label.appendChild(cb);
            label.appendChild(labTxt);

            actions.appendChild(delBtn);
            actions.appendChild(label);

            li.appendChild(nameSpan);
            li.appendChild(actions);
            list.appendChild(li);
        });
    }

    function openScheduleModal(semester) {
        const modal = document.getElementById('scheduleModal');
        const title = document.getElementById('modalSemesterTitle');
        const container = document.getElementById('scheduleTableContainer');
        const listContainer = document.getElementById('classInfoList');

        // í˜„ì¬ í•™ê¸°ì½”ë“œ/ID í™•ë³´
        currentSemesterCode = toSemesterCode(semester);
        currentTimetableId =
            timetableIdsBySemester[currentSemesterCode] ?? null;

        if (!currentTimetableId) {
            alert(
                'ì´ í•™ê¸°ì˜ ì‹œê°„í‘œ IDê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € "ì‹œê°„í‘œ ì¶”ê°€"ì—ì„œ í•™ê¸°ë¥¼ ì¶”ê°€í•˜ì„¸ìš”.'
            );
            return;
        }

        document.getElementById('closeScheduleModal').onclick = function () {
            document.getElementById('scheduleModal').classList.add('hidden');
            document.body.classList.remove('modal-open');
            hideCourseTooltip();
        };

        title.textContent = semester;
        container.innerHTML = generateEmptyScheduleTable();
        listContainer.innerHTML = '<p>ìˆ˜ì—… ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>';
        modal.classList.remove('hidden');
        document.body.classList.add('modal-open');

        const token = localStorage.getItem('jwtToken');

        console.log('ğŸ‘‰ timetableId:', currentTimetableId);
        console.log('ğŸ‘‰ userId:', UserId);

        // ğŸŸ¢ 1) í˜„ì¬ ì‹œê°„í‘œ ë¶ˆëŸ¬ì˜¤ê¸°  (êµì²´ ë²„ì „)
        fetch('/getTC', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`,
            },
            body: JSON.stringify(UserId),
        })
            .then((res) => {
                if (!res.ok) throw new Error('ì‹œê°„í‘œ ì¡°íšŒ ì‹¤íŒ¨');
                return res.json();
            })
            .then(async (allRows) => {
                // í˜„ì¬ ëª¨ë‹¬ì˜ timetableIdì— í•´ë‹¹í•˜ëŠ” í•­ëª©ë§Œ
                const filtered = (allRows || []).filter((r) => {
                    const tid = getTid(r);
                    return Number.isFinite(tid) && tid === Number(currentTimetableId);
                });

                // â¬‡ ê³¼ëª© IDë§Œ ì¶”ì¶œ (ë¬¸ìì—´/ìˆ«ì ëª¨ë‘ í—ˆìš©)
                const courseIds = Array.from(
                    new Set(
                        filtered
                            .map(getCourseId)
                            .filter((v) => v != null && String(v).trim() !== '')
                    )
                );
                if (courseIds.length === 0) {
                    // ì €ì¥ëœ ìˆ˜ì—…ì´ ì—†ìœ¼ë©´ ì´ˆê¸°í™” ìƒíƒœ ê·¸ëŒ€ë¡œ
                    return;
                }

                // â¬‡ ëŒ€í‘œ ì‹œê°„í‘œì™€ ë™ì¼í•˜ê²Œ, ìŠ¬ë¡¯ APIë¡œ ë³€í™˜ëœ ë°ì´í„° ë°›ì•„ ë Œë”
                const slotRes = await fetch('/getTS2TE', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({ getScheduleIds: courseIds }),
                });
                if (!slotRes.ok) throw new Error('ìŠ¬ë¡¯ ì¡°íšŒ ì‹¤íŒ¨');
                const slotData = await slotRes.json(); // í•„ë“œ: time_start, time_end, day, identify_number_of_course, ...
                renderScheduleFromTS2TE(slotData); // â¬… ì•„ë˜ ìƒˆ í•¨ìˆ˜
            })
            .catch((err) => console.error('getTC/ìŠ¬ë¡¯ ë¡œë“œ ì˜¤ë¥˜:', err));

        // ğŸŸ¢ 2) ìˆ˜ì—… ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        fetch('/a', { headers: { Authorization: `Bearer ${token}` } })
            .then((res) => res.json())
            .then((data) => {
                currentCourseList = data;
                console.log(data);
                renderCourseList(data);
                attachCellEvents();
            })
            .catch((err) => {
                listContainer.innerHTML = `<p style="color:red;">ìˆ˜ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
                console.error(err);
            });

        // ì €ì¥ í•¸ë“¤ëŸ¬(ì¤‘ë³µ ë°©ì§€)
        const saveBtn = document.getElementById('saveSchedule');
        saveBtn.replaceWith(saveBtn.cloneNode(true));
        document
            .getElementById('saveSchedule')
            .addEventListener('click', onClickSaveSchedule);
    }




    // ëª¨ë‹¬ ì‹œê°„í‘œ ë Œë”ë§

    function renderScheduleFromTS2TE(scheduleData) {
        const table = document.getElementById('scheduleTable');
        if (!table || !Array.isArray(scheduleData)) return;

        const needsZero = scheduleData.some(
            (it) => toPeriodNumber(it.timeStart, null) === 0 ||
                toPeriodNumber(it.timeEnd,   null) === 0
        );
        if (needsZero && !hasZeroPeriod(table)) prependZeroPeriodRow(table);

        let neededMax = 9;
        scheduleData.forEach((it) => {
            const end = toPeriodNumber(it.time_end ?? it.timeEnd ?? it.periodEnd, null);
            if (end != null) neededMax = Math.max(neededMax, end);
        });
        ensureTableMaxPeriod(table, neededMax);

        scheduleData.forEach((item) => {
            const subject    = item.courseName || '';
            const professor  = item.professorName || '';
            const classroom  = item.classroom || '';
            const courseCode = item.identify_number_of_course || item.courseCode || '';

            const coursePk =
                item.courseId ?? item.course_id ?? item.timeTableId ?? item.time_table_id ??
                item.id ?? item.coursePK ?? null;

            const dayIdx = toPeriodNumber(item.day, 0) - 1;
            if (dayIdx < 0 || dayIdx > 4) return;

            const pStart = toPeriodNumber(item.time_start ?? item.timeStart ?? item.periodStart, null);
            const pEnd   = toPeriodNumber(item.time_end   ?? item.timeEnd   ?? item.periodEnd   ?? item.time_start, null);
            if (pStart == null || pEnd == null) return;

            const key = courseCode || subject;
            const bg  = ColorManager.get(key);

            for (let p = pStart; p <= pEnd; p++) {
                const cell = getCell(table, dayIdx, p);
                if (!cell) continue;

                cell.innerHTML = renderSlotHTML(subject, classroom, professor);

                // â–¼ gradient ìŠ¤íƒ€ì¼: CSS ë³€ìˆ˜ + busy í´ë˜ìŠ¤
                cell.style.setProperty('--course-color', bg);
                cell.classList.add('busy');
                cell.style.removeProperty('background');
                cell.style.removeProperty('backgroundImage');

                cell.setAttribute('data-course-id', courseCode);
                if (coursePk != null) cell.setAttribute('data-course-pk', String(coursePk));
                cell.removeAttribute('data-preview');
            }
        });

        attachCellEvents();
    }



    function renderCourseList(classList) {
        const listContainer = document.getElementById('classInfoList');
        listContainer.innerHTML = '';

        const searchInput = document.getElementById('searchInput');
        const searchTerm = searchInput?.value?.toLowerCase() || '';

        if (!Array.isArray(classList) || classList.length === 0) {
            listContainer.innerHTML = '<p>ìˆ˜ì—… ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }

        const groupedByCourse = groupByCourse(classList);

        Object.entries(groupedByCourse).forEach(([courseName, allEntries]) => {
            if (searchTerm && !courseName.toLowerCase().includes(searchTerm))
                return;

            const wrapper = document.createElement('div');
            wrapper.style.marginBottom = '12px';
            wrapper.style.border = '1px solid #ccc';
            wrapper.style.borderRadius = '6px';
            wrapper.style.background = '#f9f9f9';
            wrapper.style.padding = '10px';

            const header = document.createElement('div');
            header.style.cursor = 'pointer';
            header.style.fontWeight = 'bold';
            header.style.color = '#2563eb';
            header.textContent = courseName;

            const subList = document.createElement('div');
            subList.style.display = 'none';
            subList.style.marginTop = '8px';

            const groupedByIdentifyNumber = {};
            allEntries.forEach((entry) => {
                const key = entry.identifyNumberOfCourse;
                if (!groupedByIdentifyNumber[key])
                    groupedByIdentifyNumber[key] = [];
                groupedByIdentifyNumber[key].push(entry);
            });

            Object.values(groupedByIdentifyNumber).forEach((entries) => {
                const detail = document.createElement('div');
                detail.style.padding = '6px 10px';
                detail.style.borderTop = '1px solid #ddd';
                detail.style.cursor = 'pointer';
                detail.style.background = '#fff';

                const professor = entries[0].professorName || '-';
                const code = entries[0]?.identifyNumberOfCourse ?? '';
                const division = (typeof code === 'string' && code.includes('-'))
                    ? code.split('-')[1]
                    : '?';

                const weekdayNames = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
                const timeText = entries
                    .map((e) => {
                        const day =
                            weekdayNames[e.scheduleDay - 1] || `ìš”ì¼ ${e.scheduleDay}`;
                        return e.timeStart === e.timeEnd
                            ? `${day} ${e.timeStart}êµì‹œ`
                            : `${day} ${e.timeStart}~${e.timeEnd}êµì‹œ`;
                    })
                    .join(', ');

                detail.innerHTML = `
          ë¶„ë°˜: ${division}<br>
          êµìˆ˜: ${professor}<br>
          ì‹œê°„: ${timeText}
        `;

                detail.addEventListener('mouseover', () => {
                    if (!isCoursePermanentlyAdded(entries))
                        previewCourseOnSchedule(entries);
                });
                detail.addEventListener('mouseout', () => {
                    if (!isCoursePermanentlyAdded(entries))
                        removePreviewFromSchedule();
                });
                detail.addEventListener('click', () => {
                    addCourseToScheduleTable(entries); // ì‹¤ì œ ë“±ë¡/í† ê¸€
                });

                subList.appendChild(detail);
            });

            header.addEventListener('click', () => {
                subList.style.display =
                    subList.style.display === 'none' ? 'block' : 'none';
            });

            wrapper.appendChild(header);
            wrapper.appendChild(subList);
            listContainer.appendChild(wrapper);
        });
    }

    function groupByCourse(data) {
        const map = {};
        data.forEach((entry) => {
            const key = entry.courseName;
            if (!map[key]) map[key] = [];
            map[key].push(entry);
        });
        return map;
    }



    // â˜… íŒŒì¼ ìƒë‹¨(ìƒìˆ˜ ëª¨ìŒ ê·¼ì²˜)ì— ì¶”ê°€: ì›í•˜ëŠ” ê³ ì • ë¯¸ë¦¬ë³´ê¸° ìƒ‰
    const FIXED_PREVIEW_COLOR = 'rgba(99, 179, 237, 0.25)'; // <- ë„¤ê°€ ì›í•˜ëŠ” ìƒ‰ìœ¼ë¡œ ë³€ê²½

    function previewCourseOnSchedule(courseEntries) {
        const table = document.getElementById('scheduleTable');
        if (!table) return;

        // (0êµì‹œ/í™•ì¥ ë¡œì§ ê¸°ì¡´ ê·¸ëŒ€ë¡œ...)
        const needsZero = courseEntries.some(
            (e) => Number(e.timeStart) === 0 || Number(e.timeEnd) === 0
        );
        if (needsZero && !hasZeroPeriod(table)) {
            prependZeroPeriodRow(table);
            previewSession.zeroAdded = true;
        }

        let neededMax = 9;
        courseEntries.forEach((e) => {
            neededMax = Math.max(neededMax, Number(e.timeEnd));
        });
        const beforeMax = getCurrentMaxPeriod(table);
        if (neededMax > beforeMax) {
            ensureTableMaxPeriod(table, neededMax);
            previewSession.extendedTo = neededMax;
        }

        // â˜… ë¯¸ë¦¬ë³´ê¸° ì±„ìš°ê¸° (ê¸€ì/ìƒ‰ì„ ì‹¤ì œì™€ ë™ì¼ í…œí”Œë¦¿ + ê³ ì •ìƒ‰ìœ¼ë¡œ)
        courseEntries.forEach((entry) => {
            const dayIndex = entry.scheduleDay - 1;
            for (let p = entry.timeStart; p <= entry.timeEnd; p++) {
                const cell = getCell(table, dayIndex, p);
                if (!cell) continue;

                let overlay = cell.querySelector('.preview-overlay');
                if (!overlay) {
                    overlay = document.createElement('div');
                    overlay.className = 'preview-overlay';
                    cell.appendChild(overlay);
                }

                // ê¸€ì: ì‹¤ì œ ì…€ê³¼ ë™ì¼ í…œí”Œë¦¿ ì‚¬ìš©
                overlay.innerHTML = renderSlotHTML(
                    entry.courseName,
                    entry.classroom,
                    entry.professorName || ''
                );

                // ìƒ‰: ë„¤ê°€ ì§€ì •í•œ ê³ ì • ìƒ‰ ì‚¬ìš©
                overlay.style.setProperty('--preview-color', FIXED_PREVIEW_COLOR);

                // ë¶€ë“œëŸ½ê²Œ ë‚˜íƒ€ë‚¨
                requestAnimationFrame(() => overlay.classList.add('show'));

                // ì •ë¦¬ìš© í”Œë˜ê·¸
                cell.setAttribute('data-preview', 'true');
            }
        });
    }


    function removePreviewFromSchedule() {
        const table = document.getElementById('scheduleTable');
        if (!table) return;

        // ë¯¸ë¦¬ë³´ê¸° ì˜¤ë²„ë ˆì´ë§Œ ë¶€ë“œëŸ½ê²Œ ì œê±°
        table.querySelectorAll('.preview-overlay').forEach((ov) => {
            ov.classList.remove('show');
            ov.addEventListener('transitionend', () => ov.remove(), {
                once: true,
            });
        });
        table.querySelectorAll('td[data-preview="true"]').forEach((td) => {
            td.removeAttribute('data-preview');
        });

        // ì•„ë˜ìª½ í™•ì¥ ì›ë³µ
        if (previewSession.extendedTo != null) {
            const permanentMax = getPermanentMaxPeriod(table);
            shrinkTableTo(table, permanentMax);
            previewSession.extendedTo = null;
        }

        // 0êµì‹œ ì›ë³µ
        if (previewSession.zeroAdded) {
            if (hasZeroPeriod(table) && isZeroRowEmpty(table)) {
                const zeroTr = table.querySelector(
                    'td[data-period="0"]'
                )?.parentElement;
                if (zeroTr) zeroTr.remove();
            }
            previewSession.zeroAdded = false;
        }
    }

    // ë¬¸ìì—´ "10", "10êµì‹œ" ë“±ë„ ì•ˆì „í•˜ê²Œ ìˆ«ìë¡œ
    function toPeriodNumber(v, fallback = null) {
        if (v == null) return fallback;
        if (typeof v === 'number' && Number.isFinite(v)) return v;
        const m = String(v).match(/\d+/);
        if (!m) return fallback;
        const n = parseInt(m[0], 10);
        return Number.isFinite(n) ? n : fallback;
    }

    function isCoursePermanentlyAdded(courseEntries) {
        const table = document.getElementById('scheduleTable');
        if (!table || !courseEntries?.length) return false;

        const courseId = courseEntries[0].identifyNumberOfCourse;

        for (const entry of courseEntries) {
            const dayIndex = toPeriodNumber(entry.scheduleDay, 0) - 1;
            const start = toPeriodNumber(
                entry.timeStart ?? entry.periodStart,
                null
            );
            const end = toPeriodNumber(
                entry.timeEnd ?? entry.periodEnd ?? entry.timeStart,
                null
            );

            if (dayIndex < 0 || start == null || end == null) continue;

            for (let p = start; p <= end; p++) {
                const cell = getCell(table, dayIndex, p); // â† ì•ˆì „ ì ‘ê·¼
                if (!cell) continue;
                if (cell.getAttribute('data-course-id') === courseId) {
                    return true;
                }
            }
        }
        return false;
    }

    function addCourseToScheduleTable(entries) {
        const table = document.getElementById('scheduleTable');
        if (!table || !Array.isArray(entries) || entries.length === 0) return;

        const courseName = entries[0].courseName;
        const classroom  = entries[0].classroom;
        const professor  = entries[0].professorName || '';
        const courseCode = entries[0].identifyNumberOfCourse;
        const coursePk   =
            entries[0].courseId ?? entries[0].course_id ?? entries[0].id ?? entries[0].coursePK ?? null;

        // ì´ë¯¸ ë°°ì¹˜ë˜ì–´ ìˆë‚˜ íƒì§€
        let alreadyPlaced = false;
        outer: for (const e of entries) {
            const d = toPeriodNumber(e.scheduleDay, 0) - 1;
            const s = toPeriodNumber(e.timeStart ?? e.periodStart, null);
            const t = toPeriodNumber(e.timeEnd   ?? e.periodEnd   ?? e.timeStart, null);
            if (d < 0 || s == null || t == null) continue;
            for (let p = s; p <= t; p++) {
                const cell = getCell(table, d, p);
                if (cell && cell.getAttribute('data-course-id') === courseCode) {
                    alreadyPlaced = true;
                    break outer;
                }
            }
        }

        // ===== í† ê¸€ ì œê±° =====
        if (alreadyPlaced) {
            for (const e of entries) {
                const d = toPeriodNumber(e.scheduleDay, 0) - 1;
                const s = toPeriodNumber(e.timeStart ?? e.periodStart, null);
                const t = toPeriodNumber(e.timeEnd   ?? e.periodEnd   ?? e.timeStart, null);
                if (d < 0 || s == null || t == null) continue;

                for (let p = s; p <= t; p++) {
                    const cell = getCell(table, d, p);
                    if (!cell || cell.getAttribute('data-course-id') !== courseCode) continue;

                    // ì¦‰ì‹œ ì •ë¦¬ (ë°°ê²½/ì˜¤ë²„ë ˆì´ ì”ìƒ ë°©ì§€)
                    cell.innerHTML = '';
                    cell.removeAttribute('data-course-id');
                    cell.removeAttribute('data-course-pk');
                    cell.removeAttribute('data-preview');

                    // ê·¸ë¼ë°ì´ì…˜/ë³´ë”ë¥¼ ë‹´ë‹¹í•˜ëŠ” í´ë˜ìŠ¤Â·ë³€ìˆ˜ ì œê±°
                    cell.classList.remove('busy');
                    cell.style.removeProperty('--course-color');

                    cell.style.removeProperty('background');
                    cell.style.removeProperty('backgroundImage');
                    cell.style.boxShadow = '';

                    const ov = cell.querySelector('.preview-overlay');
                    if (ov) ov.remove();

                    // ì‚´ì§ í˜ì´ë“œ
                    try {
                        cell.animate(
                            [
                                { opacity: 1,   transform: 'scale(1)'    },
                                { opacity: 0.92, transform: 'scale(0.98)' },
                                { opacity: 1,   transform: 'scale(1)'    },
                            ],
                            { duration: 140, easing: 'ease' }
                        );
                    } catch (_) {}
                }
            }

            // ì „ë¶€ ì§€ì›Œì¡Œìœ¼ë©´ ì»¬ëŸ¬ ë°˜ë‚©
            const colorKey = courseCode || courseName;
            const stillExists = document.querySelector(
                `#scheduleTable .cell[data-course-id="${courseCode}"]`
            );
            if (!stillExists) {
                ColorManager.free(colorKey);
            }

            normalizeTableAfterMutation(table);
            return;
        }

        // ===== ì‹ ê·œ ë°°ì¹˜ =====

        // 0êµì‹œ í•„ìš” ì‹œ ì¶”ê°€
        if (entries.some(e =>
            toPeriodNumber(e.timeStart, null) === 0 || toPeriodNumber(e.timeEnd, null) === 0
        )) {
            if (!table.querySelector('.cell[data-period="0"]')) {
                prependZeroPeriodRow(table);
            }
        }

        // ì•„ë˜ë¡œ í™•ì¥
        let neededMax = 9;
        for (const e of entries) {
            const end = toPeriodNumber(e.timeEnd ?? e.periodEnd ?? e.timeStart, null);
            if (end != null) neededMax = Math.max(neededMax, end);
        }
        ensureTableMaxPeriod(table, neededMax);

        // ì¶©ëŒ í™•ì¸
        for (const e of entries) {
            const d = toPeriodNumber(e.scheduleDay, 0) - 1;
            const s = toPeriodNumber(e.timeStart ?? e.periodStart, null);
            const t = toPeriodNumber(e.timeEnd   ?? e.periodEnd   ?? e.timeStart, null);
            if (d < 0 || s == null || t == null) continue;

            for (let p = s; p <= t; p++) {
                const cell = getCell(table, d, p);
                if (!cell) continue;
                const existing = cell.getAttribute('data-course-id');
                if (existing && existing !== courseCode) {
                    alert('í•´ë‹¹ ì‹œê°„ì— ì´ë¯¸ ë‹¤ë¥¸ ìˆ˜ì—…ì´ ìˆìŠµë‹ˆë‹¤!');
                    return;
                }
            }
        }

        // ë°°ì¹˜
        const colorKey = courseCode || courseName;
        const bg = ColorManager.get(colorKey);

        for (const e of entries) {
            const d = toPeriodNumber(e.scheduleDay, 0) - 1;
            const s = toPeriodNumber(e.timeStart ?? e.periodStart, null);
            const t = toPeriodNumber(e.timeEnd   ?? e.periodEnd   ?? e.timeStart, null);
            if (d < 0 || s == null || t == null) continue;

            for (let p = s; p <= t; p++) {
                const cell = getCell(table, d, p);
                if (!cell) continue;

                const wasPreview = cell.getAttribute('data-preview') === 'true';

                cell.innerHTML = renderSlotHTML(courseName, classroom, professor);

                // â–¼ gradient ìŠ¤íƒ€ì¼: CSS ë³€ìˆ˜ + busy í´ë˜ìŠ¤
                cell.style.setProperty('--course-color', bg);
                cell.classList.add('busy');
                cell.style.removeProperty('background');
                cell.style.removeProperty('backgroundImage');

                cell.setAttribute('data-course-id', courseCode);
                if (coursePk != null) cell.setAttribute('data-course-pk', String(coursePk));
                if (wasPreview) cell.removeAttribute('data-preview');

                // ë¯¸ë¦¬ë³´ê¸° ì˜¤ë²„ë ˆì´ ì œê±°
                const ov = cell.querySelector('.preview-overlay');
                if (ov) ov.remove();

                try {
                    cell.animate(
                        [
                            { opacity: 0.0, transform: 'scale(0.98)' },
                            { opacity: 1,   transform: 'scale(1)'    },
                        ],
                        { duration: 120, easing: 'ease' }
                    );
                } catch (_) {}
            }
        }

        attachCellEvents();
    }


    // ê¸°ì¡´ attachCellEvents() êµì²´
    function attachCellEvents() {
        const root = document.getElementById('scheduleTable');
        if (!root) return;
        const allCells = root.querySelectorAll('.cell[data-period]'); // â¬… td â†’ .cell

        allCells.forEach((cell) => {
            cell.onmouseover = function () {
                const courseId = cell.getAttribute('data-course-id');
                if (courseId) {
                    const courseInfo = currentCourseList.find(
                        (c) => c.identifyNumberOfCourse === courseId
                    );
                    if (courseInfo) showCourseTooltip(cell, courseInfo);
                }
            };
            cell.onmouseout = function () {
                hideCourseTooltip();
            };
        });
    }


    function showCourseTooltip(cell, courseInfo) {
        hideCourseTooltip();
        const tooltip = document.createElement('div');
        tooltip.className = 'course-tooltip';
        tooltip.style.position = 'absolute';
        tooltip.style.zIndex = 2000;
        tooltip.style.minWidth = '180px';
        tooltip.style.maxWidth = '260px';
        tooltip.style.background = '#ffffffcc';
        tooltip.style.border = '1px solid #2563eb';
        tooltip.style.borderRadius = '10px';
        tooltip.style.boxShadow = '0 4px 18px rgba(30,80,210,0.13)';
        tooltip.style.padding = '14px 18px 14px 14px';
        tooltip.style.fontSize = '0.98rem';
        tooltip.style.pointerEvents = 'none';
        tooltip.innerHTML = `
      <b>${courseInfo.courseName}</b>
      <br>êµìˆ˜: ${courseInfo.professorName || '-'}
      <br>ê°•ì˜ì‹¤: ${courseInfo.classroom}
      <br>êµ¬ë¶„: ${courseInfo.majorOrCulture ? 'ì „ê³µ' : 'êµì–‘'}
      <br>í•™ì : ${courseInfo.credit}
      <br>ìš”ì¼: ${
            ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'][courseInfo.scheduleDay - 1] ||
            courseInfo.scheduleDay
        }
      <br>êµì‹œ: ${courseInfo.timeStart} ~ ${courseInfo.timeEnd}
      <br>ê³¼ëª©ì½”ë“œ: ${courseInfo.identifyNumberOfCourse}
    `;
        document.body.appendChild(tooltip);

        const rect = cell.getBoundingClientRect();
        tooltip.style.left = rect.right + 8 + 'px';
        tooltip.style.top = rect.top + window.scrollY + 'px';
    }

    function hideCourseTooltip() {
        const prev = document.querySelector('.course-tooltip');
        if (prev) prev.remove();
    }

    // ê¸°ì¡´ getSelectedClassIds()ì˜ ì…€ ì„ íƒìë§Œ êµì²´
    function getSelectedClassIds() {
        const cells = document.querySelectorAll('#scheduleTable .cell[data-course-id]');
        const idSet = new Set();

        // 1) data-course-pk ìš°ì„  (ë¬¸ìì—´ "0"/null/ë¹ˆë¬¸ì ë°©ì§€)
        cells.forEach((cell) => {
            const pkAttr = cell.getAttribute('data-course-pk');
            const pk = Number(pkAttr);
            if (Number.isInteger(pk) && pk > 0) {
                idSet.add(pk);
            }
        });

        // 2) ì—†ìœ¼ë©´ ì½”ë“œâ†’PK ë§¤í•‘ (ìœ„ì—ì„œ timeTableId í¬í•¨í•˜ë„ë¡ ì´ë¯¸ ìˆ˜ì •)
        if (idSet.size === 0) {
            const codes = new Set();
            cells.forEach((cell) => {
                const code = cell.getAttribute('data-course-id');
                if (code) codes.add(code);
            });

            currentCourseList.forEach((e) => {
                const pk =
                    e.courseId ?? e.course_id ?? e.timeTableId ?? e.time_table_id ?? e.id ?? e.coursePK ?? e.pk ?? null;
                const code =
                    e.identifyNumberOfCourse ?? e.identify_number_of_course ?? e.courseCode ?? null;
                const n = Number(pk);
                if (code && codes.has(code) && Number.isInteger(n) && n > 0) {
                    idSet.add(n);
                }
            });
        }

        return Array.from(idSet);
    }



    async function onClickSaveSchedule() {
        try {
            // 1) timetableId í™•ë³´
            if (!currentTimetableId) {
                currentTimetableId = timetableIdsBySemester[currentSemesterCode] ?? null;
            }
            if (!currentTimetableId) {
                currentTimetableId = await fetchLatestTimetableIdFromUserInfo(currentSemesterCode);
            }
            if (!currentTimetableId) throw new Error('timetableIdê°€ ì—†ìŠµë‹ˆë‹¤.');

            // 2) ì„ íƒëœ ê³¼ëª© PK ìˆ˜ì§‘
            const classIds = getSelectedClassIds();
            if (!Array.isArray(classIds) || classIds.length === 0) {
                alert('ì €ì¥í•  ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            // ì¤‘ë³µ/ë¹„ì •ìƒ ê°’ ë°©ì§€
            const courseIds = Array.from(new Set(classIds.map(n => Number(n))))
                .filter(n => Number.isInteger(n) && n > 0);

            const token = localStorage.getItem('jwtToken');
            const payload = {
                timetableId: Number(currentTimetableId),
                courseIds,
            };

            console.log('[addTC] Request payload:', payload);

            // 3) JSON POST
            const res = await fetch('/addTC', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    ...(token ? { Authorization: `Bearer ${token}` } : {}),
                },
                body: JSON.stringify(payload),
            });

            console.log('[addTC] Response status:', res.status, res.statusText);
            console.log('[addTC] Response headers:', Object.fromEntries(res.headers.entries()));

            // 4) ë³¸ë¬¸ íŒŒì‹±
            const raw = await res.text();
            let data;
            try { data = raw ? JSON.parse(raw) : null; } catch { data = raw || null; }

            // 5) ì—ëŸ¬ ì²˜ë¦¬
            if (!res.ok) {
                let msg = (data && data.message) ? data.message : (typeof data === 'string' ? data : `HTTP ${res.status}`);

                // Duplicate entry ì˜ˆì˜ê²Œ ê°€ê³µ
                if (typeof msg === 'string' && msg.includes('Duplicate entry')) {
                    const m = msg.match(/'(\d+)-(\d+)'/); // 'timetableId-courseId'
                    msg = m
                        ? `ì´ë¯¸ ì¶”ê°€ëœ ê³¼ëª©ì´ ìˆì–´ìš” (timetableId=${m[1]}, courseId=${m[2]}).`
                        : 'ì´ë¯¸ ì¶”ê°€ëœ ê³¼ëª©ì´ í¬í•¨ë˜ì–´ ìˆì–´ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
                }

                console.error('[addTC] Failed:', { status: res.status, data });
                throw new Error(msg);
            }

            console.log('[addTC] Success:', data);
            alert('ì €ì¥ ì™„ë£Œ!');
            return data; // { Status: "Success" } ì˜ˆìƒ
        } catch (err) {
            console.error('[addTC] Exception:', err);
            alert(`ì €ì¥ ì¤‘ ì˜¤ë¥˜: ${err.message}`);
        }
    }


    // âœ… ëŒ€í‘œ ì‹œê°„í‘œì™€ ë™ì¼ êµ¬ì¡°(div grid)ë¡œ ëª¨ë‹¬ ì‹œê°„í‘œ ìƒì„±
    function generateEmptyScheduleTable(maxPeriod = 9) {
        const days = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ'];
        const timeLabels = ['9~10ì‹œ','10~11ì‹œ','11~12ì‹œ','12~1ì‹œ','1~2ì‹œ','2~3ì‹œ','3~4ì‹œ','4~5ì‹œ','5~6ì‹œ'];

        let html = `
    <div class="schedule-card" id="scheduleTable">
      <div class="schedule-header">
        <div class="time-col"></div>
        ${days.map(d => `<div>${d}</div>`).join('')}
      </div>
      <div class="schedule-body">
  `;

        for (let p = 1; p <= maxPeriod; p++) {
            html += `
      <div class="row">
        <div class="time-col">${p}êµì‹œ<br/><span>${timeLabels[p-1] || ''}</span></div>
        ${days.map((_, i) => `<div class="cell" data-day="${i}" data-period="${p}"></div>`).join('')}
      </div>
    `;
        }

        html += `</div></div>`;
        return html;
    }


    // ì˜êµ¬ ë°°ì¹˜ëœ(= data-course-id ì¡´ì¬) ì…€ì´ ìˆëŠ” ìµœëŒ“ êµì‹œë¥¼ ê¸°ì¤€ìœ¼ë¡œ í‘œë¥¼ ì •ë¦¬
    function normalizeTableAfterMutation(table) {
        if (!table) return;

        // 1) ì•„ë˜ìª½ ê¼¬ë¦¬ í–‰ ì •ë¦¬: ì˜êµ¬ ìˆ˜ì—…ì˜ ìµœëŒ“ êµì‹œê¹Œì§€ë§Œ ìœ ì§€ (ìµœì†Œ 9êµì‹œ)
        const targetMax = getPermanentMaxPeriod(table); // ë‚´ë¶€ì—ì„œ Math.max(9, â€¦) ì²˜ë¦¬
        shrinkTableTo(table, targetMax);

        // 2) 0êµì‹œ í–‰ ì •ë¦¬: 0êµì‹œì— ì˜êµ¬ ìˆ˜ì—…ì´ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ 0êµì‹œ í–‰ ì œê±°
        if (hasZeroPeriod(table) && isZeroRowEmpty(table)) {
            const zeroTr = table.querySelector(
                'td[data-period="0"]'
            )?.parentElement;
            if (zeroTr) zeroTr.remove();
        }
    }


    // í˜„ì¬ ê·¸ë¦¬ë“œì— 0êµì‹œ í–‰ì´ ìˆëŠ”ê°€?
    function hasZeroPeriod(container) {
        return !!(container || document).querySelector('.cell[data-period="0"]');
    }

    // í˜„ì¬ ê°€ì§„ ìµœëŒ“ êµì‹œ(ë¯¸ë¦¬ë³´ê¸° í¬í•¨)
    function getCurrentMaxPeriod(container) {
        let max = 1;
        (container || document).querySelectorAll(PERIOD_SELECTOR).forEach(el => {
            const p = Number(el.getAttribute('data-period'));
            if (Number.isFinite(p)) max = Math.max(max, p);
        });
        return max;
    }
    // ì €ì¥ ëŒ€ìƒ(= data-course-id ì¡´ì¬) ê¸°ì¤€ ìµœëŒ“ êµì‹œ (ìµœì†Œ 9 ìœ ì§€)
    function getPermanentMaxPeriod(container) {
        let max = 1;
        (container || document).querySelectorAll(PERIOD_SELECTOR).forEach(el => {
            if (el.getAttribute('data-course-id')) {
                const p = Number(el.getAttribute('data-period'));
                if (Number.isFinite(p)) max = Math.max(max, p);
            }
        });
        return Math.max(9, max);
    }

    // 0êµì‹œ í–‰ì´ ë¹„ì—ˆëŠ”ì§€(ì˜êµ¬ ë°°ì¹˜ ê¸°ì¤€)
    function isZeroRowEmpty(container) {
        const zeroCells = (container || document).querySelectorAll('.cell[data-period="0"]');
        if (zeroCells.length === 0) return true;
        for (const c of zeroCells) {
            if (c.getAttribute('data-course-id')) return false;
        }
        return true;
    }

    function makeTimeLabelTd(period) {
        const td = document.createElement('td');
        td.style.cssText =
            'border:1px solid #ddd; padding:8px; background:#e3e3fd; font-weight:bold;';
        const startHour = 8 + period;
        const endHour = 9 + period;
        const timeStr =
            startHour <= 12 ? `${startHour}ì‹œ` : `${startHour - 12}ì‹œ`;
        const endtime = endHour <= 12 ? `${endHour}ì‹œ` : `${endHour - 12}ì‹œ`;
        td.innerHTML = `${period}êµì‹œ<br>(${timeStr}~${endtime})`;
        return td;
    }

    // ì•„ë˜ìª½ì— êµì‹œ í–‰ ì¶”ê°€ (ëŒ€í‘œ ê·¸ë¦¬ë“œì™€ ë™ì¼í•œ ë§ˆí¬ì—…)
    function appendPeriodRow(container, period) {
        const body = (container || document).querySelector('.schedule-body');
        if (!body) return;

        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
    <div class="time-col">${period}êµì‹œ<br/><span></span></div>
    <div class="cell" data-day="0" data-period="${period}"></div>
    <div class="cell" data-day="1" data-period="${period}"></div>
    <div class="cell" data-day="2" data-period="${period}"></div>
    <div class="cell" data-day="3" data-period="${period}"></div>
    <div class="cell" data-day="4" data-period="${period}"></div>
  `;
        body.appendChild(row);
    }
    // í—¤ë” ë°”ë¡œ ì•„ë˜ 0êµì‹œ í–‰ ì‚½ì…
    function prependZeroPeriodRow(container) {
        if (hasZeroPeriod(container)) return;
        const body = (container || document).querySelector('.schedule-body');
        if (!body) return;

        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
    <div class="time-col">0êµì‹œ<br/><span></span></div>
    <div class="cell" data-day="0" data-period="0"></div>
    <div class="cell" data-day="1" data-period="0"></div>
    <div class="cell" data-day="2" data-period="0"></div>
    <div class="cell" data-day="3" data-period="0"></div>
    <div class="cell" data-day="4" data-period="0"></div>
  `;
        body.insertBefore(row, body.firstChild);
    }

    // í•„ìš”í•œ êµì‹œê¹Œì§€ í™•ì¥
    function ensureTableMaxPeriod(container, neededMax) {
        const root = (container || document).querySelector('#scheduleTable') || container || document;
        let curMax = getCurrentMaxPeriod(root);
        if (neededMax > curMax) {
            for (let p = curMax + 1; p <= neededMax; p++) appendPeriodRow(root, p);
        }
    }

    // targetMaxê¹Œì§€ë§Œ ë‚¨ê¸°ê³  ì¤„ì´ê¸°
    function shrinkTableTo(container, targetMax) {
        const root = (container || document).querySelector('#scheduleTable') || container || document;
        let curMax = getCurrentMaxPeriod(root);
        while (curMax > targetMax) {
            const last = root.querySelector(`.cell[data-period="${curMax}"]`);
            const row = last ? last.closest('.row') : null;
            if (!row) break;
            row.remove();
            curMax--;
        }
    }

    // dayIdx(0~4), period(ì •ìˆ˜) â†’ í•´ë‹¹ .cell
    function getCell(container, dayIdx, period) {
        const root = (container && container.querySelector) ? container : document;
        return root.querySelector(`.cell[data-day="${dayIdx}"][data-period="${period}"]`);
    }
    // âœ… íŒŒì¼ì— ì´ ë²„ì „ í•˜ë‚˜ë§Œ ìœ ì§€í•˜ì„¸ìš” (ì¤‘ë³µ ì„ ì–¸ ì œê±°!)
    function isTruthyTag(tag) {
        if (tag === true || tag === 1) return true; // boolean/number
        if (tag === false || tag === 0) return false;
        if (typeof tag === 'string') {
            const t = tag.trim().toLowerCase();
            // postgres ë“±ì—ì„œ 't'/'f'ë¡œ ë‚´ë ¤ì˜¤ëŠ” ê²½ìš° í¬í•¨
            if (
                t === 't' ||
                t === 'true' ||
                t === '1' ||
                t === 'y' ||
                t === 'yes'
            )
                return true;
            if (
                t === 'f' ||
                t === 'false' ||
                t === '0' ||
                t === 'n' ||
                t === 'no'
            )
                return false;
        }
        return !!tag;
    }

    function pickTimetableArray(obj) {
        if (!obj || typeof obj !== 'object') return [];
        const candidates = Object.values(obj).filter(Array.isArray);
        return (
            candidates.find((arr) =>
                arr.some(
                    (r) =>
                        r &&
                        typeof r === 'object' &&
                        ('timetableId' in r || 'id' in r) &&
                        ('tag' in r || 'term' in r)
                )
            ) || []
        );
    }

    // "20252" -> "2025ë…„ 2í•™ê¸°"
    function toSemesterName(termCode) {
        const s = String(termCode || '');
        const year = s.slice(0, 4);
        const sem = s.slice(4);
        const label = sem === '1' ? '1í•™ê¸°' : sem === '2' ? '2í•™ê¸°' : '';
        return year && label ? `${year}ë…„ ${label}` : 'ëŒ€í‘œ ì‹œê°„í‘œ';
    }

    async function hydrateSemestersFromServer() {
        const token = localStorage.getItem('jwtToken');
        try {
            const res = await fetch('/tableId_List', {
                method: 'GET',
                headers: { Authorization: `Bearer ${token}` },
                credentials: 'include',
            });
            if (!res.ok)
                throw new Error(`ì‹œê°„í‘œ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨ (HTTP ${res.status})`);
            const data = await res.json();

            const list = pickTimetableArray(data);
            if (!Array.isArray(list) || list.length === 0) return;

            selectedSemesters = [];
            timetableIdsBySemester = {};

            for (const row of list) {
                const term = String(row.term ?? row['term'] ?? '');
                const tid = Number(row.timeTableId ?? row['timetableId'] ?? row.id);
                const tagVal = row.tag ?? row['tag'];
                if (isTruthyTag(tagVal)) {
                    representativeTermCode = term; // âœ… ëŒ€í‘œ í•™ê¸° ì½”ë“œ ìƒíƒœ ë°˜ì˜
                }

                if (!term || !tid) continue;

                timetableIdsBySemester[term] = tid;

                const semText = toSemesterName(term); // ì´ë¯¸ íŒŒì¼ì— ì •ì˜ë¨
                if (!selectedSemesters.includes(semText)) {
                    selectedSemesters.push(semText);
                }
            }

            renderSemesterList();
            populateSemesterSelectInline();
        } catch (err) {
            console.error('hydrateSemestersFromServer ì˜¤ë¥˜:', err);
        }
    }

    async function removeSemester(termCode, timetableId) {
        if (!Number.isInteger(timetableId)) {
            alert('ìœ íš¨í•œ timetableIdê°€ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }
        const token = localStorage.getItem('jwtToken');
        if (!confirm('ì´ í•™ê¸°ì˜ ì‹œê°„í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?')) return;

        try {
            // ì„œë²„ ê·œì•½ì— ë§ì¶° í˜¸ì¶œ (ì§€ê¸ˆì€ /deleteTC ì˜ˆì‹œ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
            const res = await fetch('/deleteTC', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify(timetableId),
            });

            const txt = await res.text();
            if (!res.ok) throw new Error(`ì‚­ì œ ì‹¤íŒ¨: ${txt}`);

            // âœ… ë¡œì»¬ ìƒíƒœì—ì„œë„ ì œê±°
            const semText = toSemesterName(termCode);
            selectedSemesters = selectedSemesters.filter((s) => s !== semText);
            delete timetableIdsBySemester[termCode];
            renderSemesterList();
            alert('ì‹œê°„í‘œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        } catch (err) {
            alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
            console.error(err);
        }
    }

    async function onToggleRepresentative(termCode, checked) {
        const token = localStorage.getItem('jwtToken');
        if (!checked) {
            // í•´ì œëŠ” í—ˆìš©í•˜ì§€ ì•ŠìŒ â†’ UI ë˜ëŒë¦¼
            renderSemesterList();
            return;
        }

        // 1) termCode -> timetableId ì°¾ê¸°
        const tid =
            timetableIdsBySemester?.[termCode] ??
            (await fetchLatestTimetableIdFromUserInfo(termCode));
        if (!tid) {
            alert('timetableIdë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            renderSemesterList();
            return;
        }

        // 2) ëŒ€í‘œë¡œ ì„¤ì •
        const fd = new FormData();
        fd.append('timetableId', String(tid));
        const res = await fetch('/representative_Timetable', {
            method: 'POST',
            headers: { Authorization: `Bearer ${token}` },
            body: fd,
        });
        if (!res.ok) {
            alert('ëŒ€í‘œ ì„¤ì • ì‹¤íŒ¨');
            renderSemesterList();
            return;
        }

        // 3) ìƒíƒœ ë°˜ì˜ + ë‹¤ì‹œ ë Œë”(ì„œë²„ ìµœì‹  ë°˜ì˜)
        representativeTermCode = termCode;

        // âœ… ì—¬ê¸° ë¶€ë¶„ì´ í•µì‹¬
        await hydrateSemestersFromServer(); // ëª©ë¡/ë§¤í•‘ ìµœì‹ í™”
        await renderRepresentativeFromServer(); // ëŒ€í‘œ ì‹œê°„í‘œ ì¬ë Œë”
        renderSemesterList();
    }

    async function loadRepresentativeSchedule(getScheduleIds) {
        console.log(getScheduleIds);
        const token = localStorage.getItem('jwtToken');
        if (!token) {
            alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
            return;
        }

        try {
            // 1) ì„œë²„ í˜¸ì¶œ
            const res = await fetch('/getTS2TE', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    Authorization: `Bearer ${token}`,
                },
                body: JSON.stringify({ getScheduleIds }),
            });

            if (!res.ok) throw new Error('ëŒ€í‘œ ì‹œê°„í‘œ ì¡°íšŒ ì‹¤íŒ¨');

            const data = await res.json(); // schedule_of_course[]
            console.log('ëŒ€í‘œì‹œê°„í‘œ ë°ì´í„°:', data);

            // 2) í…Œì´ë¸” ìƒì„±
            renderRepresentativeSchedule(data);
        } catch (err) {
            console.error(err);
            alert('ëŒ€í‘œ ì‹œê°„í‘œ ë¡œë”© ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + err.message);
        }
    }

    function renderRepresentativeSchedule(scheduleData) {
        const container = document.getElementById('representativeScheduleContainer');
        if (!container) return;

        // 0) ê·¸ë¦¬ë“œ ì¹´ë“œ ë¼ˆëŒ€ê°€ ë¹„ì–´ìˆë‹¤ë©´ ë§Œë“¤ì–´ë‘”ë‹¤ (ì•ˆì „ì¥ì¹˜)
        if (!document.getElementById('repGridBody')) {
            container.innerHTML = `
      <div class="schedule-card" id="repGridCard">
        <div class="schedule-header">
          <div class="time-col"></div>
          <div>ì›”</div><div>í™”</div><div>ìˆ˜</div><div>ëª©</div><div>ê¸ˆ</div>
        </div>
        <div class="schedule-body" id="repGridBody"></div>
      </div>`;
        }

        // 1) ê¸°ë³¸ 1~9êµì‹œ ë¼ˆëŒ€ ìƒì„±
        buildRepGrid(9);

        // (ì„ íƒ) 0êµì‹œê°€ ìˆìœ¼ë©´ 0êµì‹œ í–‰ì„ ìƒë‹¨ì— ì¶”ê°€
        const hasZero = Array.isArray(scheduleData) && scheduleData.some(
            it => Number(it.time_start ?? it.timeStart ?? it.periodStart) === 0 ||
                Number(it.time_end   ?? it.timeEnd   ?? it.periodEnd)   === 0
        );
        if (hasZero) ensureZeroRepRow(); // ì•„ë˜ ë‚´ë¶€ í—¬í¼

        // 2) ë°ì´í„°ì˜ ìµœëŒ“ êµì‹œë¡œ í–‰ í™•ì¥ (10êµì‹œ ì´ìƒ ìë™ ì¶”ê°€)
        let neededMax = 9;
        scheduleData?.forEach(it => {
            const end = Number(it.time_end ?? it.timeEnd ?? it.periodEnd ?? it.time_start ?? it.timeStart);
            if (Number.isFinite(end)) neededMax = Math.max(neededMax, end);
        });
        ensureRepGridMaxPeriods(neededMax);

        // 3) ê³¼ëª©ë³„ ìƒ‰ìƒ ê³ ì • ë§µ
        if (!window.colorMap) window.colorMap = {};

        // 4) ì…€ ì±„ìš°ê¸°
        scheduleData?.forEach(item => {
            const subject   = item.courseName || '';
            const professor = item.professorName || '';
            const classroom = item.classroom || '';
            const courseCode = item.identify_number_of_course
                ?? item.courseCode
                ?? item.identifyNumberOfCourse
                ?? subject; // ì‹ë³„ì ì—†ìœ¼ë©´ ê³¼ëª©ëª…ìœ¼ë¡œ ë¬¶ìŒ

            // ìš”ì¼: 1~5 â†’ 0~4 ì¸ë±ìŠ¤ë¡œ ë³€í™˜
            const dayIdx = (Number(item.day) || 0) - 1;
            if (dayIdx < 0 || dayIdx > 4) return;

            // êµì‹œ ë²”ìœ„ ìˆ«ìí™”
            const pStart = toInt(item.time_start ?? item.timeStart ?? item.periodStart);
            const pEnd   = toInt(item.time_end   ?? item.timeEnd   ?? item.periodEnd   ?? pStart);
            if (pStart == null || pEnd == null) return;

            const bg = ColorManager.get(courseCode);


            for (let p = pStart; p <= pEnd; p++) {
                const cell = repCell(dayIdx, p);
                if (!cell) continue;

                cell.classList.add('busy');
                cell.style.background = bg;            // âœ…
                cell.style.backgroundImage = 'none';   // âœ…

                cell.style.setProperty('--course-color', bg);
                cell.style.removeProperty('background');
                cell.style.removeProperty('backgroundImage');

                cell.setAttribute('data-course-id', courseCode);
                cell.innerHTML = renderSlotHTML(subject, classroom, professor);


                // (ì„ íƒ) íˆ´íŒ ì—°ê²°
                const tipData = {
                    courseName: subject,
                    professorName: professor,
                    classroom,
                    majorOrCulture: item.majorOrCulture ?? item.isMajor ?? null,
                    credit: item.credit ?? '-',
                    scheduleDay: Number(item.day),
                    timeStart: pStart,
                    timeEnd: pEnd,
                    identifyNumberOfCourse: courseCode || '-',
                };
                cell.onmouseenter = () => showCourseTooltip(cell, tipData);
                cell.onmouseleave = () => hideCourseTooltip();
            }
        });

        // ===== ë‚´ë¶€ í—¬í¼ =====
        function toInt(v) {
            const n = Number(v);
            return Number.isFinite(n) ? n : null;
        }

        // 0êµì‹œ í–‰ì´ í•„ìš”í•œ ê²½ìš° ìƒë‹¨ì— 0êµì‹œ rowë¥¼ ì¶”ê°€
        function ensureZeroRepRow() {
            const body = document.getElementById('repGridBody');
            if (!body) return;

            // ì´ë¯¸ 0êµì‹œê°€ ìˆìœ¼ë©´ íŒ¨ìŠ¤
            const hasZeroRow = !!body.querySelector('.row .time-col') &&
                Array.from(body.children).some(row => {
                    const label = row.querySelector('.time-col')?.textContent || '';
                    return /(^|\D)0\s*êµì‹œ/.test(label);
                });
            if (hasZeroRow) return;

            // 0êµì‹œ í–‰ ìƒì„±
            const zeroRow = document.createElement('div');
            zeroRow.className = 'row';
            zeroRow.innerHTML = `
      <div class="time-col">0êµì‹œ<br/><span></span></div>
      <div class="cell" data-day="0" data-period="0"></div>
      <div class="cell" data-day="1" data-period="0"></div>
      <div class="cell" data-day="2" data-period="0"></div>
      <div class="cell" data-day="3" data-period="0"></div>
      <div class="cell" data-day="4" data-period="0"></div>
    `;
            body.insertBefore(zeroRow, body.firstChild);
        }
    }


    // âœ… ì‹œê°„í‘œ ID (ë¶€ëª¨)
    function getTid(r) {
        const v =
            r.timeTableId ??
            r.timetableId ??
            r.time_table_id ??
            r.timetable_id ??
            r.parentTimetableId ??
            r.timeTableIdOfParent ??
            r.tid;
        return v != null ? Number(v) : NaN;
    }

    // âœ… ì½”ìŠ¤ ID(= courseIds) â†’ ë‹¹ì‹ ì´ ë§í•œ â€œscheduleIds ëŠ” courseIds ì—¬ì•¼ í•œë‹¤â€ë¥¼ êµ¬í˜„í•˜ë ¤ë©´ ì´ê±¸ ì‚¬ìš©
    function getCourseId(r) {
        return (
            r.courseId ??
            r.identifyNumberOfCourse ?? // ì˜ˆ: "HAEA0001-02"
            r.subjectCode ??
            r.course_id ??
            null
        );
    }

    async function renderRepresentativeFromServer() {
        const token = localStorage.getItem('jwtToken');
        if (!token) return;

        // âœ… UserId ë³´ì¥
        if (!UserId) {
            try {
                await loaduserinfo();
            } catch (_) {}
        }

        // 1) ëŒ€í‘œ timetableId/term ì°¾ê¸°
        const res = await fetch('/tableId_List', {
            method: 'GET',
            headers: { Authorization: `Bearer ${token}` },
            credentials: 'include',
        });
        if (!res.ok) return;

        const data = await res.json();
        const list = pickTimetableArray(data);
        const rep = list.find((row) => isTruthyTag(row.tag ?? row['tag']));

        if (!rep) {
            document.getElementById(
                'representativeScheduleContainer'
            ).innerHTML = `<p style="color:#888;">ëŒ€í‘œ ì‹œê°„í‘œê°€ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</p>`;
            document.getElementById('representativeTitle').textContent =
                'ğŸ“Œ ëŒ€í‘œ ì‹œê°„í‘œ';
            return;
        }

        const termCode = String(rep.term ?? rep['term'] ?? '');
        const timetableId = Number(
            rep.timeTableId ?? rep['timeTableId'] ?? rep.timetableId ?? rep.id
        );
        representativeTermCode = termCode;
        document.getElementById(
            'representativeTitle'
        ).textContent = `ğŸ“Œ ëŒ€í‘œ ì‹œê°„í‘œ - ${toSemesterName(termCode)}`;

        // 2) í•­ìƒ userIdë¡œ /getTC ì¡°íšŒ â†’ í•´ë‹¹ timetableIdë§Œ í•„í„°
        const byUid = await fetch('/getTC', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                Authorization: `Bearer ${token}`,
            },
            // ì„œë²„ê°€ ì§€ê¸ˆê¹Œì§€ JSON.stringify(UserId) í˜•íƒœë¥¼ ë°›ì•˜ìœ¼ë‹ˆ ê·¸ëŒ€ë¡œ ìœ ì§€
            body: JSON.stringify(UserId),
        });
        if (!byUid.ok) {
            const failTxt = await byUid.text();
            console.error('getTC ì‹¤íŒ¨ status=', byUid.status, 'body=', failTxt);
            document.getElementById(
                'representativeScheduleContainer'
            ).innerHTML = `<p style="color:#888;">ëŒ€í‘œ ì‹œê°„í‘œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>`;
            return;
        }

        let all;
        try {
            const txt = await byUid.text();
            try {
                all = JSON.parse(txt);
            } catch (e) {
                console.error('[rep] /getTC JSON íŒŒì‹± ì‹¤íŒ¨. ì›ë¬¸:', txt);
                throw e;
            }
        } catch (e) {
            console.error('[rep] /getTC ì‘ë‹µ ì½ê¸° ì‹¤íŒ¨:', e);
            return;
        }
        console.log('[rep] /getTC ì „ì²´ rows:', all);
        console.log('[rep] ëŒ€í‘œ timetableId(ë¹„êµê¸°ì¤€):', timetableId);

        const rows = (all || []).filter((r) => {
            const tid = getTid(r);
            return Number.isFinite(tid) && tid === timetableId;
        });
        console.log(
            '[rep] ëŒ€í‘œ timetableId:',
            timetableId,
            'í•„í„°ëœ rows:',
            rows
        );

        // 3) scheduleIds ì¶”ì¶œ
        const courseIds = Array.from(
            new Set(
                rows.map(getCourseId).filter((v) => v != null && String(v).trim() !== '')
            )
        );
        console.log('[rep] ì¶”ì¶œëœ courseIds:', courseIds);
        // 4) /getTS2TE í˜¸ì¶œ â†’ ë Œë”
        await loadRepresentativeSchedule(courseIds);
    }
    function buildRepGrid(periodCount=9){
        const body = document.getElementById('repGridBody');
        if(!body) return;
        body.innerHTML = '';

        const timeLabels = ['9~10ì‹œ','10~11ì‹œ','11~12ì‹œ','12~1ì‹œ','1~2ì‹œ','2~3ì‹œ','3~4ì‹œ','4~5ì‹œ','5~6ì‹œ'];
        for(let p=1;p<=periodCount;p++){
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `
      <div class="time-col">${p}êµì‹œ<br/><span>${timeLabels[p-1]||''}</span></div>
      <div class="cell" data-day="0" data-period="${p}"></div>
      <div class="cell" data-day="1" data-period="${p}"></div>
      <div class="cell" data-day="2" data-period="${p}"></div>
      <div class="cell" data-day="3" data-period="${p}"></div>
      <div class="cell" data-day="4" data-period="${p}"></div>
    `;
            body.appendChild(row);
        }
    }



    // í˜„ì¬ ëŒ€í‘œ ê·¸ë¦¬ë“œì˜ 'ìµœëŒ€ êµì‹œ'ë¥¼ data-period ê¸°ì¤€ìœ¼ë¡œ ê³„ì‚° (0êµì‹œ ì œì™¸)
    function getRepCurrentMaxPeriod() {
        let maxP = 1;
        document.querySelectorAll('#repGridBody .cell[data-period]').forEach((c) => {
            const p = Number(c.getAttribute('data-period'));
            if (Number.isFinite(p)) maxP = Math.max(maxP, p);
        });
        return maxP;
    }

    // í•„ìš” ì‹œ 10êµì‹œ ì´ìƒ í–‰ì„ ì•ˆì „í•˜ê²Œ ì¶”ê°€ (0êµì‹œê°€ ìˆì–´ë„ ì •í™•í•¨)
    function ensureRepGridMaxPeriods(needed) {
        const body = document.getElementById('repGridBody');
        if (!body) return;

        const curMax = getRepCurrentMaxPeriod(); // ex) 0~9êµì‹œê°€ ìˆì–´ë„ 9ë¥¼ ëŒë ¤ì¤Œ
        if (needed <= curMax) return;

        for (let p = curMax + 1; p <= needed; p++) {
            const row = document.createElement('div');
            row.className = 'row';
            row.innerHTML = `
      <div class="time-col">${p}êµì‹œ<br/><span></span></div>
      <div class="cell" data-day="0" data-period="${p}"></div>
      <div class="cell" data-day="1" data-period="${p}"></div>
      <div class="cell" data-day="2" data-period="${p}"></div>
      <div class="cell" data-day="3" data-period="${p}"></div>
      <div class="cell" data-day="4" data-period="${p}"></div>
    `;
            body.appendChild(row);
        }
    }

    function repCell(dayIdx, period){
        return document.querySelector(
            `#repGridCard .cell[data-day="${dayIdx}"][data-period="${period}"]`
        );
    }
    function renderSlotHTML(subject, classroom, professor) {
        const sub = subject ?? "";
        const room = classroom ? `<div class="slot-room">${classroom}</div>` : "";
        return `
    <div class="slot">
      <div class="slot-title">${sub}</div>
      ${room}
    </div>
  `;
    }
</script>
</body>
</html>